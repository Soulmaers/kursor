(()=>{"use strict";var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};async function t(){const e=await fetch("/users",{method:"GET",headers:{"Content-Type":"application/json"}});console.log(e);const s=await e.json();console.log(s);const i=document.querySelectorAll(".users");i&&i.forEach((e=>{e.remove()}));const a=document.querySelector(".listAccountReal");s.forEach((e=>{const t=document.createElement("li");t.classList.add("users"),a.appendChild(t);const s=document.createElement("span");s.classList.add("login"),s.textContent=e.name;const i=document.createElement("span");i.classList.add("role");const n=document.createElement("span");n.classList.add("crud"),i.textContent=e.role;const r=document.createElement("span");r.classList.add("icon1"),r.setAttribute("id",`${e.idx}`);const l=document.createElement("icon2");l.classList.add("icon2"),l.setAttribute("id",`${e.idx}`),t.appendChild(s),t.appendChild(i),t.appendChild(n),n.appendChild(r),n.appendChild(l)}));const n=document.querySelector(".clearConfirm"),r=document.querySelectorAll(".icon2"),l=document.querySelector(".net"),o=document.querySelector(".da");r.forEach((e=>{e.addEventListener("click",(()=>{r.forEach((e=>{e.classList.remove("btna")})),e.classList.add("btna"),n.style.display="flex"}))})),l.addEventListener("click",(()=>{r.forEach((e=>{e.classList.contains("btna")&&(e.classList.remove("btna"),n.style.display="none")}))})),o.addEventListener("click",(()=>{r.forEach((e=>{if(e.classList.contains("btna")){console.log(e),n.style.display="none",console.log(e.closest(".users").children[0].textContent);const s=e.closest(".users").children[0].textContent;console.log(s),async function(e,s){const i=e,a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idx:i,log:s})},n=await fetch("/delete/:id",a),r=await n.json(),l=document.querySelector(".message");l.textContent=r.message,l.style.color="green",setTimeout((()=>l.textContent=""),2e3);const o=document.querySelectorAll(".form-control");document.getElementById("select").firstElementChild.selected=!0,o.forEach((e=>{e.value=""})),t()}(e.id,s)}}))})),function(){const e=document.querySelectorAll(".icon1"),s=document.querySelectorAll(".sigup");e.forEach((e=>{e.addEventListener("click",(async()=>{const i=e.closest(".users").children[0].textContent;s[0].innerHTML=`<div class="form-group">\n            <label>Логин</label>\n            <input type="text" class="form-control" value=${i} name="username">\n            </div>\n            <div class="form-group">\n            <label>Права доступа</label>\n            <select class="sel" id="select">\n                <option class="opt" selected disabled>Укажите права доступа</option>\n                <option class="opt" value="Пользователь" name="role">Пользователь</option>\n                  <option class="opt" value="Дилер" name="role">Дилер</option>\n                          <option class="opt" value="Дежурный" name="role">Дежурный</option>\n                <option class="opt" value="Администратор" name="role">Администратор</option>\n            </select>\n            </div>\n            <div class="btnWrap">\n            <button class="btn-up btn-lg">Сохранить</button>\n            </div>`;const a=document.querySelector(".btn-up"),n=document.getElementById("select"),r=document.querySelectorAll(".form-control"),l=e.id;a.addEventListener("click",(async()=>{const e=r[0].value,a=n.value;if(s[0].innerHTML='<div class="form-group">\n                <label>Логин</label>\n                <input type="text" class="form-control" name="username">\n            </div>\n            <div class="form-group">\n                <label>Пароль</label>\n                <input type="password" class="form-control" name="password">\n            </div>\n            <div class="form-group">\n                <label>Права доступа</label>\n                <select class="sel" id="select">\n                    <option class="opt" selected disabled>Укажите права доступа</option>\n                    <option class="opt" value="Пользователь" name="role">Пользователь</option>\n                     <option class="opt" value="Дилер" name="role">Дилер</option>\n                        <option class="opt" value="Дежурный" name="role">Дежурный</option>\n                    <option class="opt" value="Администратор" name="role">Администратор</option>\n                </select>\n            </div>\n            <div class="btnWrap">\n                <button class="btn-warning btn-lg">Добавить</button>\n            </div>',!e){const e=document.querySelector(".message");return e.textContent="Не указан логин!",e.style.color="red",void setTimeout((()=>e.textContent=""),2e3)}if("Укажите права доступа"===a){const e=document.querySelector(".message");return e.textContent="Не выбраны права доступа!",e.style.color="red",void setTimeout((()=>e.textContent=""),2e3)}if(i&&"Укажите права доступа"!==a){const s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idx:l,log:e,role:a})},i=await fetch("/update/:id",s),n=await i.json(),r=document.querySelector(".message");r.textContent=n.message,r.style.color="green",setTimeout((()=>r.textContent=""),2e3),t()}}))}))}));const i=document.querySelectorAll(".form-control");document.getElementById("select").firstElementChild.selected=!0,i.forEach((e=>{e.value=""}))}();const c=document.querySelectorAll(".login");Array.from(c).forEach((e=>{e.addEventListener("click",(()=>{e.classList.add("activUser"),function(e,t){document.querySelector(".profilUser").style.display="flex",document.querySelector(".accountControl").style.display="none";const s=document.querySelector(".nameUser"),i=document.querySelector(".userRole");s.textContent=e,i.textContent=t,async function(e){const t=document.getElementById("all"),s=document.querySelectorAll(".checkIn"),i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})},a=await fetch("/api/viewCheckObject",i),n=await a.json();0===n.length?s.forEach((e=>{e.checked=!1,t.checked=!0})):s.forEach((e=>{e.checked=!1,n.forEach((s=>{e.id===s.idw&&(t.checked=!1,e.checked=!0)}))}))}(e)}(e.textContent,e.nextElementSibling.textContent)}))}))}function s(e){const t=new Date(e),s=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"][t.getMonth()],i=t.getDate(),a=t.getHours(),n=t.getMinutes();return`${s} ${i}, ${a}:${n<10?"0":""}${n}`}e.d({},{y:()=>Pt}),document.querySelector(".btn-warning").addEventListener("click",(async function(){const e=(1e4*Math.random()).toFixed(0)+"id",s=document.querySelectorAll(".form-control"),i=document.getElementById("select"),a=s[0].value,n=s[1].value,r=i.value;if(!a){const e=document.querySelector(".message");return e.textContent="Не указан логин!",e.style.color="red",void setTimeout((()=>e.textContent=""),2e3)}if(!n){const e=document.querySelector(".message");return e.textContent="Не указан пароль!",e.style.color="red",void setTimeout((()=>e.textContent=""),2e3)}if("Укажите права доступа"===r){const e=document.querySelector(".message");return e.textContent="Не выбраны права доступа!",e.style.color="red",void setTimeout((()=>e.textContent=""),2e3)}if(a&&n&&"Укажите права доступа"!==r){const l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idx:e,login:a,pass:n,role:r})},o=await fetch("/signup",l),c=await o.json();console.log(c);const d=document.querySelector(".message");document.querySelectorAll("opt"),200==c.status?(d.textContent="Пользователь добавлен!",d.style.color="green",setTimeout((()=>d.textContent=""),2e3)):(d.textContent=c.message,d.style.color="red",setTimeout((()=>d.textContent=""),2e3)),i.firstElementChild.selected=!0,s.forEach((e=>{e.value=""})),t()}})),document.querySelector(".okey").addEventListener("click",(()=>{document.querySelector(".clearConfirmCheckModal").style.display="flex"})),document.querySelector(".nent").addEventListener("click",(()=>{document.querySelector(".clearConfirmCheckModal").style.display="none"})),document.querySelector(".close").addEventListener("click",(()=>{document.querySelector(".profilUser").style.display="none",document.querySelector(".accountControl").style.display="flex"}));const i=e=>{const t=new Set(e.map((e=>JSON.stringify(e))));return Array.from(t).map((e=>JSON.parse(e)))};function a(e){var t=Math.floor(e/86400),s=Math.floor(e%86400/3600),i=Math.floor(e%3600/60);return t>0?`${t} д. ${s} ч. ${i} мин.`:s>0?`${s} ч. ${i} мин.`:0===i?`${i} мин. ${e%60} сек.`:`${i} мин.`}function n(e){const t=new Date,s=new Date(t);return s.setDate(t.getDate()-e),`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")} `}function r(e){e.addEventListener("focus",(()=>{e.dataset.oldContent=e.textContent,e.textContent=""})),e.addEventListener("blur",(()=>{""===e.textContent.trim()&&(e.textContent=e.dataset.oldContent)}))}const l={statusnew:"Статус on/off",ingine:"Зажигание",condition:"Состояние",tagach:"Давление в шинах тягача",pricep:"Давление в шинах прицепа",oil:"Топливо",pwr:"Бортовое питание",sats:"Спутники",type:"Тип ТС",meliage:"Пробег",lasttime:"Актуальность данных"},o='<h3 class="tr oneName">\n                                                    <p class="td">Дата</p>\n                                               <p class="td">Колесо</p>\n                                                    <p class="td">P, бар</p>\n                                                    <p class="td">t,°C</p>\n                                                    <p class="td">Уведомления</p>\n                                                </h3>',c={1:"#FF0000",2:"#FFFF00",3:"#4af72f",5:"#fff"},d={1:"#FF0000",2:"#FFFF00",3:"#009933",5:"#fff"};function h(e){let t;return 100===e&&(t=5),e>=80&&e<100&&(t=4),e>=60&&e<80&&(t=3),e>=40&&e<60&&(t=2),e<40&&(t=1),t}const u={5:"rgba(5, 159, 16, 0.8)",4:"rgba(5, 159, 16, 0.8)",3:"rgba(200, 202, 8, 0.8)",2:"rgba(205, 95, 5, 0.8)",1:"rgba(209, 3, 13, 0.8)"};class p{constructor(){this.time=null}async getTimeInterval(e,t){const s=t||`#${e.children[0].children[0]?e.children[0].children[0].id:e.children[0].id}`,i=flatpickr(s,{mode:"range",dateFormat:"d-m-Y",locale:"ru",static:!0,locale:{firstDayOfWeek:1}});return new Promise(((e,t)=>{i.config.onChange.push(((t,s,i)=>{const a=t.map((e=>{const t=e.getFullYear(),s=("0"+(e.getMonth()+1)).slice(-2),i=("0"+e.getDate()).slice(-2);return[`${t}-${s}-${i}`,`${i}.${s}.${t}`,e.getTime()/1e3]}));console.log(a);const n=a.map((e=>e[e.length-1]));2===a.length&&e(n)}))}))}async getTimeIntervalOne(e,t){const s=t||`#${e.children[0].children[0]?e.children[0].children[0].id:e.children[0].id}`,i=flatpickr(s,{mode:"single",dateFormat:"d-m-Y",locale:"ru",static:!0,locale:{firstDayOfWeek:1}});return console.log(s),new Promise(((e,t)=>{i.config.onChange.push(((t,s,i)=>{if(t.length>0){const s=t[0],i=`${s.getFullYear()}-${("0"+(s.getMonth()+1)).slice(-2)}-${("0"+s.getDate()).slice(-2)}`;console.log(i),e(i)}}))}))}}class m{constructor(e){this.objectsId=e,this.arrayInterval=["Сегодня","Вчера","Неделя"],this.params=document.querySelectorAll(".pointer_chart"),this.content=document.querySelectorAll(".name_list"),this.select=document.querySelectorAll(".select_dannie"),this.title=document.querySelectorAll(".titleChangeSort"),this.data=[],this.count=2,this.params.forEach((e=>e.addEventListener("click",this.toggleClassAndParamsCollection.bind(this,e)))),this.select.forEach((e=>e.querySelector(".toggle_list_select").addEventListener("click",this.toggleListSelect.bind(this,e)))),this.select.forEach((e=>e.querySelector(".select_summary").addEventListener("mouseleave",this.hiddenListOutsideKursor.bind(this,e)))),this.select.forEach((e=>e.querySelectorAll(".item_type").forEach((e=>e.addEventListener("click",this.toggleCheckSelect.bind(this,e)))))),this.startUpdatingToday()}async clickListUpdateSummary(){const e=["Сегодня"];this.title.forEach((t=>{e.push(t.textContent)}));for(let t of e)await this.getSummaryToBase(t)}async toggleCheckSelect(e){const t=e.closest(".select_dannie").querySelector(".titleChangeSort");e.children[0].classList.toggle("radio_choice");const s=e.parentElement.classList.contains("one")?2:3;if(Array.from(e.closest(".select_summary").children).forEach((t=>{t===e||t.children[0].classList.contains("radio_choice")||t.children[0].classList.toggle("radio_choice")})),e.children[0].classList.contains("radio_choice"))t.textContent=e.parentElement.classList.contains("one")?"Вчера":"Неделя",this.getSummaryToBase(t.textContent,s);else if("Календарь"===e.lastElementChild.textContent){const i=await this.openCalendarChoise(e);t.textContent=`${i[1][0]} - ${i[1][1]}`,this.getSummaryToBase(i[0],s)}else t.textContent=e.children[0].nextElementSibling.textContent,this.getSummaryToBase(t.textContent,s)}async openCalendarChoise(e){const t=e.parentElement.nextElementSibling;return t.style.display="block",t.addEventListener("mouseleave",(()=>{t.style.display="none",e.children[0].classList.add("radio_choice")})),await this.choisIntervalDate(t)}async choisIntervalDate(e){const t=new p,s=(await t.getTimeInterval(e)).map((e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${("0"+(t.getMonth()+1)).slice(-2)}-${("0"+t.getDate()).slice(-2)}`})),i=e.children[1],a=e.children[0].children[0];return new Promise(((t,n)=>{Array.from(i.children).forEach((i=>i.addEventListener("click",(()=>{const n=s.map((e=>{const t=e.split("-");return`${t[1].replace(/^0+/,"")}/${t[2]}`}));a.value="",i.closest(".calendar").style.display="none",e.previousElementSibling.lastElementChild.children[0].classList.add("radio_choice"),"Очистить"===i.textContent?t(null):t([s,n])}))))}))}hiddenListOutsideKursor(e){e.children[1].classList.remove("hidden_view")}toggleListSelect(e){e.children[1].classList.toggle("hidden_view"),this.select.forEach((t=>{t!==e&&t.children[1].classList.contains("hidden_view")&&t.children[1].classList.toggle("hidden_view")}))}async startUpdatingToday(){for(const e of this.arrayInterval)await this.getSummaryToBase(e);setInterval((()=>{this.getSummaryToBase("Сегодня")}),6e4)}toggleClassAndParamsCollection(e){this.params.forEach((e=>{e.children[0].classList.contains("clickToggle")&&e.children[0].classList.remove("clickToggle")})),e.children[0].classList.toggle("clickToggle")}controllActiveObject(e){const t=Array.from(document.querySelectorAll(".checkInList")).reduce(((e,t)=>(t.classList.contains("changeColorCheck")&&e.push(Number(t.closest(".listItem").id)),e)),[]);return e.reduce(((e,s)=>(t.includes(s.idw)||e.push(s),e)),[])}async getSummaryToBase(e,t){const s=this.getIntervalDate(e),i=await this.getRequestSummaryToBase(s),a=this.controllActiveObject(i);let n;n="Неделя"===e||"Месяц"===e||2===e.length?this.filterWeekSummary(a):this.calculationParametrs(a),"Сегодня"!==e?this.viewSummaryTable(n,t):this.updateViewSummaryTable(n)}filterWeekSummary(e){const t=e.reduce(((e,t)=>(1===Number(t.jobTS)&&e.push(t),e)),[]),s=this.uniqSort(e),i=this.uniqSort(t),a=[];return a.push(s),a.push(i),a.push(this.calculateParam(e,"probeg")),a.push(this.calculateParam(e,"rashod")),a.push(this.calculateParam(e,"zapravka")),a.push(this.calculateParam(e,"dumpTrack")),a.push(this.calculateParam(e,"moto")/1e3),a.push(this.calculateParam(e,"prostoy")),a.push(this.calculateParam(e,"moto")/1e3-this.calculateParam(e,"prostoy")),a.push(0===e.length||0===this.calculateParam(e,"medium")?0:parseFloat((this.calculateParam(e,"medium")/e.filter((e=>e.medium>0)).length).toFixed(0))),a.push(0===e.filter((e=>e.oilHH>0)).length?0:parseFloat((this.calculateParam(e,"oilHH")/e.filter((e=>e.oilHH>0)).length).toFixed(0))),a.reduce(((e,t,s)=>(6===s||7===s||8===s?e.push(this.timesFormat(t)):e.push(t),e)),[])}uniqSort(e){let t={};for(let s=0;s<e.length;s++){let i=e[s].idw;t[i]=t[i]?t[i]+1:1}return Object.keys(t).length}updateViewSummaryTable(e){this.content.forEach(((t,s)=>{t.parentElement.children[1].textContent=e[s]}))}viewSummaryTable(e,t){t?this.content.forEach(((s,i)=>{s.parentElement.children[t].textContent=e[i]})):(this.content.forEach(((t,s)=>{t.parentElement.children[this.count].textContent=e[s]})),3===this.count?this.count=2:this.count++)}calculateParam(e,t){return e.reduce(((e,s)=>e+(isNaN(Number(s[t]))?0:Number(s[t]))),0)}calculationParametrs(e){const t=[];return t.push(e.length),t.push(this.calculateParam(e,"jobTS")),t.push(this.calculateParam(e,"probeg")),t.push(this.calculateParam(e,"rashod")),t.push(this.calculateParam(e,"zapravka")),t.push(this.calculateParam(e,"dumpTrack")),t.push(this.calculateParam(e,"moto")/1e3),t.push(this.calculateParam(e,"prostoy")),t.push(this.calculateParam(e,"moto")/1e3-this.calculateParam(e,"prostoy")),t.push(0===e.length||0===this.calculateParam(e,"medium")?0:parseFloat((this.calculateParam(e,"medium")/e.filter((e=>e.medium>0)).length).toFixed(0))),t.push(0===e.filter((e=>e.oilHH>0)).length?0:parseFloat((this.calculateParam(e,"oilHH")/e.filter((e=>e.oilHH>0)).length).toFixed(0))),t.reduce(((e,t,s)=>(6===s||7===s||8===s?e.push(this.timesFormat(t)):e.push(t),e)),[])}timesFormat(e){const t=Math.floor(e),s=Math.floor(t/3600).toString().padStart(2,"0"),i=Math.floor(t%3600/60).toString().padStart(2,"0");return(t%60).toString().padStart(2,"0"),`${s}:${i}`}async getRequestSummaryToBase(e){const t=this.objectsId,s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:e,arrayId:t})};try{const e=await fetch("/api/summaryYestoday",s),t=await e.json();return t.sort(((e,t)=>e.data-t.data)),t}catch(e){console.log(e)}}getIntervalDate(e){const t=[];let s;return"Неделя"===e&&(s=7),"Месяц"===e&&(s=30),"Вчера"===e&&(s=1),"Сегодня"===e&&(s=0),2===e.length?t.push(e[0],e[1]):s<=1?t.push(this.convertDate(s)):t.push(this.convertDate(s),this.convertDate(1)),t}convertDate(e){const t=new Date,s=new Date(t);return s.setDate(t.getDate()-e),`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`}}class y{constructor(){this.data=null,this.originalData=null,this.nameChart="probeg",this.elementList=document.querySelectorAll(".checkInList"),this.params=document.querySelectorAll(".pointer_chart"),this.params.forEach((e=>e.addEventListener("click",this.getTitleChart.bind(this,e))))}getTitleChart(e){document.querySelector(".title_lower_charts").textContent=e.getAttribute("data-attribute");const t=e.getAttribute("rel");this.nameChart=t,0!==this.data.length&&this.createChart()}async getDataSummary(){const e=_e.getIntervalDate("Месяц");this.data=await _e.getRequestSummaryToBase(e);const t=_e.controllActiveObject(Object.values(this.data));this.originalData=t;let s={};for(let e=0;e<t.length;e++){const i=t[e].data,a="-"===t[e].probeg||isNaN(t[e].probeg)?0:Number(t[e].probeg),n="-"!==t[e].rashod?Number(t[e].rashod):0,r="-"!==t[e].zapravka?Number(t[e].zapravka):0,l="-"!==t[e].dumpTrack?Number(t[e].dumpTrack):0,o="-"!==t[e].moto?Number(t[e].moto):0,c="-"===t[e].medium||isNaN(t[e].medium)?0:Number(t[e].medium),d="-"!==t[e].prostoy?Number(t[e].prostoy):0,h="-"!==t[e].jobTS?Number(t[e].jobTS):0;s[i]||(s[i]={date:i.substring(5),alldate:i,probeg:0,rashod:0,zapravka:0,dumpTrack:0,moto:0,mediumAll:0,mediumlength:0,madium:0,prostoy:0,timeJob:0,jobTS:0}),s[i].probeg+=a,s[i].rashod+=n,s[i].zapravka+=r,s[i].dumpTrack+=l,s[i].moto+=o/1e3,s[i].prostoy+=d,s[i].timeJob+=o/1e3-d,s[i].mediumlength+=0!==c?1:0,s[i].mediumAll+=c,s[i].medium=parseFloat((s[i].mediumAll/s[i].mediumlength).toFixed(0)),s[i].jobTS+=h}let i=Object.values(s);const a=document.querySelector(".clickToggle").parentElement.getAttribute("rel");this.data=i;const n=document.querySelector(".chart_global");0!==i.length?this.createChart(i,a):n&&n.remove()}timesFormat(e){const t=Math.floor(e),s=Math.floor(t/3600).toString().padStart(2,"0"),i=Math.floor(t%3600/60).toString().padStart(2,"0");return(t%60).toString().padStart(2,"0"),`${s}:${i}`}findTop(e,t){const s=document.querySelectorAll(".log")[1].textContent;return this.originalData.reduce(((s,i)=>{if(i.data===e&&"-"!==i[t]){const e=Object.assign({},i);"timeJob"!==t?(e[t]="moto"!==t?Number(e[t]):Number(e[t])/1e3,s.push(e)):(e[t]="-"!==e.moto&&"-"!==e.prostoy?e.moto/1e3-e.prostoy:0,s.push(e))}return s}),[]).sort(((e,s)=>s[t]-e[t])).slice(0,3).map((e=>({company:"Курсор"!==s?e.company:"Комания",nameCar:e.nameCar,[t]:e[t]})))}createChart(e,t){let s,i;e&&t?(s=t,i=e):(s=this.nameChart,i=this.data);const a=document.querySelector(".chart_global");a&&a.remove();const n=document.querySelector(".content_lower_charts"),r=document.createElement("div");r.classList.add("chart_global"),n.appendChild(r);const l=d3.select(".chart_global").append("svg").attr("width",n.clientWidth).attr("height",n.clientHeight+10),o=d3.scaleBand().domain(i.map((function(e){return e.date}))).range([70,n.clientWidth-110]).padding(.03),c=this,d=d3.scaleLinear().domain([0,d3.max(i,(function(e){return e[s]}))]).range([n.clientHeight-10,20]);l.append("g").attr("transform",`translate(0, ${d(0)})`).call(d3.axisBottom(o)),l.append("g").attr("transform","translate(70, 0)").call("moto"!==s&&"prostoy"!==s&&"timeJob"!==s?d3.axisLeft(d):d3.axisLeft(d).tickFormat((function(e){return c.timesFormat(e)}))),l.selectAll("rect").data(i).enter().append("rect").attr("x",(e=>o(e.date))).attr("y",(e=>d(e[s])+10)).attr("height",(e=>n.clientHeight-20-d(e[s]))).attr("width",o.bandwidth()).attr("fill","#336699").attr("stroke","#fff").attr("stroke-width",1).on("mouseenter",(function(e){if("jobTS"!==s){var t=i.reduce(((e,t)=>t[s]>e[s]?t:e));const n=c.findTop(e.alldate,s);var a=l.append("g").attr("id","tooltip").style("position","absolute").style("top",d3.event.pageY-l.node().getBoundingClientRect().top+"px").style("pointer-events","none").style("font-size","10px").style("font-weight","400").style("text-anchor","middle").attr("max-width",230).attr("height",60);a.append("rect").attr("fill","#fff").attr("x",o(e.date)+o.bandwidth()/2-115).attr("y",d(t[s])+80).attr("text-anchor","middle").attr("width",230).attr("height",60).attr("stroke","rgba(6, 28, 71, 1)"),a.append("text").attr("fill","rgba(6, 28, 71, 1)").attr("x",o(e.date)+o.bandwidth()/2).attr("y",d(t[s])+90).attr("text-anchor","middle").text("TOP 3");for(let i=0;i<3;i++)a.append("text").attr("fill","rgba(6, 28, 71, 1)").attr("x",o(e.date)+o.bandwidth()/2).attr("y",d(t[s])+105+12*i).attr("text-anchor","middle").style("font-size","0.6rem").text(`${n[i].company}, ${n[i].nameCar}, ${"moto"===s||"prostoy"===s||"timeJob"===s?c.timesFormat(n[i][s]):n[i][s]}`)}})).on("mouseleave",(function(){l.select("#tooltip").remove()})),i.forEach((function(e){l.append("text").attr("x",o(e.date)+o.bandwidth()/2).attr("y",d(e[s])).text("moto"===s||"prostoy"===s||"timeJob"===s?c.timesFormat(e[s]):0!==e[s]?e[s]:null).attr("font-size","10px").attr("text-anchor","middle").attr("fill","rgba(6, 28, 71, 1)")}))}}class g{constructor(e,t){this.element=e,this.message=t,this.tooltip=null,this.handleMouseEnter=this.handleMouseEnter.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.element.addEventListener("mouseenter",this.handleMouseEnter),this.element.addEventListener("mouseleave",this.handleMouseLeave),this.element.addEventListener("mousemove",this.handleMouseMove)}handleMouseEnter(){const e=document.querySelectorAll(".tool");e&&e.forEach((e=>{e.remove()})),this.tooltip=document.createElement("div"),this.tooltip.classList.add("tool"),this.tooltip.style.position="absolute",this.tooltip.style.top="0",this.tooltip.style.left="0",this.tooltip.style.fontSize="0.9rem",this.tooltip.style.backgroundColor="rgba(6, 28, 71, 1)",this.tooltip.style.color="#fff",this.tooltip.style.padding="5px",this.tooltip.style.zIndex=99999,this.tooltip.style.borderRadius="5px",this.tooltip.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.3)",document.body.appendChild(this.tooltip),this.message.forEach((e=>{this.tooltipLow=document.createElement("div"),this.tooltip.appendChild(this.tooltipLow),this.tooltipLow.textContent=e}))}handleMouseLeave(){const e=document.querySelectorAll(".tool");e&&(e.forEach((e=>{e.remove()})),this.tooltip=null)}handleMouseMove(e){this.tooltip&&(this.tooltip.style.top=e.pageY+20+"px",this.tooltip.style.left=e.pageX+20+"px")}setMessage(e){this.message=e,this.tooltip&&(this.tooltip.textContent=e)}}const v=(e,t,s,i,a,n)=>{const r=e.getContext("2d"),l=a/i+1,o=60/i;e.width=l,e.height=o,r.beginPath(),r.moveTo(0,o),r.lineTo(0,o-10),r.lineTo(5,o-10),r.lineTo(7.5,t),r.lineTo(l-7.5,s),r.lineTo(l-5,o-10),r.lineTo(l,o-10),r.lineTo(l,o),r.fillStyle=n,r.fill(),r.lineWidth=1,r.strokeStyle="#000",r.stroke(),r.closePath(),r.beginPath(),r.moveTo(0,0),r.lineTo(0,o-10),r.lineTo(5,o-10),r.lineTo(10,0),r.closePath(),r.fillStyle="#fff",r.fill(),r.beginPath(),r.moveTo(l,o-10),r.lineTo(l-5,o-10),r.lineTo(l-10,0),r.lineTo(l,0),r.closePath(),r.fillStyle="#fff",r.fill()};function f(e,t,s,i,a){const n=document.querySelector(".headerMM"),r=s,l=348/a;n&&(n.style.width=`${l}px`),s[0].parentNode.style.width=`${l}px`,r.forEach((e=>{e.style.display="none"}));const o=[];e.forEach((e=>{o.push(10*e)}));const c=parseFloat(10*t);let d,p,m,y;if(0===e.length){const e=116/a;r.forEach((t=>{t.style.display="block",t.style.width=`${e}px`})),function(e,t,s){const i=(e,t,s)=>{const i=e.getContext("2d"),a=s/t,n=60/t;e.width=a,e.height=n,i.beginPath(),i.moveTo(0,n),i.lineTo(0,n-10),i.lineTo(5,n-10),i.lineTo(10,0),i.lineTo(a-10,0),i.lineTo(a-5,n-10),i.lineTo(a,n-10),i.lineTo(a,n),i.fillStyle="green",i.fill(),i.lineWidth=1,i.strokeStyle="#000",i.stroke(),i.closePath(),i.beginPath(),i.moveTo(0,0),i.lineTo(0,n-10),i.lineTo(5,n-10),i.lineTo(10,0),i.closePath(),i.fillStyle="#fff",i.fill(),i.beginPath(),i.moveTo(a,n-10),i.lineTo(a-5,n-10),i.lineTo(a-10,0),i.lineTo(a,0),i.closePath(),i.fillStyle="#fff",i.fill()};i(e[0].querySelector("#drawLine2"),s,116),i(e[1].querySelector("#drawLine3"),s,116),i(e[2].querySelector("#drawLine4"),s,116)}(s,0,a)}if(2==o.length){c<=120&&(d=(c-o[0])/2,p=(c-o[1])/2),c>120&&c<=180&&(d=(c-o[0])/3,p=(c-o[1])/3),c>180&&(d=(c-o[0])/4,p=(c-o[1])/4);const e=348/a;r[0].style.display="block",r[0].style.width=`${e}px`,function(e,t,s,i,a){const n=u[h(i)];v(s[0].querySelector("#drawLine2"),e/a,t/a,a,348,n)}(d,p,s,i,a)}if(3==o.length){c<=120&&(d=(c-o[0])/2,p=(c-o[1])/2,m=(c-o[2])/2),c>120&&c<=180&&(d=(c-o[0])/3,p=(c-o[1])/3,m=(c-o[2])/3),c>180&&(d=(c-o[0])/4,p=(c-o[1])/4,m=(c-o[2])/4);const e=174/a;r[0].style.display="block",r[1].style.display="block",r[0].style.width=`${e}px`,r[1].style.width=`${e}px`,function(e,t,s,i,a,n){const r=u[h(a)];v(i[0].querySelector("#drawLine2"),e/n,t/n,n,174,r),v(i[1].querySelector("#drawLine3"),t/n,s/n,n,174,r)}(d,p,m,s,i,a)}if(4===o.length){const e=116/a;r.forEach((t=>{t.style.display="block",t.style.width=`${e}px`})),c<=120&&(d=(c-o[0])/2,p=(c-o[1])/2,m=(c-o[2])/2,y=(c-o[3])/2),c>120&&c<=180&&(d=(c-o[0])/3,p=(c-o[1])/3,m=(c-o[2])/3,y=(c-o[3])/3),c>180&&(d=(c-o[0])/4,p=(c-o[1])/4,m=(c-o[2])/4,y=(c-o[3])/4),function(e,t,s,i,a,n,r){const l=u[h(Number(n))];v(a[0].querySelector("#drawLine2"),e/r,t/r,r,116,l),v(a[1].querySelector("#drawLine3"),t/r,s/r,r,116,l),v(a[2].querySelector("#drawLine4"),s/r,i/r,r,116,l)}(d,p,m,y,s,i,a)}}async function b(){const e=document.querySelector(".color").children[0].textContent;if(e&&"КранГаличанин Р858ОР178"===e){document.querySelector(".contKran").style.display="flex";const e=document.querySelector(".color").id,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/getSens",t),i=await s.json();console.log(i),function(e){const t=e.find((e=>"lift"===e.params));if(t&&t.value){const e=t.value;e&&e&&e!==w[w.length-1]&&(w.push(e),S(w[w.length-1],w[w.length-2],!0)),e||S(null,null,!1)}}(i)}}document.querySelectorAll(".log")[1].textContent;const w=[];function S(e,t,s){const i=document.querySelector(".argRed"),a=document.querySelector(".argGreen");t&&(i.textContent=t+"°"),e&&(a.textContent=e+"°");const n=document.getElementById("krans").getContext("2d");n.width=180,n.heigth=180,length=150;const r=e*Math.PI/180,l=t*Math.PI/180;!1===s?(n.clearRect(0,0,n.canvas.width,n.canvas.height),n.beginPath(),n.setLineDash([5,0]),n.lineWidth=5,n.strokeStyle="black",n.moveTo(0,180),n.lineTo(150,180),n.stroke()):(n.clearRect(0,0,n.canvas.width,n.canvas.height),n.beginPath(),n.setLineDash([5,0]),n.lineWidth=5,n.strokeStyle="green",n.moveTo(0,180),n.lineTo(0+Math.cos(r)*length,180-(0+Math.sin(r)*length)),n.stroke(),n.beginPath(),n.lineWidth=5,n.strokeStyle="red",n.setLineDash([5,3]),n.moveTo(0,180),n.lineTo(0+Math.cos(l)*length,180-(0+Math.sin(l)*length)),n.stroke())}let _,k,C;class E{constructor(e){this.id=e,this.markerCreator=null,this.tool=null,this.track=null,this.eventMarkers=null,this.poly=null,this.startTrack=null,this.imei=null,this.time=null,this.trackMarkers={},this.pref=document.querySelector(".color").classList.contains("wialon")?"wialon":"kursor",this.setTrack=document.querySelector(".togTrack"),this.calendar=document.querySelector(".calendar_track"),this.button=this.calendar.querySelectorAll(".btm_formStart"),this.boundClear=this.clear.bind(this),this.boundOk=this.ok.bind(this),this.boundToggleCalendar=this.toggleCalendar.bind(this),this.init(),this.initEventListeners()}reinitialize(e){this.removeEventListeners(),this.id=e,this.init(),this.initEventListeners()}initEventListeners(){this.button[0].addEventListener("click",this.boundClear),this.button[1].addEventListener("click",this.boundOk),this.setTrack.addEventListener("click",this.boundToggleCalendar)}removeEventListeners(){this.button[0].removeEventListener("click",this.boundClear),this.button[1].removeEventListener("click",this.boundOk),this.setTrack.removeEventListener("click",this.boundToggleCalendar)}times(e){return`${e.getDate()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}async toggleCalendar(e){const t=e.target;if(console.log(t),t.classList.toggle("activeTrack"),t.classList.contains("activeTrack")){this.calendar.style.display="flex";const e=new p;this.time=await e.getTimeInterval(this.calendar)}else this.calendar.style.display="none",Object.values(this.trackMarkers).forEach((e=>{_.removeLayer(e.marker),e.marker.closeTooltip()})),_.removeLayer(this.poly),this.startTrack&&_.removeLayer(this.startTrack),this.markerCreator.deleteMarkers()}ok(){this.time?(this.calendar.style.display="none",this.calendar.children[0].children[0].value="",this.viewTrackAndMarkersEnent()):this.calendar.children[0].children[0].value="выберите дату"}clear(){this.calendar.style.display="none",this.calendar.previousElementSibling.classList.remove("activeTrack"),this.calendar.children[0].children[0].value=""}async viewTrackAndMarkersEnent(){this.track=await this.getIntervalTrack();const e=this.track.map((e=>e.geo)),t=await this.getEventProstoy();this.eventMarkers=await this.getEventObject(e,t),console.log(this.eventMarkers),this.eventMarkers&&this.markerCreator.createMarker(this.eventMarkers,this.track),console.log(this.poly),this.poly&&(_.removeLayer(this.poly),this.startTrack&&_.removeLayer(this.startTrack)),this.poly=L.polyline(e,{color:"rgb(0, 0, 204)",weight:2}).addTo(_),this.track.forEach(((e,t)=>{if(L.icon({iconUrl:"../../image/starttrack.png",iconSize:[10,10],iconAnchor:[10,10],popupAnchor:[0,0],className:"custom-marker"}),t%20==0){const s=this.times(new Date(1e3*Number(e.time))),i=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrowStart" style="pointer-events: none;transform: rotate(${e.course}deg);"><img src="../../image/arr.png" style="width: 15px; height:15px"></div>`});let a,n;e.course>=315||e.course<45?(a="right",n=[15,0]):e.course>=45&&e.course<135?(a="bottom",n=[0,15]):e.course>=135&&e.course<225?(a="left",n=[-15,0]):e.course>=225&&e.course<315&&(a="top",n=[0,-15]);const r=L.marker(e.geo,{icon:i}).addTo(_);r.bindTooltip(`${s}<br>${e.speed} км/ч`,{permanent:!0,direction:a,offset:n,className:"custom-tooltip"}),r.setOpacity(0),this.trackMarkers[t]={marker:r,tooltipText:`${s}<br>${e.speed} км/ч`}}})),this.zoomToggleView()}zoomToggleView(){_.getZoom()>=12?Object.values(this.trackMarkers).forEach((e=>{e.marker.setOpacity(1),e.marker.openTooltip()})):Object.values(this.trackMarkers).forEach((e=>{e.marker.setOpacity(0),e.marker.closeTooltip()}));let e=this;_.on("zoomend",(function(){_.getZoom()>=12?(e.trackMarkers&&Object.values(e.trackMarkers).forEach((e=>{e.marker.setOpacity(1),e.marker.openTooltip()})),console.log(e.trackMarkers)):e.trackMarkers&&Object.values(e.trackMarkers).forEach((e=>{e.marker.setOpacity(0),e.marker.closeTooltip()}))}))}hiddenTrackAndMarkersEnent(){Object.values(this.trackMarkers).forEach((e=>{_.removeLayer(e.marker)})),this.setTrack.classList.remove("activeTrack"),this.poly&&_.removeLayer(this.poly),this.startTrack&&_.removeLayer(this.startTrack),this.markerCreator&&this.markerCreator.deleteMarkers()}async init(){this.time=null,this.updateInterval=setInterval((()=>{this.update()}),11e4),this.update()}async update(){const e=await this.lastGeo();this.createMapMainObject(e),this.markerCreator||(this.markerCreator=new x(_))}async lastGeo(){const e=document.querySelector(".color").id,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/getSens",t),i=await s.json(),a=i.find((e=>"lat"===e.params)),n=i.find((e=>"lon"===e.params));return a&&n?[Number(a.value),Number(n.value)]:[]}async getStartTrack(e){if(this.startTrack){this.startTrack.setLatLng(e.geo).update();const t=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrowStart" style="pointer-events: none;transform: rotate(${e.course}deg);"><img src="../../image/starttrack.png" style="width: 15px; height:15px"></div>`});this.startTrack.setIcon(t)}else{const t=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrowStart" style="pointer-events: none;transform: rotate(${e.course}deg);"><img src="../../image/starttrack.png" style="width: 15px; height:15px"></div>`});this.startTrack=L.marker(e.geo,{icon:t})}}async getEventProstoy(){const e=this.id;let t=Math.round((new Date).getTime()/1e3),s=new Date,i=Math.round(s.setHours(s.getHours()-10)/1e3);console.log(t,i,e);const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nowDate:t,timeFrom:i,idw:e})},n=await fetch("/api/logsViewId",a);return(await n.json()).reduce(((e,t)=>{const s=JSON.parse(t.content);return"Простой"===s[0].event&&e.push({geo:JSON.parse(t.geo),prostoy:s[0].alarm,time:t.time}),e}),[])}createTrackMap(e){poly&&_.removeLayer(poly),poly=L.polyline(e,{color:"rgb(0, 0, 204)",weight:2})}async getIntervalTrack(){const e=document.querySelector(".color").id;let t=Math.round((new Date).getTime()/1e3),s=new Date,i=Math.round(s.setHours(s.getHours()-1)/1e3);const a=this.time?this.time[0]:i,n=this.time?this.time[1]===this.time[0]?this.time[1]+86399:this.time[1]:t;let r;console.log(a,n);const l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e,t1:a,t2:n})};console.log("тутада???");const o=await fetch("/api/geoLastInterval",l);return r=(await o.json()).resTrack.reduce(((e,t)=>(e.push({geo:[t[0],t[1]],speed:t[3],time:t[4],sats:t[5],course:t[2]}),e)),[]),console.log(r),r.sort(((e,t)=>Number(e.time)-Number(t.time))),r}async getEventPressure(){const e=this.id;let t=Math.round((new Date).getTime()/1e3),s=new Date,i=Math.round(s.setHours(s.getHours()-10)/1e3);const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nowDate:t,timeFrom:i,idw:e})},n=await fetch("/api/alarmViewId",a),r=await n.json(),l={};for(const e of r){const{senspressure:t,...s}=e;l[t]?l[t].push({senspressure:t,...s}):l[t]=[{senspressure:t,...s}]}const o=Object.values(l),c=[];o.forEach((e=>{let t=0;for(;t<e.length;)if("Норма"===e[t].alarm){const s=t+1;e[s]?(c.push(e[s]),t=s+1):("Норма"!==e[0].alarm&&c.push(e[0]),t=s)}else t++;let s=!1;e.forEach((e=>{Object.values(e).includes("Норма")&&(s=!0)})),s||c.push(e[0])}))}async getEventObject(e,t){const s=this.id;let i,a=Math.round((new Date).getTime()/1e3),n=new Date,r=Math.round(n.setHours(n.getHours()-10)/1e3);if("kursor"!==this.pref){console.log(s,a,r);const e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s,nowDate:a,timeFrom:r})},t=await fetch("api/getEventMarkers",e),n=await t.json();console.log(s,n),n.lls&&0!==Object.keys(n.lls).length&&(i=Object.values(Object.values(n.lls)[0]).reduce(((e,t)=>(e.push({geo:[t.from.y,t.from.x],[parseFloat(t.filled.toFixed(0))>0?"oil":"nooil"]:parseFloat(t.filled.toFixed(0)),time:t.from.t}),e)),[]))}const l=e.filter((e=>e.speed>100&&e.speed<140)),o=void 0!==i?i.filter((e=>e.oil)):[],c=void 0!==i?i.filter((e=>e.nooil)):[],d=[];return d.push(...l,...o,...c,...t),d}createMapMainObject(e){const t=[e[0],e[1]];if(_){var s=_.getZoom();_.setView(t,s)}else{const e=document.querySelector(".wrapper_up"),s=document.createElement("div");s.setAttribute("id","map"),s.style.width="100%",s.style.height="450px",e.appendChild(s),_=L.map("map"),_.attributionControl.setPrefix(!1),document.querySelector(".leaflet-control-attribution").style.display="none";const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'}).addTo(_);L.control.scale({imperial:""}).addTo(_),_.addLayer(i),_.setView(t,8),_.flyTo(t,8)}const i=document.querySelector(".color").children[0].textContent,a=`${e[0]}, ${e[1]}`;if(this.tool=new g(this.setTrack,[this.setTrack.getAttribute("rel")]),this.tool||new g(this.setTrack,[this.setTrack.getAttribute("rel")]),k){console.log("здесь?"),k.setLatLng(t).bindPopup(`${i}<br>${a}`).update(),C.setLatLng(t).update();const s=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrow" style="pointer-events: none;height: 75px;transform: rotate(${e[2]}deg);"><img src="../../image/arrow2.png" style="width: 20px"></div>`});C.setIcon(s)}else{const s=new(L.Icon.extend({options:{iconSize:[30,30],iconAnchor:[10,18],popupAnchor:[0,0]}}))({iconUrl:"../../image/trailer.png",iconSize:[30,22],iconAnchor:[20,20],popupAnchor:[0,0],className:"custom-marker"}),n=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrow" style="pointer-events: none;height: 75px;transform: rotate(${e[2]}deg);"><img src="../../image/arrow2.png" style="width: 20px"></div>`});k=L.marker(t,{icon:s}).bindPopup(`${i}<br>${a}`).addTo(_),C=L.marker(t,{icon:n}).addTo(_),k.getPopup().options.className="my-popup-all",k.on("mouseover",(function(e){this.openPopup()})),k.on("mouseout",(function(e){this.closePopup()}))}}}class x{constructor(e){this.map=e,this.iconUrls={speed:"../../image/upspeed.png",oil:"../../image/oil1.png",nooil:"../../image/refuel.png",prostoy:"../../image/pr.png"},this.markers=[]}deleteMarkers(){for(let e of this.markers)this.map.removeLayer(e);this.markers=[]}contentPopup(e){return{speed:`Скорость: ${e.speed} км/ч`,oil:`Заправка: ${e.oil} л`,nooil:`Слив: ${e.nooil} л`,prostoy:`Простой: ${e.prostoy}`}}createMarker(e,t){this.deleteMarkers(),e.forEach((e=>{const t=Object.keys(e)[1],s=this.iconUrls[t],i=L.icon({iconUrl:s,iconSize:[20,20],iconAnchor:[20,20],popupAnchor:[0,0],className:"custom-marker"}),a=this.contentPopup(e)[t],n=this.times(new Date(1e3*Number(e.time))),r=L.marker(e.geo,{icon:i}).bindPopup(`${a}<br>Время: ${n}`).addTo(this.map);r.on("mouseover",(function(e){this.openPopup()})),r.on("mouseout",(function(e){this.closePopup()})),this.markers.push(r)}))}}console.log("дроп");class T{constructor(e){this.elem=e,this.isDragging=!1,this.initialX=0,this.initialY=0,this.xOffset=0,this.yOffset=0,this.dragStart=this.dragStart.bind(this),this.dragEnd=this.dragEnd.bind(this),this.drag=this.drag.bind(this),this.elem.addEventListener("mousedown",this.dragStart),window.addEventListener("mouseup",this.dragEnd),window.addEventListener("mousemove",this.drag)}dragStart(e){0===e.button&&(this.initialX=e.clientX-this.xOffset,this.initialY=e.clientY-this.yOffset,e.target===this.elem&&(this.isDragging=!0))}dragEnd(e){this.initialX=this.currentX,this.initialY=this.currentY,this.elem.style.opacity=1,this.isDragging=!1}drag(e){this.isDragging&&(e.preventDefault(),this.currentX=e.clientX-this.initialX,this.currentY=e.clientY-this.initialY,this.xOffset=this.currentX,this.yOffset=this.currentY,this.elem.style.transform=`translate3d(${this.currentX}px, ${this.currentY}px, 0)`,this.elem.style.opacity=.8)}destroy(){this.elem.removeEventListener("mousedown",this.dragStart),window.removeEventListener("mouseup",this.dragEnd),window.removeEventListener("mousemove",this.drag)}}class q{constructor(e,t,s){this.geoTrack=e,this.geo=t,this.koordinates=null,this.num=s,this.map=null,this.iss=null,this.mapElement=null,this.nameCar=null,this.event=null,this.initializeMap()}async initializeMap(){this.clearExistingMap();const e=this.createMapContainer();this.map=this.createMap("mapOil"),L.polyline(this.geoTrack,{color:"darkred",weight:2}).addTo(this.map);let t={iconUrl:"oil?"!==this.num?"../../image/trailer.png":"../../image/ref.png",iconSize:[30,22],iconAnchor:[0,-10],popupAnchor:[20,24],className:"custom-marker-alarm"},s=new L.Icon(t);switch(this.num){case"bar":this.koordinates=[this.geo.geo[0],this.geo.geo[1]],this.map.setView([this.koordinates[0],this.koordinates[1]],12),await this.handleBarCase(s,e);break;case"alarm":this.koordinates=[this.geo.geoY,this.geo.geoX],this.map.setView([this.koordinates[0],this.koordinates[1]],12),this.handleAlarmCase(s,e);break;case"oil":this.koordinates=[this.geo.geo[0],this.geo.geo[1]],this.map.setView([this.koordinates[0],this.koordinates[1]],12),this.handleOilCase(s,e);break;case"stat":this.koordinates=[this.geo.geo[0],this.geo.geo[1]],this.map.setView([this.koordinates[0],this.koordinates[1]],12),this.handleStatCase(s,e);break;case"log":this.koordinates=[this.geo[0].geo[0],this.geo[0].geo[1]],this.map.setView([this.koordinates[0],this.koordinates[1]],12),this.handleLogCase(s,e)}this.addMapControls()}clearExistingMap(){const e=document.querySelector(".wrapMap");e&&e.remove()}createMapContainer(){this.nameCar=document.querySelector(".color")?document.querySelector(".color").children[0].textContent:null;const e="log"!==this.num?document.querySelector(".main"):document.querySelector(".wrapperFull"),t=document.createElement("div");return t.classList.add("wrapMap"),this.mapElement=document.createElement("div"),this.mapElement.classList.add("mapsOilCard"),this.mapElement.setAttribute("id","mapOil"),t.appendChild(this.mapElement),t.style.zIndex="2099",e.appendChild(t),t}createMap(e){return L.map(e)}async handleBarCase(e,t){const s=[this.koordinates[0],this.koordinates[1]],i=new Date(this.geo.dates),a=`${i.getDate()}/${(i.getMonth()+1).toString().padStart(2,"0")}/${i.getFullYear()} ${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`;this.mapElement.style.width="300px",this.mapElement.style.height="300px",t.style.height="320px",t.style.position="absolute",t.style.left="25px",t.style.top="500px",t.style.width="300px",new T(t),this.iss=L.marker(s,{icon:e}).addTo(this.map);const n=`Объект: ${this.nameCar}<br>Время: ${a}<br>Скорость: ${this.geo.speed} км/ч<br>Зажигание: ${this.geo.stop}`,r=L.popup({className:"my-popup-bar",autoPan:!1});this.iss.bindPopup(r).addTo(this.map),r.setContent(n),this.map.setView(s,12),this.map.flyTo(s,12)}handleAlarmCase(e,t){const s=[this.koordinates[0],this.koordinates[1]];this.mapElement.style.width="350px",this.mapElement.style.height="350px",t.style.height="370px",t.style.position="absolute",t.style.left="580px",t.style.top="40px",new T(t),this.event="my-popup-alarm",this.iss=L.marker(s,{icon:e}).bindPopup(`Объект: ${this.geo.info.car}\nВремя: ${this.geo.info.time}\nКолесо: ${this.geo.info.tyres}\nP,bar: ${this.geo.info.bar}\nt,C: ${this.geo.info.temp}\nСкорость: ${this.geo.speed} км/ч\nУведомление: ${this.geo.info.alarm}\nАдрес: ${this.geo.geoY,this.geo.geoX}`,{width:60,className:"my-popup-alarm",autoPan:!1}).addTo(this.map)}handleOilCase(e,t){const s=[this.koordinates[0],this.koordinates[1]];this.mapElement.style.width="300px",this.mapElement.style.height="300px",t.style.height="320px",t.style.width="300px",t.style.position="absolute",t.style.left="25px",t.style.top="500px",new T(t),this.event="my-popup-oil",this.iss=L.marker(s,{icon:e}).bindPopup(`Объект: ${this.nameCar}<br>Заправлено: ${this.geo.zapravka} л.<br>Дата: ${this.geo.time}<br>Адрес: ${this.geo.geo[0],this.geo.geo[1]}`,{className:"my-popup-oil"}).addTo(this.map)}handleStatCase(e,t){const i=s(this.geo.time),a=[this.koordinates[0],this.koordinates[1]];this.mapElement.style.width="350px",this.mapElement.style.height="350px",t.style.position="absolute",t.style.left="580px",t.style.top="40px",t.style.height="370px",new T(t),this.event="my-popup-stat",this.iss=L.marker(a,{icon:e}).bindPopup(`Объект: ${this.nameCar}<br>Время: ${i}<br>Состояние: ${this.geo.condition}<br>Скорость: ${this.geo.speed} км/ч<br>Местоположение: ${this.geo.geo[0],this.geo.geo[1]}`,{width:60,className:"my-popup-stat",autoPan:!1}).addTo(this.map)}handleLogCase(e,t){const s=this.geo[0].logs[0],i=[this.koordinates[0],this.koordinates[1]];this.mapElement.style.width="350px",this.mapElement.style.height="350px",t.style.position="absolute",t.style.left="580px",t.style.top="40px",t.style.height="370px",new T(t),this.event="my-popup-log",this.iss=L.marker(i,{icon:e}).bindPopup(`Время: ${s}<br>Объект: ${this.geo[0].logs[1]}<br>Время события: ${this.geo[0].logs[2]}`,{width:60,className:"my-popup-log",autoPan:!1}).addTo(this.map)}addMapControls(){this.iss.on("mouseover",(function(e){this.openPopup()})),this.iss.on("mouseout",(function(e){this.closePopup()})),setTimeout((()=>{this.map.invalidateSize()}),0),document.querySelector(".leaflet-control-attribution").style.display="none",L.control.scale({imperial:!1}).addTo(this.map),this.map.attributionControl.setPrefix(!1);const e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this.map);this.map.addLayer(e),this.map.on("zoomend",(()=>{this.map.panTo([this.koordinates[0],this.koordinates[1]])}))}}let A,O=!1;async function j(e){if(e&&(A=e),console.log(A),console.log("алармфайнд"),O)return;O=!0;const t=document.querySelectorAll(".tr");t&&t.forEach((e=>{e.remove()}));const[,s]=A;console.log(s);const a=document.querySelector(".color").id;if(0!==s.length){const e=i(s).reduce(((e,t)=>(e.push(t.pressure),e)),[]),t=await fetch("/api/alarmFind",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:a,sorTyrest:e})});N(a,await t.json(),A)}O=!1}const M=e=>{const t={};return e.forEach((e=>{const{senspressure:s}=e;t[s]?t[s].push(e):t[s]=[e]})),Object.values(t)};async function N(e,t,s){const i=M(t).map((e=>function(e){const t=[],s=[];return e.forEach(((i,a)=>{const n=JSON.stringify(i);if(!s.includes(a)){t.push(i);for(let t=a+1;t<e.length;t++)n===JSON.stringify(e[t])&&s.push(t)}})),t}(e))),a=document.querySelector(".tbody");a.innerHTML=o;const n=document.querySelector(".oneName"),r=document.createElement("div");r.classList.add("infosAlarm"),n.children[0].prepend(r);const l=document.querySelector(".infosAlarm");new g(l,["Лента уведомлений отражает зафиксированные отклонения от заданных параметров по давлению и температуре","Если внутри зафиксированного отклонения есть дополнительные изменения, то они подгружаются по нажатию стрелки вниз напротив уведомления","Если нажать красный маркер карты, то на карте отразится место события с переданными туда данными"]);const[,,c]=s;i.forEach((t=>{t.forEach((s=>{const i=c.find((e=>e.params===s.senspressure));if(!i)return;s.senspressure=i.sens;const n=document.createElement("div");n.classList.add("tr"),n.classList.add("trnone"),n.setAttribute("rel",`${e}`),a.appendChild(n);const r=t.indexOf(s)+1;n.classList.toggle("views",1==r),n.classList.toggle("norma","Норма"==s.alarm),Object.values(s).forEach((e=>{const t=document.createElement("p");t.classList.add("td"),t.textContent=e,n.appendChild(t)}))}));const s=document.querySelectorAll(".tr");s.forEach(((e,t)=>{const i=s[t+1];"Норма"==e.children[4].textContent&&i&&i.classList.add("views"),i&&e.classList.contains("views")&&!i.classList.contains("views")&&!i.classList.contains("norma")&&e.classList.add("best")}))}));const d=document.querySelectorAll(".tr");if(1===d.length)return;d.forEach((e=>{const t=document.createElement("p");if(t.classList.add("td"),e.appendChild(t),t.style.width="120px",null!==e.nextSibling&&!e.classList.contains("norma")&&e.children[1].textContent!==e.nextSibling.children[1].textContent&&!e.classList.contains("oneName")||!e.classList.contains("norma")&&!e.nextSibling){if(e.previousSibling.children[1].textContent!==e.children[1].textContent||e.previousSibling.classList.contains("norma")){e.classList.add("alarmOpen");const n=document.createElement("div");n.classList.add("alarmFire"),e.appendChild(n),n.innerHTML="&#128293",e.style.position="relative",n.style.position="absolute",n.style.right="4px",n.style.top=0,n.style.fontSize="10px"}const s=a(e);let i=0;function a(e){const t=[];let s=e.parentNode.firstElementChild;for(;s!==e;)t.push(s),s=s.nextElementSibling;return t}s.reverse().forEach((t=>{if(t.children[1].textContent===e.children[1].textContent&&t.classList.contains("best")&&!t.classList.contains("norma")&&(i++,1==i)){t.classList.add("alarmOpen");const e=document.createElement("div");e.classList.add("alarmFire"),t.appendChild(e),e.innerHTML="&#128293",t.style.position="relative",e.style.position="absolute",e.style.right="4px",e.style.top=0,e.style.fontSize="10px"}}))}})),d[0]&&d[0].children[5]&&(d[0].children[5].textContent="Время аларма",document.querySelectorAll(".best").forEach((e=>{const t=document.createElement("div");t.classList.add("wrapItem"),e.appendChild(t);const s=document.createElement("div");s.classList.add("itemIn");const i=document.createElement("div");i.classList.add("itemOut"),t.appendChild(s),t.appendChild(i),e.style.position="relative",s.style.position="absolute",s.style.left="2px",s.style.top="5px",i.style.position="absolute",i.style.left="2px",i.style.top="5px";const a=document.createElement("div");a.classList.add("wrapSpoyler"),e.appendChild(a);const n=function(e){var t=!1;return[].filter.call(e.parentNode.children,(function(s){return s===e&&(t=!0),t&&s!==e}))}(e);let r=0;n.forEach((t=>{!1!==t.classList.contains("norma")&&r++,0==t.classList.contains("norma")&&t.children[1].textContent==e.children[1].textContent&&r<1&&(t.classList.add("spoyler"),a.appendChild(t))})),e.addEventListener("click",(()=>{if(e.classList.contains("activeListtt"))return s.style.display="flex",i.style.display="none",e.classList.remove("activeListtt"),void(e.querySelector(".wrapSpoyler").style.display="none");e.classList.add("activeListtt"),s.style.display="none",i.style.display="flex",e.querySelector(".wrapSpoyler").style.display="flex",document.querySelectorAll(".spoyler").forEach((e=>{Array.from(e.children).forEach((e=>{e.style.fontSize="11px",e.style.fontWeight="normal",e.style.color="#000"}))}))}))}))),d.forEach((e=>{if(null!==e.nextSibling&&!e.classList.contains("alarmOpen")&&!e.classList.contains("oneName")&&!e.classList.contains("spoyler"))if(e.nextSibling.classList.contains("norma")&&e.nextSibling.children[1].textContent==e.children[1].textContent){const t=[...e.nextSibling.children[0].textContent],s=[];s.push(t[6],t[7],t[8],t[9],"-",t[3],t[4],"-",t[0],t[1],"T",t[11],t[12],t[13],t[14],t[15],":","0","0","Z");const i=Date.parse(s.join("")),a=[...e.children[0].textContent],n=[];n.push(a[6],a[7],a[8],a[9],"-",a[3],a[4],"-",a[0],a[1],"T",a[11],a[12],a[13],a[14],a[15],":","0","0","Z");const r=i-Date.parse(n.join("")),l=Math.floor(r/6e4%60),o=Math.floor(r/36e5%24),c=Math.floor(r/864e5%24),d=(c<1?""+c:c)+"d "+(o<10?""+o:o)+"h "+ +(l<10?""+l:l)+"m";e.children[5].textContent=d}else if(e.classList.contains("best")&&e.nextSibling.classList.contains("norma")&&e.nextSibling.children[1].textContent==e.children[1].textContent){const t=[...e.nextSibling.children[0].textContent],s=[];s.push(t[6],t[7],t[8],t[9],"-",t[3],t[4],"-",t[0],t[1],"T",t[11],t[12],t[13],t[14],t[15],":","0","0","Z");const i=Date.parse(s.join("")),a=[...e.lastElementChild.lastElementChild.childre[0].textContent],n=[];n.push(a[6],a[7],a[8],a[9],"-",a[3],a[4],"-",a[0],a[1],"T",a[11],a[12],a[13],a[14],a[15],":","0","0","Z");const r=i-Date.parse(n.join("")),l=Math.floor(r/6e4%60),o=Math.floor(r/36e5%24),c=Math.floor(r/864e5%24),d=(c<1?""+c:c)+"d "+(o<10?""+o:o)+"h "+ +(l<10?""+l:l)+"m";e.children[5].textContent=d}})),a.querySelectorAll(`[rel="${e}"]`).forEach((e=>{e.children[3].textContent<=-50||e.children[3].textContent>70?e.children[3].style.background="yellow":e.children[2].style.background="yellow"}));const h=document.querySelectorAll(".views"),u=document.querySelectorAll(".spoyler");function p(e){const t=[...e],s=[];return s.push(t[6],t[7],t[8],t[9],"-",t[3],t[4],"-",t[0],t[1],"T",t[11],t[12],t[13],t[14],t[15],":","0","0","Z"),Date.parse(s.join(""))}const m=[];h.forEach((e=>{e.style.position="relative";const t=document.createElement("div");t.classList.add("mapIcon"),e.appendChild(t),m.push(e)})),u.forEach((e=>{e.style.position="relative";const t=document.createElement("div");t.classList.add("mapIcon"),e.appendChild(t)})),m.sort((function(e,t){return parseFloat(p(t.children[0].textContent))-parseFloat(p(e.children[0].textContent))})),m.forEach((e=>{a.appendChild(e)})),document.querySelectorAll(".mapIcon").forEach((t=>{t.addEventListener("click",(()=>{const s=t.parentElement.children[0].textContent,i=t.parentElement;!async function(e,t,s){const i=e.match(/(\d+)/g),a=new Date(i[2],i[1]-1,i[0],i[3],i[4]),n=Math.floor(a.getTime()/1e3),r=n,l=n-3600;console.log(t,l,r);const o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:t,t1:l,t2:r})},c=await fetch("/api/getDataParamsInterval",o),d=await c.json();console.log(d);const h=d.map((e=>({id:e.idw,time:new Date(1e3*Number(e.last_valid_time)),speed:Number(e.speed),geo:[Number(e.lat),Number(e.lon)],oil:Number(e.oil),pwr:Number(e.pwr),engine:Number(e.engine),mileage:Number(e.mileage),curse:Number(e.course),sats:Number(e.sats),engineOn:Number(e.engineOn),summatorOil:e.summatorOil?Number(e.summatorOil):null})));h.sort(((e,t)=>e.time-t.time));const u=h.map((e=>e.geo));console.log(h);const p={car:document.querySelector(".color").children[0].textContent,time:s.children[0].textContent,tyres:s.children[1].textContent,bar:s.children[2].textContent,temp:s.children[3].textContent,alarm:s.children[4].textContent},m={geoX:h[h.length-1].geo[1],geoY:h[h.length-1].geo[0],info:p,speed:h[h.length-1].speed};new q(u,m,"alarm")}(s,e,i)}))}))}class I{constructor(e){this.elem=e,this.card=document.querySelectorAll(".icon_card"),this.msg=null,this.nameObject=null,this.changeParams=document.querySelector(".changeParams"),this.valueparamsObject={},this.id=null,this.targetElement=null,this.targetCard=null,this.intervalId=null,this.params=null,this.coefficient=null,this.handleCardClick=this.toogleModalWindow.bind(this),this.initEventListeners()}reinitialize(e){this.clearInterval(),this.removeEventListeners(),this.elem=e,this.intervalId=null,this.initEventListeners()}initEventListeners(){this.listeModalWindow(this.elem),this.card.forEach((e=>e.addEventListener("click",this.handleCardClick)))}removeEventListeners(){this.card.forEach((e=>e.removeEventListener("click",this.handleCardClick)))}clearInterval(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}async listeModalWindow(e){console.log(e),this.targetElement=e,this.id=e.id,this.nameObject=e.children[0].textContent.replace(/\s+/g,""),await this.displayIconValues(this.id),this.clearInterval(),this.intervalId=setInterval((()=>this.displayIconValues(this.id)),11e4)}async viewValueToSaveBase(e){e.style.color="green",e.style.fontWeight="bold";const t=[...e.textContent];let s;t.forEach((e=>{":"===e&&(s=t.splice(t[0]+1,t.indexOf(e)).join(""))}));const i=document.querySelector(".acto").id;await this.postIconParams(s,i)}toogleModalWindow(e){const t=e.currentTarget;this.targetCard=t;const s=document.querySelector(".sensors"),i=document.querySelectorAll(".btnsens"),a=document.querySelector(".wrapper_right"),n=document.querySelector(".tiresActiv");if(n&&n.classList.remove("tiresActiv"),this.targetCard.classList.contains("acto")){this.targetCard.classList.remove("acto"),s.style.display="none",i[2].style.display="none";const e=document.querySelector(".actBTN");return e&&e.classList.remove("actBTN"),a.style.zIndex=0,void(document.querySelector(".popup-background").style.display="none")}this.card.forEach((e=>{e.classList.remove("acto")})),document.getElementById("check_Title").checked?(this.targetCard.classList.add("acto"),s.style.display="flex",new T(s),a.style.zIndex=2,document.querySelector(".popup-background").style.display="block",this.msg=document.querySelectorAll(".msg"),this.msg.forEach((e=>e.addEventListener("click",this.viewValueToSaveBase.bind(this,e))))):s.style.display="none",i[0].style.display="none",i[1].style.display="none",i[2].style.display="flex",this.close(s,a)}close(e,t){const s=document.querySelector(".closeIconConfig");console.log(s),s.addEventListener("click",(()=>{const s=document.querySelector(".tiresActivt");s&&s.classList.remove("tiresActivt");const i=document.querySelector(".tiresActiv");i&&i.classList.remove("tiresActiv");const a=document.querySelector(".acto");a&&a.classList.remove("acto"),document.querySelector(".actBTN")&&document.querySelector(".actBTN").classList.remove("actBTN"),e.style.display="none",t.style.zIndex=0,document.querySelector(".popup-background").style.display="none"}))}async postIconParams(e,t){const s=this.nameObject,i=this.id;console.log(s,e,t,i);const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({activePost:s,param:e,id:t,idw:i})},n=await fetch("/api/icon",a),r=await n.json();console.log(r),this.displayIconValues(i)}async displayIconValues(e){this.abortController&&this.abortController.abort(),this.abortController=new AbortController;const t=this.abortController.signal,s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e}),signal:t},i=await this.iconFindParams(s),a=await this.iconFindParamsEdit(s);this.coefficient=await this.validationIngition(e),this.pushObjectProperty(i,a),await this.statusTSI(s),this.status(i),this.viewValueElement()}async pushObjectProperty(e,t){this.card.forEach((e=>this.valueparamsObject[e.id]="---")),e.forEach((e=>{switch(e[1]){case"speed":this.valueparamsObject["speed-card"]=Number(Number(e[3]).toFixed(0));break;case"engine":this.valueparamsObject["ign-card"]=e[3]}})),t.result.forEach((t=>{e.forEach((e=>{e[1]===t.params&&(this.valueparamsObject[t.icons]=Number(e[3]))}))}));const s=this.valueparamsObject["ign-card"];this.valueparamsObject["ign-card"]>1?(this.getValue("engine"),this.valueparamsObject["ign-card"]=this.getValue("engine")?s>Number(this.getValue("engine"))?"ВКЛ":"ВЫКЛ":"-"):this.valueparamsObject["ign-card"]=1===s?"ВКЛ":"ВЫКЛ"}getValue(e){let t;const s=this.coefficient?this.coefficient.find((t=>t.params===e)):null;return s&&(t=s.value),t}async validationIngition(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:e})},s=await fetch("/api/getValuePWR",t);return await s.json()}async iconFindParams(e){let t;const s=await fetch("/api/getSens",e);return t=(await s.json()).map((e=>[e.sens,e.params,Number(e.idw),Number(e.value)])),t}async iconFindParamsEdit(e){const t=await fetch("/api/iconFind",e),s=await t.json();return this.params=s,s}async statusTSI(e){let t,s;this.getValue("pwr"),this.valueparamsObject["tsi-card"]=this.getValue("pwr")?Number(this.valueparamsObject["akb-card"])>Number(this.getValue("pwr"))&&"ВКЛ"===this.valueparamsObject["ign-card"]?"ВКЛ":"ВЫКЛ":"-",console.log(this.valueparamsObject["tsi-card"]),console.log(this.id),t="ВКЛ"===this.valueparamsObject["tsi-card"]?"Включен":"-"===this.valueparamsObject["tsi-card"]?"-":"Выключен",s="ВКЛ"===this.valueparamsObject["ign-card"]?"Включено":"Выключено";const i="-"===this.valueparamsObject["tsi-card"]?null:`${t}`,a=`${s}`,n=document.querySelector(".tsi_card"),r=document.querySelector(".ign_card");new g(n,[n.getAttribute("rel"),i]),new g(r,[r.getAttribute("rel"),a])}async status(e){if(console.log(e),0===e.lengh)return;const t=e.find((e=>"last_valid_time"===e[1])),s=Math.floor((new Date).getTime()/1e3)-Number(t[3])>3600?0:1;let i,a;e.forEach((e=>{"sats"===e[1]&&(i=Number(e[3]))}));const n=document.querySelector(".status_obj"),r=this.valueparamsObject["tsi-card"];0===s?(n.textContent="Offline",n.style.color="gray"):i<=4||"ВЫКЛ"===r?(i<=4&&"ВКЛ"===r?a="Не установлена связь со спутниками":i>4&&"ВЫКЛ"===r?a="Двигатель выключен":i<=4&&"ВЫКЛ"===r&&(a="Двигатель выключен, Не установлена связь со спутниками"),n.textContent="Offline",n.style.color="gray",new g(n,[a])):i>3&&"ВКЛ"===r&&(n.textContent="Online",n.style.color="#15a32d",a=`Установлена связь с ${i} спутниками`,new g(n,[a]))}viewValueElement(){const e=document.querySelector(".role").getAttribute("rel");console.log(this.valueparamsObject),this.card.forEach((t=>{this.params.result.forEach((s=>{s.icons===t.id&&new g(t,"Администратор"===e?[t.getAttribute("rel"),s.params]:[t.getAttribute("rel")])}));const s=-348201.3876===this.valueparamsObject[t.id]?"---":this.valueparamsObject[t.id];switch(t.id){case"odom-card":t.children[0].textContent="---"!==s?this.addZero(8,s.toFixed(0)):"---";break;case"tsi-card":case"ign-card":t.children[0].textContent=s;break;case"moto-card":console.log(s),t.children[0].textContent="---"!==s?s.toFixed(1):"---";break;case"akb-card":t.children[0].textContent="---"!==s?s.toFixed(1):"---";break;case"oil-card":t.children[0].textContent="---"!==s?s.toFixed(0):"---";break;default:t.children[0].textContent="---"!==s?s:"---"}}))}addZero(e,t){let s=t+"";for(;s.length<e;)s="0"+s;return s}}class ${constructor(e,t){this.id=e.id,this.info=t,this.structura=null,this.time=null,this.iconStata=document.querySelector(".icon_stata"),this.iconCheck=document.querySelector(".icon_check"),this.calendar=document.querySelector(".calendar_graf_stata"),this.spanDate=document.querySelector(".span_date"),this.button=this.calendar.querySelectorAll(".btm_formStart"),this.button[0].addEventListener("click",this.clear.bind(this)),this.button[1].addEventListener("click",this.ok.bind(this)),this.iconCheck.addEventListener("click",this.updateTexContent.bind(this)),this.clickIcon=this.toggleCalendar.bind(this),this.clickCheck=this.updateTexContent.bind(this),this.init(),this.initEventListeners()}async init(){this.time||this.installTime(),await this.getParamsToInterval(),console.log("тут");const e=this.calcilator();console.log(e),this.createTableContent(e),this.viewTime()}viewTime(){const e=this.time.map((e=>{const t=new Date(1e3*e);return`${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getFullYear()}`})),t=e[0]===e[1];console.log(e),this.spanDate.textContent=t?e[0]:`${e[0]} - ${e[1]}`}initEventListeners(){this.iconStata.addEventListener("click",this.clickIcon),this.iconCheck.removeEventListener("click",this.clickCheck)}removeEventListeners(){this.iconStata.removeEventListener("click",this.clickIcon),this.iconCheck.addEventListener("click",this.clickCheck)}reinitialize(e,t){this.removeEventListeners(),this.info=t,this.id=e.id,this.init(),this.initEventListeners()}async calendarOpen(){const e=`#${this.calendar.children[0].children[0]?this.calendar.children[0].children[0].id:this.calendar.children[0].id}`,t=new p;this.time=await t.getTimeInterval(this.calendar,e)}async toggleCalendar(e){console.log("запуск");const t=e.target;t.classList.toggle("clickUp"),console.log(t),t.classList.contains("clickUp")?(this.calendar.style.display="flex",await this.calendarOpen()):this.calendar.style.display="none"}ok(){console.log(this.time),this.calendar.style.display="none",console.log(this.clickIcon),this.iconStata.classList.remove("clickUp"),this.calendar.children[0].children[0].value="",this.init()}clear(){console.log("здесь"),this.calendar.style.display="none",this.iconStata.classList.remove("clickUp"),this.calendar.children[0].children[0].value=""}updateTexContent(){this.iconCheck.classList.toggle("check_probeg"),document.querySelectorAll(".celValue").forEach((e=>{this.iconCheck.classList.contains("check_probeg")?e.textContent=e.getAttribute("rel"):e.textContent=e.getAttribute("rel1")}))}createTableContent(e){console.log(e);const t=document.querySelector(".table_stata"),s=document.querySelectorAll(".row_stata");s&&[...s].forEach((e=>{e.remove()})),e.forEach((e=>{const s=document.createElement("tr");s.classList.add("row_stata"),t.appendChild(s);const i=document.createElement("td");i.classList.add("cel"),i.setAttribute("rel",e.params),i.textContent=e.sensor,s.appendChild(i);for(let t=0;t<Object.entries(e.intervals).length;t++){const i=document.createElement("td");i.classList.add("cel"),i.classList.add("celValue"),i.setAttribute("rel",Object.entries(e.intervals)[t][1].totalMileage),i.setAttribute("rel1",Object.entries(e.intervals)[t][1].totalTime),i.textContent=Object.entries(e.intervals)[t][1].totalTime,s.appendChild(i)}}))}calcilator(){return console.log(this.structura),this.structura.map((e=>({sensor:e.sens,intervals:this.processSensor(e,Number(e.bar.knd),Number(e.bar.kvd),Number(e.bar.dnn),Number(e.bar.dvn))}))).map((e=>{let t=0,s=0;return Object.keys(e.intervals).forEach((i=>{const n=e.intervals[i].reduce(((e,t)=>{const s=t.end-t.start,i=t.mileage;return{...e,totalTime:e.totalTime+s,mileageInterval:e.mileageInterval+i}}),{totalTime:0,mileageInterval:0});t+=n.totalTime,s+=n.mileageInterval,e.intervals[i]={totalTime:0!==n.totalTime?a(n.totalTime):"-",totalMileage:0!==n.mileageInterval?`${n.mileageInterval} км`:"-"}})),e.intervals.all={totalTime:0!==t?a(t):"-",totalMileage:0!==s?`${s} км`:"-"},e}))}processSensor(e,t,s,i,a){let n={potery:[],belowKnd:[],betweenKndDnn:[],betweenDnnDvn:[],betweenDvnKvd:[],aboveKvd:[]},r=null,l=null,o=null;return e.val.forEach(((c,d)=>{const h=new Date(c.dates).getTime()/1e3;let u=null;"ВКЛ"===c.stop&&c.speed>0?(-.1===c.value?u="potery":c.value>=0&&c.value<=t?u="belowKnd":c.value>t&&c.value<=i?u="betweenKndDnn":c.value>i&&c.value<a?u="betweenDnnDvn":c.value>=a&&c.value<s?u="betweenDvnKvd":c.value>=s&&(u="aboveKvd"),!u||u===r&&null!==l||(null!==l&&n[r].push({start:l,end:h,mileage:null!==o?c.mileage-o:0}),l=h,o=c.mileage,r=u)):null!==l&&(n[r].push({start:l,end:h,mileage:null!==o?c.mileage-o:0}),l=null,o=null,r=null),d===e.val.length-1&&null!==l&&n[r].push({start:l,end:h,mileage:null!==o?c.mileage-o:0})})),n}async getParamsToInterval(){const[,e,t,s]=this.info,i=this.time[0],a=this.time[1]+86399,n=this.id,r=["last_valid_time","speed","lat","lon","mileage","engineOn"];console.log(e),e.forEach((e=>{r.push(e.pressure,e.temp)}));const l={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:n,t1:i,t2:a,arrayColumns:r,num:0,workerKey:"pressureStatistiks"})},o=await fetch("/api/getPressureOil",l),c=await o.json(),d={};s.forEach((e=>{d[e.idOs]=e}));const h=e.map((e=>{if(d[e.osNumber]){const s=t.find((t=>Object.values(t).includes(e.pressure)));if(!s)return;return{sens:s.sens,position:Number(e.tyresdiv),parametr:e.pressure,bar:d[e.osNumber],val:c.map((t=>({dates:new Date(1e3*Number(t.last_valid_time)),geo:[Number(t.lat),Number(t.lon)],speed:Number(t.speed),mileage:parseInt(t.mileage),pwr:parseFloat(t.pwr),sats:parseInt(t.sats),engine:Number(t.engine),stop:1===Number(t.engineOn)?"ВКЛ":"ВЫКЛ",value:t[e.pressure]?Number(t[e.pressure]):-.1,tvalue:t[e.temp]&&-128!==Number(t[e.temp])&&-50!==Number(t[e.temp])&&-51!==Number(t[e.temp])?Number(t[e.temp]):-.1})))}}})).filter((e=>void 0!==e));h.sort(((e,t)=>e.position-t.position)),h.forEach((e=>e.val.sort(((e,t)=>e.dates>t.dates?1:e.dates<t.dates?-1:0)))),this.structura=h,console.log(this.structura)}installTime(){const e=new Date,t=Math.round(e.getTime()/1e3),s=Math.floor(new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0).getTime()/1e3);this.time=[s,t]}}function D(e,t,s){const i=s.querySelector(".chartJobTS");i.style.width="700px",i.style.alignItems="center",s.querySelector(".intervalTitle").style.fontSize="16px";const a=s.querySelector(`.chartStatic${t}`);a&&a.remove();const n=s.querySelector(".jobTSDetalisationLine");var r=document.querySelector("body").offsetWidth;n.style.width="",n.style.width=r/3,i.style.alignItems="center";const l=r<860?r-5:50*e.length;n.style.display="flex",n.style.justifyContent="center";var o=250,c=d3.select(`.${{1:"intervalChart"}[t]}`).append("svg").attr("class",`chartStatic${t}`).attr("width",l).attr("height",270),d=d3.max(e.map((e=>e.melagi))),h=d3.scaleBand().domain(e.map((function(e){return e.data}))).range([0,l]),u=d3.scaleLinear().domain([0,1.3*d]).range([0,270]);const p=r<860?r/e.length:50;c.selectAll("rect").data(e).enter().append("rect").attr("x",(e=>h(e.data))).attr("y",(e=>o-u(e.melagi))).attr("width",p).attr("height",(e=>u(e.melagi))).attr("stroke","steelblue").attr("fill","steelblue").attr("opacity",.5),c.selectAll(".text-label").data(e).enter().append("text").attr("class","text-label").attr("x",(function(e,t){return t*p+p/2})).attr("y",(function(e){return u(e.melagi)>30?o-u(e.melagi)+u(e.melagi)/2:o-u(e.melagi)-5})).attr("dy",(function(e){return u(e.melagi)>30?"0.35em":"-1em"})).text((function(e){return e.melagi})).attr("fill","black").attr("font-size","14px").attr("font-family","Roboto").attr("font-weight","bold").style("text-anchor","middle"),c.selectAll(".text-label1").data(e).enter().append("text").attr("class","text-label1").attr("x",(function(e,t){return t*p+p/2})).attr("y",(function(e){return u(e.melagi)>40?o-u(e.melagi)+u(e.melagi)/1.5:u(e.melagi)>20&&u(e.melagi)<=40?o-u(e.melagi)+u(e.melagi)/1.2:o-u(e.melagi)+10})).attr("dy",(function(e){return u(e.melagi)>30?"0.35em":"-1em"})).text((function(e){return" км."})).attr("fill","black").attr("font-size","14px").attr("font-family","Roboto").attr("font-weight","bold").style("text-anchor","middle"),c.selectAll(".data-label").data(e).enter().append("text").attr("class","data-label").attr("x",(function(e){return h(e.data)+p/2})).attr("y",265).text((function(e){return e.data})).attr("fill","black").attr("font-size","12px").attr("font-family","Roboto").style("text-anchor","middle")}function P(e,t,s){const i=s.querySelector(".jobTSDetalisationCharts_legenda"),a=s.querySelectorAll(".legendaButton");i.style.justifyContent="center",a.forEach((e=>{e.style.margin="0 10px"}));const n=s.querySelector(`.chartStatic${t}`);n&&n.remove();const r={zapravka:" #8fd14f",rashod:"#3fd6e0",sliv:"#f24726"},l=Object.values(e)[0],o=Object.entries(l).map((([e,t])=>({category:e,value:t}))),c=s.querySelector(".chartJobTS");var d=document.querySelector("body").offsetWidth;const h=s.querySelector(".jobTSDetalisationLine");h.style.width="",h.style.width=d/3,c.style.alignItems="center";const u=d<860?d/3-15:s.clientWidth/3-40;var p=200,m=d3.select(`.${{1:"todayChart",2:"yestodayChart",3:"weekChart"}[t]}`).append("svg").attr("class",`chartStatic${t}`).attr("width",u).attr("height",p),y=d3.max(Object.entries(l).map((e=>e[1]))),g=d3.scaleLinear().domain([0,1.3*y]).range([0,180]);console.log(o),m.selectAll("rect").data(o).enter().append("rect").attr("x",(function(e,t){return 60*t})).attr("y",(e=>p-g(e.value))).attr("width",59).attr("height",(e=>g(e.value))).attr("stroke",(e=>g(e.value)>3?"black":r[e.category])).attr("fill",(function(e,t){return r[e.category]})),m.selectAll(".text-label").data(o).enter().append("text").attr("class","text-label").attr("x",(function(e,t){return 60*t+30})).attr("y",(function(e){return g(e.value)>30?p-g(e.value)+g(e.value)/2:p-g(e.value)-5})).attr("dy",(function(e){return g(e.value)>30?"0.35em":"-1em"})).text((function(e){return e.value+" л."})).attr("fill","black").attr("font-size","14px").attr("font-family","Roboto").attr("font-weight","bold").style("text-anchor","middle")}function F(e,t,s){console.log(e);const i=s.querySelector(`.chartStatic${t}`);console.log(i),i&&i.remove();const a={Движется:" #8fd14f",Парковка:"#3399ff","Работа на холостом ходу":"#f24726"},n=Object.entries(e).map((([e,t])=>({category:e,value:t}))),r=s.querySelector(".jobTSDetalisationGraf");var l=document.querySelector("body").offsetWidth;const o=s.querySelector(".jobTSDetalisationLine");o.style.width="",o.style.width=l/3,r.style.alignItems="center";const c=l<860?l/3-15:s.clientWidth/3-40;var d=d3.select(`.${{1:"todayChart",2:"yestodayChart",3:"weekChart"}[t]}`).append("svg").attr("class",`chartStatic${t}`).attr("width",c).attr("height",200),h=d3.max(n.map((e=>e.value))),u=d3.scaleLinear().domain([0,3===t?1.3*h:86400]).range([0,180]);d.selectAll("rect").data(n).enter().append("rect").attr("x",(function(e,t){return 60*t})).attr("y",(e=>200-u(e.value))).attr("width",59).attr("height",(e=>u(e.value))).attr("stroke",(e=>u(e.value)>3?"black":a[e.category])).attr("fill",(function(e,t){return a[e.category]}));const p=[n][0].map((function(e){var t=function(e){const t=e%3600;return{hours:Math.floor(e/3600),minutes:Math.floor(t/60)}}(e.value);return{category:e.category,value:e.value,hours:t.hours,minutes:t.minutes}}));d.selectAll("g.values").data(p).enter().append("g").attr("class","values").attr("transform",(function(e,t){return`translate(${60*t+29.5}, ${200-u(e.value)})`})).each((function(e,t){var s=u(e.value);e.hours>0&&d3.select(this).append("text").attr("x",0).attr("y",s>30?s/3:0).attr("dy",s>30?"0.75em":"-1.75em").text(e.hours+" ч.").attr("fill","black").attr("font-size","14px").attr("font-family","Roboto").attr("font-weight","bold").style("text-anchor","middle"),e.minutes>0&&d3.select(this).append("text").attr("x",0).attr("y",s>30?s/3:0).attr("dy",s>30?"1.75em":"-0.35em").text(e.minutes+" мин.").attr("fill","black").attr("font-size","14px").attr("font-family","Roboto").attr("font-weight","bold").style("text-anchor","middle")}))}function B(e,t,i){if(console.log(e.length),0===e[0].length)return;const a=document.querySelector(`.chartStatic${t}`);a&&a.remove();const n=document.querySelector("body").offsetWidth,r=function(e){const t=[];let s={...e[0]};for(let i=1;i<e.length;i++)e[i].time===s.time?s.time=e[i].time:(t.push({...s}),s={...e[i]});return t.push({...s}),t}(e[0]),l=0==i.clientWidth?707:i.clientWidth;let o=n<860?n-15:l-40;const c={Движется:" #8fd14f",Парковка:"#3399ff","Повернут ключ зажигания":"#fef445","Работа на холостом ходу":"#f24726"},d={1:"todayChart",2:"yestodayChart",3:"weekChart"},h=d3.select(`.${d[t]}`).append("div").attr("class",`tooltipStat${t}`).style("position","absolute").style("width","130px").style("padding","5px").style("background-color","rgba(0, 0, 0, 0.7)").style("color","#fff").style("border-radius","5px").style("font-size","12px").style("display","none"),u=d3.select(`.${d[t]}`).append("svg").attr("class",`chartStatic${t}`).attr("width",o).attr("height",80),p=d3.scaleTime().domain(d3.extent(e[0],(e=>new Date(e.time)))).range([0,o]),m=u.append("g").attr("transform","translate(0, 10)");let y;m.selectAll("rect").data(r).enter().append("rect").attr("x",(e=>p(new Date(e.time)))).attr("y",0).attr("width",(e=>p(new Date(e.time)))).attr("height",30).attr("fill",(e=>c[e.condition])).on("mousemove",(function(e,i){m.selectAll("rect").attr("fill",(e=>c[e.condition])),d3.select(this).attr("fill","black");const[a,n]=d3.mouse(this),l=d3.bisector((e=>e.time)).right,o=p.invert(a),d=l(r,o,1),h=r[d-1],u=r[d],y=s((i=o-h.time>u.time-o?u:h).time),g=document.querySelector(`.tooltipStat${t}`);g.style.display="block",g.textContent=`Скорость: ${i.speed} км/ч\nВремя: ${y}\nСостояние: ${i.condition}\nИнтервал: ${i.interval.hours} ч.${i.interval.minutes} мин.`,g.style.top="330px",g.style.left="350px"})).on("mouseout",(function(e,t){d3.select(this).attr("fill",(e=>c[e.condition])),h.style("display","none")})).on("click",(function(e){const[s,i]=d3.mouse(this),a=d3.bisector((e=>e.time)).right,n=p.invert(s),l=a(r,n,1),o=r[l-1],c=r[l];e=n-o.dates>c.dates-n?c:o,new q([],e,"stat"),document.querySelector(`.${d[t]}`).addEventListener("click",(function(e){e.stopPropagation()})),document.addEventListener("click",(function(e){const t=e.target,s=document.querySelector(".wrapMap");s&&!s.contains(t)&&s.remove()}))})),3===t&&(y=d3.timeFormat("%d")),y=d3.timeFormat("%H:%M");const g=d3.axisBottom(p).tickFormat(y),v=[p.domain()[0],...g.scale().ticks(g.ticks()[0])];v[0]=new Date(v[0].getTime()+3e5),g.tickValues(v).tickSizeOuter(0),m.append("g").attr("transform","translate(0, 30)").call(g)}const z='  <div class="calendar">\n                                    <input type="text" id="calen2" placeholder="Выберите диапазон дат">\n                                    <div class="btn_speedStart">\n                                        <button class="btm_formStart">Очистить</button>\n                                        <button class="btm_formStart control">Выполнить</button>\n                                    </div>\n                                </div>',R='  <div class="calendar">\n                                    <input type="text" id="calen3" placeholder="Выберите диапазон дат">\n                                    <div class="btn_speedStart">\n                                        <button class="btm_formStart">Очистить</button>\n                                        <button class="btm_formStart control">Выполнить</button>\n                                    </div>\n                                </div>',W='    <div class="jobTSDetalisationGraf">\n                        <div class="jobTSDetalisationDate todayTitle"></div>\n                        <div class="jobTSDetalisationLine todayChart"></div>\n                        <div class="jobTSDetalisationDate yestodayTitle"></div>\n                        <div class="jobTSDetalisationLine yestodayChart"></div>\n                        <div class="jobTSDetalisationDate weekTitle"></div>\n                        <div class="jobTSDetalisationLine weekChart"></div>\n                    </div>\n                    <div class="jobTSDetalisationCharts_legenda">\n                        <div class="legendaButton move">Движение</div>\n                        <div class="legendaButton parking">Парковка</div>\n                        <div class="legendaButton engineTS">Повернут ключ зажигания</div>\n                        <div class="legendaButton jobHHTS">Работа на холостом ходу</div>\n                        <div class="legendaButton notConnect">ТС не на связи</div>\n                    </div>';class H{constructor(e){this.id=e.id,this.time=null,this.structura=[],this.data=null,this.datas=null,this.nav=null,this.container=document.querySelector(".windowStatistic"),this.navstat=this.container.querySelectorAll(".navstat"),this.handleCardClick=this.toogleModalWindow.bind(this),this.handleCalensClick=this.toogleModalData.bind(this),this.wrap=document.querySelector(".wrapper_left"),this.initResizeObserver(),this.init()}initResizeObserver(){this.currentWidth=this.wrap.clientWidth,this.resizeObserver=new ResizeObserver((e=>{const t=document.querySelector(".activStatic")?.id;for(const s of e){const{width:e}=s.contentRect;console.log(this.currentWidth,e),Math.abs(this.currentWidth!==e)&&(this.currentWidth=e,this.performResizeActions(t))}}))}performResizeActions(e){switch(console.log(this.container),e){case"nav1":this.structura.forEach(((e,t)=>{B(Object.values(e)[0].datas,t+1,this.container)}));break;case"nav2":this.structura.forEach(((e,t)=>{F(this.dannieSortJobTS(Object.values(e)[0].intervals),t+1,this.container)}));break;case"nav3":let e=this.datas.reduce(((e,t)=>Number(t.zapravka)+e),0),t=this.datas.reduce(((e,t)=>Number(t.rashod)+e),0);[{day:this.datas[this.datas.length-1]},{yesterday:this.datas[this.datas.length-2]},{week:{zapravka:e,rashod:t}}].forEach(((e,t)=>{P(e,t+1,this.container)}));break;case"nav4":D(this.datas,1,this.container)}}async init(){this.nav="nav1",this.initEventListeners(),this.createIntervalTime(),this.container.insertAdjacentHTML("beforeend",` ${W}`),this.eskiz();const e=await this.getDataStor();this.createStructura(e),this.initEventListenersCalendar(),this.resizeObserver.observe(this.wrap)}reinitialize(e){this.data=null,this.id=e.id,this.structura=[],this.time=null,this.removeEventListeners(),this.resizeObserver.disconnect(),this.initResizeObserver(),this.init()}initEventListenersCalendar(){this.container.querySelectorAll(".calen").forEach((e=>e.addEventListener("click",this.handleCalensClick)))}initEventListeners(){this.navstat.forEach((e=>e.addEventListener("click",this.handleCardClick)))}removeEventListeners(){this.navstat.forEach((e=>e.removeEventListener("click",this.handleCardClick)))}clear(e){e.currentTarget.closest(".calendar").style.display="none"}async ok(e){e.currentTarget.closest(".calendar").style.display="none";const t=e.currentTarget.closest(".calendar").previousElementSibling.getAttribute("rel"),s=e.currentTarget.closest(".calendar").previousElementSibling.parentElement,i="cal2"===t?z:R,a=this.time[0][0]!==this.time[0][1]?`${this.time[0][1]}-${this.time[1][1]}<div class="calen" rel="${t}"></div>${i}`:`${this.time[0][1]}<div class="calen" rel="${t}"></div>${i}`;switch(s.innerHTML=a,this.nav){case"nav1":this.condition([await this.getDataStor()]),B(this.data.time.datas,"cal2"===t?2:3,this.container);break;case"nav2":this.condition([await this.getDataStor()]),F(this.dannieSortJobTS(this.data.time.intervals),"cal2"===t?2:3,this.container);break;case"nav3":const e=await this.getParamsOilAndMileage(3);console.log(e),P({time:{zapravka:e.reduce(((e,t)=>Number(t.zapravka)+e),0),rashod:e.reduce(((e,t)=>Number(t.rashod)+e),0)}},"cal2"===t?2:3,this.container);break;case"nav4":D(await this.getParamsOilAndMileage(4),1,this.container)}this.initEventListenersCalendar()}async toogleModalData(e){const t=e.currentTarget,s=t.nextElementSibling.querySelectorAll(".btm_formStart");t.nextElementSibling.style.display="flex",s[0].addEventListener("click",this.clear.bind(this)),s[1].addEventListener("click",this.ok.bind(this));const i=new p,a=await i.getTimeInterval(t.nextElementSibling);this.time=a.map((e=>{const t=new Date(1e3*e),s=t.getFullYear(),i=("0"+(t.getMonth()+1)).slice(-2),a=("0"+t.getDate()).slice(-2);return[`${s}-${i}-${a}`,`${a}.${i}.${s}`,t.getTime()/1e3]}))}async toogleModalWindow(e){this.time=null,this.navstat.forEach((e=>{e.classList.remove("activStatic")}));const t=e.currentTarget;switch(t.classList.add("activStatic"),this.container.children[1].remove(),this.container.children[1].remove(),t.id){case"nav1":this.nav="nav1",this.container.insertAdjacentHTML("beforeend",` ${W}`),this.eskiz(),this.structura.forEach(((e,t)=>{B(Object.values(e)[0].datas,t+1,this.container)}));break;case"nav2":this.nav="nav2",this.container.insertAdjacentHTML("beforeend",'   <div class="jobTSDetalisationGraf">\n<div class="chartJobTS">\n                        <div class="jobTSDetalisationDate todayTitle">Сегодня</div>\n                        <div class="jobTSDetalisationLine todayChart"></div>\n                        </div>\n                        <div class="chartJobTS">\n                        <div class="jobTSDetalisationDate yestodayTitle">Вчера</div>\n                        <div class="jobTSDetalisationLine yestodayChart"></div>\n                                </div>\n                        <div class="chartJobTS">\n                        <div class="jobTSDetalisationDate weekTitle">Неделя</div>\n                        <div class="jobTSDetalisationLine weekChart"></div>\n                                </div>\n                    </div>\n                    <div class="jobTSDetalisationCharts_legenda">\n                        <div class="legendaButton move">Движение</div>\n                        <div class="legendaButton parking">Парковка</div>\n                        <div class="legendaButton jobHHTS">Работа на холостом ходу</div>\n                        <div class="legendaButton notConnect">ТС не на связи</div>\n                    </div>'),this.updateHTML(),this.eskiz(),this.structura.forEach(((e,t)=>{F(this.dannieSortJobTS(Object.values(e)[0].intervals),t+1,this.container)}));break;case"nav3":this.nav="nav3",this.container.insertAdjacentHTML("beforeend",'   <div class="jobTSDetalisationGraf">\n<div class="chartJobTS">\n                        <div class="jobTSDetalisationDate todayTitle">Сегодня</div>\n                        <div class="jobTSDetalisationLine todayChart"></div>\n                        </div>\n                        <div class="chartJobTS">\n                        <div class="jobTSDetalisationDate yestodayTitle">Вчера</div>\n                        <div class="jobTSDetalisationLine yestodayChart"></div>\n                                </div>\n                        <div class="chartJobTS">\n                        <div class="jobTSDetalisationDate weekTitle">Неделя</div>\n                        <div class="jobTSDetalisationLine weekChart"></div>\n                                </div>\n                    </div>\n                    <div class="jobTSDetalisationCharts_legenda">\n                        <div class="legendaButton move">Заправка</div>\n                        <div class="legendaButton rashodTS">Израсходовано</div>\n                        <div class="legendaButton jobHHTS">Слив топлива</div>\n                                          </div>'),this.updateHTML(),this.eskiz(),this.datas=await this.getParamsOilAndMileage(3);let e=this.datas.reduce(((e,t)=>Number(t.zapravka)+e),0),t=this.datas.reduce(((e,t)=>Number(t.rashod)+e),0);[{day:this.datas[this.datas.length-1]},{yesterday:this.datas[this.datas.length-2]},{week:{zapravka:e,rashod:t}}].forEach(((e,t)=>{P(e,t+1,this.container)}));break;case"nav4":this.nav="nav4",this.container.insertAdjacentHTML("beforeend",'   <div class="jobTSDetalisationGraf">\n<div class="chartJobTS">\n                        <div class="jobTSDetalisationDate intervalTitle">Сегодня</div>\n                        <div class="jobTSDetalisationLine intervalChart"></div>\n                        </div></div>\n                               <div class="jobTSDetalisationCharts_legenda">\n                                                               </div>'),document.querySelector(".intervalTitle").innerHTML=`10 дней: ${this.convertTime(4)} <div class="calen" rel="cal2"></div>${z}`,this.datas=await this.getParamsOilAndMileage(4),D(this.datas,1,this.container)}this.initEventListenersCalendar()}async getParamsOilAndMileage(e){const t=this.time&&this.time[0].length>2?[this.time[0][0],this.time[1][0]]:[n(9),n(0)],s=this.id,i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:t,idw:s})},a=await fetch("/api/summaryIdwToBase",i),r=await a.json();r.sort(((e,t)=>e.data-t.data));let l={};return 4===e?(l=r.map((e=>({data:`${e.data.split("-")[2]}-${e.data.split("-")[1]}`,melagi:e.probeg}))),l):(l=r.map((e=>({zapravka:Number(e.zapravka),rashod:Number(e.rashod)}))),console.log(l),l)}dannieSortJobTS(e){return e["Повернут ключ зажигания"]&&(e["Парковка"]+=e["Повернут ключ зажигания"],delete e["Повернут ключ зажигания"]),e}createStructura(e){this.installTime(e),this.structura.forEach(((e,t)=>this.condition(Object.values(e),Object.keys(e),t)))}updateHTML(){console.log("работает апдейт");const e=document.querySelector(".jobTSDetalisationGraf");e.style.flexDirection="row",e.style.justifyContent="center",document.querySelector(".jobTSDetalisationLine").style.width="200px";const t=document.querySelectorAll(".chartJobTS");document.querySelectorAll(".jobTSDetalisationDate").forEach((e=>{e.style.fontSize="13px"})),t.forEach((e=>{e.style.alignItems="start"}))}eskiz(){const e=document.querySelector(".todayTitle"),t=document.querySelector(".yestodayTitle"),s=document.querySelector(".weekTitle");e.textContent=`Сегодня: ${this.convertTime(1)}`,t.innerHTML=`Вчера: ${this.convertTime(2)}<div class="calen" rel="cal2"></div>${z}`,s.innerHTML=`Неделя: ${this.convertTime(3)}<div class="calen" rel="cal3"></div>${R}`}convertTime(e){if(1===e){const e=new Date;return(t=String(e.getDate()).padStart(2,"0"))+"."+(s=String(e.getMonth()+1).padStart(2,"0"))+"."+e.getFullYear()}if(2===e){const e=new Date;return e.setDate(e.getDate()-1),String(e.getDate()).padStart(2,"0")+"."+String(e.getMonth()+1).padStart(2,"0")+"."+e.getFullYear()}if(3===e||4===e){const o=new Date;var t=String(o.getDate()-(4!==e?7:10)).padStart(2,"0"),s=String(o.getMonth()+1).padStart(2,"0"),i=o.getFullYear();if(t<=0){o.setMonth(o.getMonth()-1);const e=new Date(o.getFullYear(),o.getMonth()+1,0).getDate();t=String(e+Number(t)).padStart(2,"0"),s=String(o.getMonth()+1).padStart(2,"0")}var a=t+"."+s+"."+i;const c=new Date;c.setDate(c.getDate()-1);var n=String(c.getDate()).padStart(2,"0"),r=String(c.getMonth()+1).padStart(2,"0"),l=c.getFullYear();if(n<=0){c.setMonth(c.getMonth()-1);const e=new Date(c.getFullYear(),c.getMonth()+1,0).getDate();n=String(e+Number(n)).padStart(2,"0"),s=String(o.getMonth()+1).padStart(2,"0")}return`${a}-${n+"."+r+"."+l}`}}condition(e,t,s){console.log(e,t,s);const i=this.prostoy(e);i&&i.forEach((t=>{const s=e[0].findIndex((e=>e.time===t[0][0])),i=e[0].findIndex((e=>e.time===t[1][0]));if(-1!==s&&-1!==i)for(let t=s;t<=i;t++)e[0][t].condition="Работа на холостом ходу"}));const{datas:a,intervals:n}=this.calculateIntervalsAndTotalTime(e);t?(this.structura[s]={[t]:{datas:a,intervals:n}},B(this.structura[s][t].datas,s+1,this.container)):this.data={time:{datas:a,intervals:n}}}calculateIntervalsAndTotalTime(e){let t={},s=null,i=null;return e[0].forEach(((a,n,r)=>{const l=a.condition||(a.speed>0&&1===a.engineOn?"Движется":0===a.speed&&1===a.engine?"Повернут ключ зажигания":"Парковка");if(l!==s||0===n){if(null!==i&&null!==s){const e=(a.time-i)/1e3;t[s]||(t[s]=0),t[s]+=e;const l=this.convertToHoursAndMinutes(e);for(let e=r.findIndex((e=>e.time===i));e<n;e++)r[e].interval=l}i=a.time}if(a.condition=l,s=l,n===e.length-1){const e=(a.time-i)/1e3;t[s]||(t[s]=0),t[s]+=e;const l=this.convertToHoursAndMinutes(e);for(let e=r.findIndex((e=>e.time===i));e<=n;e++)r[e].interval=l}})),{datas:e,intervals:t}}convertToHoursAndMinutes(e){const t=e%3600;return{hours:Math.floor(e/3600),minutes:Math.floor(t/60)}}prostoy(e){if(0!==e.length)return e[0].reduce(((e,t)=>(1===t.engineOn&&0===t.speed&&t.sats>4?Array.isArray(e[e.length-1])&&e[e.length-1].length>0&&1===e[e.length-1][0].engineOn&&0===e[e.length-1][0].speed&&e[e.length-1][0].sats>4?e[e.length-1].push(t):e.push([t]):(0===t.engineOn&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length||t.speed>0&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length||t.sats<=4&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length)&&e.push([]),e)),[]).filter((e=>e.length>0)).reduce(((e,t)=>(t[t.length-1].time.getTime()/1e3-t[0].time.getTime()/1e3>1200&&e.push([[t[0].time,t[0].geo,t[0].oil],[t[t.length-1].time,t[t.length-1].geo,t[t.length-1].oil]]),e)),[])}installTime(e){const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime()/1e3,i=s-86400;let a=[],n=[];e.forEach((e=>{const t=Math.floor(new Date(e.time).getTime()/1e3);t>=s?a.push(e):t>=i&&t<s&&n.push(e)})),this.structura=[{day:a},{yesterday:n},{week:e}]}createIntervalTime(){this.navstat.forEach((e=>{e.classList.remove("activStatic")})),this.navstat[0].classList.add("activStatic");const e=Math.floor((new Date).getTime()/1e3),t=e-604800;this.time=[t,e],console.log(this.time)}async getDataStor(){const e=this.id,t=this.time[0].length>2?this.time[0][2]:this.time[0],s=this.time[0].length>2?this.time[1][2]+86399:this.time[1];this.abortController&&this.abortController.abort(),this.abortController=new AbortController;const i=this.abortController.signal,a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e,t1:t,t2:s,arrayColumns:["last_valid_time","speed","lat","lon","engine","sats","engineOn"],num:0,workerKey:"detalisationStatistiks"}),signal:i},n=await fetch("/api/getPressureOil",a),r=await n.json();return r.sort(((e,t)=>e.last_valid_time-t.last_valid_time)),r.map((e=>({time:new Date(1e3*Number(e.last_valid_time)),speed:Number(e.speed),geo:[Number(e.lat),Number(e.lon)],engine:Number(e.engine),sats:Number(e.sats),engineOn:Number(e.engineOn)})))}}class V{static deleteClasses(...e){e.forEach((e=>{document.querySelectorAll(e).forEach((t=>{t.classList.remove(e.substring(1))}))}))}static deleteElements(...e){e.forEach((e=>{document.querySelectorAll(e).forEach((e=>{e.remove()}))}))}static hideElements(e,t){e.forEach((e=>{document.querySelectorAll(e).forEach((e=>{e.style.display=t}))}))}static clearTextContent(...e){e.forEach((e=>{document.querySelectorAll(e).forEach((e=>{e.textContent=""}))}))}static createListItems(e,t,s,i){const a=document.querySelector(e);i.forEach(((e,t)=>{const i=document.createElement("li");i.className=s,i.textContent=`${e.params}:${null!==e.value?e.value:"-"}`,a.append(i)}))}}class G{static gosNum(e){e.forEach((e=>{if(e.classList.contains("pricepT")){const t=e.closest(".containerPricep"),s=document.querySelector(".nomerP");if(!s){const e=document.createElement("div");e.classList.add("nomerP"),e.style.top="65px",e.style.left="63.5px",t.lastElementChild.children[1].style.position="relative",e.style.display="flex",t.lastElementChild.children[1].appendChild(e);const s=document.createElement("input");s.classList.add("gosNumber"),s.setAttribute("placeholder","A000AA"),s.maxLength=6,e.appendChild(s);const i=document.createElement("div");i.classList.add("flagss"),e.appendChild(i);const a=document.createElement("input");a.classList.add("gosNumber1"),a.setAttribute("placeholder","00"),a.maxLength=3,i.appendChild(a);const n=document.createElement("div");n.classList.add("flagy"),i.appendChild(n);const r=document.createElement("div");r.classList.add("flagWhite"),n.appendChild(r);const l=document.createElement("div");l.classList.add("flagBlue"),n.appendChild(l);const o=document.createElement("div");o.classList.add("flagRed"),n.appendChild(o)}s&&(t.lastElementChild.children[1].style.position="relative",1===t.lastElementChild.children[0].children.length&&(s.style.left="63.5px"),t.lastElementChild.children[1].appendChild(s))}if(e.classList.contains("tagachT")){const t=e.closest(".containerTagach");if(!document.querySelector(".nomerV")){const e=document.createElement("div");e.classList.add("nomerV"),t.children[0].children[1].appendChild(e),e.style.bottom="70px",e.style.left="63.5px",t.children[0].children[1].style.position="relative",e.style.display="flex";const s=document.createElement("input");s.classList.add("gosNumberCar"),s.setAttribute("placeholder","A000AA"),s.maxLength=6,e.appendChild(s);const i=document.createElement("div");i.classList.add("flagss"),e.appendChild(i);const a=document.createElement("input");a.classList.add("gosNumberCar1"),a.setAttribute("placeholder","00"),a.maxLength=3,i.appendChild(a);const n=document.createElement("div");n.classList.add("flagy"),i.appendChild(n);const r=document.createElement("div");r.classList.add("flagWhite"),n.appendChild(r);const l=document.createElement("div");l.classList.add("flagBlue"),n.appendChild(l);const o=document.createElement("div");o.classList.add("flagRed"),n.appendChild(o)}}}))}}class J{constructor(e){this.model=e,this.config=document.querySelector(".config"),this.containerTagach=null,this.containerPricep=null,this.createViewModel()}createViewModel(){const e=this.model[0].type;this.controllViewType(e),1===this.model.length&&"-"===this.model[0].osi||(this.createContainer(),this.createOsi(),this.createTyres(),this.createNomer())}controllViewType(e){if("Тип ТС"==e)return;const t=this.config.querySelector(".select_type");t.style.display=""!==e?"flex":"none",Array.from(t.children).forEach((s=>{e!==s.textContent?s.hidden=!0:(t.value="Тип ТС"!==e?s.value:"-",console.log(t.value),t.disabled=!0,s.disabled=!0,s.selected=!0,t.style.appearance="none")})),""===t.value&&(t.selectedIndex=0)}createContainer(){const e=this.config.querySelector(".containerAll");e&&e.remove();const t=this.config.querySelector(".altConfig"),s=document.createElement("div");s.classList.add("containerAlt"),t.appendChild(s),this.containerTagach=document.createElement("div"),this.containerTagach.classList.add("containerTagach"),this.containerPricep=document.createElement("div"),this.containerPricep.classList.add("containerPricep"),s.appendChild(this.containerTagach),s.appendChild(this.containerPricep),this.containerTagach.style.border="2px solid darkblue",this.containerTagach.style.padding="2px",this.containerPricep.style.padding="2px",this.containerPricep.style.marginTop="50px"}createOsi(){this.model.sort(((e,t)=>e.osi-t.osi));for(let e=0;e<this.model.length;e++){const t=this.model[e],s="Тягач"===t.trailer?this.containerTagach:this.containerPricep;"Прицеп"===t.trailer?this.containerPricep.style.border="2px solid darkblue":this.containerPricep.style.border="none",s.innerHTML+=`<div class=" osiTest">\n        <div class="tires_spark_test">\n            <div class="tiresTest mod">\n            </div>\n                  </div>\n                  <div class="centerOsTest" id=${t.osi}>\n<div class="vnutTest"></div>\n                  </div>\n            <div class="tires_spark_test">\n                      <div class="tiresTest mod">\n            </div>\n        </div>\n    </div>`;const i=document.querySelectorAll(".centerOsTest");if(i[e].closest(".containerTagach")?i[e].classList.add("tagachT"):i[e].classList.add("pricepT"),"4"===t.tyres){const t=document.querySelectorAll(".osiTest"),s=document.createElement("div");s.classList.add("tiresTest","sp"),t[e].children[0].appendChild(s);const i=document.createElement("div");i.classList.add("tiresTest","sp"),t[e].children[2].prepend(i),t[e].children[1].children[0].style.width="112px"}}document.querySelectorAll(".centerOsTest").forEach((e=>{e.classList.contains("pricepT")&&(e.children[0].style.background="#000")}))}createTyres(){const e=document.querySelectorAll(".tiresTest");let t=0;e.forEach((e=>{t++;const s=document.createElement("a");s.classList.add("tires_link_test"),s.setAttribute("id",`${t}`),e.appendChild(s);const i=document.createElement("div");i.classList.add("tiresDTest");const a=document.createElement("div");a.classList.add("tiresTTest"),s.appendChild(i),s.appendChild(a)}))}createNomer(){const e=document.querySelectorAll(".centerOsTest");G.gosNum(e);const t=document.querySelector(".nomerP");t&&2===t.closest(".osiTest").children[0].children.length&&(t.style.left="15px");const s=document.querySelector(".gosNumber"),i=document.querySelector(".gosNumber1"),a=document.querySelector(".gosNumberCar"),n=document.querySelector(".gosNumberCar1");this.model[0].frontGosp&&(a.value=this.model[0].frontGosp),this.model[0].frontGosp1&&(n.value=this.model[0].frontGosp1),this.model[0].gosp&&(s.value=this.model[0].gosp),this.model[0].gosp1&&(i.value=this.model[0].gosp1)}}class U{constructor(e,t,s){this.tyres=e,this.params=t,this.osi=s,this.objColor={1:"darkred",2:"#FFFF00",3:"#4af72f",5:"#fff"},this.intervalId=null,this.init()}init(){this.intervalId&&clearInterval(this.intervalId),this.intervalId=setInterval((()=>this.getParams()),11e4),this.viewValueTyres()}clearInterval(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}generDav(e,t){let s;return e>=Number(t.dnmin)&&e<=Number(t.dnmax)&&(s=3),(e>Number(t.knd)&&e<=Number(t.dnmin)||e>Number(t.dnmax)&&e<=Number(t.kvd))&&(s=2),(e<=Number(t.knd)||e>=Number(t.kvd))&&(s=1),s}generT(e){let t;return t=e>-50&&e<=70?5:1,t}viewValueTyres(){const e=document.querySelector(".role").getAttribute("rel");if(!0!==document.querySelectorAll(".modals")[1].classList.contains("active")&&this.tyres){console.log(this.params);const t=i(this.tyres),s=document.querySelectorAll(".tires_link_test");let a=this.params.find((e=>"engine"===e.params));a=a?a.value:0,t.forEach((t=>{const i=this.params.find((e=>e.params===t.pressure)),n=this.params.find((e=>e.params===t.temp)),r=this.osi.find((e=>e.idOs===t.osNumber)),l=Array.from(s).find((e=>e.id==t.tyresdiv));if(i&&l){const s=i.idTyres;console.log(s);const o=null!==i.value?parseFloat(i.value):"-",c=r?this.objColor[this.generDav(o,r)]:null;l.children[0].style.position="relative",l.children[0].style.border="none",l.children[0].style.borderRadius="30% 30% 0 0",l.children[0].innerHTML=`${o}\n<div class="span_bar">Bar</div>`,l.children[0].setAttribute("rel",`${t.pressure}`);const d=l.querySelector(".span_bar");d.style.position="absolute",d.style.bottom=0;const h="0"===a?"none":"false"===i.status&&s?"lightgray":"none",u="0"===a?"lightgray":"false"===i.status?"#000":c,p="#FF0000"===c?`1px solid ${c}`:"1px solid #fff";if(l.children[0].style.background=h,l.children[0].style.color=u,l.parentElement.style.border=p,console.log(l),s||(l.style.backgroundImage='url("../../../../image/wheel_gray.png")',l.style.backgroundColor="#000"),"#FF0000"===c&&(l.parentElement.style.borderRadius="15px"),n){const r="0"===a?"none":"false"===n.status&&s?"lightgray":"none",o="0"===a?"lightgray":"false"===n.status?"#000":this.objColor[this.generT(parseFloat(n.value))];switch(l.children[1].style.background=r,l.children[1].style.color=o,l.children[1].style.borderRadius=" 0 0 30% 30%",n.value){case"-128":case"-50":case"-51":l.children[1].style.color="darkred",l.children[1].textContent="err";break;case null:l.children[1].textContent="-°C",l.children[1].setAttribute("rel",`${t.temp}`);break;default:l.children[1].textContent=n.value+"°C",l.children[1].setAttribute("rel",`${t.temp}`)}const c=new Date,d=Math.floor(c.getTime()/1e3),h=i.data?function(e,t){var s=t-e;let i,a;const n=Math.floor(s/60),r=Math.floor(n/60),l=Math.floor(r/24),o=r%24;return i=0==l%60?"":l+"д ",a=0===o?"":o+"ч ",`${i} ${a} ${n%60} мин`}(parseInt(i.data),d):"-";new g(l,"Администратор"===e?[i.sens+"("+i.params+")",n.sens+"("+n.params+")","Актуальность данных:"+h]:[i.sens,i.temp,"Актуальность данных:"+h])}}}))}}async getParams(){const e=document.querySelector(".color").id,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/getSens",t);this.params=await s.json(),this.params.sort(((e,t)=>e.name<t.name?-1:e.name<t.name?1:void 0)),this.viewValueTyres()}}class K{constructor(e){this.id=e,this.idOs=null,this.element=null,this.finalBound=this.final.bind(this),this.methodBound=this.method.bind(this),this.validationBound=this.validation.bind(this),this.clearBarBound=this.clearBar.bind(this),this.hiddenOsBound=this.hiddenOs.bind(this),this.getDOM(),this.setupEventListeners()}reinitialize(e){this.removeEventListeners(),this.id=e,this.getDOM(),this.setupEventListeners()}setupEventListeners(){console.log("Adding event listeners"),this.inpfinal.forEach((e=>e.addEventListener("input",this.finalBound))),this.vnut.forEach((e=>e.addEventListener("click",this.methodBound))),this.btnModal.addEventListener("click",this.validationBound),this.btnModalClear.addEventListener("click",this.clearBarBound),this.modalClear.addEventListener("click",this.hiddenOsBound)}removeEventListeners(){console.log("Removing event listeners"),this.inpfinal.forEach((e=>e.removeEventListener("input",this.finalBound))),this.vnut.forEach((e=>e.removeEventListener("click",this.methodBound))),this.btnModal.removeEventListener("click",this.validationBound),this.btnModalClear.removeEventListener("click",this.clearBarBound),this.modalClear.removeEventListener("click",this.hiddenOsBound)}getDOM(){this.modalCenterOs=document.querySelector(".modalCenterOs"),this.modalClear=document.querySelector(".modalClear"),this.btnModal=document.querySelector(".btnModal"),this.btnModalClear=document.querySelector(".btnModalClear"),this.norma=document.querySelector(".normal"),this.inpfinal=document.querySelectorAll(".inpfinal"),this.divFinal=document.querySelectorAll(".divfinal"),this.vnut=document.querySelectorAll(".vnutTest")}hiddenOs(){this.modalCenterOs.style.display="none"}async reqModalBar(e,t){const s=document.querySelector(".color").children[0].textContent,i=this.id;console.log(i);const a=[];a.push(i),a.push(s),a.push(t),a.push(this.norma.value),this.divFinal.forEach((e=>{a.push(e.textContent)})),console.log(t,e,a,i);const n=await fetch("/api/modalBar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,arr:e,arrValue:a,idw:i})});await n.json()}async modalBar(){this.modalCenterOs.style.display="none";const e=document.querySelectorAll(".modalText"),t=[];e.forEach((e=>{t.push(e.id)})),await this.reqModalBar(t,this.idOs),this.viewBar(this.idOs),this.element.parentElement.classList.remove("centerOsActiv")}final(e){const t=e.value.replace(/,/g,".");e.value=t,this.norma.value&&(e.previousElementSibling.textContent=String(this.norma.value/100*e.value).substr(0,5))}validation(){""===this.norma.value?this.messfn():this.modalBar()}messfn(){const e=document.querySelector(".mess");e.style.display="flex",setTimeout((()=>e.style.display="none"),3e3)}clearBar(){this.inpfinal.forEach(((e,t)=>{e.value=e.placeholder,this.divFinal[t].textContent=String(this.norma.value/100*e.placeholder).substr(0,5)}))}method(e){if(this.element=e.currentTarget,this.idOs=this.element.parentElement.id,this.element.parentElement.classList.contains("centerOsActiv"))return this.element.parentElement.classList.remove("centerOsActiv"),void(this.modalCenterOs.style.display="none");this.vnut.forEach((e=>{e.parentElement.classList.remove("centerOsActiv")})),this.element.parentElement.classList.add("centerOsActiv"),this.modalCenterOs.style.display="block",document.querySelectorAll(".modalInput").forEach((e=>{e.value=""}));const t=document.querySelector(".modalNumberOs");this.element.parentElement.classList.contains("pricepT")?t.textContent=this.idOs+"-Прицеп":t.textContent=this.idOs+"-Тягач",this.divFinal.forEach((e=>{e.textContent=""})),this.inpfinal.forEach((e=>{e.value=""})),this.viewBar(this.idOs),this.norma.addEventListener("input",(()=>{this.fncalc(this.norma.value)}))}async viewBar(e){const t=document.querySelector(".color").children[0].textContent,s=this.id,i=await fetch("/api/barView",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,activePost:t,idw:s})}),a=await i.json(),n=[];if(a.length){for(let e in a)n.push(e);const e=Object.entries(a[0]);e.shift(),e.shift(),e.shift(),e.pop(),this.norma.value=e[0][1],e.shift(),this.divFinal.forEach(((t,s)=>{t.textContent=e[s][1],this.inpfinal[s].value=(parseFloat(100*t.textContent)/this.norma.value).toFixed(2)}))}}fncalc(e){let t;this.inpfinal.forEach(((s,i)=>{t=s.value?s.value:s.placeholder,this.divFinal[i].textContent=String(e/100*t).substr(0,5)}))}}class Y{constructor(e,t,s){this.selectType=e,this.sensors=t,this.id=s}async init(){console.log("тут");const e=document.querySelector(".wrapper_right");e.style.zIndex=0,document.querySelector(".popup-background").style.display="none";const t=[],s=[],i=document.querySelector(".color"),a=this.id,n=i.children[0].textContent,r=e.querySelectorAll(".osiTest"),l=e.querySelectorAll(".tires_link_test"),o=e.querySelector(".gosNumber"),c=e.querySelector(".gosNumber1"),d=e.querySelector(".gosNumberCar"),h=e.querySelector(".gosNumberCar1");let u=0,p=0;r.forEach((e=>{u++,e.children[1].setAttribute("id",`${u}`),t.push(this.fnsortTest(e))})),l.forEach((e=>{p++,e.setAttribute("id",`${p}`),s.push(this.fnsortTyresTest(e))}));const m=this.selectType.options[this.selectType.selectedIndex].text;await this.changeBase(t,n,a,m,o,c,d,h),await this.postTyres(s,n,a),this.sensors.style.display="none"}fnsortTest(e){const t=parseFloat(e.children[1].id);let s,i;s=e.children[1].classList.contains("pricepT")?"Прицеп":"Тягач",console.log(e);const a=e.querySelector(".sparkCheck");return i=a&&a.checked?4:2,[t,s,i]}fnsortTyresTest(e){const t=e.closest(".osiTest").children[1].id;return[e.id,e.children[0].getAttribute("rel"),e.children[1].getAttribute("rel"),t]}async postTyres(e){const t=document.querySelectorAll(".color")[0].textContent.replace(/\s+/g,""),s=document.querySelector(".color").id,i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tyres:e,activePost:t,idw:s})};(await fetch("/api/tyres",i)).json()}async reqDelete(e){fetch("/api/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})}).then((e=>e.json())).then((e=>console.log(e)));const t=document.querySelector(".containerAlt");t&&t.remove()}async changeBase(e,t,s,i,a,n,r,l){let o,c,d,h;0!==e.length||e.push(["-","-","-"]),await this.reqDelete(s),o=a?a.value:"",c=r?r.value:"",d=n?n.value:"",h=l?l.value:"",console.log(o,d,c,h);const u={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({massModel:e,idw:s,activePost:t,gosp:o,gosp1:d,frontGosp:c,frontGosp1:h,type:i})},p=await fetch("/api/updateModel",u);await p.json(),document.querySelector(".modalCenterOs").style.display="none",document.getElementById("check_Title").checked=!1}async barDelete(e){document.querySelector(".modalCenterOs").style.display="none";const t=await fetch("/api/barDelete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})}),s=await t.json();console.log(s)}async paramsDelete(e){fetch("/api/paramsDelete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})}).then((e=>e.json())).then((e=>console.log(e)));const t=document.querySelectorAll(".tiresD"),s=document.querySelectorAll(".tiresT");t.forEach((e=>{e.textContent="",e.style.background="#fff"})),s.forEach((e=>{e.textContent="",e.style.background="#fff"}))}}class Z{constructor(e){this.id=e,this.change=this.startConfig.bind(this),this.clickDisk=this.viewSubMenu.bind(this,"flex"),this.cancel=this.viewSubMenu.bind(this,"none"),this.saved=this.saveConfigurator.bind(this),this.del=this.viewSubMenuDel.bind(this,"flex"),this.cancelDel=this.viewSubMenuDel.bind(this,"none"),this.savedDel=this.saveConfiguratorDelete.bind(this),this.index=0,this.getDOM(),this.initAddEvent()}getDOM(){this.altConfig=document.getElementById("check_Title"),this.selectType=document.querySelector(".select_type"),this.disk=document.querySelector(".disk"),this.sensors=document.querySelector(".sensors"),this.btnsens=document.querySelectorAll(".btnsens"),this.korz=document.querySelector(".korz"),this.save=this.disk.nextElementSibling.children[0],this.otmena=this.disk.nextElementSibling.children[1],this.saveDel=this.korz.nextElementSibling.children[0],this.otmenaDel=this.korz.nextElementSibling.children[1]}reinitialize(e){this.removeEventListeners(),this.id=e,this.getDOM(),this.initAddEvent()}initAddEvent(){this.altConfig.addEventListener("change",this.change),this.disk.addEventListener("click",this.clickDisk),this.otmena.addEventListener("click",this.cancel),this.save.addEventListener("click",this.saved),this.korz.addEventListener("click",this.del),this.otmenaDel.addEventListener("click",this.cancelDel),this.saveDel.addEventListener("click",this.savedDel)}removeEventListeners(){this.altConfig.removeEventListener("change",this.change),this.disk.removeEventListener("click",this.clickDisk),this.otmena.removeEventListener("click",this.cancel),this.save.removeEventListener("click",this.saved),this.korz.removeEventListener("click",this.del),this.otmenaDel.removeEventListener("click",this.cancelDel),this.saveDel.removeEventListener("click",this.savedDel)}viewSubMenuDel(e){this.korz.nextElementSibling.style.display=e}viewSubMenu(e){this.disk.nextElementSibling.style.display=e}async saveConfiguratorDelete(){const e=new Y(this.selectType,this.sensors,this.id);await e.reqDelete(this.id),await e.paramsDelete(this.id),await e.barDelete(this.id),this.viewSubMenuDel("none")}async saveConfigurator(){const e=new Y(this.selectType,this.sensors,this.id);await e.init(),this.clearConfig(),this.viewSubMenu("none")}startConfig(){const e=this.selectType.options[this.selectType.selectedIndex].textContent,t=document.getElementById("check_Title");console.log(t.checked),t.checked?this.createConfig(e):this.clearConfig()}createConfig(e){console.log("тута?");const t=document.querySelector(".tiresActiv");t&&t.classList.remove("tiresActiv");const s=document.querySelector(".checkAlt");s.style.color="red",s.style.fontWeight="bold";for(let t=0;t<this.selectType.options.length;t++)if(this.selectType.options[t].textContent===e){this.selectType.options[t].selected=!0;break}this.selectType.style.display="flex",this.selectType.style.appearance="",this.selectType.disabled=!1,Array.from(this.selectType.children).forEach((e=>{e.hidden=!1,e.disabled=!1}));const i=document.querySelector(".altConfig"),a=document.querySelector(".containerAlt");if(document.querySelector(".disketa").style.display="flex",document.querySelector(".korzina").style.display="flex",a)return a.style.marginTop="0",void this.nowModel(a);const n=document.createElement("div");n.classList.add("containerAlt"),i.insertBefore(n,i.children[1]);const r=document.createElement("div");r.classList.add("wrapperTagach");const l=document.createElement("div");l.classList.add("wrapperPricep"),n.appendChild(r),n.appendChild(l);const o=document.createElement("div");o.classList.add("titleTagach"),r.appendChild(o);const c=document.createElement("div");c.classList.add("containerTagach"),r.appendChild(c);const d=document.createElement("div");d.classList.add("titlePricep"),l.appendChild(d);const h=document.createElement("div");h.classList.add("containerPricep"),l.appendChild(h);const u=document.createElement("div");u.classList.add("titleT"),o.appendChild(u),u.textContent="Тягач";const p=document.createElement("div");p.classList.add("titleP"),d.appendChild(p),p.textContent="Прицеп";const m=document.createElement("div");m.classList.add("numT"),o.appendChild(m);const y=document.createElement("div");y.classList.add("quantityT"),m.appendChild(y),y.textContent="Кол-во осей:";const g=document.createElement("div");g.classList.add("kolvoT"),m.appendChild(g),g.textContent=0;const v=document.createElement("div");v.classList.add("choiceT"),o.appendChild(v);const f=document.createElement("div");f.classList.add("pluT"),v.appendChild(f);const b=document.createElement("div");b.classList.add("miT"),v.appendChild(b);const w=document.createElement("div");w.classList.add("numP"),d.appendChild(w);const S=document.createElement("div");S.classList.add("quantityP"),w.appendChild(S),S.textContent="Кол-во осей:";const _=document.createElement("div");_.classList.add("kolvoP"),w.appendChild(_),_.textContent=0;const k=document.createElement("div");k.classList.add("choiceP"),d.appendChild(k);const C=document.createElement("div");C.classList.add("pluP"),k.appendChild(C);const E=document.createElement("div");E.classList.add("miP"),k.appendChild(E),this.listenerNum()}async clearConfig(){const e=document.querySelector(".wrapper_right");document.querySelectorAll(".msg").forEach((e=>e.style.fontWeight="300")),document.querySelector(".acto")&&document.querySelector(".acto").classList.remove("acto"),document.querySelector(".actBTN")&&document.querySelector(".actBTN").classList.remove("actBTN"),"flex"===this.sensors.style.display&&(this.sensors.style.display="none",e.style.zIndex=0,document.querySelector(".popup-background").style.display="none"),this.selectType.style.display="none";const t=document.querySelector(".checkAlt");t.style.color="black",t.style.fontWeight="400",document.querySelector(".disketa").style.display="none",document.querySelector(".korzina").style.display="none";const s=document.querySelector(".containerAlt");s&&s.remove();const i=document.querySelector(".color").id,a=await this.getNewData(i);console.log(a),new le(a,i)}async getNewData(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/modelView",t),i=await s.json(),a=await fetch("/api/tyresView",t),n=await a.json(),r=await fetch("/api/getSens",t),l=await r.json(),o=await fetch("/api/barView",t),c=await o.json();return l.sort(((e,t)=>e.name<t.name?-1:e.name<t.name?1:void 0)),[i.result,n.result,l,c]}createOsNow(e){e.innerHTML+='<div class=" osiTest">\n        <div class="tires_spark_test">\n            <div class="tiresTest mod">\n            </div>\n                  </div>\n            <div class="tires_spark_test">\n                      <div class="tiresTest mod">\n            </div>\n        </div>\n    </div>',this.index++;const t=document.createElement("div");t.classList.add("centerOsTest");const s=document.createElement("div");if(s.classList.add("vnutTest"),t.appendChild(s),e.lastElementChild.children[0].insertAdjacentElement("afterEnd",t),e.lastElementChild.parentElement?.classList.contains("containerPricep")){const s=document.createElement("div");s.classList.add("spark"),s.innerHTML=`<input class="sparkCheck" type="checkbox" rel=${this.index}>Колёса спарены`,t.prepend(s),t.classList.add("pricepT"),t.children[1].style.background="#000",e.querySelectorAll(".osiTest").forEach((e=>{2===e.children[0].children.length&&(e.children[1].children[0].children[0].checked=!0)}))}else if(t.classList.add("tagachT"),1!==this.index&&e.lastElementChild.parentElement?.classList.contains("containerTagach")){const s=document.createElement("div");s.classList.add("spark"),s.innerHTML=`<input class="sparkCheck" type="checkbox" rel=${this.index}>Колёса спарены`,t.prepend(s),e.querySelectorAll(".osiTest").forEach((e=>{2===e.children[0].children.length&&(e.children[1].children[0].children[0].checked=!0)}))}const i=document.querySelectorAll(".centerOsTest");G.gosNum(i);e.lastElementChild.querySelectorAll(".tiresTest").forEach((e=>{const t=document.createElement("a");t.classList.add("tires_link_test"),e.appendChild(t);const s=document.createElement("div");s.classList.add("tiresDTest");const i=document.createElement("div");i.classList.add("tiresTTest"),t.appendChild(s),t.appendChild(i)})),this.sparka()}nowModel(e){const t=document.querySelectorAll(".centerOsTest"),s=document.querySelectorAll(".tagachT").length,i=document.querySelectorAll(".pricepT").length,a=document.createElement("div");a.classList.add("wrapperTagach");const n=document.createElement("div");n.classList.add("wrapperPricep"),e.appendChild(a),e.appendChild(n);const r=document.createElement("div");r.classList.add("titleTagach"),a.appendChild(r);const l=document.querySelector(".containerTagach");l.style.marginTop="20px",a.appendChild(l);const o=document.createElement("div");o.classList.add("titlePricep"),n.appendChild(o);const c=document.querySelector(".containerPricep");c.style.marginTop="20px",n.appendChild(c);const d=document.createElement("div");d.classList.add("titleT"),r.appendChild(d),d.textContent="Тягач";const h=document.createElement("div");h.classList.add("titleP"),o.appendChild(h),h.textContent="Прицеп";const u=document.createElement("div");u.classList.add("numT"),r.appendChild(u);const p=document.createElement("div");p.classList.add("quantityT"),u.appendChild(p),p.textContent="Кол-во осей:";const m=document.createElement("div");m.classList.add("kolvoT"),u.appendChild(m),m.textContent=s||0;const y=document.createElement("div");y.classList.add("choiceT"),r.appendChild(y);const g=document.createElement("div");g.classList.add("pluT"),y.appendChild(g);const v=document.createElement("div");v.classList.add("miT"),y.appendChild(v);const f=document.createElement("div");f.classList.add("numP"),o.appendChild(f);const b=document.createElement("div");b.classList.add("quantityP"),f.appendChild(b),b.textContent="Кол-во осей:";const w=document.createElement("div");w.classList.add("kolvoP"),f.appendChild(w),w.textContent=i||0;const S=document.createElement("div");S.classList.add("choiceP"),o.appendChild(S);const _=document.createElement("div");_.classList.add("pluP"),S.appendChild(_);const k=document.createElement("div");k.classList.add("miP"),S.appendChild(k);const C=document.querySelectorAll(".pluT, .pluP");document.querySelectorAll(".miT, .miP").forEach((e=>{e.addEventListener("click",(()=>{const t=e.parentElement.previousElementSibling.children[1];let s=e.parentElement.previousElementSibling.children[1].textContent;s>0&&s--,t.textContent=s,e.parentElement.parentElement.nextElementSibling.lastElementChild.remove();const i=document.querySelectorAll(".centerOsTest"),a=[];i.forEach((e=>{e.closest(".containerPricep")&&a.push(e)}));const n=document.createElement("div");n.classList.add("nomerP"),n.style.top="65px",2===a[a.length-1].previousElementSibling.children.length?n.style.left="15px":n.style.left="63.5px",a[a.length-1].style.position="relative",n.style.display="flex",a[a.length-1].appendChild(n);const r=document.createElement("input");r.classList.add("gosNumber"),r.setAttribute("placeholder","A000AA"),r.maxLength=6,n.appendChild(r);const l=document.createElement("div");l.classList.add("flagss"),n.appendChild(l);const o=document.createElement("input");o.classList.add("gosNumber1"),o.setAttribute("placeholder","00"),o.maxLength=3,l.appendChild(o);const c=document.createElement("div");c.classList.add("flagy"),l.appendChild(c);const d=document.createElement("div");d.classList.add("flagWhite"),c.appendChild(d);const h=document.createElement("div");h.classList.add("flagBlue"),c.appendChild(h);const u=document.createElement("div");u.classList.add("flagRed"),c.appendChild(u)}))})),C.forEach((e=>{e.addEventListener("click",(()=>{const t=e.parentElement.previousElementSibling.children[1];let s=e.parentElement.previousElementSibling.children[1].textContent;s++,t.textContent=s,console.log(e.parentElement.parentElement.nextElementSibling.children.length),this.createOsNow(e.parentElement.parentElement.nextElementSibling)}))}));let E=0;t.forEach((e=>{if(E++,e.closest(".containerPricep")){const t=document.createElement("div");t.classList.add("spark"),t.innerHTML=`<input class="sparkCheck" type="checkbox" rel=${E}>Колёса спарены`,e.prepend(t),2===e.previousElementSibling.children.length&&(e.children[0].children[0].checked=!0),e.children[1].style.background="#000"}else if(1!==E&&e.closest(".containerTagach")){const t=document.createElement("div");t.classList.add("spark"),t.innerHTML=`<input class="sparkCheck" type="checkbox" rel=${E}>Колёса спарены`,e.prepend(t),2===e.previousElementSibling.children.length&&(e.children[0].children[0].checked=!0)}})),this.sparka()}sparka(){document.querySelectorAll(".sparkCheck").forEach((e=>{e.addEventListener("change",(()=>{const t=e.closest(".osiTest");if(e.checked){if(0===t.querySelectorAll(".tiresTest.sp").length){const e=document.createElement("div");e.classList.add("tiresTest","sp"),t.children[0].appendChild(e);const s=document.createElement("div");s.classList.add("tires_link_test"),e.appendChild(s);const i=document.createElement("div");i.classList.add("tiresDTest");const a=document.createElement("div");a.classList.add("tiresTTest"),s.appendChild(i),s.appendChild(a);const n=document.createElement("div");n.classList.add("tiresTest","sp"),t.children[2].prepend(n);const r=document.createElement("div");r.classList.add("tires_link_test"),n.appendChild(r);const l=document.createElement("div");l.classList.add("tiresDTest");const o=document.createElement("div");o.classList.add("tiresTTest"),r.appendChild(l),r.appendChild(o)}t.children[1].children[1].style.width="112px"}else t.querySelectorAll(".tiresTest.sp").forEach((e=>e.remove())),t.children[1].children[1].style.width="214px";const s=document.querySelector(".nomerP");s&&(s.closest(".centerOsTest").children[0].children[0].checked?s.style.left="15px":s.style.left="63.5px"),this.forTyres()}))})),this.forTyres()}forTyres(){const e=document.querySelector(".obo"),t=document.querySelector(".containerAlt").querySelectorAll(".tires_link_test");t.forEach((s=>{s.addEventListener("click",(()=>{const i=document.querySelector(".tiresActiv");e.style.display=i?"flex":"none",t.forEach((e=>{document.querySelectorAll(".msg").forEach((e=>{e.style.color="rgba(6, 28, 71, 1)",e.classList.remove("act")})),e.classList.remove("tiresActiv")})),s.classList.add("tiresActiv"),this.sensors.style.display="flex",this.btnsens[0].style.display="flex",this.btnsens[1].style.display="flex"}))})),this.allparamsTyres()}allparamsTyres(){const e=document.querySelectorAll(".color"),t=document.querySelectorAll(".msg");let s=[],i=[];t.forEach((a=>{a.addEventListener("click",(()=>{const n=document.querySelector(".tiresActiv");t.forEach((e=>{e.style.color="rgba(6, 28, 71, 1)"})),a.style.color="green",a.style.fontWeight="bold";const r=[...a.textContent];let l;if(r.forEach((e=>{":"===e&&(l=r.splice(r.indexOf(e)+1,r.length-1).join(""))})),this.btnsens[0].classList.contains("actBTN")){r.forEach((e=>{":"===e&&(n.children[0].setAttribute("rel",r.splice(r[0]+1,r.indexOf(e)).join("")),s.push(r.splice(r[0]+1,r.indexOf(e)).join("")))})),"А 652 УА 198"==e[0].textContent&&(l=(l/10).toFixed(1));const t=l;t.length>10?n.children[0].textContent="-":n.children[0].textContent=t+"\nБар",n.children[0].style.color=c[function(e){let t;return e>=8&&e<=10&&(t=3),(e>=7.5&&e<8||e>10&&e<=13)&&(t=2),(e>-100&&e<7.5||e>13)&&(t=1),t}(t)]}this.btnsens[1].classList.contains("actBTN")&&(r.forEach((e=>{":"===e&&(n.children[1].setAttribute("rel",r.splice(r[0]+1,r.indexOf(e)).join("")),i.push(r.splice(r[0]+1,r.indexOf(e)).join("")))})),"-128"===l||"-51"===l||"-50"===l||l.length>10?(l="err",n.children[1].textContent=l):(n.children[1].textContent=l+"°",n.children[1].style.color=c[function(e){let t;return t=e>-50&&e<=70?5:1,t}(l)]))}))}))}down(e){const t=e.parentElement.previousElementSibling.children[1];let s=e.parentElement.previousElementSibling.children[1].textContent;s>0&&s--,t.textContent=s,e.parentElement.parentElement.nextElementSibling.lastElementChild.remove()}up(e){const t=e.parentElement.previousElementSibling.children[1];let s=e.parentElement.previousElementSibling.children[1].textContent;s++,t.textContent=s,this.createOsNow(e.parentElement.parentElement.nextElementSibling)}listenerNum(){const e=document.querySelectorAll(".pluT, .pluP");document.querySelectorAll(".miT, .miP").forEach((e=>{e.addEventListener("click",(()=>{this.down(e)}))})),e.forEach((e=>{e.addEventListener("click",(()=>{this.up(e)}))}))}}class X{static async setTyres(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({object:e})},s=await fetch("/api/setTyres",t);return await s.json()}static async setModelTyres(e,t){const s={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({arrayWheel:e,relId:t})},i=await fetch("/api/setModelTyres",s);return await i.json()}static async findId(){const e=await fetch("/api/findLastId",{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json();let s;if(0===t.length)s="1id";else{const e=[...t[0].idw_tyres];e.forEach((t=>{"i"===t&&e.splice(e.indexOf(t),2).join("")})),s=Number(e.join(""))+1+"id"}return s}static async getModelTyres(){const e=await fetch("/api/getModelTyres",{method:"GET",headers:{"Content-type":"application/json"}});return await e.json()}static async updateStatusTyres(e,t,s){const i={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:e,flag:t,date:s})},a=await fetch("/api/updateTyres",i);return await a.json()}static async getTyresToSlad(){const e=await fetch("/api/getTyresToSlad",{method:"GET",headers:{"Content-type":"application/json"}});return await e.json()}static async getTyresPosition(e){const t=e.idObject,s=e.identifikator,i={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idObject:t,identifikator:s})},a=await fetch("/api/getTyresPosition",i);return await a.json()}static async setTyresHistory(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({object:e})},s=await fetch("/api/setTyresHistory",t);return await s.json()}static async getHistoryTyresidTyres(e){const t=e,s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw_tyres:t})},i=await fetch("/api/getHistoryTyresToID",s);return await i.json()}static async getParams(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/getSens",t);this.params=await s.json();const i=this.params.find((e=>"mileage"===e.params));return i?Number(i.value).toFixed(0):"-"}static async saveDataToDB(e){try{const t=await fetch("/api/saveDataModelTyres",{method:"POST",body:e});return await t.json(),"Модель сохранена"}catch(e){console.error("Error:",e)}}static async getModelTyresGuide(){const e=await fetch("/api/getModelTyresGuide",{method:"GET",headers:{"Content-type":"application/json"}});return await e.json()}static async findIdTyres(){const e=await fetch("/api/findLastIdTyres",{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json();let s;if(0===t.length)s="1idt";else{const e=t[0].idw_tyres;s=parseInt(e.replace("idt",""),10)+1+"idt"}return s}static async saveDataToDBTyres(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({obj:e})};try{const e=await fetch("/api/saveDataToDBTyres",t);return await e.json(),"Модель сохранена"}catch(e){console.error("Error:",e)}}static async saveDataHistoryToDBTyres(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({obj:e})};try{const e=await fetch("/api/saveDataHistoryToDBTyres",t);return await e.json(),"Модель сохранена"}catch(e){console.error("Error:",e)}}static async getAllTyres(){const e=await fetch("/api/getAllTyres",{method:"GET",headers:{"Content-type":"application/json"}});return await e.json()}static async updateDataInDB(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({obj:e})},s=await fetch("/api/updateDataInDB",t);return await s.json()}static async updateTyreSklad(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({obj:e})},s=await fetch("/api/updateTyreSklad",t);return await s.json()}static async updateWheel(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({obj:e})},s=await fetch("/api/updateWheel",t);return await s.json()}static async updateFilterTable(e,t,s,i){const a={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idObject:e,idBitrix:t,id:s,pressure:i})},n=await fetch("/api/updateFilterTable",a);return await n.json()}static async getHistoryValueWheel(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/getHistoryValueWheel",t);return await s.json()}}class Q{static getCurrentDate(){const e=new Date,t=e.getFullYear(),s=e.getMonth()+1,i=e.getDate();return`${i<10?`0${i}`:i}-${s<10?`0${s}`:s}-${t}`}static raschet(e,t){const s=e.querySelector(".sezon_type").value,i=e.querySelector(".protector_passport").value,a=[...t].map((e=>e.value)).filter((e=>null!=e&&""!==e)).map((e=>parseFloat(e))),n="Лето"===s?2:4;let r=(Math.min(...a)-n)/(i-n)*100;return r=Math.min(r,100),r.toFixed(1)}static viewRemark(e,t,s){console.log(e,t,s),e.textContent=s,e.style.color=t,setTimeout((()=>e.textContent=""),5e3)}static async mileageCalc(e,t,s){const i=await X.getParams(s);return{mileageTyres:Number(i)-Number(e)+Number(t),mileage:i}}static validationModelTyres(e){let t=!0;return["#type_tire","#marka","#model","#type_tyres","#radius","#profil","#width","#sezon","#index_speed","#index_massa"].forEach((s=>{e.querySelector(s).value.trim()||(t=!1)})),t}static protek(e){const t=[];return t.push(e.N1,e.N2,e.N3,e.N4),t.filter((e=>""!==e)).map((e=>Number(e)))}static tooltipView(e,t,s){s.querySelectorAll(`.${e}`).forEach((e=>{new g(e,[t])}))}static validatonPunctuation(e){e.addEventListener("input",(function(){if(e.value.includes(",")){const t=e.value.replace(",",".");e.value=t}}))}static renderProtektors(e,t){[{id:"#N1_wiew_chart",value:e.N1},{id:"#N2_wiew_chart",value:e.N2},{id:"#N3_wiew_chart",value:e.N3},{id:"#N4_wiew_chart",value:e.N4}].forEach((e=>{const s=t.querySelector(e.id);if(s)if(null===e.value||""===e.value)s.parentElement.style.display="none";else{s.parentElement.style.display="flex";const t=`${e.value} мм`;"input"===s.tagName.toLowerCase()?s.value=t:s.textContent=t}}))}static raschetProtector(e,t){const s=e.querySelector("#sezon_wiew").textContent,i=e.querySelector("#protektor_passport_wiew").value;if(!i)return null;const a=[...t].map((e=>e.value)).filter((e=>null!=e&&""!==e)).map((e=>parseFloat(e)));if(0===a.length)return null;const n="Лето"===s?2:4;let r=(Math.min(...a)-n)/(i-n)*100;return r=Math.min(r,100),r.toFixed(1)}static validateSelection(e){return"-"!==e.value||(e.classList.add("invalid"),setTimeout((()=>e.classList.remove("invalid")),1e3),!1)}static validationInput(e){const t=e.querySelectorAll(".valid_input");let s=!0;return t.forEach((e=>{e.value.trim()||(s=!1,e.style.border="1px solid red",setTimeout((()=>{e.style.border=""}),3e3))})),s}static addStruktura(e,t){const s=Number(e.price),i=Number(e.probeg_passport),a=Number(e.protektor_passport),n=t.map((e=>{const t=[e.N1,e.N2,e.N3,e.N4].filter((e=>""!==e&&null!==e)).map(Number);return{probegNow:Number(e.probeg_now),price:s,minN:t.length>0?Math.min(...t):null,id:e.id}})).filter((e=>null!==e.minN));console.log(n);const r=Array.from(new Map(n.map((e=>[e.minN,e]))).values());return Q.calculate(s,i,a,r)}static calcPrognozPobeg(e){const t=Math.min(...Q.protek(e)),s=Number(e.protektor_passport),i=Math.round(s/Number(e.probeg_passport)*1e5)/1e5;return(t/(t===s?i:Math.round((s-t)/Number(e.probeg_now)*1e5)/1e5)-Number(e.probeg_now)).toFixed(0)}static addContent(e,t){const s=Q.calcPrognozPobeg(t),i=e.querySelectorAll(".row_text_shina");i[0].textContent=`ID: ${t.idw_tyres}`,i[1].textContent=`Монтаж: ${t.dateInstall}`,i[2].textContent=`Остаток пробега: ${s} км`}static calculate(e,t,s,i){const a=e/s,n=Math.round(e/t*100)/100,r=Math.round(s/t*1e5)/1e5;return i.forEach(((l,o)=>{if(l.price===e&&l.minN===s||0==l.probegNow)l.priceOneKM=Math.round(e/t*100)/100,l.protektorOneKM=Math.round(s/t*1e5)/1e5,l.priceOneKMLine=l.priceOneKM,l.protektorOneKMLine=l.protektorOneKM,l.defaultPrice=n,l.defaultProtektor=r;else if(l.priceOneKM=Math.round((s-l.minN)*a/l.probegNow*100)/100,l.protektorOneKM=Math.round((s-l.minN)/l.probegNow*1e5)/1e5,l.defaultPrice=n,l.defaultProtektor=r,o>0){const e=i[o-1];l.priceOneKMLine=Math.round((e.minN-l.minN)*a/(l.probegNow-e.probegNow==0?1:l.probegNow-e.probegNow)*100)/100,l.protektorOneKMLine=Math.round((e.minN-l.minN)/(l.probegNow-e.probegNow==0?1:l.probegNow-e.probegNow)*1e5)/1e5}else l.priceOneKMLine=l.priceOneKM,l.protektorOneKMLine=l.protektorOneKM})),i}}const ee={B:50,C:60,D:65,E:70,F:80,G:90,J:100,K:110,L:120,M:130,N:140,P:150},te={pressureHigh:["Неравномерный износ (повышенное истирание центральной части протектора)","Снижение сопротивления к проколам и другим повреждениям","Вероятность появления пилообразного износа (для блочного типа рисунка протектора)","Уменьшение комфортности вождения","Увеличение риска повреждения элементов подвески автомобиля","Снижение управляемости автомобилем"],pressureLow:["Неравномерный износ (повышенное истирание боковых зон протектора)","Повышенный расход топлива","Риск изменения структуры резиновой смеси (в результате высоких температур) и расслоения","Отслоение в надбортовой зоне (раскрытие заворота каркаса)","Повышенный износ в зоне контакта с ободом","Снижение управляемости автомобилем"],speeding:["Увеличенный износ шины","Потеря устойчивости и управляемости","Риск аварийных ситуаций"]},se={5:"rgba(5, 159, 16, 0.8)",4:"rgba(5, 159, 16, 0.8)",3:"rgba(200, 202, 8, 0.8)",2:"rgba(205, 95, 5, 0.8)",1:"rgba(209, 3, 13, 0.8)"};class ie{static objColors={5:"rgba(5, 159, 16, 0.8)",4:"rgba(5, 159, 16, 0.8)",3:"rgba(200, 202, 8, 0.8)",2:"rgba(205, 95, 5, 0.8)",1:"rgba(209, 3, 13, 0.8)"};static gener(e){let t;return 100===e&&(t=5),e>=80&&e<100&&(t=4),e>=60&&e<80&&(t=3),e>=40&&e<60&&(t=2),e<40&&(t=1),t}static objSezon={Лето:"../../../../image/leto.png",Зима:"../../../../image/zima.png",Всесезонная:"../../../../image/vse.png"};static tyresRow=(e,t)=>{const s=t.find((t=>t[6].idObject===e.idObject)),i=void 0===s||null===s[6].gosnomer?"-":s[6].gosnomer;let a,n,r=e.ostatok.trim();const l=Math.min(...Q.protek(e))===1/0?"-":Math.min(...Q.protek(e));""===r?(n="rgba(6, 28, 71, 1)",a=0):(r=parseInt(r),a=ie.gener(r),n=ie.objColors[a]);const o="0"!==e.flag_status?this.statusTyres(e.flag_status):s?ie.createIconsCar(e,s,n):"",c=s?ie.calcValue(s,e):null,d=`${e.marka} ${e.model} R${e.radius} ${e.width}/${e.profil}   ${e.index_massa} ${e.index_speed}`,h="0"!==e.flag_status?`${e.probeg_now} км   ${e.idw_tyres}   ${e.dateInputSklad}`:`${i}  ${c} км   ${e.idw_tyres}   ${e.dateZamer}`,u=ie.objSezon[e.sezon],p=[1,2,3,4].slice(0,a).map((e=>`<div class="delenie" style="background-color: ${n};"></div>`)).join(""),m=[1,2,3,4].slice(a).map((e=>`<div class="delenie" style="border: 1px solid ${n};"></div>`)).join(""),y=`style="background-image: url(../../../..${e.imagePath})";`;return`<div class="row_sklad" marka='${e.marka}' model='${e.model}' radius='${e.radius}'\n       type='${e.type_tyres}' tire='${e.type_tire} psi='${e.psi}' protektorpassport='${e.protektor_passport}' massa='${e.index_massa}' speed='${e.index_speed}' sezon='${e.sezon}'\n        width='${e.width}' profil='${e.profil}' ostatok='${e.ostatok}' position='${e.identifikator}' status='${e.flag_status}'\n        rel="${e.idw_tyres}" nameCar="${e.nameCar}"data-att="${e.idObject}" minn="${l}"relid="${e.id_bitrix}">\n            <div class="left_wrap_sklad">\n                <div class="icon_tyres" ${y}></div>\n                <div class="ostatok_tyres">\n                    <div class="protektor_tyres">\n                        <div class="battery" style="border-color: ${n}; color: ${n};">\n                            ${m}  \x3c!-- Сначала сегменты без фона --\x3e\n                            ${p}    \x3c!-- Потом сегменты с фоном --\x3e\n                        </div>\n                    </div>\n                    <div class="protektor_tyres text_value" style="color: ${n};"> ${null!=r?r:""} %</div>\n                    <div class="protektor_tyres text_value" style="color: ${n};">${e.protektor_passport||""} мм</div>\n                </div>\n                <div class="sezon_tyres_and_type">\n                    <div class="sezon_tyres" style="background-image:url(${u});"></div>\n                    <div class="type_tyres">\n                      ${e.type_tyres}\n                    </div>\n                </div>\n            </div>\n            <div class="right_wrap_sklad">\n                <div class="cel_tyres_sklad up_element">${d}</div>\n                <div class="cel_tyres_sklad down_element">${h}</div>\n                     </div>\n                          <div class="right_model_wrap_sklad">\n${o}\n                     </div>\n        </div>`};static statusTyres(e){return{1:{element:'<i class="fas fa-database status_tyres" status="Склад" rel="1" flag="true"></i>',class:"fa-database",text:"На cкладе"},2:{element:'<i class="fas fa-tools status_tyres" status="Ремонт" rel="2" flag="false"></i>',class:"fa-tools",text:"В ремонте"},3:{element:'<i class="fas fa-trash status_tyres" status="Утилизация" rel="3" flag="false"></i>',class:"fa-trash",text:"Утилизация"}}[e].element}static calcValue(e,t){const s=e[2].result.find((e=>"mileage"===e.params)),i=s?s.value:"-";return Math.round(parseFloat(i))-Math.round(parseFloat(t.mileage))+Number(t.probeg_now)}static createIconsCar(e,t,s){const i=t[1].result,a=t[0].result,n=Number(e.identifikator);a.sort(((e,t)=>parseInt(e.osi)-parseInt(t.osi)));let r=1;const l=[];return a.forEach((({trailer:e,tyres:t})=>{l.push(ie.createOsElement(e,Number(t),r,n,s,i)),r+=Number(t)})),l.join("")}static createOsElement(e,t,s,i,a,n){let r=`<div class="centerOs_shema" rel="${e}"></div>`;const l=[];for(let e=0;e<t;e++){const t=s+e,r=t===i?`style="background-color: ${a};"`:"",o=t===i?n.filter((e=>Number(e.tyresdiv)===i)).map((e=>e.pressure))[0]:"";l.push(`<div class="tyres_shema"${r} rel="${o}"></div>`)}return 2===t?`<div class="osi_shema">\n                    ${l[0]}\n                    ${r}\n                    ${l[1]}\n                </div>`:`<div class="osi_shema">\n                 ${l[0]} ${l[1]}\n          <div class="centerOs_shema" style="width:4px" rel ="${e}"></div>\n                 ${l[2]} ${l[3]}\n                </div>`}static createWindowModelTyres(){return'   <div class="card_model_window">\n        <div class="header_card_model_window">Карточка модели колеса<i class="fas fa fa-times close_modal_window"></i>\n        </div>\n        <div class="body_card_model_window">\n            <div class="image_container">\n                <div class="discripiton_image">Изображение</div>\n                <div class="image_card" id="imageContainer"></div>\n                <input type="file" id="imageUpload" accept="image/*" style="display: none;">\n                <div class="load_image" id="uploadButton">Загрузить</div>\n            </div>\n\n            <div class="input-fields">\n                <div class="field-row">\n                    <div class="field-label">Тип шины</div>\n                    <input class="styled-input" type="text" id="type_tire"  autocomplete="off">\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Производитель</div>\n                    <input class="styled-input" type="text" id="marka"  autocomplete="off">\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Модель</div>\n                    <input class="styled-input" type="text" id="model"  autocomplete="off">\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Тип колеса</div>\n                    <input class="styled-input" type="text" id="type_tyres"  autocomplete="off">\n                </div>\n                   <div class="field-row">\n                    <div class="field-label">Сезонность</div>\n                    <input class="styled-input" type="text" id="sezon"  autocomplete="off">\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Радиус</div>\n                    <input class="styled-input" type="text" id="radius"  autocomplete="off">\n                </div>\n                  <div class="field-row">\n                    <div class="field-label">Ширина</div>\n                    <input class="styled-input" type="text" id="width"  autocomplete="off">\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Профиль</div>\n                    <input class="styled-input" type="text" id="profil"  autocomplete="off">\n                </div>\n              \n              <div class="field-row">\n                    <div class="field-label">Индекс нагрузки</div>\n                    <input class="styled-input" type="text" id="index_massa"  autocomplete="off">\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Индекс скорости</div>\n                    <input class="styled-input" type="text" id="index_speed"  autocomplete="off">\n                </div>\n               \n                         </div>\n        </div>\n        <div class="footer_card_model_window">\n            <div class="mess_validation"></div>\n            <div class="save_params">Сохранить</div>\n\n        </div>\n    </div>'}static createCardTyres(e){return`   <div class="card_model_tyres">\n        <div class="header_card_tyres">Карточка колеса</div>\n        <div class="body_card_tyres">\n            <div class="image_container">\n                <div class="discripiton_image">Изображение</div>\n                <div class="image_card_wiew" id="imageContainer_wiew"></div>\n                        </div>\n${e&&"0"!==e?this.statusTyres(e):""}\n            <div class="input-fields_wiew">\n                <div class="field-row">\n                    <div class="field-label">Тип шины</div>\n                    <div class="styled-input" type="text" id="type_tire_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Производитель</div>\n                    <div class="styled-input" type="text" id="marka_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Модель</div>\n                    <div class="styled-input" type="text" id="model_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Тип колеса</div>\n                    <div class="styled-input" type="text" id="type_tyres_wiew"></div>\n                </div>\n                  <div class="field-row">\n                    <div class="field-label">Сезонность</div>\n                    <div class="styled-input" type="text" id="sezon_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Радиус</div>\n                    <div class="styled-input" type="text" id="radius_wiew"></div>\n                </div>\n                   <div class="field-row">\n                    <div class="field-label">Ширина</div>\n                    <div class="styled-input" type="text" id="width_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Профиль</div>\n                    <div class="styled-input" type="text" id="profil_wiew"></div>\n                </div>\n                            <div class="field-row">\n                    <div class="field-label">Индекс нагрузки</div>\n                    <div class="styled-input" type="text" id="index_massa_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Индекс скорости</div>\n                    <div class="styled-input" type="text" id="index_speed_wiew"></div>\n                </div>\n                                          </div>\n           \n        <div class="footer_card_tyres">\n            <div class="mess_validation_wiew"></div>\n            <div class="reduct_params">Редактировать</div>\n            </div>\n\n            <div class="input-fields_params">\n                <div class="field-row">\n                    <div class="field-label">Цена*, руб.</div>\n                    <input class="styled-input valid_input vvod" type="text" id="price_tyres" autocomplete="off">\n                </div>\n                 <div class="field-row">\n                    <div class="field-label">Пробег по паспорту*, км</div>\n                    <input class="styled-input valid_input vvod" type="text" id="probeg_passport_wiew" autocomplete="off">\n                </div>\n                 <div class="field-row">\n                    <div class="field-label">Начальная высота протектора*, мм</div>\n                    <input class="styled-input valid_input vvod" type="text" id="protektor_passport_wiew" autocomplete="off">\n                </div>\n             <div class="field-row">\n                    <div class="field-label">Максимальное давление в PSI*</div>\n                    <input class="styled-input valid_input vvod" type="text" id="psi_wiew" autocomplete="off">\n                </div>\n                <div class="field-row center_body_list">\n                    <div class="field-label">Максимальное давление в Bar</div>\n                    <input class="styled-input" type="text" id="bar_wiew" readonly="disabled" autocomplete="off">\n                </div>\n                                              <div class="field-row">\n                    <div class="field-label">Текущий пробег, км</div>\n                    <input class="styled-input vvod" type="text" id="probeg_now_wiew" value="0" autocomplete="off">\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Остаточный пробег, км</div>\n                    <input class="styled-input vvod" type="text" id="probeg_last_wiew" autocomplete="off">\n                </div>\n                                 <div class="field-row">\n                    <div class="field-label">Высота протектора 1, мм</div>\n                    <input class="styled-input protektors vvod" type="text" id="N1" autocomplete="off">\n                </div>\n                 <div class="field-row">\n                    <div class="field-label">Высота протектора 2, мм</div>\n                    <input class="styled-input protektors vvod" type="text" id="N2" autocomplete="off">\n                </div>\n                 <div class="field-row">\n                    <div class="field-label">Высота протектора 3, мм</div>\n                    <input class="styled-input protektors vvod" type="text" id="N3" autocomplete="off">\n                </div>\n                 <div class="field-row">\n                    <div class="field-label">Высота протектора 4, мм</div>\n                    <input class="styled-input protektors vvod" type="text" id="N4" autocomplete="off">\n                </div>\n                  <div class="field-row center_body_list">\n                    <div class="field-label">Остаток протектора, %</div>\n                    <input class="styled-input vvod" type="text" id="ostatok" autocomplete="off">\n                </div>\n                  <div class="field-row">\n                    <div class="field-label">Код, RFID</div>\n                    <input class="styled-input" type="text" id="rfid_cod" autocomplete="off">\n                </div>\n              \n                  <div class="field-row">\n                    <div class="field-label">ID Bitrix</div>\n                    <input class="styled-input" type="text" id="id_bitrix_wiew" autocomplete="off">\n                </div>\n                 <div class="field-row">\n                    <div class="field-label">Комментарий</div>\n                    <input class="styled-input" type="text" id="comment" autocomplete="off">\n                </div>\n                             </div>\n        </div>\n        <div class="footer_card_model_window">\n            <div class="mess_validation"></div>\n            <div class="save_params">Сохранить</div>\n        </div>\n    </div>`}static modalValidation(e,t){const s=e.closest(".sklad_tyres"),i=e.getAttribute("rel"),a=e.closest(".container_shema"),n=t.closest(".container_shema");let r;return a&&n?r="\n        <div class=\"modal_podtver\">\n        <div class='header_podtver'>Подтверждение</div>\n          <div class='body_podtver_install'>Провести ротацию?</div>\n          <div class='button_podtver'>\n          <div class=\"ok_podtver\">Ок</div>\n          <div class=\"cancel_podtver\">Отмена</div>\n          </div>\n        </div>":s||i?s||i?r='\n    <div class="modal_podtver">\n    <div class=\'header_podtver\'>Подтверждение</div>\n    <div class=\'body_podtver\'>\n        <select id="actionSelect" class="styled-select">\n            <option value="-" disabled selected>Выберите действие</option>\n              <option value="1">На склад</option>\n                    <option value="2">В ремонт</option>\n            <option value="3">Утилизация</option>\n                      </select>\n        <textarea class="comm" placeholder="комментарии..."></textarea>\n    </div>\n    <div class=\'button_podtver\'>\n        <div class="ok_podtver">Ок</div>\n        <div class="cancel_podtver">Отмена</div>\n    </div>\n</div>\n':console.log("другие условия"):r="\n        <div class=\"modal_podtver\">\n        <div class='header_podtver'>Подтверждение</div>\n          <div class='body_podtver_install'>Установить колесо?</div>\n          <div class='button_podtver'>\n          <div class=\"ok_podtver\">Ок</div>\n          <div class=\"cancel_podtver\">Отмена</div>\n          </div>\n        </div>",r}static htmlContantModal(e){return`\n    <div class="modal_podtver">\n        <div class='header_podtver'>Подтверждение</div>\n        <div class='body_podtver'>\n            <select id="actionSelect" class="styled-select">\n                <option value="-" disabled selected>Выберите действие</option>\n                ${["1","2","3"].filter((t=>t!==e)).map((e=>`<option value="${e}">${"1"===e?"На склад":"2"===e?"В ремонт":"Утилизация"}</option>`)).join("")}\n            </select>\n            <textarea class="comm" placeholder="комментарии..."></textarea>\n        </div>\n        <div class='button_podtver'>\n            <div class="ok_podtver">Ок</div>\n            <div class="cancel_podtver">Отмена</div>\n        </div>\n    </div>`}static createCarWheel(){return'   <div class="card_model_tyres_wheel">\n            <div class="header_card_tyres_wheel">\n           <div class="image_container_wheel">\n                        <div class="image_card_wiew" id="imageContainer_wiew"></div>\n                        </div>\n                       <div class="protector">\n                    <div class="title_prot">График замера протектора</div>\n                    <div class="progressBar2">\n\n                        <div class="maxMMM"> \n                        <input class="styled-input mmtext" type="text" id="protektor_passport_wiew" autocomplete="off">\n                        </div>\n                        <p class="mm0">0</p>\n                        <div class="contBar22">\n                            <canvas id="drawLine2" height="60"></canvas>\n                        </div>\n                        <div class="contBar22">\n                            <canvas id="drawLine3" height="60"></canvas>\n                        </div>\n                        <div class="contBar22">\n                            <canvas id="drawLine4" height="60"></canvas>\n                        </div>\n                    </div>\n                    <div class="headerMM">\n                                                <div class="field-row_wheel">\n                                   <input class="styled-input protektors_wheel" type="text" id="N1" autocomplete="off">\n                </div>\n                 <div class="field-row_wheel">\n                                 <input class="styled-input protektors_wheel" type="text" id="N2" autocomplete="off">\n                </div>\n                 <div class="field-row_wheel">\n                                  <input class="styled-input protektors_wheel" type="text" id="N3" autocomplete="off">\n                </div>\n                 <div class="field-row_wheel">\n                                  <input class="styled-input protektors_wheel" type="text" id="N4" autocomplete="off">\n                </div>\n                    </div>\n                </div>\n        </div>\n        <div class="all_body">\n                <div class="body_card_tyres_wheel">\n                     <div class="input-fields_wiew">\n                <div class="field-row">\n                    <div class="field-label">Тип шины</div>\n                    <div class="styled-input" type="text" id="type_tire_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Производитель</div>\n                    <div class="styled-input" type="text" id="marka_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Модель</div>\n                    <div class="styled-input" type="text" id="model_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Тип колеса</div>\n                    <div class="styled-input" type="text" id="type_tyres_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Радиус</div>\n                    <div class="styled-input" type="text" id="radius_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Профиль</div>\n                    <div class="styled-input" type="text" id="profil_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Ширина</div>\n                    <div class="styled-input" type="text" id="width_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Сезонность</div>\n                    <div class="styled-input" type="text" id="sezon_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Индекс скорости</div>\n                    <div class="styled-input" type="text" id="index_speed_wiew"></div>\n                </div>\n                <div class="field-row">\n                    <div class="field-label">Индекс нагрузки</div>\n                    <div class="styled-input" type="text" id="index_massa_wiew"></div>\n                </div>\n                           </div>\n                            <div class="input-fields_params">\n                          <div class="field-row">\n                    <div class="field-label new_card_label">Рабочее давление в PSI</div>\n                    <input class="styled-input new_card_input" type="text" id="psi_wiew" autocomplete="off" disabled>\n                </div>\n                <div class="field-row">\n                    <div class="field-label new_card_label">Давление в Bar</div>\n                    <input class="styled-input new_card_input" type="text" id="bar_wiew" readonly="disabled" autocomplete="off">\n                </div>\n                                              <div class="field-row">\n                    <div class="field-label new_card_label">Текущий пробег, км</div>\n                    <input class="styled-input new_card_input" type="text" id="probeg_now_wiew" value="0" autocomplete="off" disabled>\n                </div>\n                <div class="field-row">\n                    <div class="field-label new_card_label">Остаточный пробег, км</div>\n                    <input class="styled-input new_card_input" type="text" id="probeg_last_wiew" autocomplete="off" disabled>\n                </div>\n                                <div class="field-row">\n                    <div class="field-label new_card_label">Остаток протектора, %</div>\n                    <input class="styled-input new_card_input" type="text" id="ostatok" autocomplete="off" disabled>\n                </div>\n                                <div class="field-row">\n                    <div class="field-label new_card_label">Комментарий</div>\n                    <input class="styled-input new_card_input" type="text" id="comment" autocomplete="off">\n                </div>\n                             </div>\n        </div>\n<div class="analitika_wheel"><div class="child_chart"></div></div>\n        </div>\n        <div class="footer_card_model_window">\n            <div class="mess_validation"></div>\n            <div class="save_params">Сохранить</div>\n        </div>\n    </div>'}static contentVisualWheel(){return'<div class="wrapper_visual_wheel"><div class="header_card_tyres">Информация</div>\n                        <div class="protector wheel_card">\n                        <div class="dannie_wheel_info">\n                        <div class="info_discription"></div>\n                             <div class="info_discription"></div>\n                                  <div class="info_discription"></div>\n                                     <div class="info_discription"></div>\n                        </div>\n                        <div class="right_container_chart">\n                            <div class="title_prot right_chart">График замера протектора</div>\n                            <div class="progressBar2 right_chart">\n                                <div class="maxMMM">\n                                    <div class="styled-input mmtext" id="protektor_passport_wiew_chart"></div>\n                                </div>\n                                <p class="mm0">0</p>\n                                <div class="contBar22">\n                                    <canvas id="drawLine2" height="60"></canvas>\n                                </div>\n                                <div class="contBar22">\n                                    <canvas id="drawLine3" height="60"></canvas>\n                                </div>\n                                <div class="contBar22">\n                                    <canvas id="drawLine4" height="60"></canvas>\n                                </div>\n                            </div>\n                               <div class="headerMM">\n                                                <div class="field-row_wheel row_wheel_sklad">\n                                 <div class="styled-input protektors_wheel"id="N1_wiew_chart"></div>\n                </div>\n                 <div class="field-row_wheel row_wheel_sklad">\n                              <div class="styled-input protektors_wheel"id="N2_wiew_chart"></div>\n                </div>\n                 <div class="field-row_wheel row_wheel_sklad">\n                                    <div class="styled-input protektors_wheel"id="N3_wiew_chart"></div>\n                </div>\n                 <div class="field-row_wheel row_wheel_sklad">\n                                    <div class="styled-input protektors_wheel"id="N4_wiew_chart"></div>\n                </div>\n                    </div></div>\n                        </div>\n                        <div class="analitika_wheel card_wheel">\n                            <div class="child_chart card_wheel_chart">\n                            <div class="legend_wheel_chart">\n    <div class="legend-item">\n        <span class="dot green"></span>\n        <span class="label">Выбранный замер</span>\n    </div>\n      <div class="legend-item">\n        <span class="dot contur"></span>\n        <span class="label">Замеры протектора</span>\n    </div>\n    <div class="legend-item">\n        <span class="line_wheel dashed_red"></span>\n        <span class="label">Прогноз остатка пробега</span>\n    </div>\n    <div class="legend-item">\n        <span class="line_wheel dashed_blue"></span>\n        <span class="label">Расчетный пробег</span>\n    </div>\n    <div class="legend-item">\n        <span class="line_wheel solid bold"></span>\n        <span class="label">Выбранный сегмент пробега</span>\n    </div>\n    <div class="legend-item">\n        <span class="line_wheel thin"></span>\n        <span class="label">Сегмент пробега</span>\n    </div>\n</div></div>\n                            <div class="list_data_time">\n                            <div class="header_list_data_time">Замеры</div>\n                             <div class="body_zamer">\n                             \n                             </div>\n                            </div>\n                        </div>\n                        <div class="table_ishue"> \n                        <div class="dannie_stat pressure_stat">\n                        <div class="header_stat">Данные по давлению</div>\n                        <table class="table_stata">\n                            <tr class="rows_stata">\n                                                             <th class="cell_stata cel">Ожидание</th>\n                                <th class="cell_stata cel">Низкое</th>\n                                <th class="cell_stata cel">Ниже нормы</th>\n                                <th class="cell_stata cel">Норма</th>\n                                <th class="cell_stata cel">Выше нормы</th>\n                                <th class="cell_stata cel">Высокое</th>\n                                <th class="cell_stata cel">Всего</th>\n                            </tr>\n                        </table>\n                        <div class="description_wheel"></div>\n                     \n                        </div>\n                         <div class="dannie_stat speed_stat">\n                           <div class="header_stat">Данные по скорости</div>\n                         <table class="table_stata">\n                            <tr class="rows_stata">\n                             <th class="cell_stata cel">В норме</th>\n                                <th class="cell_stata cel">Превышение</th>\n                                <th class="cell_stata cel">Всего</th>\n                            </tr>\n                        </table>\n                        <div class="description_wheel"></div>\n                                              </div>\n                        </div>\n                        </div>'}static addContainerCharts(e){const t=document.createElement("div");t.classList.add("progressBar2"),t.setAttribute("rel",e);const s=["drawLine2","drawLine3","drawLine4"];for(let e=0;e<s.length;e++){const i=document.createElement("div");i.classList.add("contBar22");const a=document.createElement("canvas");a.classList.add(s[e]),a.id=s[e],a.height=60,i.appendChild(a),t.appendChild(i)}return t.appendChild(ie.addDiscriptionWheel(e)),t}static addDiscriptionWheel(e){const t=document.createElement("div");t.classList.add("discription_shina_wrap"),t.setAttribute("rel",e);for(let e=0;e<3;e++){const e=document.createElement("div");e.classList.add("row_text_shina"),t.appendChild(e)}return t}static renderDiscription(e){return te[e].map((e=>`<li class='list_discription'>${e}</li>`)).join("")}}class ae{constructor(e,t,s){this.data=e,this.containerCard=t,this.monitoring=s}async init(){await this.getHistoryData(),this.uniqueDataWithPrice=Q.addStruktura(this.data,this.historyWheel),this.chartLine(this.data.probeg_passport,this.data.protektor_passport)}async getHistoryData(){this.historyWheel=await X.getHistoryTyresidTyres(this.data.idw_tyres)}clearContainer(){const e=this.containerCard.querySelector(".tooltip_tochka");e&&e.remove(),d3.select(this.containerCard.querySelector(".child_chart")).select(".chart_wheel").remove()}chartLine(e,t){this.clearContainer();const s=Math.floor(parseFloat(this.uniqueDataWithPrice[this.uniqueDataWithPrice.length-1].minN)/parseFloat(this.uniqueDataWithPrice[this.uniqueDataWithPrice.length-1].protektorOneKM)),i=this;const a=d3.select(this.containerCard.querySelector(".child_chart")).append("svg").attr("width",360).attr("class","chart_wheel").attr("height",280).append("g").attr("transform","translate(30,20)"),n=this.uniqueDataWithPrice.find((t=>t.probegNow>e)),r=n?n.probegNow:null;var l=d3.scaleLinear().range([0,280]).domain([0,n?Number(r+2e4):e]),o=d3.scaleLinear().range([240,0]).domain([1,t]),c=d3.axisBottom(l).tickFormat((e=>e/1e3));a.append("g").attr("transform","translate(0,240)").call(c);var d=d3.axisLeft(o).ticks(10);a.append("g").call(d),a.append("text").attr("text-anchor","end").attr("x",330).attr("y",255).style("font-weight","bold").text("10").append("tspan").attr("dy","-0.5em").attr("font-size","0.8em").style("font-weight","bold").text("3").append("tspan").attr("dy","0.2em").attr("dx","0.2em").style("font-weight","bold").text("км"),a.append("text").attr("text-anchor","end").attr("transform","rotate(0)").attr("y",-10).attr("x",-5).style("font-weight","bold").text("мм");const h=d3.line().x((e=>l(e.probegNow))).y((e=>o(e.minN)));a.append("path").datum(this.uniqueDataWithPrice).attr("fill","none").attr("stroke","blue").attr("stroke-width",1.5).attr("d",h),a.append("line").attr("x1",l(0)).attr("y1",o(t)).attr("x2",l(s)).attr("y2",o(1)).style("stroke","darkred").attr("stroke-dasharray","5,5").attr("stroke-width",1.5),a.append("line").attr("x1",l(0)).attr("y1",o(t)).attr("x2",l(e)).attr("y2",o(1)).style("stroke","blue").attr("stroke-dasharray","5,5").attr("stroke-width",1.5);const u=d3.select(this.containerCard.querySelector(".analitika_wheel")).append("div").attr("class","tooltip_tochka").style("position","absolute").style("opacity",0);for(let e=1;e<=2;e++){const t=u.append("div").classed(`tooltip_element tooltip_element${e}`,!0);t.append("div").classed(`tooltip_element_title tooltip_element${e}_title`,!0),t.append("div").classed(`tooltip_element_value tooltip_element${e}_value`,!0),t.append("div").classed(`tooltip_element_value_otklonenie tooltip_element${e}_value_otklonenie`,!0)}for(let e=0;e<this.uniqueDataWithPrice.length-1;e++){const t={current:this.uniqueDataWithPrice[e],next:this.uniqueDataWithPrice[e+1]};a.append("line").attr("class","segment").attr("x1",l(this.uniqueDataWithPrice[e].probegNow)).attr("y1",o(this.uniqueDataWithPrice[e].minN)).attr("x2",l(this.uniqueDataWithPrice[e+1].probegNow)).attr("y2",o(this.uniqueDataWithPrice[e+1].minN)).attr("data-id",this.uniqueDataWithPrice[e+1].id).style("stroke","blue").style("cursor","pointer").attr("stroke-width",2.5).on("click",(function(e){if(i.monitoring){const e=((t.next.protektorOneKMLine-t.current.defaultProtektor)/t.current.defaultProtektor*100).toFixed(1),s=((t.next.priceOneKMLine-t.current.defaultPrice)/t.current.defaultPrice*100).toFixed(1);d3.selectAll(".segment").attr("stroke-width",2.5),d3.select(this).attr("stroke-width",4),u.style("opacity",1),i.setTooltipText(u.select(".tooltip_element1"),"Стоимость пробега за 1 км:",`${t.next.priceOneKMLine} руб.`,s),i.setTooltipText(u.select(".tooltip_element2"),"Износ протектора за 1 км:",`${t.next.protektorOneKMLine} мм`,e)}}))}a.selectAll(".dot").data(this.uniqueDataWithPrice).enter().append("circle").attr("class","dot").attr("cx",(e=>l(e.probegNow))).attr("cy",(e=>o(e.minN))).attr("data-id",(e=>e.id)).attr("r",4).style("fill","white").style("cursor","pointer").style("stroke","green").on("click",(function(e){if(i.monitoring){a.selectAll(".dot").style("fill","white").attr("r",4),d3.select(this).style("fill","green").attr("r",5);const t=((e.protektorOneKM-e.defaultProtektor)/e.defaultProtektor*100).toFixed(1),s=((e.priceOneKM-e.defaultPrice)/e.defaultPrice*100).toFixed(1);d3.event,u.style("opacity",1),i.setTooltipText(u.select(".tooltip_element1"),"Стоимость пробега за 1 км:",`${e.priceOneKM} руб.`,s),i.setTooltipText(u.select(".tooltip_element2"),"Износ протектора за 1 км:",`${e.protektorOneKM} мм`,t)}})),this.monitoring&&this.lastDot(a,u)}lastDot(e,t){const s=this.uniqueDataWithPrice.length-1,i=this.uniqueDataWithPrice[s];t.style("opacity",1),e.select(`circle[data-id='${i.id}']`).style("fill","green").attr("r",5);const a=((i.protektorOneKM-i.defaultProtektor)/i.defaultProtektor*100).toFixed(1),n=((i.priceOneKM-i.defaultPrice)/i.defaultPrice*100).toFixed(1);t.style("opacity",1),this.setTooltipText(t.select(".tooltip_element1"),"Стоимость пробега за 1 км:",`${i.priceOneKM} руб.`,n),this.setTooltipText(t.select(".tooltip_element2"),"Износ протектора за 1 км:",`${i.protektorOneKM} мм`,a)}setTooltipText(e,t,s,i){e.select(".tooltip_element_title").text(t),e.select(".tooltip_element_value").text(`${s}`);const a=Number(i)>0?"+":"",n=e.select(".tooltip_element_value_otklonenie").text(`${a}${i} %`);i>0?n.style("color","red"):i<0?n.style("color","green"):n.style("color","black")}}class ne{constructor(e){this.tyres=e,this.login=document.querySelectorAll(".log")[1].textContent,this.techInfo=document.querySelector(".techInfo"),this.containerCard=document.querySelector(".tth"),this.boundSave=this.saveTyresAndParams.bind(this),this.init()}async init(){this.createCardTyres();const e=this.paramsGeneration();if(this.dannieWheel=await X.getTyresPosition(e),0!==this.dannieWheel.length){this.wiewDataTyres(),this.protektorsEvent(),this.addChartProtektor();const e=new ae(this.dannieWheel,this.containerCard,"monitoring");await e.init(),this.initEvent()}else Q.viewRemark(this.message,"red","Шина не установлена")}createCardTyres(){this.containerCard.innerHTML=ie.createCarWheel(),this.save=this.containerCard.querySelector(".save_params"),this.message=this.containerCard.querySelector(".mess_validation")}paramsGeneration(){return{identifikator:this.tyres.id,idObject:document.querySelector(".color").id}}async wiewDataTyres(){const e=this.dannieWheel.imagePath?`url('../../../..${this.dannieWheel.imagePath}')`:"url('../../../../image/zeto_tyres.png')";this.containerCard.querySelector("#imageContainer_wiew").style.backgroundImage=e;const t=[{id:"#type_tire_wiew",value:this.dannieWheel.type_tire},{id:"#marka_wiew",value:this.dannieWheel.marka},{id:"#model_wiew",value:this.dannieWheel.model},{id:"#type_tyres_wiew",value:this.dannieWheel.type_tyres},{id:"#radius_wiew",value:this.dannieWheel.radius},{id:"#profil_wiew",value:this.dannieWheel.profil},{id:"#width_wiew",value:this.dannieWheel.width},{id:"#sezon_wiew",value:this.dannieWheel.sezon},{id:"#index_speed_wiew",value:this.dannieWheel.index_speed},{id:"#index_massa_wiew",value:this.dannieWheel.index_massa},{id:"#psi_wiew",value:this.dannieWheel.psi},{id:"#bar_wiew",value:this.dannieWheel.bar},{id:"#protektor_passport_wiew",value:this.dannieWheel.protektor_passport},{id:"#probeg_now_wiew",value:this.dannieWheel.probeg_now},{id:"#probeg_last_wiew",value:this.dannieWheel.probeg_last},{id:"#N1",value:this.dannieWheel.N1},{id:"#N2",value:this.dannieWheel.N2},{id:"#N3",value:this.dannieWheel.N3},{id:"#N4",value:this.dannieWheel.N4},{id:"#ostatok",value:this.dannieWheel.ostatok},{id:"#comment",value:this.dannieWheel.comments}];this.protektor=[this.dannieWheel.N1,this.dannieWheel.N2,this.dannieWheel.N3,this.dannieWheel.N4,this.dannieWheel.ostatok],t.forEach((e=>{const t=this.containerCard.querySelector(e.id);t&&("input"===t.tagName.toLowerCase()?t.value=e.value:t.textContent=e.value)})),this.probeg=await Q.mileageCalc(this.dannieWheel.mileage,this.dannieWheel.probeg_now,this.dannieWheel.idObject),this.containerCard.querySelector("#probeg_now_wiew").value=this.probeg.mileageTyres}protektorsEvent(){const e=this.containerCard.querySelectorAll(".protektors_wheel"),t=this.containerCard.querySelector("#ostatok");e.forEach((s=>{s.addEventListener("input",(s=>{Q.validatonPunctuation(s.target),t.value=Q.raschetProtector(this.containerCard,e)}))}))}initEvent(){this.save.addEventListener("click",this.boundSave)}async saveTyresAndParams(){const e=this.containerCard.querySelector(".protector").querySelectorAll(".styled-input"),t=this.getObject(e);console.log(t),await X.updateWheel(t),Q.viewRemark(this.message,"green","Изменения сохранены"),pro=[...e].filter((e=>""!==e.value)).map((e=>e.value)),pro.shift();const s=this.containerCard.querySelectorAll(".contBar22");f(pro,this.dannieWheel.protektor_passport,s,this.dannieWheel.ostatok,1.5);const i=new ae(this.dannieWheel,this.containerCard,"monitoring");await i.init()}getObject(e){const t=this.containerCard.querySelector(".input-fields_params").querySelectorAll(".styled-input"),s={};return t.forEach((e=>s[e.getAttribute("id")]=e.value)),s.idw_tyres=this.dannieWheel.idw_tyres,s.login=document.querySelectorAll(".log")[1].textContent,s.dateZamer=this.compareProtektor(s)?this.dannieWheel.dateZamer:Q.getCurrentDate(),s.flag_status=this.dannieWheel.flag_status,s.price_tyres=this.dannieWheel.price,s.probeg_passport_wiew=this.dannieWheel.probeg_passport,s.rfid=this.dannieWheel.rfid,s.id_bitrix=this.dannieWheel.id_bitrix,s.mileage=this.probeg.mileage,e.forEach((e=>s[e.getAttribute("id")]=e.value)),s}compareProtektor(e){const t=[e.N1,e.N2,e.N3,e.N4,e.ostatok];return this.protektor.every(((e,s)=>t[s]===e))}async addChartProtektor(){const e=[];e.push(this.dannieWheel.N1,this.dannieWheel.N2,this.dannieWheel.N3,this.dannieWheel.N4);const t=e.filter((e=>""!==e)).map((e=>e)),s=this.containerCard.querySelectorAll(".contBar22");f(t,this.dannieWheel.protektor_passport,s,this.dannieWheel.ostatok,1.5)}}class re{constructor(){this.getDOM(),this.clearText(),this.initEventListener(),this.instance=null}getDOM(){this.sensors=document.querySelector(".sensors"),this.wrapperMap=document.querySelector(".wrapper_left"),this.tiresLink=document.querySelectorAll(".tires_link_test"),this.techInfo=document.querySelector(".techInfo"),this.grafics=document.querySelector(".grafics"),this.plug=document.querySelectorAll(".plug"),this.tableTarir=document.querySelector(".tableTarir"),this.idbaseTyres=document.querySelector(".idbaseTyres"),this.wright=document.querySelector(".wrapper_right"),this.widthWind=document.querySelector("body").offsetWidth}clearText(){}initEventListener(){this.tiresLink.forEach((e=>e.addEventListener("click",this.operation.bind(this,e))))}hideElements(){this.techInfo.style.display="none",this.tableTarir.style.display="none",this.sensors.style.display="none",this.wrapperMap.style.display=this.widthWind>=860?"block":"none",this.grafics.style.display="none"}operation(e){const t=document.querySelector(".acto");if(t?.classList.remove("acto"),this.hideElements(),e.classList.contains("tiresActiv"))return e.classList.remove("tiresActiv"),void(this.plug[1].classList.contains("activGraf")&&(this.grafics.style.display="flex",this.wrapperMap.style.display="none"));this.tiresLink.forEach((e=>e.classList.remove("tiresActiv"))),e.classList.add("tiresActiv"),document.getElementById("check_Title").checked&&(this.sensors.style.display="flex",this.controllObo(),this.close(),new T(this.sensors),this.wright.style.zIndex=2,document.querySelector(".popup-background").style.display="block"),this.techInfo.style.display="block",this.tableTarir.style.display="none",this.grafics.style.display="none",this.wrapperMap.style.display="none",new ne(e)}controllObo(){this.btnsens=document.querySelectorAll(".btnsens"),this.titleSens=document.querySelector(".title_sens"),this.obo=document.querySelector(".obo"),this.btnsens.forEach((e=>{e.addEventListener("click",(()=>{this.btnsens.forEach((e=>e.classList.remove("actBTN"))),e.classList.add("actBTN"),this.obo.style.display="flex",this.titleSens.style.display="block"}))}))}close(){document.querySelector(".closeIconConfig").addEventListener("click",(()=>{const e=document.querySelector(".tiresActivt");e&&e.classList.remove("tiresActivt");const t=document.querySelector(".tiresActiv");t&&t.classList.remove("tiresActiv");const s=document.querySelector(".acto");s&&s.classList.remove("acto"),document.querySelector(".actBTN")&&document.querySelector(".actBTN").classList.remove("actBTN"),this.sensors.style.display="none",this.wright.style.zIndex=0,document.querySelector(".popup-background").style.display="none"}))}}class le{constructor(e,t){[this.model,this.tyres,this.params,this.osi]=e,this.id=t,this.pressureOsInstance=null,this.configurator=null,this.controllTyresInstance=null,this.viewTyresValueInstance=null,this.init()}init(){0!==this.model.length&&(new J(this.model),this.viewTyresValueInstance&&this.viewTyresValueInstance.clearInterval(),this.viewTyresValueInstance=new U(this.tyres,this.params,this.osi),this.controllTyresInstance=new re),le.pressureOsInstance?le.pressureOsInstance.reinitialize(this.id):le.pressureOsInstance=new K(this.id),le.configurator?le.configurator.reinitialize(this.id):le.configurator=new Z(this.id)}reinitialize(e,t){this.id=t,[this.model,this.tyres,this.params,this.osi]=e;const s=this.getControllInstance();console.log(s),s&&s.instance&&s.instance.destroy(),this.init()}getControllInstance(){return this.controllTyresInstance}}let oe=!1;class ce{constructor(e,t,s){this.info=s,this.model=s[0],this.t1=e,this.t2=t,this.data=null,this.graf=null,this.charts=null,this.char=null,this.x=null,this.svgContainers=[],this.svg=null,this.legendBar=null,this.init()}async init(){if(oe)return Promise.reject(new Error("Запрос отменен"));if(oe=!0,this.data=await this.createStructura(),console.log(this.data),0===this.data.length){document.querySelector(".noGraf").style.display="block";const e=document.querySelector(".infoGraf");return e&&e.remove(),document.querySelector(".loaders_charts").style.display="none",void(oe=!1)}this.createChart()}createChart(){this.createContainer(),this.createLegend(),this.createBodyCharts(),this.createIconsCar(),this.toggleChecked(),document.querySelector(".loaders_charts").style.display="none",oe=!1}createBodyCharts(){const e=document.querySelector("body").offsetWidth,t=e>=860?780:e-80,s=50,i=this.charts.size(),a=document.querySelector(".infoGraf"),n=document.createElement("div");n.classList.add("chart-tooltips"),a.appendChild(n),this.charts.each(((e,a,n)=>{const r=d3.select(n[a]),l=e,o=a===i-1,c=o?80:s,d=r.append("div").attr("class","graf"),h=d.append("svg").attr("width",t+10+10).attr("height",c).attr("rel",e.sens).append("g").attr("transform","translate(10,0)");r.append("div").attr("class","toolyStatic"+(o?" last":"")).text("-Бар/-С°");const u=d3.scaleTime().domain(d3.extent(l.val,(e=>new Date(e.dates)))).range([0,t]);this.x=u;const p=d3.scaleLinear().domain([0,15]).range([s,0]),m=d3.scaleLinear().domain(d3.extent(l.val,(e=>e.tvalue))).range([s,0]),y=d3.axisBottom(u),g=d3.area().x((e=>u(e.dates))).y0(s).y1((e=>p(e.value))).curve(d3.curveStep),v=void 0!==e.bar?Number(e.bar.knd).toFixed(1):null,f=void 0!==e.bar?Number(e.bar.dvn).toFixed(1):null,b=void 0!==e.bar?Number(e.bar.dnn).toFixed(1):null,w=void 0!==e.bar?Number(e.bar.kvd).toFixed(1):null,S=d3.area().x((e=>u(e.dates))).y0(s).y1((e=>e.value>v&&e.value<=b||e.value>f&&e.value<=w?p(e.value):s)).curve(d3.curveStep),_=d3.area().x((e=>u(e.dates))).y0(s).y1((e=>e.value<=v||e.value>=w?p(e.value):s)).curve(d3.curveStep),k=d3.area().x((e=>u(e.dates))).y0(s).y1((e=>m(e.tvalue))).curve(d3.curveStep);h.append("g").attr("class","osx").attr("transform","translate(0,50)").attr("height",300).transition().duration(1e3).call(y.ticks(10).tickFormat((function(e){return d3.timeFormat("%H:%M")(e)}))),h.append("g").attr("transform","translate(0, 60)").attr("class","osx2").call(y.ticks(10).tickFormat((function(e){return d3.timeFormat("%d.%m")(e)}))).style("stroke-width",0),h.append("g").attr("class","os1y"),h.append("g").attr("class","os2y").attr("transform","translate("+t+", 0)"),h.append("path").datum(l.val).transition().duration(1e3).attr("d",g).attr("fill",(function(e){return d3.select(".inputPress").property("checked")?"darkgreen":"#009933"})).attr("class","area1").attr("stroke","black").attr("stroke-width",1).attr("fill-opacity",1).style("display",this.legendBar[0].classList.contains("noActive")?"none":"block"),h.append("path").datum(l.val).attr("class","area11").transition().duration(1e3).attr("d",S).attr("fill",(function(e){return d3.select(".inputPress").property("checked")?"#e8eb65":"#009933"})).attr("stroke-width",1).attr("fill-opacity",.9).style("display",this.legendBar[0].classList.contains("noActive")?"none":"block"),h.append("path").datum(l.val).attr("class","area12").transition().duration(1e3).attr("d",_).attr("fill",(function(e){return d3.select(".inputPress").property("checked")?"darkred":"#009933"})).attr("fill-opacity",-.1===e.value?0:.9).style("display",this.legendBar[0].classList.contains("noActive")?"none":"block"),h.append("path").datum(l.val).attr("fill","none").attr("class","pat").attr("class","area2").attr("fill-opacity",.3).attr("stroke","blue").attr("stroke-width",1).transition().duration(1e3).attr("d",k).style("display",this.legendBar[1].classList.contains("noActive")?"none":"block"),this.svgContainers.push([d,h,u,p,m,s,l]),this.createTooltip(d,h,l.val,u)}))}setupZoom(){const e=document.querySelector(".inputAllPress").checked,t=d3.zoom().scaleExtent([1,10]).on("zoom",(()=>{const t=d3.event.transform;this.svgContainers.forEach((([s,i,a,n,r,l,o])=>{if(e){const e=t.rescaleX(a);this.zoomed(i,e,n,r,l,o,s)}else if(d3.select(d3.event.sourceEvent.target).node().closest(".graf")===s.node()){const e=t.rescaleX(a);this.zoomed(i,e,n,r,l,o,s)}}))}));this.svgContainers.forEach((([e])=>e.call(t))),d3.selectAll(".graf").call(t)}toggleChecked(){document.querySelector(".inputAllPress").addEventListener("change",this.setupZoom.bind(this)),this.setupZoom(),document.querySelector(".comback").addEventListener("click",(()=>{this.resetZoom()}))}resetZoom(){this.svgContainers.forEach((([e,t,s,i,a,n,r])=>{this.zoomed(t,s,i,a,n,r,e)}))}zoomed(e,t,s,i,a,n,r){requestAnimationFrame((()=>{e.select(".osx").call(d3.axisBottom(t).tickFormat(d3.timeFormat("%H:%M"))),e.select(".osx2").call(d3.axisBottom(t).tickFormat(d3.timeFormat("%d.%m")));const l=d3.area().x((e=>t(new Date(e.dates)))).y0(a).y1((e=>s(e.value))).curve(d3.curveStep);e.selectAll(".area1").attr("d",l(n.val));const o=d3.area().x((e=>t(new Date(e.dates)))).y0(a).y1((e=>e.value>n.bar.knd&&e.value<=n.bar.dnn||e.value>n.bar.dvn&&e.value<=n.bar.kvd?s(e.value):a)).curve(d3.curveStep);e.selectAll(".area11").attr("d",o(n.val));const c=d3.area().x((e=>t(new Date(e.dates)))).y0(a).y1((e=>e.value<=n.bar.knd||e.value>=n.bar.kvd?s(e.value):a)).curve(d3.curveStep);e.selectAll(".area12").attr("d",c(n.val));const d=d3.area().x((e=>t(new Date(e.dates)))).y0(a).y1((e=>i(e.tvalue))).curve(d3.curveStep);e.selectAll(".area2").attr("d",d(n.val)),this.createTooltip(r,e,n.val,t)}))}createTooltip(e,t,s,i){const a=this.graf.querySelector(".chart-tooltips");e.on("mouseout",(()=>{a.style.display="none",t.node().closest(".chart").firstElementChild.style.border="1px solid black"})).on("mousemove",function(){this.handleMouseMove(s,i,a,t.node())}.bind(this)).on("click",function(){this.handleMouseClick(s,i,t.node())}.bind(this))}handleMouseClick(e,t,s){const[i,a]=d3.mouse(s),n=this.findClosestDataIndex(i,e,t);new q([],n[2],"bar"),document.querySelector(".infoGraf").addEventListener("click",(function(e){e.stopPropagation()})),document.addEventListener("click",(function(e){const t=e.target,s=document.querySelector(".activMenuGraf").textContent,i=document.querySelector(".wrapMap");i&&!i.contains(t)&&"Давление"===s&&i.remove()}))}handleMouseMove(e,t,s,i){const a=d3.event,[n,r]=d3.mouse(i),l=this.findClosestDataIndex(n,e,t),o=e[l[1]],c=this.timeFormats(l[0]);s.innerHTML=`<div class="title_tooltip">${c}</div>\n            <div class="body_tooltips"><i class='fas fa-tachometer-alt icon_tool'><span class='spanVal'>${o.speed} км/ч</span></i>\n            <i class='fas fa-life-ring icon_tool'><span class='spanVal'>${-.1===o.value?"Потеря связи с датчиком":o.value} Бар</span></i>\n            <i class='fas fa-temperature-high icon_tool'><span class='spanVal'>${-.1===o.tvalue?"Потеря связи с датчиком":o.tvalue} t°</span></i>\n            <i class='fas fa-key icon_tool'><span class='spanVal'>${o.stop}</span></i> </div>`;const d=a.pageX,h=a.pageY;s.style.left=d-730+"px",s.style.top=h-150+"px",s.style.display="flex",i.closest(".chart").firstElementChild.style.border="2px solid rgba(6, 28, 71, 1)",this.globalTooltip(l[0])}findClosestDataIndex(e,t,s){const i=s.invert(e),a=t.map((e=>new Date(e.dates).getTime()));let n=(0,d3.bisector((e=>e)).left)(a,i);if(a[n]===i.getTime())return[t[n].dates,n,t[n]];const r=n-1<0?0:n-1,l=n>=a.length?a.length-1:n;return Math.abs(i.getTime()-a[r])<=Math.abs(a[l]-i.getTime())?[t[r].dates,r,t[r]]:[t[l].dates,l,t[l]]}globalTooltip(e){const t=[];this.data.forEach((s=>{const i=s.val.find((t=>t.dates.getTime()===e.getTime()));i&&t.push({sens:s.sens,value:i.value,tvalue:i.tvalue,speed:i.speed,time:i.dates})})),document.querySelectorAll(".chart").forEach(((e,s)=>{const i=t[s]||{value:-.1,tvalue:-.1},a=-.1===i.value?"-":i.value,n=-.1===i.tvalue?"-":i.tvalue;e.children[2].textContent=`${a} Бар/${n} С°`}))}timeFormats(e){const t=Math.floor(new Date(e).getTime()/1e3),s=new Date(1e3*t);return`${s.getDate().toString().padStart(2,"0")}.${(s.getMonth()+1).toString().padStart(2,"0")}.${s.getFullYear()} ${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}:${s.getSeconds().toString().padStart(2,"0")}`}createIconsCar(){this.char=this.graf.querySelectorAll(".chart");const e=[...this.char].map((e=>{const t=document.createElement("div");return t.classList.add("im1"),e.prepend(t),t}));this.char[this.char.length-1].children[0].classList.add("last"),this.model.sort(((e,t)=>parseInt(e.osi)-parseInt(t.osi))),e.forEach(((e,t)=>{this.model.forEach((({trailer:t,tyres:s})=>{const i=this.createOsElement(t,+s);e.appendChild(i)}));const s=e.querySelectorAll(".tyresChart");s.length>0&&(s[t%s.length].style.background="black"),new g(e,[e.nextElementSibling.children[0].getAttribute("rel")])}))}createOsElement(e,t){const s=document.createElement("div");s.classList.add("osChart");const i=document.createElement("div");if(i.classList.add("centerChartOs"),i.setAttribute("rel",e),s.appendChild(i),2===t){for(let e=0;e<t;e++){const e=document.createElement("div");e.classList.add("tyresChart"),s.appendChild(e)}s.insertBefore(s.children[1],s.children[0])}else{for(let e=0;e<t;e++){const e=document.createElement("div");e.classList.add("tyresChart"),s.appendChild(e)}s.insertBefore(s.children[1],s.children[0]),s.insertBefore(s.children[2],s.children[1]),s.children[2].style.width="4px"}return s}createContainer(){this.graf=document.createElement("div");const e=document.querySelector(".grafics");this.graf.classList.add("infoGraf"),e.appendChild(this.graf);const t=document.createElement("div");t.classList.add("infos"),this.graf.prepend(t);const s=d3.select(this.graf);this.charts=s.selectAll(".charts").data(this.data).enter().append("div").attr("class","chart")}createLegend(){const e=document.createElement("div");e.classList.add("tooltips");const t=document.createElement("div");e.classList.add("tooltips"),t.classList.add("titleGraf"),this.graf.prepend(t),t.textContent="Давление/Температура";const s=document.createElement("div");s.classList.add("checkGraf"),t.appendChild(s),s.innerHTML='<input class="inputPress" id="inputPress" type="checkbox">\n<label for="inputPress" class="labelPress">Подсветка графика</label>\n<input class="inputAllPress" id="inputAllPress" type="checkbox" checked>\n<label for="inputAllPress"class="labelAllPress" > Общее масштабирование</label>\n  <div class="comback">Масштаб по умолчанию</div></div>',this.graf.appendChild(e);const i=document.createElement("div"),a=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");e.appendChild(i),e.appendChild(a),e.appendChild(n),e.appendChild(r);const l=d3.select(".titleGraf").append("svg").attr("width",300).attr("height",40).append("g").attr("transform","translate(-70,40)");l.append("circle").attr("class","barGraf").attr("r",6).attr("cx",100).attr("cy",-25).attr("fill","#009933").attr("stroke","black"),l.append("text").attr("class","legendBar").attr("x",200).attr("y",-20).style("text-anchor","end").text("Давление").attr("fill","black"),l.append("circle").attr("class","tempGraf").attr("r",6).attr("cx",220).attr("cy",-25).attr("fill","blue").attr("stroke","black"),l.append("text").attr("class","legendBar").attr("x",345).attr("y",-20).style("text-anchor","end").text("Температура").attr("fill","black"),e.style.display="none",d3.select(".inputPress").on("click",(function(){const e=d3.select(this).property("checked");d3.selectAll(".area1").attr("fill",(function(t){return e?"darkgreen":"#009933"})),d3.selectAll(".area11").attr("fill",(function(t){return e?"#e8eb65":"#009933"})),d3.selectAll(".area12").attr("fill",(function(t){return e?"darkred":"#009933"}))})),this.legendBar=this.graf.querySelectorAll(".legendBar");const o=this.graf.querySelector(".labelPress"),c=this.graf.querySelector(".labelAllPress"),d=this.graf.querySelector(".comback"),h=this.graf.querySelector(".infos");new g(h,["График отражает давление и температуру по каждому колесу"]),new g(o,["Включает подсветку графика относительно выставленных значений на ось"]),new g(c,["Включает масштабирование всех графиков"]),new g(d,["Cбрасывает масштабирование"]),new g(this.legendBar[0],["Отключает и включает график давления"]),new g(this.legendBar[1],["Отключает и включает график температуры"]),this.legendBar[0].addEventListener("click",(()=>{const e=d3.selectAll(".line1"),t=d3.selectAll(".area1"),s=d3.selectAll(".area11"),i=d3.selectAll(".area12"),a=d3.select(".barGraf");this.legendBar[0].classList.toggle("noActive"),this.legendBar[0].classList.contains("noActive")?(a.attr("fill","none"),e.style("display","none"),t.style("display","none"),s.style("display","none"),i.style("display","none")):(a.attr("fill","darkgreen"),e.style("display","block"),t.style("display","block"),s.style("display","block"),i.style("display","block"))})),this.legendBar[1].addEventListener("click",(()=>{const e=d3.selectAll(".line2"),t=d3.selectAll(".area2"),s=d3.select(".tempGraf");this.legendBar[1].classList.toggle("noActive"),this.legendBar[1].classList.contains("noActive")?(s.attr("fill","none"),e.style("display","none"),t.style("display","none")):(s.attr("fill","blue"),e.style("display","block"),t.style("display","block"))}))}async createStructura(){const[,e,t,s]=this.info,i={};s.forEach((e=>{i[e.idOs]=e}));const a=Number(document.querySelector(".color").id);console.log(e);const n=["last_valid_time","speed","lat","lon","engineOn"];e.forEach((e=>{n.push(e.pressure,e.temp)}));const r=this.t1,l=this.t2+86399,o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:a,t1:r,t2:l,arrayColumns:n,num:1,workerKey:"pressure"})},c=await fetch("/api/getPressureOil",o),d=await c.json();if(0===d.length){document.querySelector(".noGraf").style.display="block";const e=document.querySelector(".infoGraf");return e&&e.remove(),document.querySelector(".loaders_charts").style.display="none",oe=!1,[]}document.querySelector(".noGraf").style.display="none",d.sort(((e,t)=>Number(e.last_valid_time)-Number(t.last_valid_time)));const h=e.reduce(((e,s)=>{const a=i[s.osNumber],n=t.find((e=>Object.values(e).includes(s.pressure)));if(!a||!n)return e;const r=d.filter(((e,t)=>t%5==0)).map((e=>({dates:new Date(1e3*Number(e.last_valid_time)),geo:[Number(e.lat),Number(e.lon)],speed:Number(e.speed),stop:1===Number(e.engineOn)?"ВКЛ":"ВЫКЛ",value:e[s.pressure]?Number(e[s.pressure]):-.1,tvalue:e[s.temp]&&-128!==Number(e[s.temp])&&-50!==Number(e[s.temp])&&-51!==Number(e[s.temp])?Number(e[s.temp]):-.1})));return e.push({sens:n.sens,position:Number(s.tyresdiv),parametr:s.pressure,bar:a,val:r}),e}),[]);return h.sort(((e,t)=>e.position-t.position)),h}}let de=!1;class he{constructor(e,t){this.t1=e,this.t2=t,this.data=null,this.objOil=null,this.graf=null,this.svg=null,this.width=null,this.height=null,this.chartGroup=null,this.parametr=null,this.x=null,this.y1=null,this.y2=null,this.tooltip=null,this.new_xScale=null,this.init()}async init(){if(de)return Promise.reject(new Error("Запрос отменен"));if(de=!0,this.data=await this.createStructura(),console.log(this.data),0===this.data.length){document.querySelector(".noGraf").style.display="block";const e=document.querySelector(".infoGraf");return e&&e.remove(),document.querySelector(".loaders_charts").style.display="none",void(de=!1)}this.objOil=this.findMarkerReFill(),this.createChart()}createChart(){this.createContainer(),this.createLegend(),this.createBodyCharts(),this.createIcons(),document.querySelector(".loaders_charts").style.display="none",de=!1}createIcons(){const e=this.chartGroup.append("text").attr("class","tooltipIcon").style("opacity",0);this.chartGroup.selectAll("image").remove();const t=this;this.chartGroup.selectAll("image").data(this.objOil).enter().append("image").attr("class","iconOil").attr("x",(e=>this.new_xScale?this.new_xScale(new Date(e.data)):this.x(new Date(e.data)))).attr("xlink:href","../../../image/ref.png").attr("width",24).attr("height",24).style("opacity",.5).attr("transform","translate(-12,0)").on("click",(function(e){t.click(e)})).on("mousemove",(function(s){t.mousemove(s,e)})).on("mouseout",(function(s){t.mouseout(e)}))}createTooltip(){const e=this;this.svg.on("mousemove",(function(t){e.toolMousemove(t)})).on("mouseout",(function(t){e.toolMouseout(t)}))}toolMouseout(e){d3.select(".tooltip").transition().duration(500).style("opacity",0)}toolMousemove(e){const[t,s]=d3.mouse(this.svg.node()),i=d3.bisector((e=>e.time)).right,a=this.new_xScale?this.new_xScale.invert(t):this.x.invert(t),n=i(this.data,a,1),r=this.data[n-1],l=this.data[n];e=a-r.time>l.time-a?l:r;const o=this.timeConvert(e.time);let c;c=0==+e[this.parametr]?"Нет данных":+e[this.parametr],this.tooltip.style("left",`${t+100}px`).style("top",`${s+100}px`).style("display","block").html(`Время: ${o}<br/>Топливо: ${c}<br/>Бортовое питание: ${e.pwr}`).transition().duration(200).style("opacity",.9)}timeConvert(e){const t=new Date(e),s=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"][t.getMonth()],i=t.getDate(),a=t.getHours(),n=t.getMinutes();return`${s} ${i}, ${a}:${n<10?"0":""}${n}`}mouseout(e){e.transition().duration(200).style("opacity",0)}mousemove(e,t){d3.select(".tooltip").style("opacity",0),t.transition().duration(200).style("opacity",1),t.attr("x",this.x(new Date(e.data))-40).attr("y",35).attr("text-anchor","middle").text(`Заправка: ${e.zapravka} л.`)}click(e){const t=d3.event.currentTarget,s=document.getElementById("mapOil"),i=document.querySelector(".wrapMap");if(d3.select(t).classed("clickOil"))return i&&i.remove(),s&&s.remove(),void d3.select(t).style("opacity",.5).classed("clickOil",!1);d3.selectAll(".iconOil").style("opacity",.5).classed("clickOil",!1),i&&i.remove(),s&&s.remove(),d3.select(t).style("opacity",1).classed("clickOil",!0),new q([],e,"oil"),this.graf.addEventListener("click",(function(e){e.stopPropagation()}))}createBodyCharts(){const e=this.data[this.data.length-1].summatorOil?"summatorOil":"oil";this.parametr=e;const t=d3.scaleTime().domain(d3.extent(this.data,(e=>new Date(e.time)))).range([0,this.width]);this.x=t;const s=d3.scaleLinear().domain([0,d3.max(this.data,(t=>+t[e]||0))]).range([this.height-40,0]);this.y1=s;const i=d3.scaleLinear().domain(d3.extent(this.data,(e=>e.pwr))).range([this.height-40,0]);this.y2=i;const a=d3.axisLeft(s),n=d3.axisLeft(i),r=d3.axisBottom(t),l=d3.line().x((e=>t(new Date(e.time)))).y((t=>s(+t[e]||0))).curve(d3.curveStepAfter),o=d3.line().x((e=>t(new Date(e.time)))).y((e=>i(e.pwr))).curve(d3.curveStepAfter),c=d3.area().x((e=>t(new Date(e.time)))).y0(this.height).y1((t=>s(+t[e]||0))).curve(d3.curveStepAfter),d=d3.area().x((e=>t(new Date(e.time)))).y0(this.height).y1((e=>i(e.pwr))).curve(d3.curveStepAfter);this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("class","clipart").attr("width",this.width).attr("height",this.height).attr("x",0).attr("y",0);const h=this.svg.append("g").attr("clip-path","url(#clip)");this.chartGroup=h,this.svg.append("g").attr("class","osx").attr("clip-path","url(#clip)").attr("transform","translate(0,"+this.height+")").call(r.ticks(10).tickFormat((function(e){return d3.timeFormat("%H:%M")(e)}))),this.svg.append("g").attr("transform",`translate(0, ${this.height+10})`).attr("class","osx2").attr("clip-path","url(#clip)").call(r.ticks(10).tickFormat((function(e){return d3.timeFormat("%d.%m")(e)}))).style("stroke-width",0),this.svg.append("g").attr("class","os1y").call(a).attr("transform","translate(0, 40)"),this.svg.append("g").attr("class","os2y").attr("transform","translate("+this.width+", 40)").call(n).selectAll(".tick text").attr("x","15").style("text-anchor","start"),h.append("path").datum(this.data).attr("class","line1").attr("fill","none").attr("stroke","black").attr("stroke-width",1.5).attr("d",l).attr("transform","translate(0, 40)"),h.append("path").datum(this.data).attr("class","line2").attr("fill","none").attr("stroke","black").attr("stroke-width",.5).attr("d",o).attr("transform","translate(0, 40)"),h.append("path").datum(this.data).attr("class","area1").attr("d",c).attr("fill","blue").attr("fill-opacity",.5).attr("stroke","black").attr("stroke-width",1).attr("transform","translate(0, 40)"),h.append("path").datum(this.data).attr("class","pat").attr("class","area2").attr("fill","#32a885").attr("stroke","black").attr("fill-opacity",.2).attr("stroke-width",1).attr("d",d).attr("transform","translate(0, 40)"),this.svg.append("text").attr("class","obv").attr("x",-130).attr("y",-35).attr("transform","rotate(-90)").attr("text-anchor","end").text("Объем, л"),this.svg.append("text").attr("class","napr").attr("x",-100).attr("y",this.width+50).attr("transform","rotate(-90)").attr("text-anchor","end").text("Напряжение, В"),h.call(d3.zoom().on("zoom",this.zoomed.bind(this))),this.createTooltip()}zoomed(){const e=d3.event.transform.rescaleX(this.x);this.new_xScale=e,this.svg.select(".osx").call(d3.axisBottom(e).tickFormat(d3.timeFormat("%H:%M"))),this.svg.select(".osx2").call(d3.axisBottom(e).tickFormat(d3.timeFormat("%d.%m"))),this.svg.select(".osx").call(d3.axisBottom(e).ticks(10).tickFormat((function(e){return d3.timeFormat("%H:%M")(e)})).scale(e)),this.svg.select(".osx2").call(d3.axisBottom(e).ticks(10).tickFormat((function(e){return d3.timeFormat("%d.%m")(e)})).scale(e));const t=d3.line().x((t=>e(new Date(t.time)))).y((e=>this.y1(+e[this.parametr]||0))).curve(d3.curveStepAfter),s=d3.line().x((t=>e(new Date(t.time)))).y((e=>this.y2(e.pwr))).curve(d3.curveStepAfter),i=d3.area().x((t=>e(new Date(t.time)))).y0(this.height).y1((e=>this.y1(+e[this.parametr]||0))).curve(d3.curveStepAfter),a=d3.area().x((t=>e(new Date(t.time)))).y0(this.height).y1((e=>this.y2(e.pwr))).curve(d3.curveStepAfter);d3.select(".line1").attr("d",t(this.data)),d3.select(".area1").attr("d",i(this.data)),d3.select(".line2").attr("d",s(this.data)),d3.select(".area2").attr("d",a(this.data)),this.createIcons(),this.createTooltip()}createLegend(){const e=document.createElement("div");e.classList.add("titleGraf"),this.graf.prepend(e),e.textContent="Топливо/Бортовое питание";const t=d3.select(".titleGraf").append("svg").attr("width",350).attr("height",40).append("g").attr("transform","translate(-180,40)");t.append("circle").attr("class","legendOilcircle").attr("r",6).attr("cx",200).attr("cy",-20).attr("fill","blue").attr("stroke","black"),t.append("text").attr("class","legendOil").attr("x",290).attr("y",-15).style("text-anchor","end").text("Топливо").attr("fill","black"),t.append("circle").attr("class","legendVoltcircle").attr("r",6).attr("cx",320).attr("cy",-20).attr("fill","#32a885").attr("stroke","black").attr("opacity",.3),t.append("text").attr("class","legendOil").attr("x",495).attr("y",-15).style("text-anchor","end").text("Бортовое питание").attr("fill","black");const s=document.querySelectorAll(".legendOil"),i=document.querySelector(".infos");new g(i,["График отражает топливо и бортовое питание"]),new g(s[0],["Отключает и включает график топливо"]),new g(s[1],["Отключает и включает график бортовое питание"]),s[0].addEventListener("click",(()=>{const e=d3.select(".os1y"),t=d3.select(".line1"),i=d3.select(".area1"),a=d3.select(".area11"),n=d3.select(".obv"),r=d3.select(".legendOilcircle");if(s[0].classList.toggle("noActive"),s[0].classList.contains("noActive"))return r.attr("fill","none"),e.style("display","none"),t.style("display","none"),i.style("display","none"),a.style("display","none"),void n.style("display","none");r.attr("fill","blue"),e.style("display","block"),t.style("display","block"),i.style("display","block"),a.style("display","block"),n.style("display","block")})),s[1].addEventListener("click",(()=>{const e=d3.select(".os2y"),t=d3.select(".line2"),i=d3.select(".area2"),a=d3.select(".napr"),n=d3.select(".legendVoltcircle");if(s[1].classList.toggle("noActive"),s[1].classList.contains("noActive"))return n.attr("fill","none"),e.style("display","none"),t.style("display","none"),i.style("display","none"),void a.style("display","none");n.attr("fill","#32a885"),e.style("display","block"),t.style("display","block"),i.style("display","block"),a.style("display","block")}))}createContainer(){this.graf=document.createElement("div");const e=document.querySelector(".grafics");this.graf.classList.add("infoGraf"),e.appendChild(this.graf);const t=document.createElement("div");t.classList.add("infos"),this.graf.prepend(t);var s=document.querySelector("body").offsetWidth;const i=e.offsetWidth,a=s>=860?i-250:s-80;this.width=a,this.height=440,this.svg=d3.select(".infoGraf").append("svg").attr("width",a+60+60).attr("height",500).append("g").attr("transform","translate(60,10)"),this.tooltip=d3.select(".infoGraf").append("div").attr("class","tooltip").style("opacity",0).style("display","none")}findMarkerReFill(){const e=[...this.data];for(let t=0;t<e.length-1;t++)e[t].oil===e[t+1].oil&&(e.splice(t,1),t--);const t=[];let s=0,i=0;for(let a=0;a<e.length-1;a++){const n=e[a],r=e[a+1];n.oil<r.oil?(s===i&&(s=a),i=a+1):n.oil>r.oil&&(s!==i&&t.push([e[s],e[i]]),s=i=a+1)}s!==i&&t.push([e[s],e[i]]);const a=t.filter(((e,s)=>{const i=e[0].oil,a=e[e.length-1].oil-i,n=.15*i;if(s<t.length-1){const i=t[s+1],a=e[e.length-1].time;i[0].time-a<3e5&&(e.push(i[i.length-1]),e.splice(1,1))}return i>5&&a>40&&a>=n}));for(let e=0;e<a.length-1;e++)a[e][1].time===a[e+1][1].time&&a.splice(e+1,1);const n=a.filter((e=>e[0].pwr>=11||null==e[0].pwr)).filter((e=>{const t=e[0].time.getTime()/1e3,s=e[1].time.getTime()/1e3-t,i=e[1].oil-e[0].oil;return s>=300&&i>40})),r=[],l=this.data[0].oil,o=this.data[this.data.length-1].oil;if(0!==n.length){r.push(l-n[0][0].oil);for(let e=0;e<n.length-1;e++)r.push(n[e][1].oil-n[e+1][0].oil);r.push(n[n.length-1][1].oil-o)}else r.push(l-o);return r.reduce(((e,t)=>e+t),0),n.reduce(((e,t)=>{const s=t[1].oil-t[0].oil;if(s>10){const i=new Date(t[0].time),a=`${i.getDate()}/${(i.getMonth()+1).toString().padStart(2,"0")}/${i.getFullYear()} ${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`;e.push({data:t[0].time,geo:t[0].geo,zapravka:s,time:a,icon:"../../../image/refuel.png"})}return e}),[])}async createStructura(){const e=Number(document.querySelector(".color").id),t=this.t1,s=this.t2+86399,i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e,t1:t,t2:s,arrayColumns:["last_valid_time","lat","lon","pwr","oil"],num:0,workerKey:"oil"})},a=await fetch("/api/getPressureOil",i),n=await a.json(),r=n.map((e=>({id:e.idw,time:new Date(1e3*Number(e.last_valid_time)),speed:Number(e.speed),geo:[Number(e.lat),Number(e.lon)],oil:Number(e.oil),pwr:Number(e.pwr),engine:Number(e.engine),mileage:Number(e.mileage),curse:Number(e.course),sats:Number(e.sats),engineOn:Number(e.engineOn),summatorOil:e.summatorOil?Number(e.summatorOil):0})));if(r.sort(((e,t)=>e.time-t.time)),0===n.length){document.querySelector(".noGraf").style.display="block";const e=document.querySelector(".infoGraf");return e&&e.remove(),document.querySelector(".loaders_charts").style.display="none",de=!1,[]}return document.querySelector(".noGraf").style.display="none",r}}class ue{constructor(e){this.data=e,this.time=null,this.activeGrafiks=null,this.objectMethod={pressure:ce,oil:he},this.initBound=this.init.bind(this),this.toggleCalendarBound=this.toggleCalendar.bind(this),this.okBound=this.ok.bind(this),this.clearBound=this.clear.bind(this),this.setupInitialListeners()}setup(){this.controllerMethodCharts()}setupInitialListeners(){this.grafik=document.querySelector(".grafik_button"),this.menuGrafik=document.querySelectorAll(".menu_graf"),this.iconGraf=document.querySelector(".icon_graf"),this.calendar=document.querySelector(".calendar_graf"),this.buttons=this.calendar.querySelectorAll(".btm_formStart"),this.grafik.addEventListener("click",this.initBound),this.menuGrafik.forEach((e=>e.addEventListener("click",(()=>this.navi(e))))),this.iconGraf.addEventListener("click",this.toggleCalendarBound),this.buttons[0].addEventListener("click",this.clearBound),this.buttons[1].addEventListener("click",this.okBound)}removeAllListeners(){const e=document.querySelector(".infoGraf");e&&e.remove(),this.grafik.removeEventListener("click",this.initBound),this.menuGrafik.forEach((e=>e.removeEventListener("click",(()=>this.navi(e))))),this.iconGraf.removeEventListener("click",this.toggleCalendarBound),this.buttons[0].removeEventListener("click",this.clearBound),this.buttons[1].removeEventListener("click",this.okBound)}reinitialize(e){this.removeAllListeners(),this.data=e,this.setup(),this.setupInitialListeners()}ok(){this.calendar.style.display="none",this.calendar.previousElementSibling.classList.remove("clickUp"),this.calendar.children[0].children[0].value="",this.controllerMethodCharts()}clear(){console.log("здесь"),this.calendar.style.display="none",this.calendar.previousElementSibling.classList.remove("clickUp"),this.calendar.children[0].children[0].value=""}async toggleCalendar(e){const t=e.target;t.classList.toggle("clickUp"),t.classList.contains("clickUp")?(this.calendar.style.display="flex",await this.getTimeInterval()):this.calendar.style.display="none"}async getTimeInterval(){const e=`#${this.calendar.children[0].children[0]?this.calendar.children[0].children[0].id:this.calendar.children[0].id}`,t=new p;this.time=await t.getTimeInterval(this.calendar,e)}init(e){const t=e.currentTarget;this.switch(t),this.menuGrafik.forEach((e=>{e.classList.remove("activMenuGraf")})),this.menuGrafik[0].classList.add("activMenuGraf"),this.activeGrafiks=this.menuGrafik[0].getAttribute("rel"),this.installTime(),this.controllerMethodCharts()}switch(e){const t=document.querySelector(".wrapper_right"),s=document.querySelector(".wrapper_left"),i=document.querySelector(".grafics"),a=document.querySelector(".techInfo"),n=document.querySelector(".main"),r=document.querySelectorAll(".secondFlash")[1];e.classList.add("activGraf"),t.style.display="none",a.style.display="none",s.style.display="none",i.style.display="flex",r.style.display="none",n.style.flexDirection="column"}navi(e){this.menuGrafik.forEach((e=>e.classList.remove("activMenuGraf"))),e.classList.add("activMenuGraf"),this.activeGrafiks=e.getAttribute("rel"),this.controllerMethodCharts()}installTime(){const e=new Date,t=Math.round(e.getTime()/1e3),s=Math.floor(new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0).getTime()/1e3);this.time=[s,t]}controllerMethodCharts(){if(this.grafik.classList.contains("activGraf")){const e=document.querySelector(".infoGraf");e&&e.remove(),new(0,this.objectMethod[this.activeGrafiks])(this.time[0],this.time[1],this.data),document.querySelector(".loaders_charts").style.display="flex"}}}class pe{constructor(e,t){this.elements=e,this.data=t,this.info,this.element=null,this.createEvent=null,this.instanceStatistika=null,this.instanceDetalisation=null,this.controller=null,this.wrapperFull=document.querySelector(".wrapperFull"),this.btnShina=document.querySelectorAll(".plug"),this.widthWind=document.querySelector("body").offsetWidth,this.uniqStruktura=this.findObjectByIdRecursive(this.data),this.elements.forEach((e=>e.addEventListener("click",this.handleClick.bind(this)))),this.btnShina.forEach((e=>e.addEventListener("click",this.changeTyresValue.bind(this,e))))}changeTyresValue(e){const t=document.querySelector(".main"),s=document.querySelector(".windowStatistic"),i=document.querySelector(".stata_container");t.style.flexDirection="row",this.btnShina.forEach((e=>{e.classList.remove("active")})),e.classList.add("active"),this.visual("check"),console.log("визуал"),this.btnShina[1].classList.contains("active")?(s.style.display="none",i.style.display="flex",this.styleShinaActive()):(s.style.display="flex",i.style.display="none"),document.querySelector(".activGraf")&&this.mainblock(),V.hideElements([".wrapper_left"],"block")}mainblock(){document.querySelector(".grafik_button").classList.remove("activGraf"),V.hideElements([".wrapper_right",".config",".secondFlash"],"flex"),V.hideElements([".grafics"],"none"),V.hideElements([".wrapper_left"],"block")}findObjectByIdRecursive(e){const t=e.flat().reduce(((e,t)=>(10===t.length&&0!==t[8].sub.length&&e.push(...Object.values(t[8].sub).flat()),e.push(t),e)),[]);return Array.from(new Map(t.map((e=>[e[4],e]))).values())}filterData(e){const t=this.uniqStruktura.find((t=>t[4]===Number(e)));this.info=[t[0].result,t[1].result,t[2].result,t[3].result]}handleClick(e){this.element=e.currentTarget,this.filterData(this.element.id),this.windowAdaptiv(),this.element.classList.contains("color")||e.target.classList.contains("checkInList")||e.target.classList.contains("map_unit")||e.target.classList.contains("report_unit")||e.target.classList.contains("deleteObject")||e.target.classList.contains("pref")||(V.deleteClasses(".color"),this.element.classList.add("color"),this.visual())}async visual(e){const t=this.element.id;this.btnShina[1].classList.contains("active")&&this.styleShinaActive(),V.deleteClasses(".tablo",".choice",".acto",".check_probeg",".toogleIconEvent"),V.hideElements([".calendar_track",".calendar_graf",".select_type",".start",".techInfo",".modalCenterOs",".tableTarir",".disketa",".korzina",".sensors",".alllogs",".allsec",".delIcon",".contKran"],"none"),V.hideElements([".trEvent",".main",".wrapper_up",".wrapperCont"],"flex");const s=e?[".msg",".wrapMap",".containerAlt",".delIcon"]:[".msg",".wrapMap",".containerAlt",".delIcon",".zamer",".jobTSDetalisationGraf",".jobTSDetalisationCharts_legenda"];V.deleteElements(s),e||V.clearTextContent(".odom_value",".akb_value1",".ohl_value",".oil_value1",".toil_value",".ign_value",".oborot_value",".moto_value"),V.createListItems(".obo",250,"msg",this.info[2]),this.reinitializeOrCreateInstance("instanceSKDH",le,this.info,t),console.log(this.info),e||(this.specific(this.element),this.reinitializeOrCreateInstance("createEvent",E,t),this.reinitializeOrCreateInstance("iconStatusClick",I,this.element),this.reinitializeOrCreateInstance("instanceStatistika",$,this.element,this.info),this.reinitializeOrCreateInstance("instanceDetalisation",H,this.element),this.reinitializeOrCreateInstance("instanceGrafik",ue,this.info),this.createEvent.updateInterval&&(clearInterval(this.createEvent.updateInterval),this.createEvent.hiddenTrackAndMarkersEnent()),console.log(this.info),j(this.info)),b(),setInterval(b,3e5)}reinitializeOrCreateInstance(e,t,...s){this[e]?this[e].reinitialize(...s):this[e]=new t(...s)}specific(e){const t=document.getElementById("check_Title"),s=document.querySelector(".checkAlt"),i=document.querySelector(".tarir"),a=document.querySelectorAll(".tires_link"),n=document.querySelector(".wrapper_left"),r=document.querySelector(".title_two"),l=document.querySelectorAll(".plug"),o=document.querySelector(".grafics"),c=document.querySelector(".createList");document.querySelector(".techInfo"),t.checked=!1,s.style.color="black",s.style.fontWeight="400",r&&(r.textContent=e.children[0].textContent),"Цистерна ДТ"===e.children[0].textContent&&(i.style.display="block"),a.forEach((e=>{e.classList.contains("tiresActiv")&&(o.style.display="flex")})),l[2].classList.contains("activGraf")?(n.style.display="none",o.style.display="flex"):n.style.display=this.widthWind<860?"none":"block",c.value}styleShinaActive(){const e=document.querySelector(".wrapper_containt"),t=e.querySelectorAll(".tiresD"),s=e.querySelectorAll(".tiresT");t.forEach((e=>e.classList.add("tyreD-modified"))),s.forEach((e=>e.classList.add("tyreT-modified")))}windowAdaptiv(){const e=this.wrapperFull.querySelector(".sections");if(this.widthWind<=860){document.querySelector(".centerBlock").style.width="100%",document.querySelector(".comeback").style.display="flex",document.querySelector(".main").style.display="flex",document.querySelector(".wrapper_left").style.display="none";const t=document.querySelector(".color");document.querySelector(".titleName").textContent=t.children[0].textContent,e.style.display="none",document.querySelector(".mobile_active").classList.remove("mobile_active"),document.querySelector(".mobile_config").classList.add("mobile_active"),document.querySelector(".mainAlarm").textContent="Уведом.",document.querySelector(".state_tyres").textContent="Шины",document.querySelector(".rigth_icons").style.order=2,document.querySelector(".config").style.order=3,document.querySelector(".side").appendChild(document.querySelector(".select_type")),document.querySelector(".select_type").style.order=1,document.querySelectorAll(".itemSide")[1].style.order=2}if(this.widthWind>=861&&this.widthWind<=1200){document.querySelector(".comeback").style.display="flex",document.querySelector(".sections").style.display="none";const e=document.querySelector(".main");e.style.display="flex",e.style.width="100%",e.style.justifyContent="center",document.querySelector(".centerBlock").style.width="40%";const t=document.querySelector(".color");document.querySelector(".titleName").textContent=t.children[0].textContent,document.querySelector(".wrapper_left").style.display="block"}}}const me={set_one:"account",set_two:"listView",set_three:"notification",set_four:"contactSet"},ye=document.querySelectorAll(".log")[1].textContent,ge=async e=>{const t=document.querySelectorAll(".uniqBar"),s=document.querySelectorAll(".log")[1].textContent,i={login:s},a=document.querySelectorAll(".viewIcon"),n=[];a.forEach(((e,t)=>{const s=e.getAttribute("rel").split(" "),i=s[s.length-1];n.push({rel:i,index:t})})),t.forEach((e=>{e.children[0].checked?i[e.children[0].id]=!0:i[e.children[0].id]=!1})),n.forEach((e=>{e.rel in i?e.view=i[e.rel]:e.view=i.pressure}));const r=n.reduce(((e,t)=>(e[t.rel]=JSON.stringify(t),e)),{});r.login=s;const l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mass:r,login:s})},o=await fetch("/api/saveList",l);await o.json(),e||we()};document.querySelector(".listView").lastElementChild.addEventListener("click",(()=>ge()));const ve=async e=>{document.querySelectorAll(".item_contact_set").forEach((e=>e.remove()));const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e})},s=await fetch("/api/findProfil",t),i=await s.json();console.log(i);const a=document.querySelector(".body_set");i.forEach((e=>{const t=document.createElement("li");t.classList.add("item_contact_set"),t.setAttribute("id",e.uniqId),t.innerHTML=`\n        <div class="view_email">${e.email}</div>\n        <div class="view_phone">${e.phone}</div>\n        <div class="icon_set"><i class="fas fa-trash-alt"></i></div>\n    `,a.appendChild(t)}));const n=document.querySelectorAll(".icon_set");n&&Array.from(n).forEach((e=>{console.log(e),e.addEventListener("click",(()=>fe(e)))}))},fe=async e=>{const t=e.parentNode.id,s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uniqId:t})},i=await fetch("/api/deleteProfil/:id",s);await i.json(),ve(ye)},be=()=>{const e=document.querySelector(".valid_text");e&&e.remove();const t=document.querySelector(".email_set"),s=document.querySelector(".phone_set"),i=t.value.toLowerCase(),a=s.value,n=document.querySelector(".set_form"),r=document.createElement("span");r.classList.add("valid_text"),n.appendChild(r);const l=/^[7]\d{10}$/.test(a);""===i&&""===a?r.textContent="Добавьте контакты":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)||""===i?l||""===a?async function(e,t){const s=document.querySelectorAll(".log")[0].textContent;document.querySelector(".set_form").style.display="none",document.querySelector(".email_set").value="",document.querySelector(".phone_set").value="";document.querySelector(".settings_users").style.zIndex=2,document.createElement("li").classList.add("item_contact_set");const i=Math.random().toString(36).substr(2,5),a=[];a.push(i),a.push(ye),a.push(s),a.push(e),a.push(t),console.log(a);const n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mass:a})},r=await fetch("/api/saveProfil",n);await r.json(),document.querySelectorAll(".item_contact_set").forEach((e=>e.remove())),ve(ye)}(i,a):r.textContent="Введите корректный номер":r.textContent="Введите корректный e-mail"};function we(){const e=document.querySelector(".confirm");console.log(e),e.style.display="flex";const t=document.querySelector(".settings_users");document.querySelector(".popup-background").style.display="block",t.style.zIndex=0,setTimeout((()=>{e.style.display="none",t.style.zIndex=2}),2e3),e.children[0].children[0].addEventListener("click",(()=>{e.style.display="none",t.style.zIndex=2}))}document.querySelector(".notification").lastElementChild.addEventListener("click",(()=>async function(){we();const e=document.querySelectorAll(".celEven"),t={email:[],alert:[],what:[],teleg:[],sms:[]};e.forEach((e=>{e.children[0].checked&&t[e.getAttribute("rel")].push(e.parentNode.firstElementChild.textContent)}));for(let e in t)t[e]=JSON.stringify(t[e]);console.log(t);const s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({objEvent:t,login:ye})},i=await fetch("/api/saveEvent",s),a=await i.json();console.log(a)}())),document.querySelector(".set_three").addEventListener("click",(async function(){const e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:ye})},t=await fetch("/api/viewEvent",e),s=await t.json();console.log(s),delete s.itog[0].login,delete s.itog[0].id;const i=s.itog[0];for(let e in i)i[e]=JSON.parse(i[e]);console.log(i),document.querySelectorAll(".celEven").forEach((e=>{i[e.getAttribute("rel")].forEach((t=>{console.log(!0),t===e.parentNode.firstElementChild.textContent&&(console.log(e),e.children[0].checked=!0)}))}))}));class Se{constructor(){this.getDOM(),this.init()}getDOM(){this.titleList=document.querySelectorAll(".viewIcon"),this.titleModal=document.querySelectorAll(".titleModal"),this.grays=document.querySelectorAll(".grays"),this.graysType=document.querySelectorAll(".graysType"),this.newCelChange=document.querySelectorAll(".newCelChange"),this.sortIcon=document.querySelector(".iconsort"),this.sortIconType=document.querySelector(".iconsortType"),this.element=document.querySelector(".conditionSort"),this.elementType=document.querySelector(".sortType"),this.sortCondition=document.querySelector(".sortCondition"),this.sortConditionType=document.querySelector(".sortConditionType"),this.list=document.querySelectorAll(".listItem")}init(){this.conditionFilter(),this.typeFilter(),this.titleList.forEach((e=>{if(e.addEventListener("mouseenter",this.selection.bind(this)),e.addEventListener("mouseleave",this.selectionOff.bind(this)),e.children[1]){const t=e.children[1].children[0],s=e.children[1].children[1];t.addEventListener("click",this.selectOn.bind(this)),s.addEventListener("click",this.selectOff.bind(this))}}))}select(e,t,s){void 0!==s&&(e.style.display="none"),void 0!==s&&(s.style.display="block"),"flex"===t&&(e.parentNode.previousElementSibling.style.color="rgba(6, 28, 71, 1)");const i=e.parentNode.parentNode.getAttribute("rel");this.newCelChange.forEach((e=>{i.split(" ")[1]?e.getAttribute("rel").split(" ")[1]===i.split(" ")[1]&&0===e.children.length&&(e.closest(".listItem").style.display=t):e.getAttribute("rel")===i&&(0===e.children.length?"-"===e.textContent&&(e.closest(".listItem").style.display=t):e.children[0].classList.contains("toogleIcon")&&"-"!==e.textContent||(e.closest(".listItem").style.display=t))}))}selectOn(e){const t=e.target;this.select(t,"none",e.target.nextElementSibling),this.checkZero()}selectOff(e){const t=e.target;this.select(t,"flex",e.target.previousElementSibling),this.titleModal.forEach((e=>{"none"===e.style.display&&(e.style.display="flex")})),this.check(),this.filterType();const s=document.querySelectorAll(".grays");let i=!1;this.grays.forEach((e=>{e.classList.contains("toogleIcon")&&(i=!0)})),i&&(s[0].parentElement.previousElementSibling.previousElementSibling.style.color="gray")}dubleSelectOn(e){this.select(e,"none"),document.querySelectorAll(".titleModal").forEach((e=>{0===Array.from(e.nextElementSibling.children).filter((e=>"none"!==e.style.display)).length&&(e.style.display="none")}))}selection(e){e.target.children[1].style.display="flex"}selectionOff(e){e.target.children[1].style.display="none","block"===e.target.children[1].children[1].style.display&&(e.target.children[0].style.color="gray");const t=document.querySelector(".iconsort");"block"===t.previousElementSibling.children[1].style.display?t.previousElementSibling.previousElementSibling.style.color="gray":t.previousElementSibling.previousElementSibling.style.color="rgba(6, 28, 71, 1)"}filterCondition(e,t){const s=t||e.target,i=document.querySelectorAll(".grays");if(i.forEach((e=>{e!==s&&e.classList.remove("toogleIcon")})),s.classList.toggle("toogleIcon"),s.closest(".viewIcon").children[0].style.color="gray",s.classList.contains("toogleIcon")){const e=document.querySelectorAll(".newCelChange");Array.from(e).forEach((e=>{e.getAttribute("rel")===s.parentNode.parentNode.getAttribute("rel")&&(e.children[0]&&s.getAttribute("rel")===e.children[0].getAttribute("rel")?(e.closest(".listItem").style.display="flex",this.check(),this.filterType(),this.checkZero()):e.closest(".listItem").style.display="none")}))}else"none"!==s.closest(".viewIcon").children[0].nextElementSibling.children[1].style.display?s.closest(".viewIcon").children[0].style.color="gray":s.closest(".viewIcon").children[0].style.color="rgba(6, 28, 71, 1)",document.querySelectorAll(".listItem").forEach((e=>e.style.display="flex")),this.check();this.checkZero();const a=document.querySelector(".conditionSort"),n=document.querySelector(".iconsort");let r=!1;i.forEach((e=>{e.classList.contains("toogleIcon")&&(r=!0)})),r?(a.children[0].style.color="gray",n.style.color="gray"):(this.filterType(),a.children[0].style.color="rgba(6, 28, 71, 1)",n.style.color="rgba(6, 28, 71, 1)"),this.checkZero()}check(){this.titleList.forEach((e=>{"gray"===e.children[0].style.color&&this.dubleSelectOn(e.children[1].children[1])}))}filterType(){const e=document.querySelectorAll(".graysType"),t=document.querySelectorAll(".listItem"),s=document.querySelectorAll(".grays");let i,a=!1;s.forEach((e=>{e.classList.contains("toogleIcon")&&(a=!0,i=e)})),t.forEach((e=>e.style.display="none"));const n=[];e.forEach((e=>{e.classList.contains("toogleIcon")?(e.closest(".viewIcon").children[0].style.color="gray",e.style.color="rgba(6, 28, 71, 1)",a?t.forEach((t=>{let s=!1,a=!1;Array.from(t.children).forEach((t=>{t.getAttribute("rel")===e.closest(".viewIcon").getAttribute("rel")&&t.textContent===e.nextElementSibling.textContent&&(s=!0),t.children[0]&&t.children[0].getAttribute("rel")===i.getAttribute("rel")&&(a=!0)})),s&&a&&n.push(t)})):t.forEach((t=>{Array.from(t.children).forEach((t=>{t.getAttribute("rel")===e.closest(".viewIcon").getAttribute("rel")&&t.textContent===e.nextElementSibling.textContent&&n.push(t.closest(".listItem"))}))}))):e.style.color="gray"})),n.forEach((e=>e.style.display="flex"));const r=document.querySelector(".sortType"),l=document.querySelector(".iconsortType");let o=!1;e.forEach((e=>{e.classList.contains("toogleIcon")&&(o=!0)})),o?(r.children[0].style.color="gray",l.style.color="gray"):a?t.forEach((e=>Array.from(e.children).forEach((t=>{t.children[0]&&t.children[0].getAttribute("rel")===i.getAttribute("rel")&&(e.style.display="flex")})))):(r.children[0].style.color="rgba(6, 28, 71, 1)",l.style.color="rgba(6, 28, 71, 1)",t.forEach((e=>e.style.display="flex"))),this.check(),this.checkZero()}checkZero(){document.querySelectorAll(".titleModal").forEach((e=>{0===Array.from(e.nextElementSibling.children).filter((e=>"none"!==e.style.display)).length?e.style.display="none":e.style.display="flex"}))}typeFilter(){const e=document.querySelector(".iconsortType"),t=document.querySelector(".sortType"),s=document.querySelector(".sortConditionType");t&&(t.addEventListener("mouseenter",(()=>{e.style.display="block"})),s.addEventListener("mouseleave",(()=>{s.style.display="none"})),e.addEventListener("click",(()=>{t.style.position="relative",s.style.display="flex"})),t.addEventListener("mouseleave",(()=>{e.style.display="none"})),document.querySelectorAll(".graysType").forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("toogleIcon"),this.filterType()}))})))}conditionFilter(){const e=document.querySelector(".iconsort"),t=document.querySelector(".conditionSort"),s=document.querySelector(".sortCondition"),i=document.querySelectorAll(".grays");t&&(t.addEventListener("mouseenter",(()=>{t.style.width="70px",e.style.display="block"})),s.addEventListener("mouseleave",(()=>{s.style.display="none"})),t.addEventListener("mouseleave",(()=>{e.style.display="none",t.style.width="40px";let s=!1;i.forEach((e=>{e.classList.contains("toogleIcon")&&(s=!0)})),s?(t.children[0].style.color="gray",e.style.color="gray"):(t.children[0].style.color="rgba(6, 28, 71, 1)",e.style.color="rgba(6, 28, 71, 1)")})),e.addEventListener("click",(()=>{t.style.position="relative",s.style.display="flex"})),i.forEach((e=>{e.addEventListener("click",this.filterCondition.bind(this))})))}draggable(){const e=document.querySelector(".list_att"),t=[],s=[];let i;const a=this;function n(e){0!==t.length&&(t.length=0),i=e.target,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",i.outerHTML);const s=document.createElement("div");s.appendChild(i.cloneNode(!0)),e.dataTransfer.setData("text/html",s.innerHTML),document.querySelectorAll(".newCelChange").forEach((i=>{s.children[0].getAttribute("rel").split(" ")[1]?i.getAttribute("rel").split(" ")[1]===s.children[0].getAttribute("rel").split(" ")[1]&&t.push(i):i.getAttribute("rel")===e.target.closest(".viewIcon").getAttribute("rel")&&t.push(i)}))}function r(e){e.preventDefault(),e.target.classList.add("drag-over"),e.dataTransfer.dropEffect="move"}function o(c){c.preventDefault(),c.target.classList.remove("drag-over");const d=c.dataTransfer.getData("text/html"),h=document.createElement("div");h.innerHTML=d,h.children[0].children[1].style.display="none",e.insertBefore(h.children[0],c.target.closest(".viewIcon")),document.querySelectorAll(".newCelChange").forEach((e=>{c.target.closest(".viewIcon").getAttribute("rel").split(" ")[1]?e.getAttribute("rel").split(" ")[1]===c.target.closest(".viewIcon").getAttribute("rel").split(" ")[1]&&s.push(e):e.getAttribute("rel")===c.target.closest(".viewIcon").getAttribute("rel")&&s.push(e)})),s.forEach(((e,s)=>{e.parentElement.insertBefore(t[s],e)})),t.length=0,s.length=0,i.remove(),Array.from(e.children).forEach((e=>{e.removeEventListener("dragstart",n),e.removeEventListener("dragover",r),e.removeEventListener("drop",o)}));const u=document.querySelectorAll(".viewIcon"),p=[];u.forEach(((e,t)=>{const s=e.getAttribute("rel").split(" "),i=s[s.length-1];p.push({rel:i,index:t}),new g(e,[l[i]])})),ge(1),a.getDOM(),a.init(),a.draggable()}Array.from(e.children).forEach((e=>{e.setAttribute("draggable",!0),e.addEventListener("dragstart",n),e.addEventListener("dragover",r),e.addEventListener("drop",o)}))}}let _e,ke,Ce;class Ee{constructor(e){this.data=e,this.element=null,this.lowList=document.querySelector(".low_list"),this.login=document.querySelectorAll(".log")[1].textContent,this.allId=null,this.final=null,this.sensorsName=!1,this.lastSensor=!1,this.finishload=!1,this.init()}async init(){this.simulateLoader(),this.allId=this.format(this.data,0),this.final=this.format(this.data,1),this.findDomElement(),this.createListObjectAndGroup();const e=this.lowList.querySelectorAll(".listItem");new pe(e,this.data),this.sensorsName=!0,this.lastSensor=!0,_e=new m(this.allId),ke=new y,ke.getDataSummary(),await this.viewList(this.login),this.element&&this.grennColorPref(e),this.validRole(),this.finishload=!0,setInterval(this.zaprosSpisok.bind(this),1e5)}grennColorPref(e){const t=[...e].find((e=>e.id===this.element));t&&(t.classList.add("border"),t.children[0].children[0].style.color="green")}simulateLoader(){let e=0,t=document.querySelector(".loaders-progress"),s=setInterval((()=>{e=this.updateProgress(e),this.finishload?(clearInterval(s),document.querySelector(".loaders").style.display="none"):t.textContent=e+"%"}),300)}updateProgress(e){if(95===e||96===e)return e;let t=0;return Pt.dataspisok?(this.sensorsName?(e=66,t+=1):e=52,this.lastSensor&&this.finishload?(e=100,t+=1):this.lastSensor&&(e=95,t+=1)):e+=2*(1===t?2:2===t?3:1),e}validRole(){const e=document.querySelector(".role").getAttribute("rel"),t=document.querySelectorAll(".pref"),s=document.querySelectorAll(".deleteObject"),i=document.querySelectorAll(".deleteGroup"),a=document.querySelectorAll(".settingsGroup"),n=document.querySelector(".create_object"),r=document.querySelector(".checkAlt"),l=document.querySelectorAll(".titleModal"),o=document.querySelector(".list_item1");"Пользователь"===e&&(o.style.width="220px",o.style.marginLeft="30px",o.style.marginRight="70px",l.forEach((e=>{e.style.paddingLeft="20px"})),r.style.display="none",n.style.display="none",t.forEach((e=>{e.style.display="none"})),s.forEach((e=>{e.style.display="none"})),i.forEach((e=>{e.style.display="none"})),a.forEach((e=>{e.style.display="none"})))}updateIconsSensors(e,t,s,i,n,r,l){const o=document.querySelectorAll(".newColumn");let c,d;const h={0:'<i class="fas fa-parking toogleIcon"rel="03g"></i>',1:'<i class="fas fa-arrow-alt-circle-right toogleIcon" rel="01g"></i>',2:'<i class="fas fa-pause-circle toogleIcon"rel="02g"></i>'};let u;const p=e.find((e=>"summatorOil"===e[1]&&e[2]===t));if(p&&"ON"===p[5])u=`${p[3].toFixed(0)} л.`;else{const s=e.find((e=>"oil"===e[1]&&e[2]===t));u=s?null===s[3]?"-":`${s[3].toFixed(0)} л.`:"-"}const m=e.find((e=>"pwr"===e[1]&&e[2]===t)),y=m?parseFloat(Number(m[3]).toFixed(1)):"-",g=e.find((e=>"mileage"===e[1]&&e[2]===t)),v=g?`${Number(g[3]).toFixed(0)} км.`:"-",f=e.find((e=>"speed"===e[1]&&e[2]===t)),b=f?parseInt(f[3].toFixed(0)):"-",w=e.find((e=>"last_valid_time"===e[1]&&e[2]===t));if(w){const e=parseFloat(((new Date).getTime()/1e3).toFixed(0))-Number(w[3]);i=e>3600?"ВЫКЛ":i,d=a(e)}"-"===b||!b&&0!==b||(c=h[b>0&&1===l?1:0===b&&1===l?2:0===b&&0===l?0:void 0]);const S={statusnew:[i,'<i class="fas fa-satellite-dish actIcon"></i>'],ingine:[l,'<i class="fas fa-key actIcon"></i>'],condition:[c,c],oil:[u,u],pwr:[y,y],sats:[n,n],type:[r,r],meliage:[v,v],lasttime:[d,d]};for(let e=0;e<o.length;e++){const t=o[e].getAttribute("rel"),i=s.querySelector(`.newCel[rel="${t}"]`);if(i)i.innerHTML=S[t][1],"statusnew"===t&&"ВКЛ"===S[t][0]?i.children[0].classList.add("toogleIcon"):"statusnew"===t&&void 0===S[t][0]&&(i.innerHTML="-"),"ingine"===t&&1===S[t][0]?i.children[0].classList.add("toogleIcon"):"ingine"===t&&"-"===S[t][0]&&(i.innerHTML="-"),("type"===t&&"Тип ТС"===S[t][0]||"type"===t&&void 0===S[t][0])&&(i.innerHTML="-"),void 0===S[t][0]&&(i.innerHTML="-");else{const i=document.createElement("div");i.classList.add("newCel"),i.classList.add("newCelChange"),i.setAttribute("rel",`${t}`),"type"===t&&(i.style.width="150px"),("oil"===t||"pwr"===t)&&(o[e].style.width="50px",i.style.width="50px"),("type"===t||"meliage"===t)&&i.classList.add("newCelTextType"),["meliage","pwr","oil","lasttime"].includes(t)&&i.classList.add("rightLine"),"lasttime"===t&&i.classList.add("newCelTimeType"),i.innerHTML=S[t][1],void 0===S[t][0]&&(i.innerHTML="-"),"statusnew"===t&&"ВКЛ"===S[t][0]?i.children[0].classList.add("toogleIcon"):"statusnew"===t&&void 0===S[t][0]&&(i.innerHTML="-"),"ingine"===t&&1===S[t][0]?i.children[0].classList.add("toogleIcon"):"ingine"===t&&"-"===S[t][0]&&(i.innerHTML="-"),("type"===t&&"Тип ТС"===S[t][0]||"type"===t&&null==S[t][0])&&(i.innerHTML="-"),s.appendChild(i)}}}async zaprosSpisok(){const e=document.querySelectorAll(".listItem"),t=Array.from(e).map((e=>Number(e.id))),s=[...new Set(t.map(JSON.stringify))].map(JSON.parse).map((e=>Number(e))),i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uniqData:s})},a=await fetch("/api/spisokList",i),n=await a.json();e.forEach((e=>{const t=e.id,s=n.res.filter((e=>{if(e.idw===Number(t))return e.result}))[0].result,i=Object.values(s[2])[0].filter((e=>e.idw===t&&"Н/Д"!==e.value&&null!==e.value)).map((e=>[e.sens,e.params,Number(e.idw),Number(e.value),e.status,e.meta]));this.viewListKoleso(s[0],s[1],s[2],s[3],e,i)}))}viewListKoleso(e,t,s,i,a,n){const r=parseFloat(a.id),l=n.find((e=>"engine"===e[1]&&e[2]===r)),o=l?Number(l[3]):null,c=n.find((e=>"sats"===e[1]&&e[2]===r)),d=c?Number(c[3]):null,h=d?d>4&&1===o?"ВКЛ":"ВЫКЛ":null,u=e.result&&0!==e.result.length?e.result[0].type:void 0,p=a.querySelectorAll(".arc");this.coloring(p,a,t,s,i,o),this.updateIconsSensors(n,r,a,h,d,u,o)}viewList=async e=>{const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e})},s=await fetch("/api/viewList",t),i=await s.json();if(0!==i.res.length){const e=i.res[0];delete e.login,delete e.id;const t={};for(let s in e)t[s]=JSON.parse(e[s]);const s=Object.assign({},t);delete t.tagach;for(let e in t)"pricep"===e&&(t.pressure=t.pricep,delete t.pricep);const a=document.querySelectorAll(".uniqBar");console.log(t),a.forEach((e=>{console.log(e.children[0].id),t[e.children[0].id].view&&(e.children[0].checked=!1!==t[e.children[0].id].view)})),document.querySelectorAll(".title_list_global").forEach((e=>{e.style.display=!1===t[e.getAttribute("rel").split(" ")[1]?e.getAttribute("rel").split(" ")[0]:e.getAttribute("rel")].view?"none":"flex"})),document.querySelectorAll(".newCelChange").forEach((e=>{e.style.display=!1===t[e.getAttribute("rel").split(" ")[1]?e.getAttribute("rel").split(" ")[0]:e.getAttribute("rel")].view?"none":"flex"}));for(let e in s){const t=s[e].index,i=e;Array.from(document.querySelectorAll("[rel]")).filter((e=>e.getAttribute("rel").split(" ").includes(i))).forEach((e=>{const s=e.parentNode,i=s.children[t+1];s.insertBefore(e,i)}))}(new Se).draggable()}else(new Se).draggable()};coloring(e,t,s,a,n,r){if(s.result){const t=i(s.result);a.result.forEach((s=>{const i=t.find((e=>s.params==e.pressure));if(i){const t=[...e].find((e=>e.id==i.tyresdiv));if(t){const e=s.value,a=0===r||null===r?"#000":"false"===s.status?"gray":null!==e?d[function(e,t){let s;return e>=Number(t.dnmin)&&e<=Number(t.dnmax)&&(s=3),(e>Number(t.knd)&&e<=Number(t.dnmin)||e>Number(t.dnmax)&&e<=Number(t.kvd))&&(s=2),(e<=Number(t.knd)||e>=Number(t.kvd))&&(s=1),s}(e,n.result.find((e=>e.idOs==i.osNumber)))]:null;t.children[0].style.fill=a}}}))}}createListObjectAndGroup(){for(let e of this.data)if(0!==e.length){const t=document.querySelector(".low_list"),s=document.createElement("div");s.classList.add("groups"),"kursor"===e[0][e[0].length-1]?s.classList.add("kursorgroups"):s.classList.add("wialongroups");const i=e[0][7].replace(/\s/g,"_");s.classList.add(`${i}`),s.setAttribute("id",e[0][8]),s.style.display="flex",s.style.flexDirection="column",s.style.width="100%",t.appendChild(s);const a=document.createElement("div");a.classList.add("titleModal"),"kursor"!==e[0][e[0].length-1]?a.classList.add("titlewialon"):a.classList.add("titlekursor"),"Курсор"===this.login?a.textContent=`Компания... (${e.length})`:a.textContent=`${i} (${e.length})`,s.appendChild(a);const n=document.createElement("i");n.classList.add("fas"),n.classList.add("fa-sort-amount-up"),n.classList.add("filterV"),a.appendChild(n);const r=document.createElement("i");r.classList.add("fas"),r.classList.add("fa-sort-amount-down"),r.classList.add("filterVN"),"Курсор"===this.login&&(r.style.display="none",n.style.display="none"),a.appendChild(r);const l=document.createElement("i");l.classList.add("fa"),l.classList.add("fa-check"),l.classList.add("chekHidden"),a.prepend(l);const o=document.createElement("i");o.classList.add("fas"),o.classList.add("fa-toggle-on"),o.classList.add("minusS");const c=document.createElement("i");c.classList.add("fas"),c.classList.add("fa-toggle-off"),c.classList.add("plusS"),a.prepend(o),a.prepend(c);const d=document.createElement("i");d.classList.add("fas"),d.classList.add("fa-times"),d.classList.add("deleteGroup");const h=document.createElement("i");h.classList.add("fas"),h.classList.add("fa-wrench"),h.classList.add("settingsGroup"),a.appendChild(d),a.appendChild(h);const u=document.createElement("div");u.classList.add("hiddenModal"),s.classList.add(`${i}`),s.setAttribute("rel",`${i}`),s.appendChild(u);const p=document.querySelector(`.${i}`);for(let t of e)0!==Object.values(t[0]).length&&this.createIconsAndLeftSpisok(t,this.final,p,i,"master")}}fnTagach(e,t,s){const i=document.querySelector(`.${s}`);Array.from(i.lastElementChild.querySelectorAll(".listItem")).filter((e=>e.getAttribute("rel")===`${String(t)}`)).forEach((t=>{const s=[];let i=0;for(let t=0;t<e.tyres;t++){i++;const t={};t.tyres=i,t.rate=100/e.tyres,s.push(t)}const a=d3.select(t).select(".list_profil2").append("svg").attr("class","axis2").attr("width",18).attr("height",18).style("margin","0 1px").append("g").attr("class","gOs").attr("id",e.osi).attr("transform","translate(9,9)"),n=(Math.PI,d3.arc().outerRadius(4).innerRadius(8).startAngle((function(e){return e.startAngle+Math.PI})).endAngle((function(e){return e.endAngle+Math.PI}))),r=d3.pie().sort(null).value((function(e){return e.rate}));a.selectAll(".arc").data(r(s)).enter().append("g").attr("class","arc").append("path").attr("d",n).style("fill","white").style("stroke","black"),a.append("g").attr("transform",(function(e,t){return"translate(0,0)"})).append("circle").attr("cx",0).attr("cy",0).attr("r",4).style("fill","black").style("stroke","gray"),a.append("g").attr("transform",(function(e,t){return"translate(0,0)"})).append("circle").attr("cx",0).attr("cy",0).attr("r",.5).style("fill","white")}))}fnPricep(e,t,s){const i=document.querySelector(`.${s}`);Array.from(i.lastElementChild.querySelectorAll(".listItem")).filter((e=>e.getAttribute("rel")===`${String(t)}`)).forEach((t=>{const s=[];let i=0;for(let t=0;t<e.tyres;t++){i++;const t={};t.tyres=i,t.rate=100/e.tyres,s.push(t)}const a=d3.select(t).select(".list_trail2").append("svg").attr("class","axis2").attr("width",18).attr("height",18).style("margin","0 0.5px").append("g").attr("class","gOs").attr("id",e.osi).attr("transform","translate(9,9)"),n=d3.arc().outerRadius(4).innerRadius(8).startAngle((function(e){return e.startAngle+Math.PI})).endAngle((function(e){return e.endAngle+Math.PI})),r=d3.pie().sort(null).value((function(e){return e.rate}));a.selectAll(".arc").data(r(s)).enter().append("g").attr("class","arc").append("path").attr("d",n).style("fill","white").style("stroke","black"),a.append("g").attr("transform",(function(e,t){return"translate(0,0)"})).append("circle").attr("cx",0).attr("cy",0).attr("r",4).style("fill","black").style("stroke","gray"),a.append("g").attr("transform",(function(e,t){return"translate(0,0)"})).append("circle").attr("cx",0).attr("cy",0).attr("r",.5).style("fill","white")}))}createElements(e,t,s){const i=document.createElement("i");i.classList.add("fas"),i.classList.add("fa-print"),i.classList.add("report_map_InList"),i.classList.add("report_unit"),i.setAttribute("rel",`${t}`),i.setAttribute("id",`${t}`),e.prepend(i),new g(i,["Перейти в отчеты"]);const a=document.createElement("i");a.classList.add("fas"),a.classList.add("fa-map-marker-alt"),a.classList.add("report_map_InList"),a.classList.add("map_unit"),a.setAttribute("rel",`${t}`),a.setAttribute("id",`${t}`),e.prepend(a),new g(a,["Перейти на карту"]);const n=document.createElement("div");n.classList.add("newCelChange"),n.setAttribute("rel","pressure tagach"),n.classList.add("list_profil2"),s.appendChild(n);const r=document.createElement("div");return r.classList.add("newCelChange"),r.setAttribute("rel","pressure pricep"),r.classList.add("list_trail2"),s.appendChild(r),[n,r]}createIconsAndLeftSpisok(e,t,s,a,n){const r=e[0].message.replace(/\s+/g,""),l=document.createElement("div");l.classList.add("listItem"),l.classList.add(`${n}`),"kursor"===n&&l.classList.add("sub"),l.classList.add(`${e[4]}`),l.setAttribute("rel",`${e[4]}`),l.setAttribute("id",`${e[4]}`),s.lastChild.appendChild(l);const o=document.createElement("div");o.classList.add("list_name2"),o.setAttribute("rel","name"),l.appendChild(o),o.textContent=e[0].message;const c=this.createElements(o,r,l),d=document.createElement("i");d.classList.add("fa","fa-check","checkInList"),d.setAttribute("rel",`${r}`),d.setAttribute("id",`${r}`),o.prepend(d);const h=document.createElement("i");h.classList.add("fas","fa-times","deleteObject"),h.setAttribute("rel",`${r}`),h.setAttribute("id",`${r}`),o.prepend(h),new g(h,["Удалить объект"]);const u=document.createElement("i");let p;u.classList.add("fas","fa-wrench","pref"),u.style.color=!1===e[5]?"red":"darkblue",o.prepend(u),new g(u,["Редактировать объект"]),"master"===n&&("kursor"===e[e.length-1]?(l.classList.add("kursor"),o.classList.add("kursor_name")):l.classList.add("wialon"));const m=t.find((t=>"engine"===t[1]&&t[2]===e[4])),y=m?Number(m[3]):null,v=t.find((t=>"sats"===t[1]&&t[2]===e[4])),f=v?Number(v[3]):null,b=f?f>4&&1===y?"ВКЛ":"ВЫКЛ":null;e[0].result&&i(e[0].result).forEach((t=>{p=t.type,document.createElement("div").classList.add("osi_list"),("Прицеп"!==t.trailer&&"2"===t.tyres||"Прицеп"!==t.trailer&&"4"===t.tyres)&&this.fnTagach(t,e[4],a),("Прицеп"===t.trailer&&"2"===t.tyres||"Прицеп"==t.trailer&&"4"===t.tyres)&&this.fnPricep(t,e[4],a)}));const w=document.querySelector(`.${a}`);Array.from(w.lastElementChild.querySelectorAll(".listItem")).filter((t=>t.getAttribute("rel")===`${String(e[4])}`)).forEach((t=>{const s=t.querySelectorAll(".arc");let i=0;s.forEach((e=>{i++,e.setAttribute("id",i)})),this.coloring(s,r,e[1],e[2],e[3],y)})),this.updateIconsSensors(t,e[4],l,b,f,p,y),l.insertBefore(c[1],l.children[6]),l.insertBefore(c[0],l.children[5])}findDomElement(){this.groups=this.lowList.querySelectorAll(".groups"),this.listItem=this.lowList.querySelectorAll(".listItem"),this.removeElements(this.groups),this.removeElements(this.listItem)}removeElements(e){e&&e.forEach((e=>{e.remove()}))}updateData(e,t){this.data=e,this.element=t,this.init()}format(e,t){const s=e.filter((e=>0!==e.length));if(1===t){const e=s.flat().flatMap((e=>{if(!e[2]||!e[2].result)return[];let t=e[2].result.filter((e=>null!==e.value)).map((e=>[e.sens,e.params,Number(e.idw),Number(e.value),e.status,e.meta])).filter((e=>e.length>0));return 10===e.length&&e[8]&&e[8].sub&&0!==e[8].sub.length?Object.values(e[8].sub).flat().flatMap((e=>e[2]&&e[2].result?e[2].result.filter((e=>null!==e.value)).map((e=>[e.sens,e.params,Number(e.idw),Number(e.value),e.status,e.meta])).filter((e=>e.length>0)):[])):t}));return Array.from(new Set(e.map((e=>JSON.stringify(e))))).map((e=>JSON.parse(e)))}{const e=[],t=s.flat().flatMap((t=>(10===t.length&&t[8]&&t[8].sub&&0!==t[8].sub.length&&e.push(Object.values(t[8].sub).flat().map((e=>e[4]))),t[4]||[])));return[...new Set(t.concat(e.flat()))]}}}class Le{static markers={};static markersArrow={};static polyMode={};static iconsMode="normal";static namesMode="normal";static trackMode="normal";constructor(e,t,s){this.list=e,this.map=t,this.geoTrack=s,this.settings=document.querySelector(".settingsMap"),this.container=document.querySelector(".containerSettingsMap"),this.objIconsMarkers={},this.listObject=document.querySelectorAll(".listItem"),this.tableInfoCar=document.querySelector(".tableInfoCar")}opasityMarkers(e){const t=e.id,s=Le.markers[t],i=Le.markersArrow[t];if(s){console.log(s),Object.values(Le.markers).forEach((e=>{e.setOpacity(0),e._tooltip&&e.closeTooltip()})),Object.values(Le.markersArrow).forEach((e=>{e.setOpacity(0),e._tooltip&&e.closeTooltip()})),s._tooltip&&s.openTooltip(),s.setOpacity(1),i.setOpacity(1);const e=s.getLatLng();this.map.setView(e,8)}}opasityMarkersBack(e){Object.values(Le.markers).forEach((e=>{e.setOpacity(1),e._tooltip&&e.openTooltip()})),Object.values(Le.markersArrow).forEach((e=>{e.setOpacity(1)}))}viewHiddenInfoMap(){this.tableInfoCar.addEventListener("mouseenter",(()=>{Array.from(this.tableInfoCar.children[0].children).forEach((e=>{e.style.display="flex"})),this.tableInfoCar.children[0].style.justifyContent="space-around",this.tableInfoCar.children[0].style.width="300px"})),this.tableInfoCar.addEventListener("mouseleave",(()=>{document.querySelector(".iconMapsInfoActive")||(console.log("тут?"),Array.from(this.tableInfoCar.children[0].children).forEach((e=>{e.style.display="none",this.tableInfoCar.children[0].children[0].style.display="flex"})),this.tableInfoCar.children[0].style.justifyContent="",this.tableInfoCar.children[0].style.width="")}))}createInfoControll(){const e=document.querySelectorAll(".checkInList"),t=new Set(this.list.filter((e=>e[0])).map((e=>Number(e[0]))));let s=t.size;const i=new Set;e.forEach((e=>{const a=Number(e.parentNode.parentNode.id);t.has(a)&&e.classList.contains("changeColorCheck")&&(i.add(a),s--)}));let a=0;const n={move:0,pause:0,stop:0};this.list.forEach((e=>{if(!i.has(Number(e[0])))if("off"===e[6])a++;else{const t=e[4];"Движется"!==t&&"Остановка"!==t&&"Стоянка"!==t||n["Движется"===t?"move":"Остановка"===t?"pause":"stop"]++}}));const r=[e.length,s,a,n.move,n.pause,n.stop];[...this.tableInfoCar.children[0].children].forEach(((e,t)=>{e.textContent=r[t]}))}viewHiddenMenuMap(){this.settings.addEventListener("mouseenter",(()=>{this.container.style.display="flex",this.settings.style.width="165px",this.settings.firstElementChild.innerHTML='<i class="fas fa-cogs" style="padding-right:10px" ></i> Настройки'})),this.settings.addEventListener("mouseleave",(()=>{this.container.style.display="none",this.settings.style.width="30px",this.settings.firstElementChild.innerHTML='<i class="fas fa-cogs"></i>'}))}nameObjectView(){console.log(Le.markers),Le.namesMode="normal"===Le.namesMode?"alternate":"normal",console.log(Le.namesMode),Object.values(Le.markers).forEach((e=>{"normal"!==Le.namesMode?e.bindTooltip("normal"===Le.iconsMode?e.group:e.name,{permanent:!0,direction:"top",className:"my-custom-tooltip"}).openTooltip():e.unbindTooltip()}))}toggleMarkersIcon(){console.log("здесь?"),document.querySelectorAll(".checkInList").forEach((e=>{const t=e.closest(".listItem").id;Le.markers[t]&&(e.classList.contains("changeColorCheck")?(this.map.removeLayer(Le.markers[t]),this.map.removeLayer(Le.markersArrow[t]),Le.markers[t].isTrackActive&&Le.polyMode[t].remove(this.map)):(Le.markers[t].addTo(this.map),Le.markers[t].isTrackActive&&Le.polyMode[t].addTo(this.map),this.list.forEach((e=>{e[0]===t&&("Стоянка"!==e[4]?Le.markersArrow[t].addTo(this.map):this.map.removeLayer(Le.markersArrow[t]))}))))}))}changeMarkersIcon(){Le.iconsMode="normal"===Le.iconsMode?"alternate":"normal",Object.values(Le.markers).forEach((e=>{let t;const s=L.Icon.extend({options:{iconSize:[30,30],iconAnchor:[10,18],popupAnchor:[0,0]}});"normal"===Le.iconsMode?(t=new s({iconUrl:"../../image/trailer.png",iconSize:[30,22],iconAnchor:[20,20],popupAnchor:[0,0],className:"custom-markers"}),e.setTooltipContent(e.group)):(t=new s({iconUrl:this.objIconsMarkers[e.group],iconSize:[30,30],iconAnchor:[20,20],popupAnchor:[0,0],className:"custom-markers-group"}),e.setTooltipContent(e.name)),e.setIcon(t)}))}async lastTravelTrek(e){let t=Math.round((new Date).getTime()/1e3),s=new Date,i=Math.round(s.setHours(s.getHours()-12)/1e3);const a=e.target.id,n=Le.markers[a];if(n.isTrackActive=!n.isTrackActive,n.isTrackActive){e.target.style.color="rgba(6, 28, 71, 1)";const s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:a,t1:i,t2:t})},n=await fetch("/api/geoLastInterval",s),r=(await n.json()).resTrack.map((e=>[e[0],e[1]]));if(Le.polyMode[a])Le.polyMode[a].setLatLngs(r);else{const e=L.polyline(r,{color:"rgb(0, 0, 204)",weight:1});Le.polyMode[a]=e}Le.polyMode[a].addTo(this.map)}else e.target.style.color="gray",Le.polyMode[a].remove(this.map)}addMarkersToMap(){Array.from(new Set(this.list.map((e=>e[8])))).forEach(((e,t)=>{this.objIconsMarkers[e]=`../../../image/${t+1}.png`})),this.list.forEach((e=>{const[t,s,i,a,n,r,,l,o]=e,c=new(L.Icon.extend({options:{iconSize:[30,30],iconAnchor:[10,18],popupAnchor:[0,0]}}))({iconUrl:"../../image/trailer.png",iconSize:[30,22],iconAnchor:[20,20],popupAnchor:[0,-10],className:"custom-markers"});var d=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrow" style="pointer-events: none;height: 75px;transform: rotate(${i}deg);"><img src="../../image/arrow2.png" style="width: 20px"></div>`});const h=`<i class="fas fa-check markerTrack" id=${t} style="margin-right:5px; cursor:pointer"></i><span class="titlePopupPoly">Построить трек</span>`;if(Le.markers[t]){Le.markers[t].setLatLng(s),Le.markersArrow[t].setLatLng(s);let e=Le.markersArrow[t].getElement();e&&(e.children[0].style.transform=`rotate(${i}deg)`),Le.markers[t].setPopupContent(`Группа: ${o}<br>Объект: ${l}<br>Актуальность данных: ${r}<br>Cостояние: ${n}<br>${"Поездка"===n?`Скорость: ${a} км/ч<br>`:""}Координаты: ${s}<br>${h}`)}else{const e=L.marker(s,{icon:c}).addTo(this.map),i=L.marker(s,{icon:d});"Стоянка"!==n?i.addTo(this.map):this.map.removeLayer(i),e.bindPopup(`Группа: ${o}<br>Объект: ${l}<br>Актуальность данных: ${r}<br>Cостояние: ${n}<br>${"Поездка"===n?`Скорость: ${a} км/ч<br>`:""}Координаты: ${s}<br>${h}`,{className:"my-popup-markers"}),e.group=o,e.name=l,e.id=t,e.isTrackActive=!1,e.on("mouseover",(function(e){this.openPopup()})),e.on("mouseout",(function(e){setTimeout((()=>this.closePopup()),2e3)})),e.on("popupopen",(e=>{let s=e.popup._contentNode;const i=s.querySelector(".markerTrack");Le.markers[t].isTrackActive?i.style.color="rgba(6, 28, 71, 1)":i.style.color="gray",s.clickEventAttached||(s.addEventListener("click",(e=>{e.target.matches(".markerTrack")&&this.lastTravelTrek.bind(this)(e)})),s.clickEventAttached=!0)})),Le.markers[t]=e,Le.markersArrow[t]=i,e.clickEventAttached||(e.clickEventAttached=!0)}}))}}let xe,Te,qe={};async function Ae(e){if(!document.getElementById("gMap")){const t=document.createElement("div");t.classList.add("globalmap"),t.setAttribute("id","gMap"),t.style.width="100%",t.style.height="100%",t.style.zIndex=0,e.appendChild(t),xe=L.map("gMap").setView([59.9386,30.3141],9),xe.attributionControl.setPrefix(!1),document.querySelector(".leaflet-control-attribution").style.display="none";const s=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'}).addTo(xe);L.control.scale({imperial:""}).addTo(xe),xe.addLayer(s),setTimeout((()=>{xe.invalidateSize()}),0)}const t=document.querySelectorAll(".listItem"),s={0:"Стоянка",1:"Движется",2:"Остановка"},i=Array.from(t).map((e=>e.id)).map((async e=>{const t=e,i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:t})},a=await fetch("api/getSens",i),n=await a.json(),r=n.find((e=>"speed"===e.params)),l=n.find((e=>"lat"===e.params)),o=n.find((e=>"lon"===e.params)),c=n.find((e=>"course"===e.params)),d=n.find((e=>"engine"===e.params)),h=n.find((e=>"last_valid_time"===e.params));let u;if(r.value&&d.value){const e=Number(r.value)>0&&1===Number(d.value)?1:0===Number(r.value)&&1===Number(d.value)?2:0===Number(r.value)&&0===Number(d.value)?0:void 0;u=s[e]}const p=[l.value,o.value];return null!==h.value?[e,p,Number(c.value),Number(r.value),u,h.value]:[]})).filter((e=>0!==e.length)),n=(await Promise.allSettled(i)).filter((e=>"fulfilled"===e.status)).map((e=>e.value)),r=Array.from(document.querySelectorAll(".checkInList")).reduce(((e,t)=>(e.push(t.closest(".listItem").id),e)),[]),l=n.reduce(((e,t)=>(r.includes(t[0])&&e.push(t),e)),[]).map((e=>{let t=[...e];const s=Math.floor((new Date).getTime()/1e3)-Number(e[5]);return t[5]=null==e[5]?null:a(Number(s)),t.push(null!==e[5]?s>3600?"off":"on":"-"),t})).reduce(((e,s)=>{const i=Array.from(t).filter((e=>s[0]===e.id)),a=i[0].children[0].textContent,n=i[0].closest(".groups").getAttribute("rel");return e.push([...s,a,n]),e}),[]);Ce=new Le(l,xe,qe),Ce.addMarkersToMap(),Ce.viewHiddenMenuMap(),Ce.viewHiddenInfoMap(),Ce.toggleMarkersIcon(),Ce.createInfoControll(),document.querySelectorAll(".checkMarkers").forEach(((e,t)=>{e.hasListener||(e.addEventListener("click",(()=>{switch(e.classList.toggle("checkMark"),t){case 0:const t=e.classList.contains("checkMark"),s=e.nextSibling;s&&(s.textContent=t?"Группа":"Тип"),Ce.changeMarkersIcon();break;case 1:Ce.nameObjectView()}})),e.hasListener=!0)}))}class Oe{constructor(){this.mark=document.querySelector(".markers"),this.are=document.querySelector(".area"),this.lin=document.querySelector(".line"),this.checkMarkers=this.mark?this.mark.querySelector(".item_type_p"):null,this.checkAres=this.are?this.are.querySelector(".item_type_p"):null,this.checkLine=this.lin?this.lin.querySelector(".item_type_p"):null,this.markers=document.querySelectorAll(".wrapper_marker"),this.area=this.are?this.are.querySelectorAll(".item_type_lineANDarea"):null,this.line=this.lin?this.lin.querySelectorAll(".item_type_lineANDarea"):null,this.markers&&this.markers.forEach((e=>e.addEventListener("click",this.toogleClickLegends.bind(this,e)))),this.area&&this.area.forEach((e=>e.addEventListener("click",this.toogleClickLegends.bind(this,e)))),this.line&&this.line.forEach((e=>e.addEventListener("click",this.toogleClickLegends.bind(this,e)))),this.checkMarkers&&this.checkMarkers.addEventListener("click",(()=>this.toogleClickLegendsAndCheckAll(this.checkMarkers))),this.checkAres&&this.checkAres.addEventListener("click",(()=>this.toogleClickLegendsAndCheckAll(this.checkAres))),this.checkLine&&this.checkLine.addEventListener("click",(()=>this.toogleClickLegendsAndCheckAll(this.checkLine)))}toogleClickLegendsAndCheckAll(e){const t=e.children[0],s=t.parentNode.nextElementSibling.children;t.classList.toggle("noactiveCheckAll"),Array.from(s).forEach((e=>{t.classList.contains("noactiveCheckAll")?e.children[0].classList.add("noactive"):e.children[0].classList.remove("noactive"),t.classList.contains("noactiveCheckAll")?this.controllVisualElementsToCharts(e.children[0].getAttribute("rel"),"hidden"):this.controllVisualElementsToCharts(e.children[0].getAttribute("rel"),"view")}))}toogleClickLegends(e){console.log(e),e.children[0].classList.toggle("noactive"),console.log(e),this.controllVisualElementsToCharts(e.children[0].getAttribute("rel"))}controllVisualElementsToCharts(e,t){console.log(e,t);const s=d3.select(".chart_to_wialon").selectAll(`[rel='${e}']`);console.log(s),t?"hidden"===t?s.style("opacity",0).classed("hidden",!0):s.style("opacity",1).classed("hidden",!1):s.classed("hidden")?s.style("opacity",1).classed("hidden",!1):s.style("opacity",0).classed("hidden",!0)}}class je{constructor(){this.listObjects=document.querySelectorAll(".listItem"),this.groups=document.querySelectorAll(".groups"),this.object=document.querySelector(".object"),this.file=document.querySelector(".file"),this.shablons=document.querySelector(".shablons"),this.interval=document.querySelector(".interval_reports"),this.buttons=document.querySelector(".btn_speedStart_reports"),this.titleReports=document.querySelector(".list_reports"),this.mapContainer=document.querySelector(".reports_maps"),this.reports_module=document.querySelector(".reports_module"),this.globalChartData=null,this.svg=null,this.xScaleStart=null,this.marker=null,this.map=null,this.stats=null,this.tablesReports=null,this.rows=null,this.attachments=null,this.backgroundRegions=null,this.markers=null,this.requestParams={idResourse:null,idShablon:null,idObject:null,timeInterval:null},this.createMap(),this.createCalendar(),this.checkObjects=this.object.querySelector(".toggle_reports"),this.checkShablons=this.shablons.querySelector(".toggle_reports"),this.checkInterval=this.interval.querySelector(".toggle_reports"),this.checkTypeFile=this.file.querySelector(".toggle_reports"),this.selectObjects=this.object.children[0].lastElementChild,this.selectShablons=this.shablons.children[0].lastElementChild,this.selectinterval=this.interval.children[0].lastElementChild,this.selectTypeFile=this.file.lastElementChild,this.checkShablons.addEventListener("click",this.hiddenView.bind(this)),this.checkInterval.addEventListener("click",this.hiddenView.bind(this)),this.checkTypeFile.addEventListener("click",this.hiddenView.bind(this)),this.file.querySelectorAll(".item_type_file").forEach((e=>e.addEventListener("click",this.changeTitleRequestFile.bind(this,e)))),this.interval.querySelectorAll(".item_type").forEach((e=>e.addEventListener("click",this.checkChoice.bind(this,e)))),this.selectShablons.addEventListener("mouseleave",this.hiddenListOutsideKursor.bind(this)),this.selectinterval.addEventListener("mouseleave",this.hiddenListOutsideKursor.bind(this)),this.selectTypeFile.addEventListener("mouseleave",this.hiddenListOutsideKursor.bind(this)),this.buttons.children[1].addEventListener("click",this.requestDataTitleReport.bind(this))}async createCalendar(){const e=this.interval.nextElementSibling,t=`#${e.children[0]?e.children[0].id:e.id}`,s=new p;this.requestParams.timeInterval=await s.getTimeInterval(e,t)}changeTitleRequestFile(e){e.closest(".file").querySelector(".titleChange_list_name").textContent=e.lastElementChild.textContent,"cursor"===this.requestParams.idResourse?this.convertPDF(this.globalChartData):this.downloadFileReports(e)}async convertPDF(e){const t=Array.from(document.querySelectorAll(".titleNameReport")).reduce(((e,t)=>(e.push(t.textContent),e)),[]),s=e.stats,i=e.tables,a=e.row,n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stats:s,titleNameReports:t,tables:i,rows:a})},r=await fetch("/api/fileDown",n),l=await r.blob(),o=document.createElement("a");o.href=URL.createObjectURL(l),o.download="report.pdf",o.click()}async downloadFileReports(e){const t=this.object.querySelector(".titleChange_list_name").textContent.replace(/\s+/g,"_"),s=this.shablons.querySelector(".titleChange_list_name").textContent.replace(/\s+/g,"_"),i=e.getAttribute("data-attribute"),a=e.getAttribute("rel"),n=this.requestParams.timeInterval.reduce(((e,t)=>(e.push(this.converterTimes(t)),e)),[]),r={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({format:i,formatToWialon:a})},l=await fetch("/api/file",r),o=await l.blob(),c=document.createElement("a");c.href=URL.createObjectURL(o),c.download=`${s}.${t}.${n[0]}_по_${n[1]}.${i}`,c.click()}converterTimes(e){let t=new Date(1e3*e);return`${t.getFullYear()}-${("0"+(t.getMonth()+1)).slice(-2)}-${("0"+t.getDate()).slice(-2)} ${("0"+t.getHours()).slice(-2)}:${("0"+t.getMinutes()).slice(-2)}:${("0"+t.getSeconds()).slice(-2)}`}converterTimesTooltip(e){let t=new Date(1e3*e),s=(t.getFullYear(),("0"+(t.getMonth()+1)).slice(-2)),i=("0"+t.getDate()).slice(-2),a=("0"+t.getHours()).slice(-2),n=("0"+t.getMinutes()).slice(-2);return("0"+t.getSeconds()).slice(-2),`${i}.${s} ${a}:${n}`}formatTime(e){var t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=e%60;return t.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}async requestDataTitleReport(){const e=document.querySelectorAll(".titleNameReport");e&&e.forEach((e=>e.remove()));let t=!0;for(let e in this.requestParams)null==this.requestParams[e]&&(t=!1);if(!t){const e=document.querySelector(".inform");return e.textContent="Выберите все параметры отчета",void setTimeout((()=>e.textContent=""),5e3)}const s=document.querySelector(".loaders_report");s.style.display="flex";const i=this.requestParams.idResourse,a=this.requestParams.idShablon,n=this.requestParams.idObject,r=this.requestParams.timeInterval;if("cursor"===i){console.time("рек");const e=await this.requestData(a,n,r);console.timeEnd("рек"),this.globalChartData=e,this.stats=e.stats,this.attachments=e.attachments,this.tablesReports=e.tables,this.rows=e.row,this.clearTable(),this.createListTitleReports(this.tablesReports,this.stats,this.attachments),s.style.display="none"}else{const e=await fetch("/api/titleShablon",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idResourse:i,idShablon:a,idObject:n,interval:r})}),t=await e.json();this.tablesReports=t.data.reportResult.tables,this.stats=t.data.reportResult.stats,this.rows=t.rows,this.attachments=t.data.reportResult.attachments,this.clearTable(),this.createListTitleReports(this.tablesReports,this.stats,this.attachments),s.style.display="none"}if(0!==this.stats.length){const e=document.createElement("li");e.classList.add("titleNameReport"),e.classList.add("activeTitleReports"),e.textContent="Статистика",this.titleReports.prepend(e),this.reports_module.lastElementChild.children[0].textContent=this.titleReports.children[0].textContent,this.createStatsTable(this.stats),document.querySelectorAll(".titleNameReport").forEach((e=>e.addEventListener("click",this.createMetaTable.bind(this,e))))}else{const e=document.querySelectorAll(".titleNameReport");e[0].classList.add("activeTitleReports"),0!==this.tablesReports.length&&this.createTable(this.tablesReports,this.rows,e[0].id),this.checkPointerToMaps(),this.reports_module.lastElementChild.children[0].textContent=e[0].textContent,e.forEach((e=>e.addEventListener("click",this.createMetaTable.bind(this,e))))}}createMetaTable(e){console.log(e),this.clearTable(),this.marker&&this.hiddenMarkerToMap(),document.querySelectorAll(".titleNameReport").forEach((e=>e.classList.remove("activeTitleReports"))),this.reports_module.lastElementChild.children[0].textContent=e.textContent,e.classList.toggle("activeTitleReports"),e.id?"chart"===e.id?"cursor"===this.requestParams.idResourse?this.createChartToWialon(this.globalChartData):this.requestChartData(e.getAttribute("rel")):(this.createTable(this.tablesReports,this.rows,e.id),this.checkPointerToMaps()):this.createStatsTable(this.stats)}async requestChartData(e){console.log(e);const t=this.requestParams.timeInterval,s=await fetch("/api/chartData",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({interval:t,att:e})}),i=await s.json();console.log(i),this.createChartToWialon(i)}createOsiFormat(e,t,s){return Object.values(e.datasets).map((e=>{const s=d3.scaleTime().domain(d3.extent(e.data.x,(e=>new Date(1e3*e)))).range([70,t.clientWidth-410]),i=d3.scaleLinear().domain([0,d3.max(e.data.y,(e=>parseFloat(e)))]).range([t.clientHeight-30,35]),a=d3.line().x((e=>s(e.x))).y((e=>i(parseFloat(e.y))));return{data:e.data.x.map(((t,s)=>({x:new Date(1e3*t),y:parseFloat(e.data.y[s])<-100?parseFloat(e.data.y[s-1]):parseFloat(e.data.y[s])}))),name:e.name,color:"number"==typeof e.color?e.color.toString(16):e.color,uniq:e.y_axis,xScale:s,yScale:i,line:a}}))}createLine(e,t){e.forEach((e=>{t.append("path").datum(e.data).attr("class","linezoom").attr("clip-path","url(#clip)").attr("d",e.line).attr("rel",`${e.color}`).attr("stroke",`#${e.color}`).attr("stroke-width",1.5).attr("fill","none")}))}createArea(e,t,s,i){e.interval.forEach((a=>{t.append("rect").attr("x",s(new Date(Math.round(a[0][0]?1e3*a[0][0]:1e3*a[0])))).attr("y",35).attr("class","areazoom").attr("clip-path","url(#clip)").attr("width",s(new Date(Math.round(a[1][0]?1e3*a[1][0]:1e3*a[1])))-s(new Date(Math.round(a[0][0]?1e3*a[0][0]:1e3*a[0])))).attr("height",i.clientHeight-65).attr("rel",`${e.id}`).attr("fill",`#${e.color}`).attr("stroke","none")}))}createMarkers(e,t,s){const i={8:"../../../image/ref.png",32:"../../../image/parking.png",256:"../../../image/sliv.png",128:"../../../image/stop.png",64:"../../../image/maxspeed.png",4:"../../../image/er.png",10:"../../../image/tah.png",11:"../../../image/prst.png",12:"../../../image/drain.png"};t.selectAll("image").data(e).enter().append("image").attr("class","markerszoom").attr("clip-path","url(#clip)").attr("x",(e=>s(new Date(1e3*e.time.x)))).attr("rel",(function(e){return e.type})).attr("xlink:href",(function(e){return i[e.type]})).attr("width",16).attr("height",16).style("opacity",1).attr("transform","translate(-8,10)").each((function(e,t,s){new g(s[t],8!==e.type?[[`${e.tool}: ${e.time.str}`],[`Длительность: ${e.time.duration}`]]:[[`${e.name}: ${e.time.start}`],[`${e.tool}: ${e.time.value} л.`]])}))}createLegendaNavi(e,t){const s={8:"../../../image/ref.png",32:"../../../image/parking.png",256:"../../../image/sliv.png",128:"../../../image/stop.png",64:"../../../image/maxspeed.png",4:"../../../image/er.png",10:"../../../image/tah.png",11:"../../../image/prst.png",12:"../../../image/drain.png"};if(t.markers){const i=document.createElement("div");i.classList.add("markers"),e.appendChild(i);const a=document.createElement("div");a.classList.add("item_type_p"),i.appendChild(a);const n=document.createElement("i");n.classList.add("fa"),n.classList.add("fa-check"),n.classList.add("checkAll"),a.appendChild(n);const r=document.createElement("p");r.classList.add("text_type_p"),r.textContent="Все маркеры",a.appendChild(r);const l=document.createElement("div");l.classList.add("markers_container"),i.appendChild(l),t.markers.forEach((e=>{const t=document.createElement("div");t.classList.add("wrapper_marker"),l.appendChild(t);const i=document.createElement("div");i.classList.add("markers_image"),i.style.backgroundImage=`url(${s[e.type]})`,i.setAttribute("rel",e.type),t.appendChild(i),new g(i,[e.sensor])}))}if(t.background_regions){const s=document.createElement("div");s.classList.add("area"),e.appendChild(s);const i=document.createElement("div");i.classList.add("item_type_p"),s.appendChild(i);const a=document.createElement("i");a.classList.add("fa"),a.classList.add("fa-check"),a.classList.add("checkAll"),i.appendChild(a);const n=document.createElement("p");n.classList.add("text_type_p"),n.textContent="Все области",i.appendChild(n);const r=document.createElement("div");r.classList.add("area_line_container"),s.appendChild(r),t.background_regions.forEach((e=>{const t=document.createElement("div");t.classList.add("item_type_lineANDarea"),r.appendChild(t);const s=document.createElement("i");s.classList.add("fa"),s.classList.add("fa-check"),s.classList.add("marg"),s.classList.add("galka"),s.setAttribute("rel",e.id),t.appendChild(s);const i=document.createElement("div");i.classList.add("fon"),i.style.background=`#${e.color.toString(16)}`,t.appendChild(i);const a=document.createElement("p");a.classList.add("text_type_p"),a.classList.add("fonAndArea"),a.textContent=`${e.name}`,t.appendChild(a)}))}if(t.datasets){const s=document.createElement("div");s.classList.add("line"),e.appendChild(s);const i=document.createElement("div");i.classList.add("item_type_p"),s.appendChild(i);const a=document.createElement("i");a.classList.add("fa"),a.classList.add("fa-check"),a.classList.add("checkAll"),i.appendChild(a);const n=document.createElement("p");n.classList.add("text_type_p"),n.textContent="Все линии",i.appendChild(n);const r=document.createElement("div");r.classList.add("area_line_container"),s.appendChild(r),Object.values(t.datasets).forEach((e=>{const t=document.createElement("div");t.classList.add("item_type_lineANDarea"),r.appendChild(t);const s=document.createElement("i");s.classList.add("fa"),s.classList.add("fa-check"),s.setAttribute("rel","number"==typeof e.color?e.color.toString(16):e.color),s.classList.add("galka"),t.appendChild(s);const i=document.createElement("div");i.classList.add("fon"),i.classList.add("line_color"),i.style.background=`#${e.color.toString(16)}`,t.appendChild(i);const a=document.createElement("p");a.classList.add("text_type_p"),a.classList.add("small_discription"),a.textContent=`${e.name}`,t.appendChild(a)}))}}createChartToWialon(e){const t=document.querySelector(".chart_to_wialon");t&&t.remove();const s=document.querySelector(".legenda_navi");s&&s.remove();const i=this.reports_module.lastElementChild.children[1].children[0],a=document.createElement("div");a.classList.add("legenda_navi"),a.style.height=i.clientHeight-20+"px",this.reports_module.lastElementChild.children[1].children[0].appendChild(a);const n=document.createElement("div");n.classList.add("chart_to_wialon"),this.reports_module.lastElementChild.children[1].children[0].appendChild(n);const r=this.attachments[0].axis_y;i.style.display="flex",i.style.justifyContent="space-around",i.style.alignItems="center",this.createLegendaNavi(a,e);const l=d3.select(".chart_to_wialon").append("svg").attr("class","chart_reports").attr("width",i.clientWidth-300).attr("height",i.clientHeight);this.svg=l,l.append("defs").append("clipPath").attr("id","clip").append("rect").attr("class","clipart").attr("width",i.clientWidth-480).attr("height",i.clientHeight).attr("x",70).attr("y",0);const o=d3.scaleTime().domain(d3.extent(e.possitions.time,(e=>new Date(1e3*e)))).range([70,i.clientWidth-410]);this.xScaleStart=o;const c=this.createOsiFormat(e,i,l);e.background_regions&&(this.backgroundRegions=e.background_regions.reduce(((e,t)=>(e.push({name:t.name,id:t.id,priority:t.priority,interval:t.regions,color:t.color.toString(16)}),e)),[]),this.backgroundRegions.forEach((e=>{this.createArea(e,l,o,i)}))),e.datasets&&this.createLine(c,l),void 0!==e.markers&&(this.markers=e.markers.flatMap((e=>e.x.map((t=>({name:e.sensor,time:t,type:e.type,tool:e.tool}))))),this.createMarkers(this.markers,l,o)),l.append("g").attr("transform",`translate(0, ${i.clientHeight-30})`).attr("class","os1").attr("clip-path","url(#clip)").call(d3.axisBottom(o).ticks(10).tickFormat((function(e){return d3.timeFormat("%H:%M")(e)}))),l.append("g").attr("transform",`translate(0, ${i.clientHeight-20})`).attr("class","os2").attr("clip-path","url(#clip)").call(d3.axisBottom(o).ticks(10).tickFormat((function(e){return d3.timeFormat("%d.%m")(e)}))).style("stroke-width",0),l.append("g").attr("transform","translate(70,0)").attr("class","osy1").call(d3.axisLeft(c[0].yScale).ticks(10)),l.append("g").attr("transform",`translate(${i.clientWidth-410}, 0)`).attr("class","osy2").call(d3.axisRight(c[1].yScale)).selectAll("text").attr("dx","5").attr("dy","-.3em").style("text-anchor","start"),l.append("text").attr("y",10).attr("x",-190).attr("dy","1em").style("text-anchor","middle").attr("transform","rotate(-90)").style("font-size","1rem").style("font-weight",400).text(`${r[0]}`),l.append("text").attr("y",i.clientWidth-350).attr("x",-190).attr("dy","1em").style("text-anchor","middle").attr("transform","rotate(-90)").style("font-size","1rem").style("font-weight",400).text(`${r[1]}`),new Oe,l.call(d3.zoom().on("zoom",this.zoomed.bind(this,c,o,l))),this.createTooltip(l,c,e,o,i)}createTooltip(e,t,s,i,a){const n=document.querySelector(".chart-tooltip");n&&n.remove();const r=document.querySelector(".chart_to_wialon"),l=document.createElement("div");l.classList.add("chart-tooltip"),r.appendChild(l),e.on("mouseout",(()=>{l.style.display="none"})).on("mousemove",(function(){const e=document.querySelector(".line"),s=Array.from(e.querySelectorAll(".noactive")).reduce(((e,t)=>(e.push(t.getAttribute("rel")),e)),[]),[a,n]=d3.mouse(this);if(n<30||n>425)l.style.display="none";else{const r=t.map((e=>{const t=function(e,t){console.log(e,t);const s=i.invert(e),a=t.map(((e,t)=>e.x)),n=d3.bisect(a,s);return n<0?-1:[s,n]}(a,e.data);return t[1]<=0?-1:t})),o=r.reduce(((e,i,a)=>{const n=t[a].name.split(" "),r=n.pop();return 0!==s.length?s.filter((e=>e!==t[a].color)).length===s.length&&e.push(c(t[a],n,i,r)):e.push(c(t[a],n,i,r)),e}),[]);function c(e,t,s,i){return{color:e.color,name:t.join(" "),value:parseFloat("number"===e.data[s[1]].y?e.data[s[1]].y.toFixed(2):e.data[s[1]].y),val:i,uniq:e.color}}const d=Math.floor(new Date(r[0][0]).getTime()/1e3),h=new Date(1e3*d),u=`${h.getDate().toString().padStart(2,"0")}.${(h.getMonth()+1).toString().padStart(2,"0")}.${h.getFullYear()} ${h.getHours().toString().padStart(2,"0")}:${h.getMinutes().toString().padStart(2,"0")}:${h.getSeconds().toString().padStart(2,"0")}`;l.innerHTML=`<div class="title_tooltip">${u}</div>\n            <div class="body_tooltip">${o.map((e=>`<div class="all_list_tooltip"><div class="color_tooltip" style="width: 20px; height: 2px; background: #${e.color}"></div>\n<div class="list_tooltip" rel=${e.uniq}>${e.name}  ${e.value} ${e.val}</div></div>`)).join("")}</div>`,l.style.left=a<=460?a+30+"px":a-250+"px",l.style.top=n<=320?n+10+"px":n-60+"px",l.style.display="block"}}))}zoomed(e,t,s,i){const a=d3.event.transform,n=a.rescaleX(t);e.forEach((e=>{e.xScale=a.rescaleX(t),e.line=e.line.x((t=>e.xScale(t.x)))})),s.select(".os1").call(d3.axisBottom(t).ticks(10).tickFormat((function(e){return d3.timeFormat("%H:%M")(e)})).scale(n)),s.select(".os2").call(d3.axisBottom(t).ticks(10).tickFormat((function(e){return d3.timeFormat("%d.%m")(e)})).scale(n)),s.selectAll(".linezoom").data(e).attr("d",(e=>e.line(e.data))),this.backgroundRegions.forEach((e=>{s.selectAll(`[rel = '${e.id}']`).data(e.interval).attr("x",(e=>n(new Date(Math.round(e[0][0]?1e3*e[0][0]:1e3*e[0]))))).attr("width",(e=>n(new Date(Math.round(e[1][0]?1e3*e[1][0]:1e3*e[1])))-n(new Date(Math.round(e[0][0]?1e3*e[0][0]:1e3*e[0])))))})),s.selectAll(".markerszoom").data(this.markers).attr("x",(e=>n(new Date(1e3*e.time.x)))),this.createTooltip(s,e,i,n)}hiddenMarkerToMap(){this.map.removeLayer(this.marker)}checkPointerToMaps(){const e=document.querySelectorAll(".pointer_cell");e.forEach((t=>t.addEventListener("click",(()=>{e.forEach((e=>{e.classList.remove("active_cell")})),t.classList.add("active_cell");const s=t.getAttribute("rel").split(","),i=t.textContent,a=new(L.Icon.extend({options:{iconSize:[20,30],iconAnchor:[10,18],popupAnchor:[0,0]}}))({iconUrl:"../../image/map1.png",iconSize:[30,22],iconAnchor:[20,20],popupAnchor:[0,-10],className:"custom-markers"});this.marker?this.marker.setLatLng(s).addTo(this.map):this.marker=L.marker(s,{icon:a}).addTo(this.map),this.map.setView(s,9),this.marker.bindPopup(i,{width:60,className:"reports_popup",autoPan:!1}),this.marker.on("mouseover",(function(e){this.openPopup()})),this.marker.on("mouseout",(function(e){this.closePopup()}))}))))}createTable(e,t,s){t.length;const i=e.filter(((e,t)=>t===Number(s))),a=t.filter(((e,t)=>t===Number(s)))[0].reduce(((e,t)=>{const s=t.c.map((e=>e));return e.push(s),e}),[]),n=document.createElement("table");n.classList.add("cell_params"),n.style.width="100%";const r=document.createElement("tr");r.classList.add("headersRow"),r.classList.add("row_up"),i[0].header.forEach((e=>{const t=document.createElement("th");t.classList.add("header_table_reports"),t.textContent=e.replace(/Grouping/g,"Дата"),r.appendChild(t)}));const l=document.createElement("tr");l.classList.add("headersRow"),l.classList.add("row_footer"),i[0].total&&i[0].total.forEach((e=>{const t=document.createElement("th");t.classList.add("header_table_reports"),t.textContent=e,l.appendChild(t)})),n.appendChild(r),a.forEach((e=>{const t=document.createElement("tr");for(var s=0;s<e.length;s++){const i=document.createElement("td");"object"==typeof e[s]&&null!==e[s]?(i.textContent=e[s].t,i.setAttribute("rel",[e[s].y,e[s].x]),i.classList.add("pointer_cell")):i.textContent=e[s],t.appendChild(i)}n.appendChild(t)})),n.appendChild(l),r.style.position="sticky",r.style.top="0",l.style.position="sticky",l.style.bottom="0",this.reports_module.lastElementChild.children[1].children[0].appendChild(n)}createStatsTable(e){if(0===e.length)return;const t=document.createElement("table");t.classList.add("cell_params");for(var s=0;s<e.length;s++){const i=document.createElement("tr"),a=document.createElement("td"),n=document.createElement("td");a.textContent=e[s][0],n.textContent=e[s][1],i.appendChild(a),i.appendChild(n),t.appendChild(i)}this.reports_module.lastElementChild.children[1].children[0].appendChild(t)}clearTable(){const e=document.querySelector(".cell_params");e&&e.remove(),this.reports_module.lastElementChild.children[1].children[0].style.display="block";const t=document.querySelector(".chart_to_wialon");t&&t.remove();const s=document.querySelector(".legenda_navi");s&&s.remove()}createListTitleReports(e){const t=document.querySelectorAll(".titleNameReport");t&&t.forEach((e=>e.remove())),e.forEach(((e,t)=>{const s=document.createElement("li");s.classList.add("titleNameReport"),s.setAttribute("id",t),s.textContent=e.label,this.titleReports.appendChild(s)})),0!==this.attachments.length&&this.attachments.forEach(((e,t)=>{const s=document.createElement("li");s.classList.add("titleNameReport"),s.setAttribute("id","chart"),s.setAttribute("rel",`${t}`),s.textContent=e.name,this.titleReports.appendChild(s)}))}hiddenListOutsideKursor(e){e.target.classList.remove("hidden_view")}checkChoice(e){const t=e.closest(".select_list").querySelector(".titleChange_list_name");e.firstElementChild.classList.toggle("radio_choice"),e.firstElementChild.classList.contains("radio_choice")?(t.textContent=t.getAttribute("rel"),this.clearParams(e)):(t.textContent=e.lastElementChild.textContent,this.pushParams(e)),Array.from(e.parentNode.children).forEach((t=>{t===e||t.firstElementChild.classList.contains("radio_choice")||t.firstElementChild.classList.toggle("radio_choice")}))}pushParams(e){if(e.parentNode.parentNode.parentNode.classList.contains("shablons")){const t=document.querySelector(".list_item1");t.style.color="red",setTimeout((()=>{t.style.color=""}),3e3),this.requestParams.idResourse=e.getAttribute("rel"),this.requestParams.idShablon=e.getAttribute("data-attribute");const s=e.getAttribute("data-ct");this.object.style.display="block";const i=this.object.children[0].lastElementChild;Array.from(i.children).forEach((e=>e.remove())),"avl_unit"===s?this.createListObjects():this.createListGroup(),this.object.querySelectorAll(".item_type").forEach((e=>e.addEventListener("click",this.checkChoice.bind(this,e))))}if(e.parentNode.parentNode.parentNode.classList.contains("interval_reports")){const t=this.getTimeInterval(e.lastElementChild.textContent);this.requestParams.timeInterval=t,this.interval.nextElementSibling.children[0].value=""}}clearParams(e){e.parentNode.parentNode.parentNode.classList.contains("shablons")&&(this.requestParams.idResourse=null,this.requestParams.idShablon=null,this.object.style.display="none"),e.parentNode.parentNode.parentNode.classList.contains("interval_reports")&&(this.requestParams.timeInterval=null)}getTimeInterval(e){(new Date).getDay();const t=new Date;let s,i,a=Math.floor(new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0).getTime()/1e3);if("Неделя"===e){const e=this.getPreviousWeekUnixTimestamps();s=e[0],i=e[1]}if("Месяц"===e){const e=this.getPreviousMonthUnixTimestamps();s=e[0],i=e[1]}return"Вчера"===e&&(s=a-86400,i=s+86399),"Сегодня"===e&&(s=a,i=s+86399),[s,i]}getPreviousMonthUnixTimestamps(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth()-1,1),s=Math.floor(t.getTime()/1e3),i=new Date(e.getFullYear(),e.getMonth(),1);return[s,Math.floor(i.getTime()/1e3)-1]}getPreviousWeekUnixTimestamps(){const e=new Date,t=864e5*(e.getDay()-1),s=Math.floor(new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0).getTime())-t-6048e5,i=s+6048e5-1e3;return[Math.floor(s/1e3),Math.floor(i/1e3)]}hiddenView(e){e.target.parentNode.nextElementSibling.classList.toggle("hidden_view")}createListGroupSelect(e){this.object.querySelector(".titleChange_list_name").textContent=e.closest(".groups").getAttribute("rel"),this.requestParams.idObject=e.closest(".groups").id}createListGroup(){Array.from(this.listObjects).forEach((e=>{e.querySelector(".checkInList").style.opacity=0})),Array.from(this.groups).forEach((e=>{e.querySelector(".chekHidden").classList.add("changeColorCheck"),e.querySelector(".chekHidden").style.opacity=1}))}createListObjectsSelect(e){console.log(this.object.querySelector(".titleChange_list_name")),this.object.querySelector(".titleChange_list_name").textContent=e.getAttribute("rel"),this.requestParams.idObject=e.closest(".listItem").id}createListObjects(){Array.from(this.groups).forEach((e=>{e.querySelector(".chekHidden").style.opacity=0})),Array.from(this.listObjects).forEach((e=>{e.querySelector(".checkInList").classList.add("changeColorCheck"),e.querySelector(".checkInList").style.opacity=1}))}createShablonsObjects(e){const t=this.shablons.children[0].lastElementChild;t.children.length>0&&Array.from(t.children).forEach((e=>{e.remove()}));const s=document.createElement("li");s.classList.add("item_type"),t.appendChild(s);const i=document.createElement("i");i.classList.add("fa"),i.classList.add("fa-check"),i.classList.add("radio_choice"),s.appendChild(i);const a=document.createElement("p");a.classList.add("text_type"),s.appendChild(a),a.textContent="Основной отчет Курсор",s.setAttribute("rel","cursor"),s.setAttribute("data-attribute","moto"),s.setAttribute("data-ct","avl_unit"),e.forEach((e=>{const s=Object.values(e)[0];for(let i in s){const a=document.createElement("li");a.classList.add("item_type"),t.appendChild(a);const n=document.createElement("i");n.classList.add("fa"),n.classList.add("fa-check"),n.classList.add("radio_choice"),a.appendChild(n);const r=document.createElement("p");r.classList.add("text_type"),a.appendChild(r),r.textContent=s[i].n,a.setAttribute("rel",Object.keys(e)),a.setAttribute("data-attribute",s[i].id),a.setAttribute("data-ct",s[i].ct)}}))}async createListShablons(e){console.log(e);const t=await this.requestAllShablons();if(e){const s=Object.values(t).reduce(((t,s)=>{const i=Object.values(Object.values(s)[0]).reduce(((t,s,i)=>(s.ct===e&&(t[i]=s),t)),{});if(Object.values(i).length>0){const e={[Object.keys(s)[0]]:i};t.push(e)}return t}),[]);this.createShablonsObjects(s),this.shablons.querySelectorAll(".item_type").forEach((e=>e.addEventListener("click",this.checkChoice.bind(this,e)))),console.log(document.querySelector(".act_modules"));const i=document.querySelector(".act_modules").parentNode.children[2];this.createListObjectsSelect(i)}else this.createShablonsObjects(t),this.shablons.querySelectorAll(".item_type").forEach((e=>e.addEventListener("click",this.checkChoice.bind(this,e))))}async requestAllShablons(){const e=await fetch("/api/shablons",{method:"GET",headers:{"Content-Type":"application/json"}});return(await e.json()).items.reduce(((e,t)=>(e.push({[t.id]:t.rep}),e)),[])}createMap(){if(!document.getElementById("reportsMap")){const e=document.createElement("div");e.classList.add("miniMapReports"),e.setAttribute("id","reportsMap"),e.style.width="100%",e.style.height="100%",e.style.zIndex=0,this.mapContainer.appendChild(e),this.map=L.map("reportsMap").setView([59.9386,30.3141],9),this.map.attributionControl.setPrefix(!1),document.querySelector(".leaflet-control-attribution").style.display="none";const t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this.map);L.control.scale({imperial:""}).addTo(this.map),this.map.addLayer(t),setTimeout((()=>{this.map.invalidateSize()}),0)}}convertUnixTime(e){const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async requestData(e,t,s){const i=t,a=await this.requstModel(i),[n,r]=s,l=String(t);let o;this.listObjects.forEach((e=>{e.id===l&&(o=e)}));const c=await async function(e,t,s){const i=e;console.log(e,t,s);const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:i,t1:t,t2:s})},n=await fetch("/api/getDataParamsInterval",a);return await n.json()}(l,n,r),d=c.map((e=>({id:e.idw,time:new Date(1e3*Number(e.last_valid_time)),speed:Number(e.speed),geo:[Number(e.lat),Number(e.lon)],oil:Number(e.oil),pwr:Number(e.pwr),engine:Number(e.engine),mileage:Number(e.mileage),curse:Number(e.course),sats:Number(e.sats),engineOn:Number(e.engineOn)})));d.sort(((e,t)=>e.time-t.time));const h=["speed","sats","engine","pwr","oil","meliage"].map((e=>{const t=d.map((t=>({x:Number(t.time/1e3),y:t[e],geo:t.geo,speed:t.speed,sats:t.sats})));return{[e]:t}})),u=Math.min(...h.map((e=>Object.values(e)[0].length))),p=h.filter((e=>Object.values(e)[0].length===u)),m=Object.values(Object.values(p)[0])[0].reduce(((e,t,s)=>{const i={};return h.forEach((e=>{const t=Object.values(e)[0][s];i[Object.keys(e)[0]]=t?t.y:void 0})),e.push({...t,...i}),e}),[]),y=this.calculateOilUp(m),g=this.calculateOilSliv(m),v=this.calculate(m,a,"Моточасы"),f=this.calculate(m,a,"Простои"),b=this.calculate(m,a,"Зажигание"),w=this.calculate(m,a,"Скорость"),S=0!==v.length?this.diff(v):0,_=0!==f.length?this.diff(f):0,k=0!==f.length?this.diff(f,1):0,C=w.reduce(((e,t)=>(e.distance+=parseFloat(t[2].distance.toFixed(2)),e.oil+=parseFloat(t[2].rashod.toFixed(2)),e.duration+=t[1][0]-t[0][0],e.maxSpeed=Math.max(e.maxSpeed,t[2].maxSpeed),e.averageSpeed+=t[2].averageSpeed,e.count++,e)),{duration:0,distance:0,oil:0,maxSpeed:0,averageSpeed:0,count:0});C.averageSpeed=C.averageSpeed/C.count,C.averageRashod=parseFloat((C.oil/C.distance*100).toFixed(1));const E=S-_,L={type:10,tool:"Работа двигателя",sensor:"Начало работы двигателя",x:0!==v.length?this.xtimes(v):[]},x={type:11,tool:"Простой",sensor:"Начало простоя на холостом ходу",x:0!==f.length?this.xtimes(f):[]},T={type:8,tool:"Топливо",sensor:"Заправка",x:0!==y.length?this.xtimesOil(y):[]},q={type:12,tool:"Топливо",sensor:"Слив",x:0!==g.length?this.xtimesOil(g):[]},A=d.map((e=>Number(e.time/1e3))),O={oil:["Топливо, л.","410c96"],pwr:["Бортовое питание, В","d90b9e"],speed:["Скорость, км/ч","0eab5f"],sats:["Спутники, шт.","8f751a"]},j=h.filter((e=>!e.hasOwnProperty("engine")&&!e.hasOwnProperty("meliage"))),M=v.map((e=>{const t=e[1][0]-e[0][0];return{c:[{t:this.converterTimes(e[0][0]),y:e[0][1][0],x:e[0][1][1]},e[0][1].join(""),{t:this.converterTimes(e[1][0]),y:e[1][1][0],x:e[1][1][1]},e[1][1].join(""),this.formatTime(t)]}})),N=f.map((e=>{const t=parseFloat(e[0][2]-e[1][2]).toFixed(1);return{c:[{t:this.converterTimes(e[0][0]),y:e[0][1][0],x:e[0][1][1]},e[0][1].join(""),{t:this.converterTimes(e[1][0]),y:e[1][1][0],x:e[1][1][1]},e[1][1].join(""),this.formatTime(e[1][0]-e[0][0]),t>0?`${t} л.`:"-"]}})),I=y.map((e=>({c:[{t:this.converterTimes(e.timeStart),y:e.geo[0],x:e.geo[1]},{t:this.converterTimes(e.timeFinish),y:e.geo[0],x:e.geo[1]},e.geo.join(""),`${e.startOilValue} л.`,`${e.finishOilValue} л.`,`${e.valueOil} л.`]}))),$=g.map((e=>({c:[{t:this.converterTimes(e.timeStart),y:e.geo[0],x:e.geo[1]},{t:this.converterTimes(e.timeFinish),y:e.geo[0],x:e.geo[1]},e.geo.join(""),`${e.startOilValue} л.`,`${e.finishOilValue} л.`,`${e.valueOil} л.`]}))),D=w.map((e=>{const t=(e[2].rashod/e[2].distance*100).toFixed(1);return{c:[{t:this.converterTimes(e[0][0]),y:e[0][1][0],x:e[0][1][1]},e[0][1].join(""),{t:this.converterTimes(e[1][0]),y:e[1][1][0],x:e[1][1][1]},e[1][1].join(""),e[2].duration,`${e[2].distance} км.`,`${e[2].averageSpeed} км.ч`,`${e[2].maxSpeed} км/ч`,`${e[2].rashod.toFixed(1)} л.`,`${t} л.`]}})),P=this.shablons.querySelector(".titleChange_list_name").textContent,F=this.object.querySelector(".titleChange_list_name").textContent,B={background_regions:[],datasets:{},markers:[],possitions:{time:A,lat:d.map((e=>e.geo[0])),lon:d.map((e=>e.geo[1]))},attachments:[{name:"График",axis_y:[O.oil[0],O.pwr[0]]}],stats:[["Отчет",P],["Объект",F],["Начало интервала",this.converterTimes(this.requestParams.timeInterval[0])],["Конец интервала",this.converterTimes(this.requestParams.timeInterval[1])]],tables:[],row:[]};if(B.background_regions.push({color:"f2a974",id:"chart_engine",name:"Зажигание",regions:b}),0!==w.length&&(B.tables.push({name:"unit_travel",label:"Поездки",header:["Начало","Местоположение","Конец","Местоположение","Длительность","Пробег","Ср. скорость","Макс. скорость","Расход","Ср. расход на 100км"],total:[this.converterTimes(w[0][0][0]),w[0][0][1],this.converterTimes(w[w.length-1][1][0]),w[w.length-1][1][1],this.formatTime(C.duration),`${C.distance.toFixed(2)} км.`,`${C.averageSpeed.toFixed(0)} км.ч`,`${C.maxSpeed} км/ч`,`${C.oil.toFixed(0)} л.`,`${C.averageRashod.toFixed(1)} л.`]}),B.row.push(D),B.stats.push(["Пробег в поездках",`${C.distance.toFixed(2)} км.`]),B.stats.push(["Расход в поездках",`${C.oil.toFixed(1)} л.`]),B.stats.push(["Средний расход в поездках на 100км",`${C.averageRashod} л.`]),B.background_regions.push({color:"f7f488",id:"chart_travel",name:"Поездки",regions:w})),0!==v.length&&(B.tables.push({name:"unit_moto",label:"Моточасы",header:["Начало","Местоположение","Конец","Местоположение","Моточасы"],total:[this.converterTimes(v[0][0][0]),v[0][0][1],this.converterTimes(v[v.length-1][1][0]),v[v.length-1][1][1],this.formatTime(S)]}),B.row.push(M),B.stats.push(["Моточасы",this.formatTime(S)]),B.stats.push(["Время полезной работы",this.formatTime(E)]),B.markers.push(L),B.background_regions.push({color:"94f2a4",id:"chart_moto",name:"Моточасы",regions:v})),0!==f.length&&(B.tables.push({name:"unit_prostoy",label:"Простои",header:["Начало","Местоположение","Конец","Местоположение","Время простоя на холостом ходу","Расход на холостом ходу"],total:[this.converterTimes(f[0][0][0]),f[0][0][1],this.converterTimes(f[f.length-1][1][0]),f[f.length-1][1][1],this.formatTime(_),`${k} л.`]}),B.row.push(N),B.stats.push(["Простои",this.formatTime(_)]),B.stats.push(["Расход на холостом ходу",`${k} л.`]),B.markers.push(x),B.background_regions.push({color:"90c1f0",id:"chart_prostoy",name:"Простои",regions:f})),0!==y.length){const e=y.reduce(((e,t)=>e+t.valueOil),0);B.tables.push({name:"unit_gasStation",label:"Заправки",header:["Начало","Конец","Местоположение","Нач. уровень","Кон. уровень","Заправлено"],total:["---","---","---",`${y[0].startOilValue} л.`,`${y[y.length-1].finishOilValue} л.`,`${e} л.`]}),B.row.push(I),B.stats.push(["Заправки",`${e} л.`]),B.markers.push(T)}if(0!==g.length){const e=g.reduce(((e,t)=>e+t.valueOil),0);B.tables.push({name:"unit_fuelDrain",label:"Сливы",header:["Начало","Конец","Местоположение","Нач. уровень","Кон. уровень","Слито"],total:["---","---","---",`${g[0].startOilValue} л.`,`${g[g.length-1].finishOilValue} л.`,`${e} л.`]}),B.row.push($),B.stats.push(["Сливы",`${e} л.`]),B.markers.push(q)}return j.forEach(((e,t)=>{const s=Object.values(e)[0].reduce(((e,t)=>(e.push(t.y),e)),[]);B.datasets={...B.datasets,[t]:{name:O[Object.keys(e)[0]][0],y_axis:t,color:O[Object.keys(e)[0]][1],data:{x:A,y:s}}}})),B}xtimesOil(e){return e.reduce(((e,t)=>{const s=t.valueOil;return e.push({x:t.timeStart,start:this.converterTimesTooltip(t.timeStart),value:s}),e}),[])}xtimes(e){const t=e.reduce(((e,t)=>{const s=this.formatTime(t[1][0]-t[0][0]),i=this.converterTimesTooltip(t[0][0]),a=this.converterTimesTooltip(t[1][0]);return e.push({x:t[0][0],duration:s,str:`${i} - ${a}`}),e}),[]);return t}diff(e,t){let s;return s=t?e.reduce(((e,t)=>{const s=t[0][2]-t[1][2];return parseFloat((e+=s>0?s:0).toFixed(1))}),0):e.reduce(((e,t)=>e+(t[1][0]-t[0][0])),0),s}calculate(e,t,s){let i=[];if(t){if("Моточасы"===s&&(i=e.reduce(((e,s)=>(s.pwr>t?Array.isArray(e[e.length-1])&&e[e.length-1].length>0&&e[e.length-1][0].pwr>t?e[e.length-1].push(s):e.push([s]):s.pwr<=t&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length&&e.push([]),e)),[]).filter((e=>e.length>0)).reduce(((e,t)=>(t[t.length-1].x-t[0].x>0&&e.push([[t[0].x,t[0].geo,t[0].oil],[t[t.length-1].x,t[t.length-1].geo,t[t.length-1].oil]]),e)),[])),"Зажигание"===s&&(i=e.reduce(((e,t)=>(1===t.engine?Array.isArray(e[e.length-1])&&e[e.length-1].length>0&&1===e[e.length-1][0].engine?e[e.length-1].push(t):e.push([t]):0===t.engine&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length&&e.push([]),e)),[]).filter((e=>e.length>0)).reduce(((e,t)=>(e.push([[t[0].x,t[0].geo],[t[t.length-1].x,t[t.length-1].geo]]),e)),[])),"Скорость"===s){const s=Array.from(new Set(e.map((e=>e.x)))).map((t=>e.find((e=>e.x===t)))),a=[];let n=0;for(let i=0;i<s.length-1;i++){const r=this.calculateDistance(e[i].geo[0],e[i].geo[1],e[i+1].geo[0],e[i+1].geo[1]);0!==s[i].speed&&s[i].sats>4&&s[i].pwr>t?(s[i].distance=n,Array.isArray(a[a.length-1])&&a[a.length-1].length>0?(a[a.length-1].push(s[i]),n+=r):a.push([s[i]])):0===s[i].speed&&s[i].sats>4&&(a.push([]),n=0)}i=a.filter((e=>e.length>0)).reduce(((e,t)=>{const s=t.reduce(((e,t)=>Math.max(e,t.speed)),0),i=t.reduce(((e,t)=>e+t.speed),0)/t.length,a=this.formatTime(t[t.length-1].x-t[0].x),n=t.length>1?t[t.length-1].distance-t[0].distance:t[0].distance,r=t[t.length-1].x-t[0].x,l=t[0].oil-t[t.length-1].oil,o=l<0?0:l;return r>90&&n>.15&&e.push([[t[0].x,t[0].geo,t[0].oil],[t[t.length-1].x,t[t.length-1].geo,t[t.length-1].oil],{distance:parseFloat(n.toFixed(2)),maxSpeed:s,averageSpeed:parseFloat(i.toFixed(0)),duration:a,rashod:o}]),e}),[])}return"Простои"===s&&(i=e.reduce(((e,s)=>(s.pwr>t&&0===s.speed&&s.sats>4?Array.isArray(e[e.length-1])&&e[e.length-1].length>0&&e[e.length-1][0].pwr>t&&0===e[e.length-1][0].speed&&e[e.length-1][0].sats>4?e[e.length-1].push(s):e.push([s]):(s.pwr<=t&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length||s.speed>0&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length||s.sats>4&&Array.isArray(e[e.length-1])&&0!==e[e.length-1].length)&&e.push([]),e)),[]).filter((e=>e.length>0)).reduce(((e,t)=>(t[t.length-1].x-t[0].x>600&&e.push([[t[0].x,t[0].geo,t[0].oil],[t[t.length-1].x,t[t.length-1].geo,t[t.length-1].oil]]),e)),[])),i}return i}calculateDistance(e,t,s,i){function a(e){return e*(Math.PI/180)}const n=a(s-e),r=a(i-t),l=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a(e))*Math.cos(a(s))*Math.sin(r/2)*Math.sin(r/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371}async requstModel(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/modelView",t),i=await s.json();return!(!i.result[0]||!i.result[0].tsiControll)&&i.result[0].tsiControll}calculateOilUp(e){const t=[];let s=0,i=0;for(let a=0;a<e.length-1;a++){const n=e[a],r=e[a+1];n.oil<r.oil?(s===i&&(s=a),i=a+1):n.oil>r.oil&&(s!==i&&t.push([e[s],e[i]]),s=i=a+1)}return s!==i&&t.push([e[s],e[i]]),t.filter(((e,s)=>{const i=e[0].oil,a=e[e.length-1].oil-i,n=.15*i;if(s<t.length-1){const i=t[s+1],a=e[e.length-1].x;i[0].x-a<3e5&&(e.push(i[i.length-1]),e.splice(1,1))}return i>5&&a>40&&a>=n})).reduce(((e,t)=>{const s=t[1].oil-t[0].oil;return e.push({timeStart:t[0].x,timeFinish:t[1].x,geo:t[0].geo,startOilValue:parseFloat(t[0].oil.toFixed(0)),finishOilValue:parseFloat(t[1].oil.toFixed(0)),valueOil:parseFloat(s.toFixed(0))}),e}),[])}calculateOilSliv(e){const t=[];let s=0,i=0;for(let a=0;a<e.length-1;a++){const n=e[a],r=e[a+1];n.oil>r.oil?(s===i&&(s=a),i=a+1):n.oil<r.oil&&(s!==i&&t.push([e[s],e[i]]),s=i=a+1)}return s!==i&&t.push([e[s],e[i]]),t.filter(((e,s)=>{const i=e[0].oil,a=e[e.length-1].oil,n=i-a,r=.15*i;if(s<t.length-1){const i=t[s+1],a=e[e.length-1].x;i[0].x-a<300&&(e.push(i[i.length-1]),e.splice(1,1))}return e[e.length-1].x-e[0].x<300&&a>5&&n>40&&n>=r})).reduce(((e,t)=>{const s=t[0].oil-t[1].oil;return e.push({timeStart:t[0].x,timeFinish:t[1].x,geo:t[0].geo,startOilValue:parseFloat(t[0].oil.toFixed(0)),finishOilValue:parseFloat(t[1].oil.toFixed(0)),valueOil:parseFloat(s.toFixed(0))}),e}),[])}}class Me{constructor(e){this.pen=document.querySelector(".pen_servis"),this.strL=this.pen.querySelector(".strL"),this.strR=this.pen.querySelector(".strR"),this.map=null,this.data=e,this.leftContainer=document.querySelector(".list_servis"),this.rightContainer=document.querySelector(".map_servis"),this.attachEventListeners()}attachEventListeners(){this.strL&&this.strL.addEventListener("click",(()=>this.moveLeft())),this.strR&&this.strR.addEventListener("click",(()=>this.moveRight()))}moveLeft(){console.log(),this.leftContainer.style.width="20%",this.rightContainer.style.width="80%",this.strL.style.display="none",this.strR.style.display="flex",this.map?setTimeout((()=>{this.map.invalidateSize()}),300):this.createMap()}moveRight(){this.leftContainer.style.width="100%",this.rightContainer.style.width="0%",this.strR.style.display="none",this.strL.style.display="flex"}createMap(){this.map=L.map("mapServis"),this.map.setView([59.9386,30.3141],9),this.map.attributionControl.setPrefix(!1),document.querySelector(".leaflet-control-attribution").style.display="none";const e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'}).addTo(this.map);L.control.scale({imperial:""}).addTo(this.map),this.map.addLayer(e),setTimeout((()=>{this.map.invalidateSize()}),300),this.addMarkersToMap()}addMarkersToMap(){this.icons={Экскаватор:"../../../image/exkavator.png",Кран:"../../../image/kran_icon.png",Бульдозер:"../../../image/Buldozer.png","Фронтальный погрузчик":"../../../image/frong-pogr.png",Газель:"../../../image/gasel.png",Фургон:"../../../image/furgon.png","Экскаватор-погрузчик":"../../../image/ex-pogr.png",Трактор:"../../../image/traktor.png",Фура:"../../../image/fura.png",Легковушка:"../../../image/legk.png",Самосвал:"../../../image/samosval.png",Каток:"../../../image/katok.png",Бетономешалка:"../../../image/beton.png",Бензовоз:"../../../image/benzovoz.png",ЖКХ:"../../../image/zkh.png","-":"../../../image/tehnika.png"},this.data.forEach((e=>{const{idObject:t,geo:s,course:i,speed:a,nameObject:n,idGroup:r,nameGroup:l,time:o,condition:c,type:d}=e;console.log(d);const h=new(L.Icon.extend({options:{iconSize:[30,30],iconAnchor:[10,18],popupAnchor:[0,0]}}))({iconUrl:this.icons[d],iconSize:[30,15],iconAnchor:[20,20],popupAnchor:[0,-10],className:"custom-markers"});var u=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrow" style="pointer-events: none;height: 75px;transform: rotate(${i}deg);"><img src="../../image/arrow2.png" style="width: 20px"></div>`});const p=L.marker(s,{icon:h}).addTo(this.map);p.bindPopup(`Группа: ${l}<br>Объект: ${n}<br>Cостояние: ${c}<br>${"Поездка"===c?`Скорость: ${a} км/ч<br>`:""}Координаты: ${s}`,{className:"my-popup-markers"}),p.on("mouseover",(function(e){this.openPopup()})),p.on("mouseout",(function(e){this.closePopup()}));const m=L.marker(s,{icon:u}).addTo(this.map);"Стоянка"!==c&&"Нет данных"!==c?m.addTo(this.map):this.map.removeLayer(m)}))}}class Ne{constructor(e,t,s){this.elem1=e,this.elem2=t,this.elem3=s,document.addEventListener("click",this.handleClickOutside.bind(this))}handleClickOutside(e){const t=this.elem1.contains(e.target),s=document.querySelector(".wrapMap"),i=s?.contains(e.target);if(this.elem3){const s=this.elem2.contains(e.target),i=this.elem3.contains(e.target);t||s||i||(this.elem1.style.display="none",this.elem1.classList.remove("clickLog"))}else t||(this.elem1.classList.contains("alarmStorage")&&!i&&(this.elem1.style.display="none",this.elem2.classList.remove("check_alarm"),s?.remove(),j()),this.elem1.classList.contains("alarmStorage")||(this.elem1.style.display="none"))}}class Ie{constructor(e,t,s){this.elem1=e,this.elem2=t,this.modal=s,document.addEventListener("click",this.handleClickOutside.bind(this))}handleClickOutside(e){console.log(this.elem1,this.elem2);const t=this.elem1.contains(e.target),s=this.elem2.contains(e.target);console.log(t,s),t||s||(this.modal.style.display="none")}}class $e{constructor(e,t,s){this.data=e,this.idObject=this.data[4],this.structura=t,this.onlineParams=null,this.shablon=null,this.wrapper=s,this.map=null,this.arrayName=[["motohours","Моточасы"],["mileage","Пробег"],["day","Дни"]],this.icons={Экскаватор:"../../../image/exkavator.png",Кран:"../../../image/kran_icon.png",Бульдозер:"../../../image/Buldozer.png","Фронтальный погрузчик":"../../../image/frong-pogr.png",Газель:"../../../image/gasel.png",Фургон:"../../../image/furgon.png","Экскаватор-погрузчик":"../../../image/ex-pogr.png",Трактор:"../../../image/traktor.png",Фура:"../../../image/fura.png",Легковушка:"../../../image/legk.png",Самосвал:"../../../image/samosval.png",Каток:"../../../image/katok.png",Бетономешалка:"../../../image/beton.png",Бензовоз:"../../../image/benzovoz.png",ЖКХ:"../../../image/zkh.png","-":"../../../image/tehnika.png"},this.globalServis=document.querySelector(".globalServis"),this.close=this.globalServis.querySelector(".close_settings_inner"),this.closeShablonTo=this.globalServis.querySelector(".close_settings_inner_to"),this.cancelShablonTo=this.globalServis.querySelector(".cancel"),this.shablonsBtn=this.globalServis.querySelector(".shablons_model_marka"),this.modalWindow=this.globalServis.querySelector(".modal_window"),this.save=this.globalServis.querySelector(".ok_modal"),this.matTo=this.globalServis.querySelector(".mat_to"),this.jobTo=this.globalServis.querySelector(".job_to"),this.tableTo=this.globalServis.querySelector(".tableTo"),this.tableToUniq=this.globalServis.querySelector(".tableToUniq"),this.message=this.globalServis.querySelector(".validation_message_to"),this.globalInner=this.globalServis.querySelector(".global_inner"),this.valueInner=this.globalInner.querySelectorAll(".value_inner"),this.gosnomer=this.globalInner.querySelector(".nomer_inner"),this.mestopolo=this.globalInner.querySelector(".mestopolo"),this.pictureInner=this.globalInner.querySelector(".picture_inner"),this.dilerInfo=this.globalInner.querySelector(".diler_info"),this.textDiler=this.dilerInfo.querySelectorAll(".value_center_inner"),this.valueTo=this.globalInner.querySelectorAll(".value_to_inner"),this.iconCalendar=this.globalInner.querySelector(".icon_inner"),this.calendar=this.globalInner.querySelector(".calendar_inner"),this.leftArrow=this.globalInner.querySelector(".left_to_str"),this.rightArrow=this.globalInner.querySelector(".right_to_str"),this.jobs=this.globalInner.querySelectorAll(".body_job"),this.btnInner=this.globalInner.querySelectorAll(".btn_inner"),this.bodyInner=this.globalInner.querySelectorAll(".body_inner"),this.typeTo=this.globalInner.querySelector(".type_to"),this.typeShablons=this.globalInner.querySelector(".type_to_shablons"),this.pop=document.querySelector(".popup-background"),this.clear=this.calendar.querySelectorAll(".btm_formStart")[0],this.ok=this.calendar.querySelectorAll(".btm_formStart")[1],this.currentJobIndex=0,this.boundClosed=this.closed.bind(this),this.clickCalendar=this.addCalendar.bind(this),this.boundClear=this.clearCalendar.bind(this),this.boundInner=this.toggleBodyInner.bind(this),this.boundLeft=this.leftStr.bind(this),this.boundRight=this.rightStr.bind(this),this.boundShablons=this.createViewShablon.bind(this),this.boundClose=this.hiddenContainer.bind(this),this.boundCancel=this.hiddenContainer.bind(this),this.boundView=this.viewShablonsList.bind(this),this.boundSave=this.saveShablon.bind(this),this.initEvent(),this.init()}async init(){this.containerInitialisation(this.globalInner,"flex"),this.getData(),this.viewContent(),this.createMap(),this.onlineParams&&this.addMarkersToMap(),this.shablon=await this.getShablon(),0!==this.shablon.length?this.createCompliteShablon(this.shablon):this.createViewShablonBase()}initEvent(){this.close.addEventListener("click",this.boundClosed),this.iconCalendar.addEventListener("click",this.clickCalendar),this.clear.addEventListener("click",this.boundClear),this.btnInner.forEach((e=>e.addEventListener("click",this.boundInner))),this.leftArrow.addEventListener("click",this.boundLeft),this.rightArrow.addEventListener("click",this.boundRight),this.typeShablons.addEventListener("click",this.boundShablons),this.closeShablonTo.addEventListener("click",this.boundClose),this.cancelShablonTo.addEventListener("click",this.boundCancel),this.shablonsBtn.addEventListener("click",this.boundView),this.save.addEventListener("click",this.boundSave)}destroy(){this.close.removeEventListener("click",this.boundClosed),this.iconCalendar.removeEventListener("click",this.clickCalendar),this.clear.removeEventListener("click",this.boundClear),this.btnInner.forEach((e=>e.removeEventListener("click",this.boundInner))),this.leftArrow.removeEventListener("click",this.boundLeft),this.rightArrow.removeEventListener("click",this.boundRight),this.typeShablons.removeEventListener("click",this.boundShablons),this.closeShablonTo.removeEventListener("click",this.boundClose),this.cancelShablonTo.removeEventListener("click",this.boundCancel),this.shablonsBtn.removeEventListener("mouseenter",this.boundView),this.save.removeEventListener("click",this.boundSave),this.shablon=null}raschetTO(e,t,s){const i=this.tableToUniq.querySelector(".job_to"),a=document.querySelectorAll(".header_shablon_servis_to_uniq");a&&a.forEach((e=>e.remove())),this.valueTo[0].textContent="-",this.valueTo[1].textContent="-";const n=e.filter((e=>e[s]===t));if(console.log(n),0===n.length)return;this.currentJobIndex=n[0].typeTo;const r=n[0].motohours-this.structura.engineHours,l=n[0].nameTo,o=n.filter((e=>"Материалы"===e.guideType&&1===e.IsRequired)),c=n.filter((e=>"Работы"===e.guideType&&1===e.IsRequired));this.createRowsUniq(o),this.tableToUniq.appendChild(i),this.createRowsUniq(c),this.valueTo[0].textContent=l,this.valueTo[1].textContent=r<0?"-":r}createRowsUniq(e){e.forEach((e=>{const t=document.createElement("tr"),s=document.createElement("td");t.classList.add("header_shablon_servis_to_uniq"),s.classList.add("cel_body_uniq"),s.textContent=e.guideDescription,t.appendChild(s),this.tableToUniq.appendChild(t)}))}createCompliteShablon(e){e.sort(((e,t)=>e.typeTo-t.typeTo)),this.raschetTO(e,this.structura.nearestTo,"nameTo");const t=document.querySelectorAll(".name_to");t&&t.forEach((e=>e.parentElement.remove()));const s={};Object.values(e).forEach((e=>{s[e.typeTo]=e})),this.arrayName.forEach((e=>{const t=document.createElement("tr"),i=document.createElement("td");t.classList.add("header_shablon_servis_to"),i.classList.add("cel_body","name_to"),i.textContent=e[1],t.appendChild(i),i.setAttribute("data-att",e[0]),this.tableTo.appendChild(t),Object.values(s).forEach((s=>{let i;switch(e[0]){case"motohours":i=s.motohours;break;case"mileage":i=s.mileage;break;case"day":i=s.day}const a=document.createElement("td");a.classList.add("cel_body","editable"),a.setAttribute("contenteditable","true"),a.textContent=i,t.appendChild(a),r(a)}))})),this.tableTo.appendChild(this.matTo);const i={};Object.values(e).forEach((e=>{i[e.guideID]=e}));const a=Object.values(i).map((e=>({guideID:e.guideID,guideDescription:e.guideDescription,guideType:e.guideType}))),n=a.filter((e=>"Материалы"===e.guideType)),l=a.filter((e=>"Работы"===e.guideType));this.createRows(n,e),this.tableTo.appendChild(this.jobTo),this.createRows(l,e)}createRows(e,t){e.forEach((e=>{const s=document.createElement("tr"),i=document.createElement("td");s.classList.add("header_shablon_servis_to"),i.classList.add("cel_body","name_to"),i.setAttribute("data-att",e.guideID),i.textContent=e.guideDescription,s.appendChild(i),this.tableTo.appendChild(s),this.createCheck(i),t.forEach((t=>{if(e.guideID===t.guideID){const e=document.createElement("td");e.classList.add("cel_body","editable"),e.setAttribute("contenteditable","true"),e.textContent=t.IsRequired,s.appendChild(e),this.validationInput(e),r(e)}}))}))}createCheck(e){const t=document.createElement("i");t.classList.add("fa","fa-check","check_to_guide"),e.appendChild(t),t.addEventListener("click",(()=>{t.classList.toggle("check_hidden")}))}async saveShablon(){const e=this.preparingStruktura();await this.saveShablonToBase(e)}async saveShablonToBase(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({struktura:e})},s=await fetch("/api/save_shablon",t),i=await s.json();this.message.textContent=i,setTimeout((()=>this.message.textContent=""),3e3)}preparingStruktura(){const e=document.querySelectorAll(".name_to"),t=[];let s,i,a;return[...e].slice(0,3).forEach((e=>{switch([...e.parentElement.children].shift().getAttribute("data-att")){case"motohours":s=[...e.parentElement.children].slice(1).map((e=>""!==e.textContent?parseInt(e.textContent):null));break;case"mileage":i=[...e.parentElement.children].slice(1).map((e=>""!==e.textContent?parseInt(e.textContent):null));break;case"day":a=[...e.parentElement.children].slice(1).map((e=>""!==e.textContent?parseInt(e.textContent):null))}})),[...e].slice(3).forEach((e=>{const n=parseInt(e.getAttribute("data-att")),r=[...e.parentElement.children].slice(1).map((e=>""!==e.textContent?parseInt(e.textContent):null));if(!e.children[0].classList.contains("check_hidden")){const e=26;for(let l=0;l<e;l++)t.push({to:l+1,guide:n,bool:r[l],moto:s[l],mileage:i[l],day:a[l],idObject:String(this.idObject)})}})),t}async getShablon(){const e=this.idObject,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/get_shablon",t);return await s.json()}async createViewShablonBase(){const e=document.querySelectorAll(".name_to");e&&e.forEach((e=>e.parentElement.remove())),this.valueTo[0].textContent="-",this.valueTo[1].textContent="-";const t=await this.getGuide(),s=t.filter((e=>"Материалы"===e.guideType)),i=t.filter((e=>"Работы"===e.guideType));this.arrayName.forEach((e=>{const t=document.createElement("tr"),s=document.createElement("td");t.classList.add("header_shablon_servis_to"),s.classList.add("cel_body","name_to"),s.textContent=e[1],t.appendChild(s),s.setAttribute("data-att",e[0]),this.tableTo.appendChild(t);for(let e=1;e<27;e++){const e=document.createElement("td");e.classList.add("cel_body","editable"),e.setAttribute("contenteditable","true"),t.appendChild(e)}})),this.tableTo.appendChild(this.matTo),this.createRowsDefault(s),this.tableTo.appendChild(this.jobTo),this.createRowsDefault(i)}createRowsDefault(e){e.forEach((e=>{const t=document.createElement("tr"),s=document.createElement("td");t.classList.add("header_shablon_servis_to"),s.classList.add("cel_body","name_to"),s.setAttribute("data-att",e.guideID),s.textContent=e.guideDescription,t.appendChild(s),this.tableTo.appendChild(t),this.createCheck(s);for(let e=1;e<27;e++){const e=document.createElement("td");e.classList.add("cel_body","editable"),e.setAttribute("contenteditable","true"),t.appendChild(e),this.validationInput(e)}}))}validationInput(e){e.addEventListener("keypress",(function(e){const t=e.key;console.log(t),("0"!==t&&"1"!==t||this.textContent.length>=1)&&e.preventDefault()}))}async getGuide(){const e=await fetch("/api/guide_to",{method:"GET",headers:{"Content-Type":"application/json"}});return await e.json()}toggleBodyInner(e){const t=e.currentTarget;document.querySelector(".activ_inner").classList.remove("activ_inner"),document.querySelector(".activ_body_inner").classList.remove("activ_body_inner"),t.classList.add("activ_inner"),this.btnInner.forEach(((e,t)=>{e.classList.contains("activ_inner")&&this.bodyInner[t].classList.add("activ_body_inner")}))}viewShablonsList(){this.containerInitialisation(this.modalWindow,"flex"),new Ie(this.modalWindow,this.shablonsBtn,this.modalWindow)}hiddenContainer(){const e=this.globalServis.children[1];this.containerInitialisation(this.pop,"none"),this.containerInitialisation(e,"none")}createViewShablon(){const e=this.wrapper.nextElementSibling;this.containerInitialisation(this.pop,"flex"),this.containerInitialisation(e,"flex")}leftStr(){this.currentJobIndex=this.currentJobIndex-1,this.currentJobIndex<1&&(this.currentJobIndex=26),this.raschetTO(this.shablon,this.currentJobIndex,"typeTo")}rightStr(){this.currentJobIndex=this.currentJobIndex+1,this.currentJobIndex>26&&(this.currentJobIndex=1),this.raschetTO(this.shablon,this.currentJobIndex,"typeTo")}clearCalendar(){this.containerInitialisation(this.calendar,"none")}addCalendar(){this.containerInitialisation(this.calendar,"flex")}closed(){this.containerInitialisation(this.globalInner,"none"),this.destroy()}containerInitialisation(e,t){e.style.display=t}async viewContent(){const e=this.data[6].typeObject?this.data[6].typeObject:"-",t=new Map(this.data[2].result.map((e=>[e.params,e.value]))),s=t.get("mileage")?parseInt(t.get("mileage")):"-",i=t.get("mileage"),a=t.get("engine"),n=t.get("last_valid_time"),r=n?this.convert(Number(n)):"-",l=i&&a&&n?this.statusValid(Number(i),Number(a),Number(n)):"-",o=this.structura.engineHours,{marka:c,model:d,vin:h,typeDevice:u,dut:p,gosnomer:m}=this.data[6],y=[c,d,h,o,s,l,u,p,r];this.valueInner.forEach(((e,t)=>{e.textContent=y[t],"status"===e.getAttribute("rel")&&(e.style.color="online"===y[t]?"#00FF7F":"gray")})),this.pictureInner.style.backgroundImage=`url(${this.icons[e]})`,this.gosnomer.textContent=m,this.mestopolo.textContent=this.onlineParams?await async function(e,t){var s=e,i=t;console.log(s,i);try{const a=await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${s},${i}&key=e156e8924c3a4e75bc1eac26f153457e&no_annotations=1&language=ru`),n=await a.json();if(console.log(n.results),console.log(a.status),a.ok){console.log("рекорд");const e=n.results[0].components,t=[];return t.push(e.road_reference),t.push(e.municipality),t.push(e.county),t.push(e.town),t.push(e.state),t.push(e.country),Object.values(t).filter((e=>void 0!==e)).join(", ")}if(402===a.status)return[e,t]}catch(s){return[e,t]}}(this.onlineParams.geo[0],this.onlineParams.geo[1]):"-";const g=[this.structura.company,this.structura.contact[0],this.structura.contact[1]];this.textDiler.forEach(((e,t)=>{e.textContent=g[t]}))}statusValid(e,t,s){let i;const a=Math.floor((new Date).getTime()/1e3);return i=e>4&&1===t&&a-s<3600?"online":"offline",i}convert(e){const t=new Date(1e3*e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")} ${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getFullYear()}`}createMap(){const e=document.getElementById("mapInner");e&&e.remove();const t=document.querySelector(".map_inner"),s=document.createElement("div");s.classList.add("map_servis_id"),s.setAttribute("id","mapInner"),t.appendChild(s),this.map=L.map("mapInner"),this.onlineParams&&this.map.setView(this.onlineParams.geo,9),this.map.attributionControl.setPrefix(!1),document.querySelector(".leaflet-control-attribution").style.display="none";const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'}).addTo(this.map);L.control.scale({imperial:""}).addTo(this.map),this.map.addLayer(i),setTimeout((()=>{this.map.invalidateSize()}),300)}addMarkersToMap(){const{geo:e,course:t,speed:s,nameObject:i,nameGroup:a,condition:n,type:r}=this.onlineParams,l=new(L.Icon.extend({options:{iconSize:[30,30],iconAnchor:[10,18],popupAnchor:[0,0]}}))({iconUrl:this.icons[r],iconSize:[30,15],iconAnchor:[20,20],popupAnchor:[0,-10],className:"custom-markers"});var o=L.divIcon({className:"custom-marker-arrow",html:`<div class="wrapContainerArrow" style="pointer-events: none;height: 75px;transform: rotate(${t}deg);"><img src="../../image/arrow2.png" style="width: 20px"></div>`});const c=L.marker(e,{icon:l}).addTo(this.map);c.bindPopup(`Группа: ${a}<br>Объект: ${i}<br>Cостояние: ${n}<br>${"Поездка"===n?`Скорость: ${s} км/ч<br>`:""}Координаты: ${e}`,{className:"my-popup-markers"}),c.on("mouseover",(function(e){this.openPopup()})),c.on("mouseout",(function(e){this.closePopup()}));const d=L.marker(e,{icon:o}).addTo(this.map);"Стоянка"!==n&&"Нет данных"!==n?d.addTo(this.map):this.map.removeLayer(d)}getData(){const e={0:"Стоянка",1:"Движется",2:"Остановка",3:"Нет данных"},t=this.data[2].result,s=this.data[6].typeObject?this.data[6].typeObject:"-";if(0===t.length)return null;const i=new Map(t.map((e=>[e.params,e.value]))),a=i.get("lat"),n=i.get("lon"),r=i.get("speed"),l=i.get("course"),o=i.get("engine"),c=i.get("last_valid_time");let d;r&&o&&(d=e[Number(r)>0&&1===Number(o)?1:0===Number(r)&&1===Number(o)?2:0===Number(r)&&0===Number(o)?0:3]),a&&n&&r&&l&&c&&(this.onlineParams={idObject:this.data[4],nameObject:this.data[0].message,idGroup:this.data[8],nameGroup:this.data[7],geo:[a,n],speed:r,course:l,time:c,condition:d,type:s})}}class De{constructor(e){this.data=e,this.struktura=null,this.onlineParams=null,this.instance=null,this.type=[],this.bodyTable=document.querySelector(".body_servis"),this.wrapper=document.querySelector(".wrapper_servis"),this.icons={Экскаватор:"../../../image/exkavator.png",Кран:"../../../image/kran_icon.png",Бульдозер:"../../../image/Buldozer.png","Фронтальный погрузчик":"../../../image/frong-pogr.png",Газель:"../../../image/gasel.png",Фургон:"../../../image/furgon.png","Экскаватор-погрузчик":"../../../image/ex-pogr.png",Трактор:"../../../image/traktor.png",Фура:"../../../image/fura.png",Легковушка:"../../../image/legk.png",Самосвал:"../../../image/samosval.png",Каток:"../../../image/katok.png",Бетономешалка:"../../../image/beton.png",Бензовоз:"../../../image/benzovoz.png",ЖКХ:"../../../image/zkh.png","-":"../../../image/tehnika.png"},this.init()}async init(){this.convertionIdArray(),this.getData(),await this.findTo(),this.createRows(),new Me(this.onlineParams)}async findTo(){const e=this.data.flat().map((e=>e[4])),t=this.struktura.map((e=>e.engineHours)),s=e.map(((e,s)=>({idw:e,engineHours:t[s]})));await this.getTo(s)}async getTo(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({array:e})};try{const e=await fetch("/api/getToToBase ",t);(await e.json()).forEach((e=>{this.struktura.filter((t=>t.idw===e.idw)).map((t=>{t&&(t.hoursDifference=e.motoRemains,t.nearestTo=0!==e.TOData.length?e.TOData[0].nameTo:"-")}))}))}catch(e){console.error("Failed to fetch TO data:",e)}}convertionIdArray(){this.struktura=this.data.flat().map((e=>{const t=new Map(e[2].result.map((e=>[e.params,e.value]))),s=t.get("engine_hours")?parseInt(t.get("engine_hours")):"-",i=e[4],a=e[6].marka,n=e[6].model,r=e[6].vin,l=e[6].face,o=e[6].number,c=e[6].gosnomer,d=e[6].typeObject?e[6].typeObject:"-";return this.type.push({type:d,idw:i}),{idw:i,object:[a,n],vin:r,company:e[7],contact:[l,o],gosnomer:c,engineHours:s}}))}createRows(){const e=this.bodyTable.querySelectorAll(".rows_servis");e&&e.forEach((e=>e.remove())),this.bodyTable.style.width=this.wrapper.clientWidth-15+"px",this.bodyTable.previousElementSibling.style.width=this.wrapper.clientWidth-15+"px",this.struktura.forEach(((e,t)=>{delete e.idw;const s=document.createElement("div");s.classList.add("rows_servis"),s.setAttribute("id",this.type[t].idw),this.bodyTable.appendChild(s);const i=document.createElement("div");i.classList.add("special_first"),i.style.backgroundImage=`url(${this.icons[this.type[t].type]})`,s.appendChild(i);for(let t in e){const i=document.createElement("div"),a=["cel_servis","title_servis"];"engineHours"!==t&&"hoursDifference"!==t&&"nearestTo"!==t&&a.push("long"),i.classList.add(...a),s.appendChild(i);let n=e[t];Array.isArray(n)&&(n=n.slice(0,2).join(" ")),i.textContent=n||"-"}this.createRowsStata(3,s),s.addEventListener("click",(()=>{this.instance&&(this.instance.destroy(),this.instance=null),this.instance=new $e(this.data.flat()[t],e,this.wrapper)}))}))}createRowsStata(e,t){for(let s=0;s<e;s++){const e=document.createElement("div");e.classList.add("cel_servis"),e.classList.add("title_servis"),t.appendChild(e),e.textContent="-"}}getData(){const e={0:"Стоянка",1:"Движется",2:"Остановка",3:"Нет данных"};this.onlineParams=this.data.flat().map((t=>{const s=t[2].result,i=t[6].typeObject?t[6].typeObject:"-";if(0===s.length)return null;const a=new Map(s.map((e=>[e.params,e.value]))),n=a.get("lat"),r=a.get("lon"),l=a.get("speed"),o=a.get("course"),c=a.get("engine"),d=a.get("last_valid_time");let h;if(l&&c){const t=Number(l)>0&&1===Number(c)?1:0===Number(l)&&1===Number(c)?2:0===Number(l)&&0===Number(c)?0:3;h=e[t]}return n&&r&&l&&o&&d?{idObject:t[4],nameObject:t[0].message,idGroup:t[8],nameGroup:t[7],geo:[n,r],speed:l,course:o,time:d,condition:h,type:i}:null})).filter((e=>null!==e))}}class Pe{static createListObject(e){const t=document.querySelectorAll(".groupsSklad");t&&t.forEach((e=>e.remove()));const s=e.map((e=>e.filter((e=>0!==e[0].result.length&&"-"!==e[0].result[0].osi)))).filter((e=>e.length>0));for(let e of s){const t=document.querySelector(".list_body"),s=document.createElement("div");s.classList.add("groupsSklad");const i=e[0][7].replace(/\s/g,"_");s.classList.add(`${i}`),s.setAttribute("id",e[0][8]),s.style.display="flex",s.style.flexDirection="column",s.style.width="100%",t.appendChild(s);const a=document.createElement("div");a.classList.add("titleModalSklad"),a.textContent=`${i} (${e.length})`,s.appendChild(a);const n=document.createElement("div");n.classList.add("hiddenModalSklad"),s.classList.add(`${i}`),s.setAttribute("rel",`${i}`),s.appendChild(n);for(let t of e)0!==Object.values(t[0]).length&&Pe.createIconsAndLeftSpisok(t,n)}}static createIconsAndLeftSpisok(e,t){const s=document.createElement("div");s.classList.add("listItemSklad"),s.classList.add(`${e[4]}`),s.setAttribute("rel",`${e[4]}`),s.setAttribute("id",`${e[4]}`),s.textContent=e[0].message,t.appendChild(s)}static createModelCar(e,t){const s=e[4],i=t.filter((e=>"0"===e.flag_status&&e.idObject===String(s))),a=e[1].result,n=e[0].result;n.sort(((e,t)=>parseInt(e.osi)-parseInt(t.osi)));let r=1;const l=[];return n.forEach((({trailer:e,tyres:t,osi:s})=>{l.push(Pe.createOsElement(e,Number(t),r,i,s,a)),r+=Number(t)})),l.join("")}static createOsElement(e,t,s,i,a,n){let r=`<div class="centerOs_shema_car" id='${a}'rel="${e}"></div>`;const l=[];for(let e=0;e<t;e++){const a=s+e,r=i.find((e=>Number(e.identifikator)===a)),o=n.filter((e=>Number(e.tyresdiv)===a)).map((e=>e.pressure))[0],c=r?r.idw_tyres:"",d=r?r.id_bitrix:"",h=r?`${Number(r.ostatok)}%`:null,u=r?Math.min(...Q.protek(r)):"";console.log(u);const p=`${r?"background-image: url(../../../../image/0000.png);":""} ${r?`color: ${se[ie.gener(Number(r.ostatok))]};`:""}`,m=2===t?0===e?"left":"right":e<2?"left":"right";l.push(`<div class="tyres_shema_car" id="${a}" minN='${u}' rel="${c}"style="${p}" data-att="${o}" relid="${d}" side="${m}">${h}</div>`)}return 2===t?`<div class='container_na_osi'>\n            <div class='left_container charts_wrap_wheel'></div>\n            <div class="osi_shema_car">\n                    ${l[0]}\n                    ${r}\n                    ${l[1]}\n                </div>\n                     <div class='right_container charts_wrap_wheel'></div>\n                </div>`:`<div class='container_na_osi'>\n               <div class='left_container charts_wrap_wheel'></div>\n            <div class="osi_shema_car">\n                 ${l[0]} ${l[1]}\n          <div class="centerOs_shema_car" style="width:50px" id='${a}' rel ="${e}"></div>\n                 ${l[2]} ${l[3]}\n                </div>\n                 <div class='right_container charts_wrap_wheel'></div>\n                </div>`}static createListModelsTyres(e,t){e.innerHTML=t.map((e=>{const t=e.imagePath&&""!==e.imagePath?`style="background-image: url('../../../..${e.imagePath}')"`:"style=\"background-image: url('../../../../image/zeto_tyres.png')\"";return`<div class="row_model" rel="${e.uniqTyresID}" \n             marka='${e.marka}' model='${e.model}' radius='${e.radius}'\n       type='${e.type_tyres}' tire='${e.type_tire}' massa='${e.index_massa}' speed='${e.index_speed}' sezon='${e.sezon}'\n        width='${e.width}' profil='${e.profil}'>\n                        <div class="img_tyres" ${t}></div>\n                        <div class="parametr_tyres">${e.type_tire} ${e.marka} ${e.model} ${e.type_tyres}\n                         Размер:${e.radius}/${e.width}/${e.profil}  ${e.sezon} Индекс:${e.index_massa} ${e.index_speed}\n                        </div>\n                        </div>`})).join("")}}class Fe{constructor(e,t){this.tyreModels=e,this.fields=t,this.selection={},this.inputElements={},this.globalArrayDatas={},this.init()}init(){console.log(this.tyreModels),this.fields.forEach((e=>{const t=document.getElementById(e);t&&(this.inputElements[e]=t,this.globalArrayDatas[e]=this.getUniqueValues(this.tyreModels,e),t.addEventListener("input",(t=>this.onElementInput(t,e))),t.addEventListener("focus",(()=>this.createList(e,this.globalArrayDatas[e]))))})),document.addEventListener("click",(e=>{this.fields.forEach((t=>{this.inputElements[t].contains(e.target)||this.removeList(t)}))}))}getUniqueValues(e,t){return[...new Set(e.map((e=>e[t])))]}onElementInput(e,t){Q.validatonPunctuation(e.target);const s=this.inputElements[t].value.toLowerCase();this.selection[t]=s;const i=this.filterBySelection(this.tyreModels,this.selection);this.fields.forEach((e=>{const s=this.inputElements[e];e!==t&&(this.globalArrayDatas[e]=this.getUniqueValues(i,e),this.updateAutocomplete(s,this.globalArrayDatas[e]))}));const a=this.globalArrayDatas[t].filter((e=>e.toLowerCase().includes(s)));this.removeList(t),this.createList(t,a)}filterBySelection(e,t){return e.filter((e=>Object.keys(t).every((s=>!t[s]||e[s].toLowerCase().includes(t[s])))))}createList(e,t){this.removeList(e);const s=document.createElement("div");s.className="autocomplete-list",t.forEach((t=>{const i=document.createElement("div");i.className="autocomplete-item",i.textContent=t,i.addEventListener("click",(()=>{this.inputElements[e].value=t,this.selection[e]=t,this.removeList(e),this.onElementInput({target:this.inputElements[e]},e)})),s.appendChild(i)})),this.inputElements[e].parentNode.appendChild(s)}updateAutocomplete(e,t){}removeList(e){const t=this.inputElements[e].parentNode.querySelector(".autocomplete-list");t&&t.remove()}}class Be{static async createTyre(e,t){const s=await Be.createObject(t,e);return await X.saveDataToDBTyres(s)}static async updateTyre(e,t,s,i){const a=e.getAttribute("relId"),n=t[2].result.find((e=>"mileage"===e.params)),r={};r.idw_tyres=e.getAttribute("rel"),r.nameCar=t[0].message,r.dateInputSklad="-",r.dateOutputSklad=Q.getCurrentDate(),r.dateInstall=Q.getCurrentDate(),r.idObject=String(t[4]),r.mileage=n?Math.round(parseFloat(n.value)):"-",r.flag_status="0",r.identifikator=e.id,r.typeOs=e.parentElement.querySelector(".centerOs_shema_car").getAttribute("rel"),r.numberOs=e.parentElement.querySelector(".centerOs_shema_car").id,r.login=document.querySelectorAll(".log")[1].textContent;const l=await X.updateDataInDB(r);return await X.updateFilterTable(r.idObject,a,r.idw_tyres,e.getAttribute("data-att")),i&&await X.updateFilterTable(r.idObject,null,null,s),l}static renderChartById(e,t){const s=Q.protek(e),i=t.querySelectorAll(".contBar22");s.length>0&&f(s,e.protektor_passport,i,e.ostatok,2)}static async updateTyreSklad(e,t,s,i,a,n,r){console.log(e,t,s,i,a,n,r);const l=s[2].result.find((e=>"mileage"===e.params)),o={};o.idw_tyres=e,o.nameCar="-",o.dateInputSklad=Q.getCurrentDate(),o.dateOutputSklad="-",o.dateInstall="-",o.idObject="-",o.mileage="-",o.flag_status=i,o.identifikator="-",o.typeOs="-",o.numberOs="-",o.login=document.querySelectorAll(".log")[1].textContent,o.probeg_now=l?Math.round(parseFloat(l.value))-Math.round(parseFloat(t.mileage))+Math.round(parseFloat(t.probeg_now)):Math.round(parseFloat(t.probeg_now)),o.probeg_last=Number(t.probeg_passport)-o.probeg_now,o.comments=r;const c=await X.updateTyreSklad(o);return await X.updateFilterTable(t.idObject,null,null,"0"===i?a.getAttribute("data-att"):n.getAttribute("data-att")),c}static async generateUniqueId(){return await X.findIdTyres()}static async createObject(e,t){const s={};return e.forEach((e=>{s[e.getAttribute("id")]=e.value})),s.login=document.querySelectorAll(".log")[1].textContent,s.dateInputSklad=Q.getCurrentDate(),s.idw_tyres=await Be.generateUniqueId(),s.flag_status="1",s.uniqTyresID=t,s.dateZamer=s.ostatok?Q.getCurrentDate():"-",s}}class ze{constructor(e,t,s,i,a){this.parent=e,this.draggableSelector=t,this.droppableSelector=s,this.instanceSkladyres=a,this.element=i,this.pop=document.querySelector(".popup-background"),this.draggableElements=[...this.parent.querySelectorAll(t)].filter((e=>"true"===e.querySelector(".status_tyres").getAttribute("flag"))).map((e=>e)),this.droppableElements=document.querySelectorAll(s),this.drag=null,this.boundOnDragStart=this.onDragStart.bind(this),this.boundOnDragOver=this.onDragOver.bind(this),this.boundOnDrop=this.onDrop.bind(this),this.init()}init(){this.draggableElements.forEach((e=>{e!==this.parent&&(e.setAttribute("draggable",!0),e.addEventListener("dragstart",this.boundOnDragStart))})),this.droppableElements.forEach((e=>{e!==this.parent&&(e.setAttribute("draggable",!0),e.addEventListener("dragstart",this.boundOnDragStart),e.addEventListener("dragover",this.boundOnDragOver),e.addEventListener("drop",this.boundOnDrop))})),this.parent.addEventListener("dragover",this.boundOnDragOver),this.parent.addEventListener("drop",this.boundOnDrop)}removeEventListeners(){this.draggableElements.forEach((e=>{e.removeAttribute("draggable"),e.removeEventListener("dragstart",this.boundOnDragStart)})),this.droppableElements.forEach((e=>{e.removeEventListener("dragstart",this.boundOnDragStart),e.removeEventListener("dragover",this.boundOnDragOver),e.removeEventListener("drop",this.boundOnDrop)})),this.parent.removeEventListener("dragover",this.boundOnDragOver),this.parent.removeEventListener("drop",this.boundOnDrop)}onDragStart(e){this.drag=e.target,e.dataTransfer.setData("data-att",e.target.getAttribute("rel")),e.dataTransfer.setData("classList",e.target.classList.toString())}onDragOver(e){e.preventDefault()}onDrop(e){e.preventDefault();const t=e.dataTransfer.getData("data-att"),s=e.target,i=s.closest(".sklad_tyres"),a=this.drag.closest(".sklad_tyres"),n=s.closest(".container_shema"),r=this.drag.closest(".container_shema");this.id=s.getAttribute("rel"),this.idBitrix=s.getAttribute("relid"),this.sensor=s.getAttribute("data-att"),this.idDrag=this.drag.getAttribute("rel"),this.idBitrixDrag=this.drag.getAttribute("relid"),this.sensorDrag=this.drag.getAttribute("data-att"),s.getAttribute("rel")===t||i&&a||!this.drag.getAttribute("rel")||(this.removeExistingModal(),this.createModal(s),n&&r?this.setupModalHandlers(t,s,"flag"):this.setupModalHandlers(t,s))}removeExistingModal(){const e=document.querySelector(".modal_podtver");e&&e.remove()}createModal(e){this.element.insertAdjacentHTML("beforeend",ie.modalValidation(e,this.drag)),this.modal=this.element.querySelector(".modal_podtver"),this.modal?this.pop.style.display="block":console.error("Не удалось найти элемент .modal_podtver")}setupModalHandlers(e,t,s){const i=this.modal.querySelector(".ok_podtver"),a=this.modal.querySelector(".cancel_podtver"),n=this.modal.querySelector("#actionSelect"),r=this.modal.querySelector(".comm");a.addEventListener("click",(()=>{this.closeModal()})),i.addEventListener("click",(async()=>{if(t.closest(".sklad_tyres")){if(!this.validateSelection(n))return;this.removeChart(this.drag),this.clearRelAttribute(e),await this.selectionControlMethod(n.value,null,this.drag,r.value)}else if(s)await this.handleFlagDrop(t,s);else if(!await this.handleDefaultDrop(t,n,r))return;this.closeModal()}))}async handleFlagDrop(e,t){e.getAttribute("rel")?(this.removeChart(e),this.assignDataAttribute(this.idDrag,this.idBitrixDrag,e),await this.updateStatusTyres(e,this.sensor,t),this.removeChart(this.drag),this.assignDataAttribute(this.id,this.idBitrix,this.drag),await this.updateStatusTyres(this.drag,this.sensorDrag,t)):(this.assignDataAttribute(this.idDrag,this.idBitrixDrag,e),await this.updateStatusTyres(e,this.sensorDrag,t,"rotate"),this.updateBackgroundImage(e),this.removeChart(this.drag),this.clearRelAttribute()),this.closeModal()}async handleDefaultDrop(e,t,s){if(e.getAttribute("rel")){if(!this.validateSelection(t))return!1;{const i=e.getAttribute("rel");this.removeChart(e),await this.selectionControlMethod(t.value,i,e,s.value)}}else this.assignDataAttribute(this.idDrag,this.idBitrixDrag,e),this.updateBackgroundImage(e),await this.updateStatusTyres(e,this.sensor);this.closeModal()}async selectionControlMethod(e,t,s,i){let a;t?(a=t,this.assignDataAttribute(this.idDrag,this.idBitrixDrag,s),this.updateBackgroundImage(s),await this.updateStatusTyres(s,this.sensorDrag)):a=this.idDrag;const n=this.instanceSkladyres.allTyres.find((e=>e.idw_tyres===a));switch(e){case"1":await this.updateStatusTyresSklad(a,n,this.instanceSkladyres.modelCar,"1",s,this.drag,i);break;case"2":await this.updateStatusTyresSklad(a,n,this.instanceSkladyres.modelCar,"2",s,this.drag,i);break;case"3":await this.updateStatusTyresSklad(a,n,this.instanceSkladyres.modelCar,"3",s,this.drag,i);break;default:console.error("Неизвестное действие:",e)}}validateSelection(e){return"-"===e.value?(e.classList.add("invalid"),!1):(e.classList.remove("invalid"),!0)}closeModal(){this.pop.style.display="none",this.modal.remove()}removeChart(e){[...e.closest(".container_na_osi").querySelectorAll(".progressBar2")].find((t=>t.getAttribute("rel")===e.getAttribute("rel"))).remove()}clearRelAttribute(){this.drag.removeAttribute("rel"),this.drag.removeAttribute("relId"),this.drag.style.backgroundImage="none",this.drag.textContent=""}async updateStatusTyres(e,t,s,i){await Be.updateTyre(e,this.instanceSkladyres.modelCar,t,i),s||this.instanceSkladyres.updateListTyres()}async updateStatusTyresSklad(e,t,s,i,a,n,r){await Be.updateTyreSklad(e,t,s,i,a,n,r),this.instanceSkladyres.updateListTyres()}assignDataAttribute(e,t,s){if(e){const i=this.instanceSkladyres.allTyres.find((t=>t.idw_tyres===e));s.textContent=i.ostatok,s.setAttribute("rel",e),s.setAttribute("relid",t),s.style.color=se[ie.gener(Number(i.ostatok))];const a=s.getAttribute("side"),n=ie.addContainerCharts(e);n.setAttribute("rel",e);const r=n.querySelector(".discription_shina_wrap");"left"===a?(s.closest(".osi_shema_car").previousElementSibling.appendChild(n),r.style.left="-110%"):(s.closest(".osi_shema_car").nextElementSibling.appendChild(n),r.style.right="-125%"),Q.addContent(r,i),Be.renderChartById(i,n)}}updateBackgroundImage(e){e.style.backgroundImage='url("../../../../image/0000.png")'}}class Re{constructor(e,t,s,i,a){this.data=e,this.interval=t,this.info=s,this.container=i,this.wheel=a,this.init()}init(){if(console.log(this.data),this.clearRows(),this.formatTineUnix(),this.addActualData(),this.proparation(),this.addStruktura(),0===this.structura.length)return;const e=this.calcilator();console.log(e),this.createTableContent(e)}clearRows(){this.container.querySelectorAll(".row_stata").forEach((e=>e.remove())),this.container.querySelectorAll(".list_discription").forEach((e=>e.remove()))}proparation(){const e=this.actualArray.reduce(((e,t)=>{const s=`${t.idObject}-${t.params}`;return e[s]||(e[s]=[]),e[s].push(t),e}),{});this.groupedData=Object.values(e)}createTableContent(e){const t=this.container.querySelectorAll(".table_stata"),s=this.container.querySelectorAll(".description_wheel"),i=t[0],a=t[1],n=s[0],r=s[1],l=Object.entries(e.intervals),o=Object.entries(e.speeding),c=(e,t)=>{const s=document.createElement("tr");s.classList.add("row_stata"),e.forEach((e=>{const t=document.createElement("td");t.classList.add("cel","celValue"),t.textContent=e,s.appendChild(t)})),t.appendChild(s)};c(l.map((([e,t])=>t.totalTime)),i),c(l.map((([e,t])=>t.totalMileage)),i),n.innerHTML=ie.renderDiscription(this.condition),c(o.map((([e,t])=>t.totalTime)),a),c(o.map((([e,t])=>t.totalMileage)),a),r.innerHTML=ie.renderDiscription(this.speed)}calcilator(){const e=ee[this.wheel.index_speed],t=this.structura.map((t=>({intervals:this.processSensor(t[0],Number(t[0].bar.knd),Number(t[0].bar.kvd),Number(t[0].bar.dnn),Number(t[0].bar.dvn)),speeding:this.processSpeed(t[0],e)}))),s=e=>{let t=0,s=0;const i={};return Object.keys(e).forEach((a=>{const n=e[a].reduce(((e,t)=>{const s=t.end-t.start,i=t.mileage;return{totalTime:e.totalTime+s,mileageInterval:e.mileageInterval+i}}),{totalTime:0,mileageInterval:0});t+=n.totalTime,s+=n.mileageInterval,i[a]={totalTime:0!==n.totalTime?n.totalTime:0,totalMileage:0!==n.mileageInterval?n.mileageInterval:0}})),i.all={totalTime:0!==t?t:"-",totalMileage:0!==s?s:"-"},i},i=t.map((e=>(e.intervals=s(e.intervals),e.speeding=s(e.speeding),e))),n={intervals:{},speeding:{}};return i.forEach((e=>{const{intervals:t,speeding:s}=e;Object.keys(t).forEach((e=>{n.intervals[e]||(n.intervals[e]={totalTime:0,totalMileage:0}),n.intervals[e].totalTime+=t[e].totalTime,n.intervals[e].totalMileage+=t[e].totalMileage})),Object.keys(s).forEach((e=>{n.speeding[e]||(n.speeding[e]={totalTime:0,totalMileage:0}),n.speeding[e].totalTime+=s[e].totalTime,n.speeding[e].totalMileage+=s[e].totalMileage}))})),Object.keys(n.intervals).forEach((e=>{n.intervals[e]={totalTime:n.intervals[e].totalTime?a(n.intervals[e].totalTime):"-",totalMileage:n.intervals[e].totalMileage?`${n.intervals[e].totalMileage} км`:"-"}})),Object.keys(n.speeding).forEach((e=>{n.speeding[e]={totalTime:n.speeding[e].totalTime?a(n.speeding[e].totalTime):"-",totalMileage:n.speeding[e].totalMileage?`${n.speeding[e].totalMileage} км`:"-"}})),n}processSpeed(e,t){let s={norma:[],speeding:[]},i=null,a=null,n=null;return e.val.forEach(((r,l)=>{const o=new Date(r.dates).getTime()/1e3;let c=null;r.speed>0&&1===r.dvs?(r.speed<=t?(c="norma",this.speed="speeding"):c="speeding",!c||c===i&&null!==a||(null!==a&&s[i].push({start:a,end:o,mileage:null!==n?r.mileage-n:0}),a=o,n=r.mileage,i=c)):null!==a&&(s[i].push({start:a,end:o,mileage:null!==n?r.mileage-n:0}),a=null,n=null,i=null),l===e.val.length-1&&null!==a&&s[i].push({start:a,end:o,mileage:null!==n?r.mileage-n:0})})),s}processSensor(e,t,s,i,a){let n={potery:[],belowKnd:[],betweenKndDnn:[],betweenDnnDvn:[],betweenDvnKvd:[],aboveKvd:[]},r=null,l=null,o=null;e.val.forEach(((c,d)=>{const h=new Date(c.dates).getTime()/1e3;let u=null;c.speed>0&&1===c.dvs?(-.1===c.value?u="potery":c.value>=0&&c.value<=t?u="belowKnd":c.value>t&&c.value<=i?u="betweenKndDnn":c.value>i&&c.value<a?u="betweenDnnDvn":c.value>=a&&c.value<s?u="betweenDvnKvd":c.value>=s&&(u="aboveKvd"),!u||u===r&&null!==l||(null!==l&&n[r].push({start:l,end:h,mileage:null!==o?c.mileage-o:0}),l=h,o=c.mileage,r=u)):null!==l&&(n[r].push({start:l,end:h,mileage:null!==o?c.mileage-o:0}),l=null,o=null,r=null),d===e.val.length-1&&null!==l&&n[r].push({start:l,end:h,mileage:null!==o?c.mileage-o:0})}));const c=this.calculateTotalMileage(n.betweenDvnKvd)+this.calculateTotalMileage(n.aboveKvd),d=this.calculateTotalMileage(n.betweenKndDnn)+this.calculateTotalMileage(n.belowKnd);return this.condition=c>d?"pressureHigh":"pressureLow",n}calculateTotalMileage=e=>e.reduce(((e,t)=>e+t.mileage),0);addStruktura(){this.structura=this.groupedData.map((e=>{const t=e[0].idObject,s=this.info.find((e=>e[4]==t)),[,i,a,n]=s,r={};n.result.forEach((e=>{r[e.idOs]=e}));const l=i.result.map((t=>{if(t.pressure!==e[0].params)return null;if(r[t.osNumber]){const s=a.result.find((e=>Object.values(e).includes(t.pressure)));return s?{sens:s.sens,position:Number(t.tyresdiv),parametr:t.pressure,bar:r[t.osNumber],val:e.map((e=>({dates:new Date(1e3*Number(e.time)),speed:Number(e.speed),value:Number(e.value),mileage:Number(e.mileage),dvs:Number(e.dvs)})))}:null}return null})).filter((e=>null!==e));return l.sort(((e,t)=>e.position-t.position)),l.forEach((e=>e.val.sort(((e,t)=>e.dates-t.dates)))),l})),console.log(this.structura)}addActualData(){1===this.time.length?this.actualArray=this.data.filter((e=>Number(e.time)<=this.time[0])):this.actualArray=this.data.filter((e=>Number(e.time)>=this.time[0]&&Number(e.time)<=this.time[1]))}formatTineUnix(){this.time=this.interval.map((e=>{const[t,s,i]=e.split("-"),a=new Date(`${i}-${s}-${t}T00:00:00Z`);return Math.floor(a.getTime()/1e3)}))}}class We{constructor(e,t,s,i){this.history=e,this.instanceSkladTyres=i,this.data=t,this.containerCard=s,this.bodyZamer=this.containerCard.querySelector(".body_zamer"),this.status={0:"Установлено",1:"На складе",2:"В ремонте",3:"Утилизировано"},this.init()}async init(){console.log(this.history),this.uniqueDataWithPrice=Q.addStruktura(this.data,this.history),await this.getValue(),this.preparation(),this.addListElements(),this.highlightLastDate(),this.addDotClickHandlers(),this.addSegmentClickHandlers()}async getValue(){const e=this.data.idw_tyres;this.historyValue=await X.getHistoryValueWheel(e)}preparation(){this.date=Object.values(this.history.reduce(((e,t)=>{const s=[t.N1,t.N2,t.N3,t.N4];return s.filter((e=>!e)).length<=2&&(e[s.join("-")]=t),e}),{}))}addListElements(){console.log(this.date),this.date.forEach((e=>{const t=document.createElement("div");t.classList.add("listRows"),t.textContent=e.dateZamer,t.setAttribute("rel",e.id),this.bodyZamer.appendChild(t),t.addEventListener("click",this.handleDateClick.bind(this))}))}handleDateClick(e){this.clearClass();const t=e.target.getAttribute("rel"),s=this.bodyZamer.querySelector(".selected");s&&s.getAttribute("rel")===t?this.highlightLastDate():(this.highlightElement(e.target),this.highlightDotById(t),this.updateTooltip(t),this.renderChartById(t),this.renderTexContent(t),this.startSvodka(t))}highlightLastDate(){const e=this.bodyZamer.querySelectorAll(".listRows");e.forEach((e=>e.classList.remove("selected"))),e[e.length-1].classList.add("selected");const t=this.date[this.date.length-1];this.highlightDotById(t.id),this.updateTooltip(t.id),this.renderChartById(t.id),this.renderTexContent(t.id),this.startSvodka(t.id)}startSvodka(e,t){let s;if(t){const t=this.date.findIndex((t=>t.id===Number(e)));s=[this.date[t-1].dateZamer,this.date[t].dateZamer]}else s=[this.date.find((t=>t.id===Number(e))).dateZamer];new Re(this.historyValue,s,this.instanceSkladTyres.uniqData,this.containerCard,this.data)}highlightElement(e){this.bodyZamer.querySelectorAll(".listRows").forEach((e=>e.classList.remove("selected"))),e.classList.add("selected")}renderTexContent(e){console.log(e);const t=this.date.find((t=>t.id===Number(e)));console.log(t);const s=this.uniqueDataWithPrice.find((t=>t.id===Number(e))),i=Math.floor(parseFloat(s.minN)/parseFloat(s.protektorOneKM))-Number(t.probeg_now),a=this.containerCard.querySelectorAll(".info_discription");a[0].textContent=`ID: ${t.idw_tyres}`,a[1].textContent=`Статус: ${this.status[t.flag_status]}`,a[2].textContent=`Пробег: ${t.probeg_now} км`,a[3].textContent=`Прогноз остатка пробега: ${i} км`}renderChartById(e){const t=this.date.find((t=>t.id===Number(e)));Q.renderProtektors(t,this.containerCard);const s=Q.protek(t),i=this.containerCard.querySelectorAll(".contBar22");s.length>0&&f(s,t.protektor_passport,i,t.ostatok,2)}highlightDotById(e){this.containerCard.querySelectorAll(".dot").forEach((t=>{t.getAttribute("data-id")==e?(t.style.fill="green",t.setAttribute("r",5)):(t.style.fill="white",t.setAttribute("r",4))}))}addSegmentClickHandlers(){this.containerCard.querySelectorAll(".segment").forEach((e=>{e.removeEventListener("click",this.boundHandleSegmentClick),this.boundHandleSegmentClick=this.handleSegmentClick.bind(this),e.addEventListener("click",this.boundHandleSegmentClick)}))}addDotClickHandlers(){this.containerCard.querySelectorAll(".dot").forEach((e=>{e.removeEventListener("click",this.boundHandleDotClick),this.boundHandleDotClick=this.handleDotClick.bind(this),e.addEventListener("click",this.boundHandleDotClick)}))}handleSegmentClick(e){const t=e.target.getAttribute("data-id");this.segment&&this.segment.getAttribute("data-id")===t||(this.clearClass(),this.addClass(e.target),this.updateTooltipSegment(t),this.startSvodka(t,"segment"))}clearClass(){this.segment&&(this.segment.classList.remove("selected_segment"),this.segment.style.strokeWidth="2.5",this.segment=null)}addClass(e){e.classList.add("selected_segment"),e.style.strokeWidth="4",this.segment=e}handleDotClick(e){this.clearClass();const t=e.target.getAttribute("data-id"),s=this.containerCard.querySelector(".dot.selected");if(s&&s.getAttribute("data-id")===t)this.highlightLastDate();else{this.highlightDotById(t);const e=this.bodyZamer.querySelector(`[rel='${t}']`);this.highlightElement(e),this.updateTooltip(t),this.renderChartById(t),this.renderTexContent(t),this.startSvodka(t)}}updateTooltipSegment(e){const t=this.uniqueDataWithPrice.findIndex((t=>t.id===Number(e))),s={prev:this.uniqueDataWithPrice[t-1],current:this.uniqueDataWithPrice[t]},i=this.containerCard.querySelector(".tooltip_tochka");this.uniqueDataWithPrice.find((t=>t.id==e))&&i&&(i.style.opacity=1,i.style.top="15px",i.style.left="195px",this.setTooltipText(i.querySelector(".tooltip_element1"),"Стоимость пробега за 1 км:",`${s.current.priceOneKMLine} руб.`,this.calculatePercentage(s.current.priceOneKMLine,s.prev.defaultPrice)),this.setTooltipText(i.querySelector(".tooltip_element2"),"Износ протектора за 1 км:",`${s.current.protektorOneKMLine} мм`,this.calculatePercentage(s.current.protektorOneKMLine,s.prev.defaultProtektor)))}updateTooltip(e){const t=this.containerCard.querySelector(".tooltip_tochka"),s=this.uniqueDataWithPrice.find((t=>t.id==e));s&&t&&(t.style.opacity=1,t.style.top="15px",t.style.left="195px",this.setTooltipText(t.querySelector(".tooltip_element1"),"Стоимость пробега за 1 км:",`${s.priceOneKM} руб.`,this.calculatePercentage(s.priceOneKM,s.defaultPrice)),this.setTooltipText(t.querySelector(".tooltip_element2"),"Износ протектора за 1 км:",`${s.protektorOneKM} мм`,this.calculatePercentage(s.protektorOneKM,s.defaultProtektor)))}setTooltipText(e,t,s,i){e.querySelector(".tooltip_element_title").textContent=t,e.querySelector(".tooltip_element_value").textContent=s;const a=Number(i)>0?"+":"",n=e.querySelector(".tooltip_element_value_otklonenie");n.textContent=`${a}${i} %`,n.style.color=i>0?"red":i<0?"green":"black"}calculatePercentage(e,t){return((e-t)/t*100).toFixed(1)}}class He{constructor(e,t){this.rows=e,this.instanceSkladTyres=t,this.activeRow=null,this.cardWindow=this.instanceSkladTyres.element.querySelector(".card_tyres_window"),this.card=this.cardWindow.children[0],this.analitika=this.cardWindow.children[1],this.protektor=[],this.pop=document.querySelector(".popup-background"),this.init()}init(){this.validate(),this.rows.forEach((e=>{e.addEventListener("click",(()=>this.handleCardClick(e)))}))}validate(){this.instanceSkladTyres.clickCardRow&&(this.activeRow=[...this.rows].find((e=>e.getAttribute("rel")===this.instanceSkladTyres.clickCardRow)),this.activeRow.classList.add("click_row"))}async handleCardClick(e){const t=e.classList.contains("click_row");this.resetActiveRow(),t?(this.instanceSkladTyres.lastClickedElement?(this.instanceSkladTyres.updateJobField("Колесная схема","none","flex","none","none"),document.querySelector(".activ_button_sklad").classList.contains("navi_job_tyres")?this.instanceSkladTyres.changeSkaldAndJob():this.instanceSkladTyres.changeJobAndSklad()):this.instanceSkladTyres.updateJobField("Аналитика","flex","none","none","none"),this.cardWindow.style.display="none"):(this.setActiveRow(e),this.methods(e))}resetActiveRow(){this.activeRow&&this.activeRow.classList.remove("click_row"),this.activeRow=null}setActiveRow(e){e.classList.add("click_row"),this.activeRow=e}async methods(e){this.renderCard(e),this.wiewDataTyres(e),this.cardWindow.querySelectorAll(".vvod").forEach((e=>Q.validatonPunctuation(e)));const t=new ae(this.targetWheel,this.cardWindow);await t.init(),this.historyWheel=await X.getHistoryTyresidTyres(this.targetWheel.idw_tyres),new We(this.historyWheel,this.targetWheel,this.cardWindow,this.instanceSkladTyres),"0"!==this.targetWheel.flag_status&&this.controllStatusTyres(e),this.saveReduct(e)}controllStatusTyres(e){const t=this.card.querySelector(".position_icon"),s=t.getAttribute("rel");t.addEventListener("click",(()=>{this.showModal(s),this.setupModalHandlers(e,s)}))}showModal(e){this.pop.style.display="block",this.cardWindow.closest(".globalSklad").insertAdjacentHTML("beforeend",ie.htmlContantModal(e)),this.modal=this.cardWindow.closest(".globalSklad").querySelector(".modal_podtver")}setupModalHandlers(e){const t=this.modal.querySelector(".ok_podtver"),s=this.modal.querySelector(".cancel_podtver"),i=this.modal.querySelector("#actionSelect"),a=this.modal.querySelector(".comm");s.addEventListener("click",(()=>this.closeModal())),t.addEventListener("click",(async()=>{Q.validateSelection(i)&&(await this.updateStatus(e,i.value,a.value),this.closeModal())}))}async updateStatus(e,t,s){const i=this.getObject();i.flag_status=t,i.comment=s,await X.updateWheel(i),this.instanceSkladTyres.clickCardRow=e.getAttribute("rel"),await this.instanceSkladTyres.getTyres(),this.instanceSkladTyres.createRows(),this.methods(e)}closeModal(){this.pop.style.display="none",this.modal.remove()}saveReduct(e){const t=Array.from(e.querySelectorAll(".tyres_shema")).find((e=>null!==e.getAttribute("rel")&&""!==e.getAttribute("rel").trim())),s=this.cardWindow.querySelector(".save_params"),i=this.cardWindow.querySelector(".mess_validation");s.addEventListener("click",(async()=>{if(Q.validationInput(this.cardWindow)){const s=this.getObject(),a=await X.updateWheel(s);Q.viewRemark(i,"green",a),this.instanceSkladTyres.clickCardRow=e.getAttribute("rel"),t&&await X.updateFilterTable(e.getAttribute("data-att"),s.id_bitrix_wiew,e.getAttribute("rel"),t.getAttribute("rel")),await this.instanceSkladTyres.updateListTyres(),this.instanceSkladTyres.toggleTyresVisibility(),this.methods(e)}else Q.viewRemark(i,"red","Заполните обязательные поля")}))}getObject(){const e=this.cardWindow.querySelector(".input-fields_params").querySelectorAll(".styled-input"),t={};return e.forEach((e=>t[e.getAttribute("id")]=e.value)),t.idw_tyres=this.activeRow.getAttribute("rel"),t.login=document.querySelectorAll(".log")[1].textContent,t.dateZamer=this.compareProtektor(t)?this.targetWheel.dateZamer:Q.getCurrentDate(),t.flag_status=this.targetWheel.flag_status,t.mileage=this.probeg.mileage,t}compareProtektor(e){const t=[e.N1,e.N2,e.N3,e.N4,e.ostatok];return this.protektor.every(((e,s)=>t[s]===e))}async wiewDataTyres(e){const t=e.getAttribute("rel"),s=this.instanceSkladTyres.allTyres.find((e=>e.idw_tyres===t));this.targetWheel=s;const i=s.imagePath?`url('../../../..${s.imagePath}')`:"url('../../../../image/zeto_tyres.png')";this.cardWindow.querySelector("#imageContainer_wiew").style.backgroundImage=i;const a=[{id:"#type_tire_wiew",value:s.type_tire},{id:"#marka_wiew",value:s.marka},{id:"#model_wiew",value:s.model},{id:"#type_tyres_wiew",value:s.type_tyres},{id:"#radius_wiew",value:s.radius},{id:"#profil_wiew",value:s.profil},{id:"#width_wiew",value:s.width},{id:"#sezon_wiew",value:s.sezon},{id:"#index_speed_wiew",value:s.index_speed},{id:"#index_massa_wiew",value:s.index_massa},{id:"#probeg_passport_wiew",value:s.probeg_passport},{id:"#protektor_passport_wiew",value:s.protektor_passport},{id:"#id_bitrix_wiew",value:s.id_bitrix},{id:"#psi_wiew",value:s.psi},{id:"#bar_wiew",value:s.bar},{id:"#probeg_now_wiew",value:s.probeg_now},{id:"#probeg_last_wiew",value:s.probeg_last},{id:"#N1",value:s.N1},{id:"#N2",value:s.N2},{id:"#N3",value:s.N3},{id:"#N4",value:s.N4},{id:"#ostatok",value:s.ostatok},{id:"#rfid_cod",value:s.rfid},{id:"#price_tyres",value:s.price},{id:"#comment",value:s.comments},{id:"#protektor_passport_wiew_chart",value:s.protektor_passport}];this.protektor=[s.N1,s.N2,s.N3,s.N4,s.ostatok],a.forEach((e=>{const t=this.cardWindow.querySelector(e.id);t&&("input"===t.tagName.toLowerCase()?t.value=e.value:t.textContent=e.value)})),this.probeg=await Q.mileageCalc(s.mileage,s.probeg_now,s.idObject),console.log(this.cardWindow),this.cardWindow.querySelector("#probeg_now_wiew").value=isNaN(this.probeg.mileageTyres)?s.probeg_now:this.probeg.mileageTyres,this.instanceSkladTyres.valueCalculate(this.cardWindow)}renderCard(e){const t=e.getAttribute("rel"),s=this.instanceSkladTyres.allTyres.find((e=>e.idw_tyres===t));this.card.innerHTML=ie.createCardTyres(s.flag_status),this.analitika.innerHTML=ie.contentVisualWheel(),"0"!==s.flag_status&&(this.card.querySelector(".status_tyres").classList.add("position_icon"),console.log(this.card.querySelector(".status_tyres")),new g(this.card.querySelector(".status_tyres"),["Изменение статуса колеса"])),this.card.querySelector(".footer_card_tyres").remove();const i=this.instanceSkladTyres.element.querySelector(".body_last_container");Array.from(i.children).forEach((e=>{e!==this.cardWindow&&(e.style.display="none")})),this.cardWindow.style.display="flex";const a=this.instanceSkladTyres.element.querySelector(".up_name_last_container");a&&(a.textContent="Основные характеристики колеса")}}class Ve{constructor(e,t){this.pref=t,this.data=e,this.container=document.querySelector(".analitika"),this.protektors=null,this.statuss=null,this.object={0:"Установлено",1:"На складе",2:"В ремонте",3:"Утилизировано"},this.objColors={5:"В норме",4:"В норме",3:"Средний",2:"Умеренный",1:"Критический"},this.init()}init(){this.deletNowGraf(),this.protektors=this.data.map((e=>e.ostatok)),this.polymor()}deletNowGraf(){d3.select(this.container).select("svg").remove()}polymor(){switch(this.pref){case"sklad":this.statuss=this.getStruktura(),this.createDonutChart(this.statuss,this.object,["Установлено","На складе","В ремонте","Утилизировано"],["#87CEEB","green","gray","red"],this.toggleStatus.bind(this));break;case"install":this.protektors=this.getStrukturaInstall(),this.createDonutChart(this.protektors,this.objColors,["Критический","Умеренный","Средний","В норме"],["#FF0000","#FF6633","#c1bd3d","#009933"],this.toggleStatusInstall.bind(this))}}getStruktura(){const e=this.data.reduce(((e,t)=>(e[t.flag_status]=(e[t.flag_status]||0)+1,e)),{});return Object.keys(e).map((t=>({status:this.object[t],count:e[t]})))}getStrukturaInstall(){const e=this.data.reduce(((e,t)=>{const s=this.objColors[this.gener(t.ostatok)];return e[s]=(e[s]||0)+1,e}),{});return Object.keys(e).map((t=>({status:t,count:e[t]})))}createDonutChart(e,t,s,i,a){const n=Math.min(600,500)/2,r=n-150,l=d3.scaleOrdinal().domain(s).range(i),o=d3.select(this.container).append("svg").attr("width",600).attr("height",500).append("g").attr("transform","translate(300, 250)"),c=d3.arc().innerRadius(r).outerRadius(n),d=d3.pie().value((e=>e.count)).sort(null),h=o.selectAll(".arc").data(d(e)).enter().append("g").attr("class","arc");h.append("path").attr("d",c).attr("fill",(e=>l(e.data.status))),h.append("text").attr("transform",(e=>`translate(${c.centroid(e)})`)).attr("dy","0.35em").text((e=>`(${e.data.count})`)).style("text-anchor","middle").style("font-size","16px"),h.append("text").attr("transform",(e=>`translate(${c.centroid(e)})`)).attr("dy","1.35em").text((t=>`${(t.data.count/d3.sum(e,(e=>e.count))*100).toFixed(2)}%`)).style("text-anchor","middle").style("font-size","16px");const u=o.append("g").attr("class","legend").attr("transform",`translate(0, -${r/2})`).selectAll(".legend-item").data(l.domain()).enter().append("g").attr("class","legend-item").attr("transform",((e,t)=>`translate(-35, ${20*t})`));u.append("rect").attr("x",-9).attr("width",18).attr("height",18).style("cursor","pointer").style("fill",(t=>e.find((e=>e.status===t))?l(t):"white")).style("stroke",(e=>l(e))).on("click",(e=>a(e))),u.append("text").attr("x",12).attr("y",9).attr("dy",".35em").style("text-anchor","start").style("font-size","14px").text((e=>t[e]||e))}toggleStatus(e){const t=this.statuss.findIndex((t=>t.status===e));if(t>-1)this.statuss.splice(t,1);else{const t=this.getStruktura().find((t=>t.status===e));t&&this.statuss.push(t)}this.deletNowGraf(),this.createDonutChart(this.statuss,this.object,["Установлено","На складе","В ремонте","Утилизировано"],["#87CEEB","green","gray","red"],this.toggleStatus.bind(this))}toggleStatusInstall(e){const t=this.protektors.findIndex((t=>t.status===e));if(t>-1)this.protektors.splice(t,1);else{const t=this.getStrukturaInstall().find((t=>t.status===e));t&&this.protektors.push(t)}this.deletNowGraf(),this.createDonutChart(this.protektors,this.objColors,["Критический","Умеренный","Средний","В норме"],["#FF0000","#FF6633","#c1bd3d","#009933"],this.toggleStatusInstall.bind(this))}gener(e){return e>=100?5:e>=80?4:e>=60?3:e>=40?2:1}}class Ge{constructor(e,t,s){this.tyres=e,this.container=t,this.axisContainer=s,this.left=this.container.querySelector(".left_grafs"),this.right=this.container.querySelector(".right_grafs"),this.elementsTyres=t.querySelectorAll(".tyres_shema_car"),this.init()}init(){this.filterWheel(),this.addAxisElements(),this.createContainers()}filterWheel(){this.wheel=[...this.elementsTyres].filter((e=>e.getAttribute("rel")));const e=new Set(this.wheel.map((e=>e.getAttribute("rel"))));this.data=this.tyres.filter((t=>e.has(t.idw_tyres)))}addAxisElements(){const e=this.axisContainer.querySelectorAll(".osi_shema_car");e.forEach((e=>{const t=e.querySelector(".centerOs_shema_car"),s=e.querySelectorAll(".tyres_shema_car");let i=[...s].filter((e=>"left"===e.getAttribute("side"))).map((e=>`ID:${e.getAttribute("rel")} Протектор:${e.getAttribute("minn")} мм`)),a=[...s].filter((e=>"right"===e.getAttribute("side"))).map((e=>`ID:${e.getAttribute("rel")} Протектор:${e.getAttribute("minn")} мм`));const n=document.createElement("div");n.classList.add("row_axis");const r=`${i} --- Номер оси:${t.id} Тип оси:${t.getAttribute("rel")} --- ${a}`;n.textContent=r,this.axisContainer.appendChild(n)})),console.log(e)}createContainers(){this.data.sort(((e,t)=>Number(e.identifikator)-Number(t.identifikator))),this.wheel.forEach(((e,t)=>{const s=this.data[t].protektor_passport,i=Number(this.data[t].ostatok),a=Q.protek(this.data[t]),n=e.parentElement,r=ie.addContainerCharts(this.data[t].idw_tyres),l=r.querySelectorAll(".contBar22"),o=r.querySelector(".discription_shina_wrap");"left"===e.getAttribute("side")?(n.previousElementSibling.appendChild(r),o.style.left="-110%"):(n.nextElementSibling.appendChild(r),o.style.right="-105%"),Q.addContent(o,this.data[t]),f(a,s,l,i,2)}))}}class Je{constructor(e,t){this.element=e,this.globalArrayDatas=[],this.rows=t,this.element.addEventListener("input",this.onElementInput.bind(this)),this.pushData()}updateRows(e){this.rows=e,this.pushData()}pushData(){this.element.value="",console.log(this.rows),this.globalArrayDatas=[...this.rows].map((e=>{const t=e.getAttribute("rel"),s=e.getAttribute("marka")?e.getAttribute("marka").toLowerCase():"",i=e.getAttribute("model")?e.getAttribute("model").toLowerCase():"",a=e.getAttribute("type")?e.getAttribute("type").toLowerCase():"",n=e.getAttribute("radius")?e.getAttribute("radius").toLowerCase():"",r=e.getAttribute("width")?e.getAttribute("width").toLowerCase():"",l=e.getAttribute("profil")?e.getAttribute("profil").toLowerCase():"",o=e.getAttribute("massa")?e.getAttribute("massa").toLowerCase():"",c=e.getAttribute("speed")?e.getAttribute("speed").toLowerCase():"",d=e.getAttribute("data-att")?e.getAttribute("data-att").toLowerCase():"",h=e.getAttribute("relid")?e.getAttribute("relid").toLowerCase():"",u=e.getAttribute("sezon")?e.getAttribute("sezon").toLowerCase():"",p=e.getAttribute("nameCar")?e.getAttribute("nameCar").toLowerCase():"",m=e.getAttribute("tire")?e.getAttribute("tire").toLowerCase():"",y=e.querySelector(".status_tyres");return{rel:t,marka:s,model:i,type:a,radius:n,width:r,profil:l,massa:o,speed:c,idObject:d,idBitrix:h,sezon:u,nameCar:p,tire:m,status:y?y.getAttribute("status")?.toLowerCase():"",element:e}}))}onElementInput({target:e}){console.log(this.globalArrayDatas);const t=e.value.trim().toLowerCase();if(!t)return void this.openAllList();const s=this.globalArrayDatas.filter((({element:e,...s})=>Object.values({...s}).some((e=>"string"==typeof e&&(e.includes(t)||e===t)))));this.createList(s)}createList(e){this.removeList(),e.forEach((e=>{e.element.style.display="flex"}))}removeList(){this.rows.forEach((e=>e.style.display="none"))}openAllList(){this.rows.forEach((e=>e.style.display="flex"))}}class Ue{static formaSorting(e){console.log(e);const t="flex"===e.style.display,s=document.querySelector(".modal_podtver");return s&&s.remove(),console.log(t),`\n    <div class="modal_podtver">\n        <div class='header_podtver'>Параметры сортировки</div>\n        <div class='body_podtver body_sorting'>\n        ${t?"":'<div class="row_kritery"><i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="status">Статус</div></div>'}\n      <div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="tire">Тип шины</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="radius">Радиус</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="width">Ширина</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="profil">Профиль</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="type">Тип колеса</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="sezon">Сезонность</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="massa">Индекс нагрузки</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="speed">Индекс скорости</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="protektorpassport">Начальная высота протектора</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="psi">Максимальное давлеие PSI</div></div>\n<div class="row_kritery"> <i class="fa fa-check flag_sorting"></i><div class="text_sotring" rel="ostatok">Остаток протектора</div></div>\n\n        </div>\n        <div class='button_podtver'>\n            <div class="ok_podtver">Ок</div>\n            <div class="cancel_podtver">Отмена</div>\n        </div>\n    </div>`}static userSorting(e,t,s){const i=Array.from(s);i.sort(((t,s)=>{for(const i of e){const e=t.getAttribute(i),a=s.getAttribute(i);if("ostatok"===i){if(Number(e)>Number(a))return-1;if(Number(e)<Number(a))return 1}if("position"===i){if(Number(e)<Number(a))return-1;if(Number(e)>Number(a))return 1}else if(e!==a)return e.localeCompare(a)}return 0})),t.innerHTML="",i.forEach((e=>{t.appendChild(e)}))}static formaChangeWheel(){const e=document.querySelector(".modal_podtver");return e&&e.remove(),'<div class="modal_podtver">\n            <div class=\'header_podtver\'>Подобрать замену?</div>\n            <div class=\'body_podtver body_sorting\'>\n                 <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="model">Производитель</div></div>\n                <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="radius">Радиус</div></div>\n                <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="width">Ширина</div></div>\n                <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="profil">Профиль</div></div>\n                <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="type">Тип колеса</div></div>\n                 <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="massa">Индекс нагрузки</div></div>\n                <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="speed">Индекс скорости</div></div>\n                    <div class="row_kritery"> <i class="fa fa-check flag_sorting activFlagSort"></i><div class="text_sotring" rel="sezon">Сезонность</div></div>\n                </div>\n            <div class=\'button_podtver\'>\n                <div class="ok_podtver">Ок</div>\n                <div class="cancel_podtver">Отмена</div>\n            </div>\n        </div>'}static podborWheel(e,t,s,i){const a=Array.from(s);console.log(i);const n={radius:i.radius,width:i.width,profil:i.profil,massa:i.index_massa,speed:i.index_speed,sezon:i.sezon,model:i.model,type:i.type_tyres,minn:i.minn};a.sort(((e,t)=>{const s=Number(n.minn),i=Number(e.getAttribute("minn")),a=Number(t.getAttribute("minn")),r=s-Math.abs(s-i),l=s-Math.abs(s-a);return r!==l?l-r:a-i}));let r=!1;if(a.forEach((t=>{((t,s)=>{for(const i of e)if(t.getAttribute(i)!==s[i])return!0;return!1})(t,n)?t.style.display="none":"1"==t.getAttribute("status")&&(t.style.display="flex",r=!0)})),console.log(r),t.innerHTML="",a.forEach((e=>{t.appendChild(e)})),!r){const e=document.querySelector(".text_disklaymer");Q.viewRemark(e,"red","Подходящих шин нет на складе. Измените параметры подбора.")}}}class Ke{constructor(e,t){this.element=e,this.data=t,this.uniqData=null,this.arrayNameColumns=["marka","model","size","probegNow","probegVal","dateOutputSklad"],this.allTyres=null,this.jobTyres=this.element.querySelector(".job_tyres").querySelector(".body_sklad"),this.pop=document.querySelector(".popup-background"),this.skladTyres=this.element.querySelector(".sklad_tyres").querySelector(".body_sklad"),this.job_field=this.element.querySelector(".job_field"),this.container_shema=this.element.querySelector(".container_shema"),this.add_model_tyres=this.element.querySelector(".add_model_tyres"),this.add_tyres=this.element.querySelector(".add_tyres"),this.add_tyres_sort=this.element.querySelector(".add_tyres_sort"),this.navi=this.element.querySelectorAll(".up_name"),this.icon_add_tyres=this.element.querySelectorAll(".icon_add_tyres"),this.tyresRoom=this.element.querySelector(".tyres_room"),this.find=this.element.querySelector(".search_input_meta"),this.modelTyres=null,this.modelCar=null,this.clickCard=null,this.fields=["type_tire","marka","model","type_tyres","radius","profil","width","sezon","index_speed","index_massa"],this.lastClickedElement=null,this.clickCardRow=null,this.boundNavi=this.showBody.bind(this),this.boundModelTyresWindow=this.addWindow.bind(this),this.boundTyresWindow=this.addCardListTyres.bind(this),this.boundSorting=this.sortingModal.bind(this),this.init()}async init(){await this.getTyres(),this.defaultDOMElements(),this.addTooltips(),this.initEvent(),this.uniqData=this.getUniqData(this.data),Pe.createListObject(this.data),this.modelTyres=await X.getModelTyresGuide(),this.createRows(),this.controllListAndTyres()}initEvent(){this.navi.forEach((e=>e.addEventListener("click",this.boundNavi))),this.add_model_tyres.addEventListener("click",this.boundModelTyresWindow),this.add_tyres.addEventListener("click",this.boundTyresWindow),this.add_tyres_sort.addEventListener("click",this.boundSorting)}removeEvent(){this.navi.forEach((e=>e.removeEventListener("click",this.boundNavi))),this.add_model_tyres.removeEventListener("click",this.boundModelTyresWindow),this.add_tyres.removeEventListener("click",this.boundTyresWindow),this.add_tyres_sort.removeEventListener("click",this.boundSorting)}sortingModal(){this.element.insertAdjacentHTML("beforeend",Ue.formaSorting(this.element.querySelector(".job_tyres")));const e=this.element.querySelector(".modal_podtver");e.style.zIndex=2,this.toggleDisplay(this.pop,"block"),this.toogleFlagSorting(e);const[t,s]=e.querySelectorAll(".ok_podtver, .cancel_podtver");s.addEventListener("click",(()=>{this.toggleDisplay(this.pop,"none"),e.remove()})),t.addEventListener("click",(()=>{const t=Array.from(e.querySelectorAll(".activFlagSort")).map((e=>e.nextElementSibling.getAttribute("rel"))),s=Array.from(this.element.querySelectorAll(".container_sklad")).find((e=>"flex"===e.style.display)).querySelectorAll(".row_sklad"),i=s[0].parentElement;Ue.userSorting(t,i,s),this.toggleDisplay(this.pop,"none"),e.remove()}))}toogleFlagSorting(e){e.querySelectorAll(".row_kritery").forEach((e=>e.addEventListener("click",(()=>{e.children[0].classList.toggle("activFlagSort")}))))}async updateListTyres(){await this.getTyres(),this.createRows(),this.skladTyres.querySelectorAll(".row_sklad").forEach((e=>{"1"!==e.getAttribute("status")&&(e.style.display="none")})),this.lastClickedElement&&(this.dragAndDropInstance&&this.dragAndDropInstance.removeEventListeners(),this.dragAndDropInstance=new ze(this.skladTyres,".row_sklad",".tyres_shema_car",this.element,this)),this.addTooltip()}async addCardListTyres(){const e=this.element.querySelector(".click_row");e&&e.classList.remove("click_row");const t=this.job_field.querySelector(".tyres_model_list");this.toggleDisplay(t,"flex"),this.updateJobField("Карточка создания шины","none","none","flex","none"),t.children[0].innerHTML=ie.createCardTyres(),this.container=document.querySelector(".body_card_tyres"),this.container.querySelectorAll(".vvod").forEach((e=>Q.validatonPunctuation(e)));const s=this.job_field.querySelector(".list_item_tyres_model");this.modelTyres=await X.getModelTyresGuide(),Pe.createListModelsTyres(s,this.modelTyres);const i=s.querySelectorAll(".row_model"),a=t.querySelector(".search_input_meta");new Je(a,i),this.viewValueParamsCard(t,this.modelTyres),this.clickReduct(t),this.saveTyres(t)}saveTyres(e){const t=e.querySelector(".save_params"),s=e.querySelector(".mess_validation"),i=e.querySelector(".input-fields_params").querySelectorAll(".styled-input");t.addEventListener("click",(async()=>{if(Q.validationInput(this.container)){const e=t.getAttribute("id");if(!e)return void Q.viewRemark(s,"red","Выберите модель колеса");const a=await Be.createTyre(e,i);Q.viewRemark(s,"green",a),this.clickCard=null,t.removeAttribute("rel"),this.addCardListTyres(),this.updateListTyres()}else Q.viewRemark(s,"red","Заполните обязательные поля")}))}valueCalculate(e){const t=e.querySelector("#psi_wiew"),s=e.querySelector("#bar_wiew"),i=e.querySelector("#ostatok"),a=e.querySelector("#probeg_passport_wiew"),n=e.querySelector("#probeg_now_wiew"),r=e.querySelector("#probeg_last_wiew"),l=e.querySelectorAll(".protektors");this.psiEvent(t,s),this.protektorsEvent(e,l,i),this.probegEvent(a,n,r)}probegEvent(e,t,s){s.value=Number(e.value)-Number(t.value),t.addEventListener("input",(()=>{s.value=Number(e.value)-Number(t.value)})),e.addEventListener("input",(()=>{s.value=Number(e.value)-Number(t.value)}))}psiEvent(e,t){e.addEventListener("input",(()=>{t.value=(e.value/14.504).toFixed(1)}))}protektorsEvent(e,t,s){t.forEach((i=>{i.addEventListener("input",(i=>{Q.validatonPunctuation(i.target),s.value=Q.raschetProtector(e,t)}))})),e.addEventListener("input",(()=>{s.value=Q.raschetProtector(e,t)}))}clickReduct(e){const t=e.querySelector(".reduct_params"),s=e.querySelector(".mess_validation");t.addEventListener("click",(()=>{this.clickCard?(this.addWindow("reduct"),this.viewValueParamsModel()):Q.viewRemark(s,"red","Выберите модель колеса")}))}viewValueParamsModel(){const e=this.job_field.querySelector(".card_model_window"),t=this.clickCard.imagePath?`url('../../../..${this.clickCard.imagePath}')`:"url('../../../../image/zeto_tyres.png')";e.querySelector("#imageContainer").style.backgroundImage=t,[{id:"#type_tire",value:this.clickCard.type_tire},{id:"#marka",value:this.clickCard.marka},{id:"#model",value:this.clickCard.model},{id:"#type_tyres",value:this.clickCard.type_tyres},{id:"#radius",value:this.clickCard.radius},{id:"#profil",value:this.clickCard.profil},{id:"#width",value:this.clickCard.width},{id:"#sezon",value:this.clickCard.sezon},{id:"#index_speed",value:this.clickCard.index_speed},{id:"#index_massa",value:this.clickCard.index_massa},{id:"#probeg_passport",value:this.clickCard.probeg_passport},{id:"#protektor_passport",value:this.clickCard.protektor_passport}].forEach((t=>{const s=e.querySelector(t.id);s&&(s.value=t.value)}))}viewValueParamsCard(e,t){const s=e.querySelectorAll(".row_model"),i=e.querySelector(".card_model_tyres"),a=e.querySelector(".save_params");s.forEach((s=>s.addEventListener("click",(()=>{const n=t.find((e=>e.uniqTyresID===Number(s.getAttribute("rel"))));this.clickCard=n,a.setAttribute("id",s.getAttribute("rel"));const r=n.imagePath?`url('../../../..${n.imagePath}')`:"url('../../../../image/zeto_tyres.png')";i.querySelector("#imageContainer_wiew").style.backgroundImage=r,[{id:"#type_tire_wiew",value:n.type_tire},{id:"#marka_wiew",value:n.marka},{id:"#model_wiew",value:n.model},{id:"#type_tyres_wiew",value:n.type_tyres},{id:"#radius_wiew",value:n.radius},{id:"#profil_wiew",value:n.profil},{id:"#width_wiew",value:n.width},{id:"#sezon_wiew",value:n.sezon},{id:"#index_speed_wiew",value:n.index_speed},{id:"#index_massa_wiew",value:n.index_massa},{id:"#probeg_passport_wiew",value:n.probeg_passport},{id:"#protektor_passport_wiew",value:n.protektor_passport}].forEach((e=>{const t=i.querySelector(e.id);t&&(t.textContent=e.value)})),this.valueCalculate(e)}))))}addWindow(e){const t=this.element.querySelector(".click_row");t&&t.classList.remove("click_row"),e.isTrusted&&(this.clickCard=null);const s=this.job_field.querySelector(".tyres_model_card");s.style.display="flex",s.innerHTML=ie.createWindowModelTyres(),s.style.zIndex=2,this.pop.style.display="block",new Fe(this.modelTyres,this.fields),this.closeFunction(s),this.loadButton(s),this.saveData(s,"reduct")}loadButton(e){const t=e.querySelector("#uploadButton"),s=e.querySelector("#imageUpload"),i=e.querySelector("#imageContainer");t.addEventListener("click",(()=>{console.log("Клик по кнопке загрузки"),s.click()})),s.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{i.style.backgroundImage=`url(${e.target.result})`},e.readAsDataURL(t)}}))}saveData(e,t){const s=e.querySelector(".mess_validation"),i=e.querySelector(".save_params"),a=e.querySelector("#imageUpload");i.addEventListener("click",(async()=>{if(!Q.validationModelTyres(e,s))return void Q.viewRemark(s,"red","Заполните все поля!");const i=new FormData;i.append("type_tire",e.querySelector("#type_tire").value),i.append("marka",e.querySelector("#marka").value),i.append("model",e.querySelector("#model").value),i.append("type_tyres",e.querySelector("#type_tyres").value),i.append("radius",e.querySelector("#radius").value),i.append("profil",e.querySelector("#profil").value),i.append("width",e.querySelector("#width").value),i.append("sezon",e.querySelector("#sezon").value),i.append("index_speed",e.querySelector("#index_speed").value),i.append("index_massa",e.querySelector("#index_massa").value),i.append("reduct",t&&this.clickCard?this.clickCard.uniqTyresID:null);const n=a.files[0];n?i.append("image",n):this.clickCard&&this.clickCard.imagePath&&i.append("imagePath",this.clickCard.imagePath);const r=await X.saveDataToDB(i);Q.viewRemark(s,"green",r),t&&this.addCardListTyres()}))}closeFunction(e){e.querySelector(".close_modal_window").addEventListener("click",(()=>{e.style.display="none",e.style.zIndex=0,this.pop.style.display="none"}))}destroy(e,t){this.removeEvent(),this.element=e,this.data=t,this.init()}addTooltips(){new g(this.add_model_tyres,["Создать модель колеса"]),new g(this.add_tyres,["Создать колесо"]),new g(this.add_tyres_sort,["Сортировка списка"])}defaultDOMElements(){new Ve(this.allTyres,"sklad"),this.updateJobField("Аналитика","flex","none","none","none"),this.navi.forEach((e=>e.classList.remove("activ_button_sklad"))),this.navi[1].classList.add("activ_button_sklad"),this.toggleDisplay(this.jobTyres.parentElement,"none"),this.toggleDisplay(this.skladTyres.parentElement,"flex"),this.icon_add_tyres.forEach((e=>e.style.display="flex")),this.clickCard=null,this.clickCardRow=null,this.lastClickedElement=null}controllListAndTyres(){this.element.querySelectorAll(".listItemSklad").forEach((e=>e.addEventListener("click",(e=>{const t=this.element.querySelector(".click_row");t&&t.classList.remove("click_row");const s=e.target;this.controllActivElement(s),this.toggleTyresVisibility(),this.lastClickedElement&&this.addShema(),this.dragAndDropInstance&&this.dragAndDropInstance.removeEventListeners(),this.dragAndDropInstance=new ze(this.skladTyres,".row_sklad",".tyres_shema_car",this.element,this)}))))}addShema(){this.modelCar=this.uniqData.find((e=>e[4]===Number(this.lastClickedElement.getAttribute("rel")))),this.container_shema.innerHTML=Pe.createModelCar(this.modelCar,this.allTyres),this.container_shema.previousElementSibling.textContent=this.modelCar[0].message,Q.tooltipView("tyres_shema_car","Остаток протектора",this.container_shema),new Ge(this.allTyres,this.job_field.children[1].children[1],this.container_shema),this.wheelClick()}wheelClick(){this.container_shema.querySelectorAll(".tyres_shema_car").forEach((e=>e.addEventListener("click",(e=>{if(this.navi[0].classList.contains("activ_button_sklad"))return;const t=e.target;let s;s=2===t.parentElement.querySelectorAll(".tyres_shema_car").length?"left"===t.getAttribute("side")?t.parentElement.querySelector('.tyres_shema_car[side="right"]'):t.parentElement.querySelector('.tyres_shema_car[side="left"]'):t.previousElementSibling&&t.previousElementSibling.hasAttribute("side")?t.previousElementSibling:t.nextElementSibling&&t.nextElementSibling.hasAttribute("side")?t.nextElementSibling:null;const i=Number(s.getAttribute("minn")),a=s.getAttribute("rel");if(!a)return;const n=this.allTyres.find((e=>e.idw_tyres===a));n.minn=i,this.sortingConfirmation(n)}))))}sortingConfirmation(e){this.element.insertAdjacentHTML("beforeend",Ue.formaChangeWheel(this.element.querySelector(".job_tyres")));const t=this.element.querySelector(".modal_podtver");t.style.zIndex=2,this.toggleDisplay(this.pop,"block"),this.toogleFlagSorting(t);const[s,i]=t.querySelectorAll(".ok_podtver, .cancel_podtver");i.addEventListener("click",(()=>{this.toggleDisplay(this.pop,"none"),t.remove()})),s.addEventListener("click",(()=>{const s=Array.from(t.querySelectorAll(".activFlagSort")).map((e=>e.nextElementSibling.getAttribute("rel"))),i=this.skladTyres.querySelectorAll(".row_sklad");Ue.podborWheel(s,this.skladTyres,i,e),this.toggleDisplay(this.pop,"none"),t.remove()}))}controllActivElement(e){this.lastClickedElement&&this.lastClickedElement!==e&&this.lastClickedElement.classList.remove("clickElement"),e.classList.contains("clickElement")?(e.classList.remove("clickElement"),this.lastClickedElement=null,this.updateJobField("Аналитика","flex","none","none","none")):(e.classList.add("clickElement"),this.lastClickedElement=e,this.updateJobField("Колесная схема","none","flex","none","none"),this.changeSkaldAndJob())}updateJobField(e,t,s,i,a){this.job_field.children[0].textContent=e,this.job_field.children[1].children[0].style.display=t,this.job_field.children[1].children[1].style.display=s,this.job_field.children[1].children[3].style.display=i,this.job_field.children[1].children[4].style.display=a}toggleTyresVisibility(){const e=this.jobTyres.querySelectorAll(".row_sklad");Ue.userSorting(["data-att","position"],this.jobTyres,e),this.lastClickedElement?[...this.jobTyres.children].forEach((e=>{this.lastClickedElement.getAttribute("rel")===e.getAttribute("data-att")?e.style.display="flex":e.style.display="none"})):[...this.jobTyres.children].forEach((e=>e.style.display="flex"));const t=[...this.jobTyres.children].filter((e=>"flex"===e.style.display));this.instanceFind.updateRows(t)}showBody(e){const t=e.target;if(document.querySelector(".activ_button_sklad").classList.remove("activ_button_sklad"),t.classList.add("activ_button_sklad"),t.classList.contains("navi_job_tyres")){this.changeSkaldAndJob(),this.toggleTyresVisibility();const e=this.jobTyres.querySelectorAll(".row_sklad");Ue.userSorting(["data-att","position"],this.jobTyres,e)}else{this.changeJobAndSklad();const e=this.skladTyres.querySelectorAll(".row_sklad");e.forEach((e=>{e.style.display=this.lastClickedElement&&"1"!==e.getAttribute("status")?"none":"flex"})),Ue.userSorting(["status","ostatok"],this.skladTyres,e),this.instanceFind.updateRows(e)}}changeJobAndSklad(){this.toggleDisplay(this.jobTyres.parentElement,"none"),this.toggleDisplay(this.skladTyres.parentElement,"flex"),this.icon_add_tyres.forEach((e=>e.style.display="flex")),new Ve(this.allTyres,"sklad")}changeSkaldAndJob(){this.toggleDisplay(this.jobTyres.parentElement,"flex"),this.toggleDisplay(this.skladTyres.parentElement,"none"),this.icon_add_tyres.forEach((e=>e.style.display="none")),document.querySelector(".activ_button_sklad").classList.remove("activ_button_sklad"),this.navi[0].classList.add("activ_button_sklad"),new Ve(this.allTyres,"install")}toggleDisplay(e,t){e.style.display=t}createRows(){const e=this.element.querySelectorAll(".row_sklad");e&&e.forEach((e=>e.remove())),this.allTyres.forEach((e=>{const t=ie.tyresRow(e,this.uniqData);"0"!==e.flag_status?this.skladTyres.insertAdjacentHTML("beforeend",t):this.jobTyres.insertAdjacentHTML("beforeend",t)})),this.addTooltip();const t=this.element.querySelectorAll(".row_sklad");new He(t,this);const s=this.skladTyres.querySelectorAll(".row_sklad"),i=this.jobTyres.querySelectorAll(".row_sklad");Ue.userSorting(["status","ostatok"],this.skladTyres,s),Ue.userSorting(["data-att","position"],this.jobTyres,i),this.instanceFind=new Je(this.find,s)}async getTyres(){this.allTyres=await X.getAllTyres()}getUniqData(e){const t=e.flat(),s=new Map(t.map((e=>[e[4],e])));return Array.from(s.values())}addTooltip(){Q.tooltipView("battery","Остаток протектора",this.element),Q.tooltipView("fa-database","На складе",this.element),Q.tooltipView("fa-tools","В ремонте",this.element),Q.tooltipView("fa-trash","Утилизация",this.element)}}class Ye{constructor(e){this.data=e,this.buttonElements=document.querySelectorAll(".monitoring"),this.iconsToggle=document.querySelectorAll(".report_map_InList"),this.mapUnit=document.querySelectorAll(".map_unit"),this.reportUnit=document.querySelectorAll(".report_unit"),this.globalContainer=document.querySelector(".wrapperFull"),this.globalServis=document.querySelector(".globalServis"),this.currentTimeoutId=null,this.instancSklad=null,this.menuItems={dash:{method:this.dash.bind(this),elem:"globalDash"},karta:{method:this.karta.bind(this),elem:"globalMaps"},reports:{method:this.reports.bind(this),elem:"globalReports"},servis:{method:this.servis.bind(this),elem:"globalServis"},sklad:{method:this.sklad.bind(this),elem:"globalSklad"},statistika:{method:this.statistika.bind(this),elem:"start"}},console.log(this.data),this.init()}init(){this.handleButtonClickList(),this.buttonElements.forEach((e=>{e.addEventListener("click",this.handleButtonClick.bind(this))}))}handleButtonClickList(){this.currentTimeoutId&&(clearInterval(this.currentTimeoutId),this.currentTimeoutId=null)}handleButtonClick(e){if(this.buttonElements.forEach((e=>e.classList.remove("tablo"))),e.target.classList.add("tablo"),document.querySelectorAll(".groups").forEach((e=>{e.querySelector(".chekHidden").style.opacity=1})),document.querySelectorAll(".listItem").forEach((e=>{e.querySelector(".checkInList").style.opacity=1})),this.currentTimeoutId){clearInterval(this.currentTimeoutId);const e=document.querySelector(".checkTypeMarkers");document.querySelector(".tableInfoCar").style.display="none",e.style.display="none",this.currentTimeoutId=null}const t=document.querySelector(".start"),s=document.querySelector(".main");t.style.display="none",s.style.display="none";const i=document.querySelector(".color");document.querySelectorAll(".allsec").forEach((e=>{e.style.display="none"}));const a=e.target.getAttribute("rel"),n=this.menuItems[a],r=document.querySelector(`.${n.elem}`);n&&(n.method(r),i&&i.classList.remove("color"))}dash(e){e.style.display="flex",this.globalContainer.style.display="flex"}servis(e){this.globalContainer.style.display="none",e.style.display="flex",new De(this.data)}statistika(e){this.reportUnit.forEach((e=>{e.style.display="block",e.classList.remove("act_modules")})),this.mapUnit.forEach((e=>{e.style.display="block",e.classList.remove("act_modules")})),e.style.display="flex",e.style.width="98%",setTimeout((function(){ke.createChart()}),300),this.globalContainer.style.display="flex"}karta(e){this.globalContainer.style.display="flex",console.log("карта"),e.style.display="flex";const t=document.querySelector(".checkTypeMarkers"),s=document.querySelector(".tableInfoCar");t.style.display="flex",s.style.display="flex",document.querySelectorAll(".map_unit").forEach((e=>e.style.display="none")),this.mapUnit.forEach((e=>{e.style.display="none",e.classList.remove("act_modules")})),this.reportUnit.forEach((e=>{e.style.display="block",e.classList.remove("act_modules")}));const i=document.querySelector(".globalMaps").children[0];Ae(i),this.currentTimeoutId=setInterval((()=>{Ae(i)}),6e3)}reports(e,t,s){this.globalContainer.style.display="flex",this.reportUnit.forEach((e=>{e.style.display="none",e.classList.remove("act_modules")})),this.mapUnit.forEach((e=>{e.style.display="block",e.classList.remove("act_modules")})),s&&s.classList.add("act_modules"),e.style.display="flex",function(e){Te||(Te=new je),Te.createListShablons(e)}(t)}sklad(e){this.globalContainer.style.display="none",e.style.display="flex",this.instancSklad?this.instancSklad.destroy(e,this.data):this.instancSklad=new Ke(e,this.data)}}class Ze{constructor(e){this.element=e,this.globalArrayData=[],this.globalArrayDatas=[],this.list=document.querySelectorAll(".listItem"),this.group=document.querySelectorAll(".groups"),this.element.addEventListener("input",this.onElementInput.bind(this)),this.pushData()}async pushData(){this.group.forEach((e=>this.globalArrayDatas.push(e.getAttribute("rel"))));const e=[];this.list.forEach((t=>{!t.classList.contains("wialon")&&e.push(t.getAttribute("rel"))}));const t=[...new Set(e)];if(console.log(t),0!==t.length){const e={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:t})},s=await fetch("/api/objects",e);(await s.json()).forEach((e=>{""!==e.idObject&&this.globalArrayDatas.push(String(e.idObject)),""!==e.nameObject&&this.globalArrayDatas.push(e.nameObject),""!==e.imei&&this.globalArrayDatas.push(e.imei),""!==e.number&&this.globalArrayDatas.push(e.number)}))}const s=await fetch("/api/wialonObjects",{method:"GET",headers:{"Content-type":"application/json"}});(await s.json()).forEach((e=>{""!==e.idObject&&this.globalArrayDatas.push(String(e.idObject)),""!==e.nameObject&&this.globalArrayDatas.push(e.nameObject),""!==e.imei||null!==e.imei&&this.globalArrayDatas.push(e.imei),""!==e.phone||null!==e.phone&&this.globalArrayDatas.push(e.phone)}))}onElementInput({target:e}){this.removeList(),e.value||this.openAllList(),this.createList(this.globalArrayDatas.filter((t=>-1!==t.toLowerCase().indexOf(e.value.toLowerCase()))))}createList(e){this.list.forEach((t=>{const s=t.closest(".groups");(e.includes(t.children[0].textContent)||e.includes(t.getAttribute("rel"))||s&&e.includes(s.getAttribute("rel"))||e.includes(t.getAttribute("data-att"))||e.includes(t.getAttribute("data-phone")))&&(t.style.display="flex",s&&(s.style.display="flex"))}))}removeList(){this.list.forEach((e=>e.style.display="none")),this.group.forEach((e=>e.style.display="none"))}openAllList(){this.list.forEach((e=>e.style.display="flex")),this.group.forEach((e=>e.style.display="flex"))}}class Xe{constructor(){this.mainAlarm=document.querySelector(".mainAlarm"),this.alarmStorage=document.querySelector(".alarmStorage"),this.wrapMap=document.querySelector(".wrapMap"),this.mainAlarm.addEventListener("click",this.toggleCheck.bind(this))}toggleCheck(e){this.mainAlarm.classList.toggle("check_alarm"),this.mainAlarm.classList.contains("check_alarm")?(this.alarmStorage.style.display="block",new T(this.alarmStorage),e.stopPropagation(),document.addEventListener("click",(function(e){const t=e.target;this.wrapMap&&!this.wrapMap.contains(t)&&this.wrapMap.remove()})),new Ne(this.alarmStorage,this.mainAlarm)):this.alarmStorage.style.display="none"}}class Qe{constructor(e,t){this.sett=t,this.obj=e,this.clickElement=null,this.login=document.querySelectorAll(".log")[1].textContent,this.chekHiddens=document.querySelectorAll(".chekHidden"),this.plusS=document.querySelectorAll(".plusS"),this.minusS=document.querySelectorAll(".minusS"),this.filterV=document.querySelectorAll(".filterV"),this.filterVN=document.querySelectorAll(".filterVN"),this.checkInList=document.querySelectorAll(".checkInList"),this.groups=document.querySelectorAll(".groups"),this.globalcheck=document.querySelector(".globalcheck"),this.listItem=document.querySelectorAll(".listItem"),this.tableInfoCar=document.querySelector(".tableInfoCar"),this.parent=document.querySelector(".sortCondition"),this.cond=document.querySelectorAll(".cond"),this.mapUnit=document.querySelectorAll(".map_unit"),this.reportUnit=document.querySelectorAll(".report_unit"),this.mores=document.querySelector(".mores"),this.ones=document.querySelector(".ones"),this.delete=document.querySelectorAll(".deleteObject"),this.deleteGroup=document.querySelectorAll(".deleteGroup"),this.settingGroups=document.querySelectorAll(".settingsGroup"),this.prefs=document.querySelectorAll(".pref"),this.init()}init(){this.minusS.forEach((e=>e.addEventListener("click",this.hiddenList.bind(this)))),this.plusS.forEach((e=>e.addEventListener("click",this.viewList.bind(this)))),this.filterVN.forEach((e=>e.addEventListener("click",this.sortListUp.bind(this)))),this.filterV.forEach((e=>e.addEventListener("click",this.sortListDown.bind(this)))),this.groups.forEach((e=>this.hiddenWindows.bind(this,e)())),this.chekHiddens.forEach((e=>e.addEventListener("click",this.toggleHiddenChildList.bind(this)))),this.checkInList.forEach((e=>e.addEventListener("click",this.toggleHiddenList.bind(this)))),this.globalcheck.addEventListener("click",this.toggleGlobalObjectMaps.bind(this)),this.listItem.forEach((e=>e.children[0].addEventListener("mouseenter",this.opasity.bind(this)))),this.listItem.forEach((e=>e.children[0].addEventListener("mouseleave",this.opasityBack.bind(this)))),this.mapUnit.forEach((e=>e.addEventListener("click",this.naviToggle.bind(this,e)))),this.reportUnit.forEach((e=>e.addEventListener("click",this.naviToggle.bind(this,e)))),this.delete.forEach((e=>e.addEventListener("click",this.confirmation.bind(this,e,1)))),this.deleteGroup.forEach((e=>e.addEventListener("click",this.confirmation.bind(this,e,2)))),this.mores.addEventListener("click",this.toggleMoresOnes.bind(this)),this.ones.addEventListener("click",this.toggleMoresOnes.bind(this)),this.settingGroups.forEach((e=>e.addEventListener("click",this.edit.bind(this,e)))),this.prefs.forEach((e=>e.addEventListener("click",this.editObject.bind(this,e)))),Array.from(this.cond).forEach(((e,t)=>{e.addEventListener("click",(()=>{e.classList.contains("clicker")?e.classList.remove("clicker"):(Array.from(this.cond).forEach((e=>{e.classList.remove("clicker")})),e.classList.add("clicker")),Array.from(this.listItem).forEach((e=>{e.children[0].children[0].classList.remove("changeColorCheck")})),Array.from(this.listItem).forEach((e=>{"flex"!==e.style.display&&e.children[0].children[0].classList.add("changeColorCheck")})),Ce.toggleMarkersIcon()}))}))}editObject(e){const t=document.querySelector(".border");t&&(t.classList.remove("border"),t.children[0].children[0].style.color="darkblue"),e.parentElement.parentElement.classList.add("border"),e.style.color="green",this.obj.viewObjects(e)}async edit(e){const t=e.parentElement.parentElement.id,s=document.querySelector(".create_group_modal").querySelectorAll(".field_modal"),i=e.parentElement.parentElement.classList.contains("subgroup")?"sub":"group";s[0].setAttribute("id",t),s[0].setAttribute("rel",i),await this.sett.viewModal();const a=await this.sett.getIdGroup(t),n=document.querySelectorAll(".sostav_group"),r=document.querySelectorAll(".objects_list"),l=[a[0].name_g,a[0].face_company,a[0].number_company];s.forEach(((e,t)=>e.value=l[t])),a.forEach((e=>{Array.from(r[0].children).forEach((t=>{t.getAttribute("rel")===e.idObject&&n[0].appendChild(t)}))}))}confirmation(e,t){console.log(e,t);const s=document.querySelector(".modal_confirm"),i=document.querySelector(".popup-background");i.style.display="block",s.style.display="flex";const a=s.querySelector(".cancel"),n=s.querySelector(".ok_modal"),r=1===t?e.closest(".listItem").firstChild.textContent:e.parentNode.parentNode.getAttribute("rel");s.children[1].textContent=r,s.children[0].textContent=1===t?"Удалить объект?":"Удалить группу?",a.addEventListener("click",(()=>{s.style.display="none",i.style.display="none"})),n.addEventListener("click",(async()=>{if(s.style.display="none",i.style.display="none",1===t&&(await this.deleteObjectToBase(e),await this.deleteObjectToBaseGroups(e),Pt.startClass()),2===t){const t=e.parentNode.parentNode.id;await this.deleteGroupToBaseGroups(t),Pt.startClass();const s=document.querySelector(".create_object"),i=document.querySelector(".list_item1");this.mores.classList.remove("toggle_list"),this.ones.classList.remove("toggle_list"),this.ones.classList.add("toggle_list"),this.viewOnes(s,i)}}))}async deleteObjectToBase(e){const t=e.closest(".listItem").id,s=this.login,i={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({login:s,id:t})};(await fetch("api/deleteObject",i)).json()}async deleteGroupToBaseGroups(e){const t=this.login,s={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({login:t,id:e})};(await fetch("api/deleteGroupToBaseGroups",s)).json()}async deleteObjectToBaseGroups(e){const t=e.closest(".listItem").id,s=this.login,i={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({login:s,id:t})};(await fetch("api/deleteObjectInGroups",i)).json()}toggleMoresOnes(e){const t=e.target;this.mores.classList.remove("toggle_list"),this.ones.classList.remove("toggle_list"),t.classList.add("toggle_list");const s=t.parentElement,i=document.querySelector(".create_object"),a=document.querySelectorAll(".deleteGroup"),n=document.querySelectorAll(".settingsGroup");t.classList.contains("mores")&&(i.classList.add("gr"),new g(i,["Добавить новую группу"]),s.lastElementChild.textContent="Список групп",this.minusS.forEach((e=>{e.style.display="none",e.previousElementSibling.style.display="flex",e.closest(".groups").children[2]?(Array.from(e.closest(".groups").children[1].children).forEach((e=>{e.lastElementChild.style.display="none"})),e.closest(".groups").children[2].style.display="none"):e.closest(".groups").children[1].style.display="none"})),this.viewAndHidden(a,n)),t.classList.contains("ones")&&this.viewOnes(i,s)}viewOnes(e,t){const s=document.querySelectorAll(".deleteGroup"),i=document.querySelectorAll(".settingsGroup");e.classList.remove("gr"),new g(e,["Добавить новый объект"]),t.lastElementChild.textContent="Список объектов",this.plusS.forEach((e=>{e.style.display="none",e.nextElementSibling.style.display="flex",e.closest(".groups").children[2]?(Array.from(e.closest(".groups").children[1].children).forEach((e=>{e.lastElementChild.style.display="block"})),e.closest(".groups").children[2].style.display="block"):e.closest(".groups").children[1].style.display="block"})),this.viewAndHidden(s,i,"num")}naviToggle(e){document.querySelectorAll(".monitoring").forEach((e=>e.classList.remove("tablo")));const t=document.querySelector(".start"),s=document.querySelector(".main");t.style.display="none",s.style.display="none",document.querySelectorAll(".allsec").forEach((e=>{e.style.display="none"})),this.checkInList.forEach((e=>{e.classList.add("changeColorCheck")})),this.chekHiddens.forEach((e=>{e.classList.add("changeColorCheck")})),e.parentNode.children[2].classList.remove("changeColorCheck");const i=document.querySelector(".karta"),a=document.querySelector(".reports");e.classList.add("act_modules"),console.log(document.querySelector(".act_modules"));const n=new Ye;if(console.log(e),e.classList.contains("map_unit")){this.reportUnit.forEach((e=>{e.style.display="block",e.classList.remove("act_modules")})),this.mapUnit.forEach((e=>{e.style.display="none"}));const e=n.menuItems.karta,t=document.querySelector(`.${e.elem}`);a.classList.remove("tablo"),i.classList.add("tablo"),n.karta(t),Ce&&Ce.toggleMarkersIcon(),Ce&&Ce.createInfoControll()}if(e.classList.contains("report_unit")){this.mapUnit.forEach((e=>{e.style.display="block",e.classList.remove("act_modules")})),this.reportUnit.forEach((e=>{e.style.display="none"}));const t=n.menuItems.reports,s=document.querySelector(`.${t.elem}`);a.classList.add("tablo"),i.classList.remove("tablo"),n.reports(s,"avl_unit",e)}}opasity(e){Ce&&Ce.opasityMarkers(e.target.parentElement)}opasityBack(e){Ce&&Ce.opasityMarkersBack(e.target.parentElement)}toggleGlobalObjectMaps(e){this.globalcheck.classList.toggle("changeGlobalCheck");const t=document.querySelector(".changeGlobalCheck");console.log(t),t?(this.checkInList.forEach((e=>{e.classList.add("changeColorCheck")})),this.chekHiddens.forEach((e=>{e.classList.add("changeColorCheck")}))):(this.checkInList.forEach((e=>{e.classList.remove("changeColorCheck")})),this.chekHiddens.forEach((e=>{e.classList.remove("changeColorCheck")}))),Ce&&Ce.toggleMarkersIcon(),_e.clickListUpdateSummary(),ke&&ke.getDataSummary(),Ce&&Ce.createInfoControll()}toggleHiddenList(e){e.stopPropagation();const t=e.target,s=document.querySelector(".tablo");s&&"reports"===s.getAttribute("rel")?(this.checkInList.forEach((e=>{e.classList.add("changeColorCheck")})),t.classList.remove("changeColorCheck"),Te&&Te.createListObjectsSelect(t)):(t.classList.toggle("changeColorCheck"),Ce&&Ce.toggleMarkersIcon(),_e.clickListUpdateSummary(),ke&&ke.getDataSummary(),Ce&&Ce.createInfoControll())}toggleHiddenChildList(e){const t=e.target,s=t.closest(".groups").lastElementChild.parentElement.querySelectorAll(".checkInList"),i=document.querySelector(".tablo");i&&"reports"===i.getAttribute("rel")?(this.chekHiddens.forEach((e=>{e.classList.add("changeColorCheck")})),t.classList.remove("changeColorCheck"),Te&&Te.createListGroupSelect(t)):(t.classList.toggle("changeColorCheck"),Array.from(s).forEach((e=>{t.classList.contains("changeColorCheck")?e.classList.add("changeColorCheck"):e.classList.remove("changeColorCheck")})),Ce&&Ce.toggleMarkersIcon(),_e.clickListUpdateSummary(),ke&&ke.getDataSummary(),Ce&&Ce.createInfoControll())}hiddenList(e){const t=e.target;t.style.display="none",t.previousElementSibling.style.display="flex",t.closest(".groups").children[2]?(Array.from(t.closest(".groups").children[1].children).forEach((e=>{e.lastElementChild.style.display="none"})),t.closest(".groups").children[2].style.display="none"):t.closest(".groups").children[1].style.display="none"}viewAndHidden(e,t,s){"Администратор"===document.querySelector(".role").getAttribute("rel")&&(s?(e.forEach((e=>{e.style.display="none"})),t.forEach((e=>{e.style.display="none"}))):(e.forEach((e=>{e.style.display="block"})),t.forEach((e=>{e.style.display="block"}))))}viewList(e){const t=e.target;t.style.display="none",t.nextElementSibling.style.display="flex",t.closest(".groups").children[2]?(Array.from(t.closest(".groups").children[1].children).forEach((e=>{e.lastElementChild.style.display="block"})),t.closest(".groups").children[2].style.display="block"):t.closest(".groups").children[1].style.display="block"}sortListUp(e){const t=e.target;t.style.display="none",t.previousElementSibling.style.display="block";const s=[];Array.from(t.parentNode.nextElementSibling.children).forEach((e=>{s.push(e)})),console.log(Array.from(t.parentNode.nextElementSibling.children)),s.forEach((e=>{t.parentNode.nextElementSibling.prepend(e)}))}sortListDown(e){const t=e.target;t.style.display="none",t.nextElementSibling.style.display="block";const s=[];Array.from(t.parentNode.nextElementSibling.children).forEach((e=>{s.push(e)})),s.forEach((e=>{t.parentNode.nextElementSibling.prepend(e)}))}hiddenWindows(e){var t=e.children[1].childNodes,s=[];for(var i in t)1==t[i].nodeType&&s.push(t[i]);for(s.sort((function(e,t){return e.innerHTML==t.innerHTML?0:e.innerHTML>t.innerHTML?1:-1})),i=0;i<s.length;++i)e.children[1].appendChild(s[i])}}class et{constructor(){this.arrayContent=[],this.init()}init(){const e=document.querySelector(".role"),t=document.querySelector(".logoutIcon"),s=document.querySelector(".create_object"),i=document.querySelector(".loop_find"),a=document.querySelectorAll(".viewIcon"),n=document.querySelector(".tableInfoCar"),r=document.querySelector(".infosCenter"),o=document.querySelector(".wrap_alarm"),c=document.querySelector(".icon_stata"),d=document.querySelector(".icon_check"),h=document.querySelector(".icon_graf");a.forEach((e=>{const t=e.getAttribute("rel").split(" "),s=t[t.length-1];this.arrayContent.push([e,[l[s]]])})),[...n.children[0].children].forEach((e=>{this.arrayContent.push([e,[e.getAttribute("rel")]])})),this.arrayContent.push([h,["Календарь"]]),this.arrayContent.push([c,["Календарь"]]),this.arrayContent.push([d,["Давление/Пробег"]]),this.arrayContent.push([e,[e.getAttribute("rel")]]),this.arrayContent.push([o,["События по давлению"]]),this.arrayContent.push([t,[t.getAttribute("rel")]]),this.arrayContent.push([s,["Добавить новый объект"]]),this.arrayContent.push([i,[["Поиск объектов по имени, ID, имени группы,"],["уникальному IMEI, телефону"]]]),this.arrayContent.push([r,["Если зажигание включено и данные  приходят, то значения подсвечены в зависимости от условий подсветки","Если зажигание включено, а данные не приходят, то колесо будет с серый фоном","Если зажигание выключено, то колесо будет черным, а последние зафиксированные показатели серым цветом","При наведении на колесо появится подсказка с параметром колеса и актуальностью данных"]]),this.initTooltipClass()}initTooltipClass(){this.arrayContent.forEach((e=>{new g(e[0],e[1])}))}}const tt=document.querySelector(".sections"),st=document.querySelector(".centerBlock"),it=document.querySelector(".start"),at=document.querySelector(".menu"),nt=document.querySelector(".main"),rt=document.querySelector(".wrapper_left"),lt=document.querySelector(".wrapper_right"),ot=document.querySelector(".comeback"),ct=document.querySelectorAll(".secondFlash"),dt=document.querySelector(".sections"),ht=document.querySelector(".techInfo"),ut=document.querySelector(".main_menu"),pt=document.querySelector(".grafics");document.querySelector(".create_object"),new class{constructor(e,t,s){this.leftContainer=e,this.rightContainer=t,this.sliderBar=s,this.currentX=0,this.isResizing=!1,this.sliderBar.addEventListener("mousedown",this.startResize.bind(this)),document.addEventListener("mousemove",this.resize.bind(this)),document.addEventListener("mouseup",this.stopResize.bind(this)),window.addEventListener("resize",this.handleResize.bind(this))}startResize(e){this.isResizing=!0,this.currentX=e.clientX,this.sliderBar.style.userSelect="none"}resize(e){if(!this.isResizing)return;const t=e.clientX-this.currentX,s=this.leftContainer.offsetWidth+t;s<330||s>1200?this.stopResize():(this.leftContainer.style.width=s+"px",this.rightContainer.style.width=`calc(100% - ${s}px)`,this.currentX=e.clientX)}handleResize(){const e=this.leftContainer.offsetWidth;e<100?(this.leftContainer.style.width="100px",this.rightContainer.style.width="calc(100% - 100px)"):e>900&&(this.leftContainer.style.width="900px",this.rightContainer.style.width="calc(100% - 900px)")}stopResize(e){this.isResizing&&(this.isResizing=!1,this.sliderBar.style.removeProperty("user-select"),console.log("дубль!!!"),setTimeout((function(){ke.createChart()}),300))}}(tt,it,ct[0]),new class{constructor(){this.rigthFrame=document.querySelectorAll(".rigthFrame"),this.searchList=document.querySelector(".search_list"),this.rightContainerWidth=null,this.rigthFrame.forEach((e=>{console.log(e),e.children[1].addEventListener("click",this.handleClickOne.bind(this)),e.children[0].addEventListener("click",this.handleClickTwo.bind(this))})),this.wrapLeft=document.querySelector(".wrapper_left").clientWidth}init(e){let t=e.previousElementSibling;for(;t&&"none"===window.getComputedStyle(t).display;)t=t.previousElementSibling;let s=e.nextElementSibling;for(;s&&"none"===window.getComputedStyle(s).display;)s=s.nextElementSibling;return[t,s]}handleClickOne(e){const t=e.target.parentNode,s=this.init(t);console.log(s),t.children[1].style.display="none",t.children[0].style.display="block",console.log(s[0]),console.log(s[1]),s[0].classList.contains("sections")?(s[0].style.width="10px",s[1].style.width="98%"):(this.rightContainerWidth=document.querySelector(".main").offsetWidth,s[0].style.width="0px",s[0].style.margin=0,s[1].style.flexGrow="1"),s[1].classList.contains("globalMaps")&&setTimeout((function(){xe.invalidateSize()}),300),(s[1].classList.contains("main")||s[1].classList.contains("wrapper_left"))&&setTimeout((function(){_.invalidateSize()}),300)}handleClickTwo(e){const t=e.target.parentNode,s=this.init(t);t.children[0].style.display="none",t.children[1].style.display="block",console.log(s[0]),console.log(s[1]),s[0].classList.contains("sections")?(s[0].style.width="550px",s[1].style.width="74%"):(s[0].style.margin="0 10px",s[0].style.width="495px",s[1].style.flexGrow="1"),s[1].classList.contains("globalMaps")&&setTimeout((function(){xe.invalidateSize()}),300),(s[1].classList.contains("main")||s[1].classList.contains("wrapper_left"))&&setTimeout((function(){_.invalidateSize()}),300)}},ut.addEventListener("click",(e=>{e.stopPropagation(),new Ne(at,ut),at.style.display="flex"})),document.querySelector(".itemInfoGlobal").addEventListener("click",(e=>{e.target.classList.toggle("iconMapsInfoActive")}));const mt=document.querySelectorAll(".mobile_item");mt.forEach((e=>{e.addEventListener("click",(()=>{if(mt.forEach((e=>{e.classList.remove("mobile_active")})),e.classList.toggle("mobile_active"),"Список"===e.children[0].textContent){const e=document.querySelector(".sections"),t=document.querySelector(".centerBlock");e.style.display="flex",t.style.display="flex",it.style.display="none",ot.style.display="none",nt.style.display="none"}if("Статистика"===e.children[0].textContent){const e=document.querySelector(".wrapperFull"),t=document.querySelectorAll(".content_card");ot.style.display="none",nt.style.display="none",dt.style.display="none",it.style.display="flex",it.style.flexDirection="column",it.style.flexWrap="nowrap",it.style.overflow="auto",e.style.height="",t.forEach((e=>{e.style.width="96%",e.style.minHeight="550px",e.style.margin="2px",e.children[0]?(e.children[0].children[0].children[0].style.width="50%",e.children[0].children[0].style.justifyContent="space-around",e.children[0].children[1].children[0].children[0].style.width="50%",e.children[0].children[1].children[0].children[3].style.width="20%",e.children[0].children[1].children[0].children[3].children[1].style.right="40px",Array.from(e.children[0].children[1].children[1].children).forEach((e=>{e.children[0].style.width="50%"}))):e.remove()}))}"Карта"===e.children[0].textContent&&(document.querySelector(".color")?(document.querySelector(".jobTSDetalisation").textContent="Время раб. ТС дет.",document.querySelector(".engineTS").textContent="Зажигание ВКЛ",document.querySelector(".jobHHTS").textContent="Холостой ход",document.getElementById("map").style.height="",dt.style.display="none",it.style.display="none",nt.style.display="flex",st.style.display="none",ht.style.display="none",pt.style.display="none",rt.style.display="block"):console.log("ничего")),"Конфигуратор"===e.children[0].textContent&&(document.querySelector(".color")?(pt.style.display="none",dt.style.display="none",it.style.display="none",nt.style.display="flex",st.style.display="flex",rt.style.display="none",ht.style.display="none",lt.style.display="flex"):console.log("ничего"))}))})),document.querySelector(".logo").addEventListener("click",(()=>{const e=document.querySelectorAll(".cond");document.querySelectorAll(".groups").forEach((e=>{e.querySelector(".chekHidden").style.opacity=1})),document.querySelectorAll(".listItem").forEach((e=>{e.querySelector(".checkInList").style.opacity=1})),e.forEach(((e,t)=>{e.classList.contains("clicker")&&e.classList.remove("clicker")})),clearInterval(void 0),clearInterval(void 0),document.querySelectorAll(".allsec").forEach((e=>{e.style.display="none"}));const t=document.querySelector(".tablo");t&&t.classList.remove("tablo");const s=document.querySelectorAll(".rigthFrame")[0],i=document.querySelector(".main"),a=document.querySelector(".start"),n=document.querySelector(".sections"),r=document.querySelector(".wrapper_right_dash"),l=document.querySelector(".color");i.style.display="none",r.style.display="none",a.style.display="flex",s.style.display="flex",a.style.width="100%",n.style.display="flex",l&&l.classList.remove("color"),_e.clickListUpdateSummary(),ke.getDataSummary()}));const yt=document.querySelector(".settings"),gt=document.querySelector(".close_settings"),vt=document.querySelector(".settings_users");yt&&(yt.addEventListener("click",(e=>{const s=document.querySelectorAll(".log")[0].getAttribute("rel");e.stopPropagation(),document.querySelector(".popup-background").style.display="block",vt.style.display="flex";const i=document.querySelector(".set_one"),a=document.querySelector(".set_two");if("Пользователь"===s||"Дежурный"===s){const e=document.querySelector(".account");i.remove(),e.remove(),a.classList.add("active_set"),document.querySelector(`.${me[a.getAttribute("rel")]}`).style.display="flex"}else t(),i.classList.add("active_set"),document.querySelector(`.${me[i.getAttribute("rel")]}`).style.display="flex";!function(){ve(ye);const e=document.querySelectorAll(".item_settings"),t=document.querySelectorAll(".content_set");e.forEach((s=>{s.addEventListener("click",(()=>{e.forEach((e=>{e.classList.remove("active_set")})),t.forEach((e=>{e.style.display="none"})),s.classList.add("active_set"),document.querySelector(`.${me[s.getAttribute("rel")]}`).style.display="flex"}))}))}(),new T(vt)})),gt.addEventListener("click",(()=>{vt.style.display="none",document.querySelector(".active_set").classList.remove("active_set"),document.querySelectorAll(".content_set").forEach((e=>{e.style.display="none"})),document.querySelector(".popup-background").style.display="none"}))),document.querySelector(".conF").addEventListener("click",(()=>{document.querySelector(".popup-background").style.display="block",vt.style.zIndex=0,document.querySelector(".set_form").style.display="flex",document.querySelector(".set_form_button").addEventListener("click",be)})),document.querySelector(".close_settings_form").addEventListener("click",(()=>{document.querySelector(".valid_text")&&(document.querySelector(".valid_text").textContent=""),document.querySelector(".email_set").value="",document.querySelector(".phone_set").value="",document.querySelector(".set_form").style.display="none",vt.style.zIndex=2}));const ft=document.querySelector("body").offsetWidth;document.querySelector(".iconStrela").addEventListener("click",(()=>{if(ft<=860){const e=document.querySelector(".centerBlock"),t=document.querySelector(".sections"),s=document.querySelector(".visualGrafics"),i=document.querySelector(".wrapList");e.style.display="flex",t.style.display="flex",t.style.width="100%",i.style.height="",document.querySelector(".comeback").style.display="none",s.style.display="none";const a=document.querySelector(".main");return a.style.display=a.style.display="none",document.querySelector(".mobile_active").classList.remove("mobile_active"),void document.querySelector(".mobile_spisok").classList.add("mobile_active")}if(ft>860&&ft<=1200)document.querySelector(".comeback").style.display="none",document.querySelector(".wrapper_left").style.display="none",document.querySelector(".main").style.display="flex",document.querySelector(".sections").style.display="flex",document.querySelector(".centerBlock").style.width="70%";else{document.querySelector(".sections").style.display="flex",document.querySelector(".comeback").style.display="none";const e=document.querySelector(".main");e.style.display="flex",e.style.display="55%",document.querySelector(".wrapper_left").style.display="block",document.querySelector(".centerBlock").style.width="70%"}}));const bt=document.querySelector(".dropdown"),wt=document.querySelector(".dropdown-content");bt&&bt.addEventListener("click",(()=>{if(bt.classList.contains("btnActive"))return wt.style.display="none",void bt.classList.remove("btnActive");bt.classList.add("btnActive"),wt.style.display="block"})),document.querySelectorAll("[name=radio]").forEach((e=>{e.addEventListener("change",(()=>{const e=document.querySelector(".headerMM");let t=e.children,s=[3,2,1,0];for(let i=0;i<s.length;i++)for(let a=0;a<s.length;a++)i==s[a]&&e.appendChild(t[a])}))}));class St{constructor(e,t,s){this.element=e,this.evnt=t,this.allObjects=s,this.sortConditionTypeFilter=this.element.nextElementSibling,this.grays=this.sortConditionTypeFilter.querySelectorAll(".graysEvent"),this.element.addEventListener("click",this.eventFilter.bind(this,"flex")),this.sortConditionTypeFilter.addEventListener("mouseleave",this.eventFilter.bind(this,"none")),this.grays.forEach((e=>e.addEventListener("click",this.filterEventLogs.bind(this)))),this.allObjects.addEventListener("click",this.chanchColor.bind(this))}chanchColor(){const e=this.evnt.closest(".wrapperLogs").querySelectorAll(".trEvent"),t=document.querySelector(".color").id,s=Array.from(this.sortConditionTypeFilter.querySelectorAll(".toogleIconEvent")).map((e=>e.nextElementSibling.textContent)),i=this.allObjects.classList.toggle("choice");e.forEach((e=>e.style.display="none")),e.forEach((e=>{const a=e.getAttribute("rel")===t,n=e.children[3].textContent,r=s.includes(n);i?(0===s.length||r)&&(e.style.display="flex"):a&&(0===s.length||r)&&(e.style.display="flex")})),i&&0===s.length&&!t&&e.forEach((e=>e.style.display="flex"))}initListeners(e){this.flash(e),this.styl(e),this.viewMap(e)}viewMap(e){e.children[3].addEventListener("click",this.clickHandler.bind(this))}styl(e){e.style.cursor="default",e.children[3].style.cursor="pointer"}flash(e){e.addEventListener("mouseenter",(function(){e.style.backgroundColor="lightgray"})),e.addEventListener("mouseleave",(function(){e.style.backgroundColor=""}))}clickHandler(e){e.stopPropagation();const t=e.currentTarget,s=[];s.push(parseFloat(t.parentElement.lastElementChild.textContent.split(",")[0])),s.push(parseFloat(t.parentElement.lastElementChild.textContent.split(",")[1]));const i=[{geo:s,logs:[t.parentElement.lastElementChild.parentElement.children[0].textContent,t.parentElement.lastElementChild.parentElement.children[2].textContent,t.parentElement.lastElementChild.parentElement.children[4].textContent]}];new q([],i,"log");const a=document.querySelector(".wrapMap");new Ne(a)}filterEventLogs(e){this.rows=this.evnt.closest(".wrapperLogs").querySelectorAll(".trEvent"),this.activeElement=document.querySelector(".color");const t=document.querySelector(".choice");e.isTrusted?e.target.classList.toggle("toogleIconEvent"):e.classList.add("toogleIconEvent");const s=Array.from(this.grays).filter((e=>e.classList.contains("toogleIconEvent"))).map((e=>e.nextElementSibling.textContent));this.rows.forEach((e=>e.style.display="none")),t?0===s.length?this.rows.forEach((e=>e.style.display="flex")):this.rows.forEach((e=>{s.includes(e.children[3].textContent)&&(e.style.display="flex")})):0===s.length?this.rows.forEach((e=>{e.getAttribute("rel")===this.activeElement.id&&(e.style.display="flex")})):this.rows.forEach((e=>{s.includes(e.children[3].textContent)&&e.getAttribute("rel")===this.activeElement.id&&(e.style.display="flex")})),this.evnt.style.color=s.length?"gray":"rgba(6, 28, 71, 1)"}eventFilter(e){"none"===e&&this.grays.forEach((e=>{e.removeEventListener("click",this.filterEventLogs.bind(this))})),this.sortConditionTypeFilter.style.display=e}}class _t{constructor(){this.container=null,this.wrapperLogs=null,this.controllInstance=null,this.objColor={Заправка:"darkblue",Простой:"darkgreen",Предупреждение:"darkred",Слив:"red","Потеря связи":"#28ad9e",Состояние:"#acad4c"},this.initializeTable()}initializeTable(){if(this.container=document.querySelector(".alllogs"),!this.container){const e=document.getElementsByTagName("body")[0];this.wrapperLogs=document.createElement("div"),this.wrapperLogs.classList.add("wrapperLogs"),document.createElement("div").classList.add("header_logs"),this.container=document.createElement("div"),this.container.classList.add("alllogs");const t=document.createElement("p");t.classList.add("spanTitle"),t.textContent="Логи событий";const s=document.createElement("input");s.classList.add("enterRows"),s.value=300;const i=document.createElement("i");i.classList.add("fas"),i.classList.add("fa-binoculars"),i.classList.add("allobjects"),e.appendChild(this.container),this.container.appendChild(t),this.container.appendChild(s),this.container.appendChild(i),this.container.appendChild(this.wrapperLogs),this.wrapperLogs.innerHTML='<h3 class="trLogs">\n                        <p class="tdLogs">Дата</p>\n                                       <p class="tdLogs">Группа</p>\n                        <p class="tdLogs">Объект</p>\n                           <div class="tdLogs evnt">Событие  <i class="fas fa-power-off filterEvent"></i>\n               <ul class="sortConditionTypeFilter">\n        <li class="item_type"><i class="fas fa-check graysEvent"></i>\n            <p class="text_types">Предупреждение</p>\n        </li>\n        <li class="item_type"><i class="fas fa-check graysEvent"></i>\n            <p class="text_types">Заправка</p>\n        </li>\n        <li class="item_type"><i class="fas fa-check graysEvent"></i>\n            <p class="text_types">Слив</p>\n        </li>\n        <li class="item_type"><i class="fas fa-check graysEvent"></i>\n            <p class="text_types">Простой</p>\n        </li>\n         <li class="item_type"><i class="fas fa-check graysEvent"></i>\n            <p class="text_types">Потеря связи</p>\n        </li>\n         <li class="item_type"><i class="fas fa-check graysEvent"></i>\n            <p class="text_types">Состояние</p>\n        </li>\n        <li class="item_type"><i class="fas fa-check graysEvent"></i>\n            <p class="text_types">Тех. обслуживание</p>\n        </li>\n    </ul>  </div>\n        <p class="tdLogs">Содержание</p>\n        <p class="tdLogs">Местоположение</p>\n                     </h3>';const a=document.querySelector(".evnt");a.addEventListener("mouseenter",(()=>a.children[0].style.display="flex")),a.addEventListener("mouseleave",(()=>a.children[0].style.display="none"));const n=a.querySelector(".filterEvent"),r=this.container.querySelector(".allobjects");this.controllInstance=new St(n,a,r)}}updateTable(e){console.log(e);const t=document.querySelector(".allobjects");new g(t,["Все объекты/Текущий"]),this.container.querySelectorAll(".trEvent").forEach((e=>e.remove())),e.forEach((e=>this.createRow(e)))}createRow(e){const t=document.createElement("div");t.classList.add("trEvent"),t.setAttribute("rel",e.id),t.setAttribute("tabindex","0"),this.wrapperLogs.insertBefore(t,this.wrapperLogs.firstChild.nextSibling);for(const s in e)if("id"!==s&&"data"!==s){const i=document.createElement("p");i.classList.add("tdEvent"),i.textContent=e[s],i.style.color=this.objColor[i.textContent]||"initial",t.appendChild(i)}this.controllInstance.initListeners(t)}}class kt{constructor(e,t,s){this.data=e,this.login=t,this.arrayIdGroups=s,this.init()}createPopup(e){const t=Object.values(e[0]);console.log(t);const s=document.getElementsByTagName("body")[0],i=document.createElement("div");i.classList.add("popup"),s.prepend(i);const a=document.createElement("div");a.classList.add("popH");const n=document.createElement("div");n.classList.add("popup-header"),n.textContent=t[0],t.shift(),i.appendChild(a),a.appendChild(n);const r=document.createElement("div");r.classList.add("popup-content"),i.appendChild(r);for(let e=0;e<t.length;e++){const s=document.createElement("div");s.classList.add("body_content"),s.textContent=t[e],r.appendChild(s)}const l=document.createElement("div");l.classList.add("popup-close"),l.innerHTML='<i class="fas fa fa-times "></i>',a.appendChild(l);const o=document.querySelector(".popup");o.style.display="block";const c=document.querySelector(".popup-background");c.style.display="block",o.classList.add("open"),document.querySelector(".popup-close").addEventListener("click",(function(){o.remove(),c.style.display="none"})),setTimeout((function(){o.remove(),c.style.display="none"}),1e4)}async init(){const e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:this.login})},t=await fetch("/api/viewEvent",e),s=await t.json();if(s.itog&&0!==s.itog.length){const e=this.prepareViewObject(s.itog[0]);this.data.forEach((t=>{const s=JSON.parse(t.content),i=s[0].event,a=this.formatDate(new Date(1e3*Number(t.time))),n=this.createMessage(t,i,s,a);e.alert.includes(i)&&this.createPopup(n)}))}else console.log("нет данных")}prepareViewObject(e){delete e.login,delete e.id;for(let t in e)e[t]=JSON.parse(e[t]).map((e=>["Давление","Температура"].includes(e)?"Предупреждение":e));return e}createMessage(e,t,s,i){console.log(e);const a={event:t,group:`Компания: ${e.groups}`,name:`Объект: ${e.name}`};switch(t){case"Заправка":case"Слив":return[{...a,litrazh:`${s[0].litrazh}`,time:`Время ${"Заправка"===t?"заправки":"слива"}: ${i}`}];case"Простой":return[{...a,time:`${s[0].time}`,alarm:`${s[0].alarm}`}];case"Предупреждение":return[{...a,group:`Компания: ${this.getGroupById(e.idw)}`,time:`${s[0].time}`,tyres:`${s[0].tyres}`,param:`${s[0].param}`,alarm:`${s[0].alarm}`}];case"Потеря связи":return[{...a,lasttime:`${s[0].lasttime}`}];default:return[a]}}formatDate(e){return`${e.getDate()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}getGroupById(e){if("Курсор"===this.login)return"demo";console.log(e),console.log(this.arrayIdGroups);const t=this.arrayIdGroups.find((t=>t[0]==e));return console.log(t),t?t[1]:"не определено"}}class Ct{constructor(e,t){this.data=e,this.login=t,this.log=document.querySelector(".logs"),this.wrapperLogs=null,this.count=300,this.quantity=0,this.arrayId=null,this.arrayIdGroups=null,this.value=null,this.rowsContent=null,this.logsTable=new _t,this.logs(),this.init(),setInterval((()=>this.update()),11e4),this.log.addEventListener("click",this.togglePopup.bind(this))}update(){this.wrapperLogs&&"block"!==this.wrapperLogs.style.display&&this.init()}async init(){try{this.pushId(),await this.getLogs(),await this.getQuantity(),this.rowsContent&&this.validationPopup(),this.createRowsEventLogs(),this.logsTable.updateTable(this.rowsContent),this.wrapperLogs=document.querySelector(".alllogs")}catch(e){console.error("Ошибка в инициализации LogsEvent:",e)}}validationPopup(){const e=this.value.view.filter((e=>!this.rowsContent.some((function(t){return t.data===e.time}))));0!==e.length&&new kt(e,this.login,this.arrayIdGroups)}updateValueCount(){document.querySelector(".enterRows").addEventListener("input",(async e=>{const t=Number(e.target.value);this.count=t,await this.getLogs(),this.createRowsEventLogs(),this.logsTable.updateTable(this.rowsContent)}))}async togglePopup(){if(!this.wrapperLogs)return;this.updateValueCount();const e=this.wrapperLogs.querySelector(".allobjects"),t=document.querySelector(".color");!t&&e.classList.add("choice");const s=!this.wrapperLogs.style.display||"none"===this.wrapperLogs.style.display;if(this.wrapperLogs.style.display=s?"block":"none",this.wrapperLogs.classList.toggle("clickLog",s),new T(this.wrapperLogs),s){this.logs(this.quantity),this.viewTableNum(0);const s=document.querySelector(".enterRows"),i=this.log.querySelector(".num");new Ne(this.wrapperLogs,this.log,i);const a=this.wrapperLogs.querySelectorAll(".trEvent");a.forEach((e=>{e.style.display="flex"})),t?(s.style.display="none",e.style.display="block",a.forEach((e=>{e.style.display=e.getAttribute("rel")!==t.id?"none":"flex"}))):(s.style.display="flex",e.style.display="none")}}times(e){return`${e.getDate()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}createRowsEventLogs(){const e=this.arrayIdGroups.reduce(((e,[t,s])=>(e[t]=s,e)),{});this.rowsContent=this.value.view.map((t=>{const s=JSON.parse(t.content),i=s[0].event,a=""!==t.geo?JSON.parse(t.geo):null,n=a?a.map((e=>Number(e).toFixed(5))).join(", "):"нет данных",r="Курсор"===this.login?"demo":"Предупреждение"!==i?t.groups:e[t.idw]||[],l=Object.values(s[0]);l.shift();const o=`${l.join(", ")}`,c=this.times(new Date(1e3*Number(t.time)));return{data:t.time,time:c,group:r,name:t.name,typeEvent:i,content:o,geo:n,id:t.idw}}))}createFetchRequestParams(e){return{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}}viewTableNum(e){document.querySelector(".num").textContent=e}async getQuantity(){const e=this.createFetchRequestParams({login:this.login}),t=await fetch("/api/quantityLogs",e),s=await t.json(),i=this.value.quant-s[0].quantity;this.viewTableNum(i)}async getLogs(){const e=this.createFetchRequestParams({arrayId:this.arrayId,quantity:this.quantity,count:this.count}),t=await fetch("/api/logsView",e);this.value=await t.json(),this.quantity=this.value.itog}pushId(){this.arrayId=this.data.reduce(((e,t)=>e.concat(Object.values(t).map((e=>e[4])))),[]),this.arrayIdGroups=this.data.reduce(((e,t)=>e.concat(Object.values(t).map((e=>[e[4],e[7]])))),[])}async logs(e){const t=e?this.createFetchRequestParams({login:this.login,quantity:e}):this.createFetchRequestParams({login:this.login});await fetch("/api/viewLogs",t)}}class Et{constructor(e){this.element=e,this.globalArrayDatas=[],this.meta=document.querySelectorAll(".item_meta"),this.element.addEventListener("input",this.onElementInput.bind(this)),this.pushData()}async pushData(){this.meta.forEach((e=>this.globalArrayDatas.push(e.textContent)))}onElementInput({target:e}){this.removeList(),e.value||this.openAllList(),this.createList(this.globalArrayDatas.filter((t=>-1!==t.toLowerCase().indexOf(e.value.toLowerCase()))))}createList(e){this.meta.forEach((t=>{e.includes(t.textContent)&&(t.style.display="flex")}))}removeList(){this.meta.forEach((e=>e.style.display="none"))}openAllList(){this.meta.forEach((e=>e.style.display="flex"))}}class Lt{constructor(e,t,s){this.element=t,this.id=e,this.param=s,this.container=document.querySelector(".container_tarir"),this.close=this.container.querySelector(".closes"),this.save=this.container.querySelector(".ok_modal"),this.addRow=this.container.querySelector(".add_modal"),this.wrapper_data=this.container.querySelector(".list_table_tarir"),this.values=this.container.querySelectorAll(".value_data"),this.message=this.container.querySelector(".validation_message"),this.boundClose=this.clos.bind(this),this.boundOk=this.ok.bind(this),this.boundAdd=this.add.bind(this,"",""),this.init(),this.initEventListeners()}async init(){this.container.style.display="flex";const e=await this.getTarirData();if(console.log(e),0!==e.length){this.wrapper_data.querySelectorAll(".row_tarir_data").forEach((e=>{e.remove()})),this.createRowsViewValue(e);const t=e.map((e=>[1,2,3,Number(e.dut),Number(e.litrazh)]));this.approcsimationsViewParabola(t)}}createRowsViewValue(e){e.forEach((e=>{this.add(e.dut,e.litrazh)}))}reinitialize(e,t,s){this.removeEventListeners(),this.id=e,this.param=s,this.element=t,this.resetInputs(),this.init(),this.add("",""),this.add("",""),this.initEventListeners();const i=document.querySelector(".chartTarir");i&&i.remove()}resetInputs(){const e=this.wrapper_data.querySelectorAll(".row_tarir_data");console.log(e),e.forEach(((e,t)=>{t>=2&&e.remove()})),this.wrapper_data.querySelectorAll("input").forEach((e=>{e.value="",e.style.border=""}))}initEventListeners(){this.close.addEventListener("click",this.boundClose),this.save.addEventListener("click",this.boundOk),this.addRow.addEventListener("click",this.boundAdd),this.container.addEventListener("input",(e=>{e.target.matches(".value_data")&&this.validateInput(e)}))}removeEventListeners(){this.close.removeEventListener("click",this.boundClose),this.save.removeEventListener("click",this.boundOk),this.addRow.removeEventListener("click",this.boundAdd),this.container.removeEventListener("input",this.validateInput)}clos(){console.log(this.id),console.log(this.container),this.container.style.display="none"}async ok(){if(this.validateRows()){const e=this.saveToBaseAndCreateChart();await this.updateTarirTable(e),console.log(e[0].length),e[0].length>2?this.element.style.color="green":this.element.style.color="rgba(6, 28, 71, 1)",this.approcsimationsViewParabola(e)}else this.message.textContent="Некорректные данные",this.message.style.color="red",this.message.style.fontWeigth="bold"}approcsimationsViewParabola(e){const t=[],s=[],i=[];let a;e.forEach((e=>{const a=[];t.push(Number(e[3])),s.push(Number(e[4])),a.push(Number(e[3])),a.push(Number(e[4])),i.push(a)})),console.log(i),t.length<3&&(a=1),t.length>=3&&(a=6);const n=this.approximateValue(t,s,a);console.log(n),this.grafikPoly(i,6,n)}approximateValue(e,t,s){return this.polynomialApproximation(e,t,s)}polynomialApproximation(e,t,s){const i=e.length,a=s+1;let n=Array.from({length:a},(()=>new Array(a).fill(0))),r=new Array(a).fill(0),l=new Array(a).fill(0);for(let s=0;s<i;s++){let i=e[s],l=t[s];for(let e=0;e<a;e++){for(let t=0;t<a;t++){let s=Math.pow(i,e+t);Number.isFinite(s)&&(n[e][t]+=s)}let t=Math.pow(i,e)*l;Number.isFinite(t)&&(r[e]+=t)}}for(let e=0;e<a;e++)for(let t=e+1;t<a;t++){let s=n[t][e]/n[e][e];r[t]-=s*r[e];for(let i=e;i<a;i++){let a=n[e][i]*s;Number.isFinite(a)&&(n[t][i]-=a)}}for(let e=a-1;e>=0;e--){let t=r[e];for(let s=e+1;s<a;s++)t-=l[s]*n[e][s];let s=n[e][e];Number.isFinite(s)||(s=Number.MAX_VALUE),l[e]=t/s}return l}grafikPoly(e,t,s){const i=document.querySelector(".chart_tarir"),a=(e,t)=>t.reduce(((t,s,i)=>t+s*e**i),0),n=document.querySelector(".chartTarir");n&&n.remove();const r=document.createElement("div");r.classList.add("chartTarir"),i.appendChild(r);const l=d3.select(".chartTarir").append("svg").attr("width",450).attr("height",300).append("g").attr("transform","translate(40, 20)"),o=d3.scaleLinear().range([0,390]).domain(d3.extent(e,(e=>e[0]))),c=d3.scaleLinear().range([230,0]).domain([0,d3.max(e,(e=>e[1]))]);l.append("g").attr("transform","translate(0, 230)").call(d3.axisBottom(o)),l.append("g").call(d3.axisLeft(c));const d=(o.domain()[1]-o.domain()[0])/100,h=d3.range(o.domain()[0],o.domain()[1],d).map((e=>[e,a(e,s)]));console.log(h);const u=d3.line().x((e=>o(e[0]))).y((e=>c(e[1])));l.append("path").datum(h).attr("class","line").attr("d",u).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2),l.append("path").datum(e).attr("fill","none").attr("stroke","red").attr("stroke-width",2).attr("d",u),l.selectAll("circle").data(e).enter().append("circle").attr("cx",(e=>o(e[0]))).attr("cy",(e=>c(e[1]))).attr("r",2).attr("fill","black")}async getTarirData(){const e=this.id,t=this.param;console.log(e,t);const s={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:e,param:t})},i=await fetch("api/getTarirTable",s);return await i.json()}async updateTarirTable(e){console.log(e);const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({values:e})},s=await fetch("api/updateTarirTable",t),i=await s.json();this.message.textContent=i,this.message.style.color="green",this.message.style.fontWeigth="bold"}saveToBaseAndCreateChart(){const e=[...this.wrapper_data.querySelectorAll(".row_tarir_data")].filter((e=>""!==e.children[0].value&&""!==e.children[1].value)).map(((e,t)=>[this.id,this.param,t+1,e.children[0].value,e.children[1].value]));return 0!==e.length?e:[[this.id,this.param]]}validateRows(){let e=!0;return[...this.wrapper_data.querySelectorAll(".row_tarir_data")].forEach((t=>{const s=[...t.querySelectorAll(".value_data")],i=s.some((e=>""===e.value)),a=s.some((e=>""!==e.value));s.forEach((e=>{e.style.border=i&&a?"1px solid red":""})),i&&a&&(e=!1)})),e}add(e,t){const s=document.createElement("li");s.classList.add("row_tarir_data"),this.wrapper_data.appendChild(s);const i=document.createElement("input");i.classList.add("value_data"),i.classList.add("value_dut"),i.value=e,s.appendChild(i),i.addEventListener("input",this.validateInput);const a=document.createElement("input");a.classList.add("value_data"),a.classList.add("value_oil"),a.value=t,s.appendChild(a),a.addEventListener("input",this.validateInput)}validateInput(e){/^\d*\.?\d*$/.test(e.target.value)?e.target.style.border="":e.target.style.border="1px solid red"}}class xt{constructor(e,t,s,i){this.element=t,this.id=e,this.params=s,this.lists=i,this.oils=null,this.container=document.querySelector(".container_summ"),this.close=this.container.querySelector(".closesSumm"),this.save=this.container.querySelector(".ok_modals"),this.bodySumm=this.container.querySelector(".body_summ"),this.boundClose=this.clos.bind(this),this.boundOk=this.ok.bind(this),this.init(),this.initEventListeners()}async init(){this.container.style.display="flex",this.filterOil(),this.createRows();const e=await this.getSummatorData();0!==e.length&&this.addClassCheckBox(e)}addClassCheckBox(e){this.colorSummator("green","ON");const t=this.container.querySelectorAll(".rowOil"),s=e.map((e=>e.param));t.forEach((e=>{s.includes(e.children[1].textContent)&&e.children[0].classList.remove("falseCheck")}))}async getSummatorData(){const e=this.id,t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/getSummator",t);return await s.json()}createRows(){const e=document.querySelectorAll(".rowOil");e&&e.forEach((e=>{e.remove()})),console.log(this.oils),this.oils.forEach((e=>{const t=document.createElement("div");t.classList.add("rowOil"),this.bodySumm.appendChild(t);const s=document.createElement("i");s.classList.add("fa"),s.classList.add("fa-check"),s.classList.add("drebizg"),s.classList.add("falseCheck"),t.appendChild(s);const i=document.createElement("div");i.classList.add("litrazhParams"),i.textContent=e.param,t.appendChild(i);const a=document.createElement("div");a.classList.add("dutParams"),a.textContent=e.dut,t.appendChild(a),t.addEventListener("click",this.toggleColor.bind(this,t))}))}toggleColor(e){e.children[0].classList.toggle("falseCheck")}filterOil(){const e=[...this.lists.children].filter((e=>e.children[1].textContent.startsWith("oil")&&e.children[1].textContent.length<=4&&""!==e.children[2].textContent));this.oils=e.map((e=>({param:e.children[1].textContent,dut:e.children[2].textContent})))}ok(){const e=[...this.container.querySelectorAll(".rowOil")].filter((e=>!e.children[0].classList.contains("falseCheck"))).map((e=>({idw:this.id,param:e.children[1].textContent,dut:e.children[2].textContent})));this.setSummator(e),0!==e.length?this.colorSummator("green","ON"):this.colorSummator("rgba(6, 28, 71, 1)","OFF"),this.clos()}colorSummator(e,t){const s=this.element.closest(".item_stor").children[2];this.element.style.color=`${e}`,s.style.color=`${e}`,s.textContent=`${t}`}clos(){this.container.style.display="none"}async setSummator(e){const t=this.id,s={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({data:e,idw:t})},i=await fetch("/api/setSummator",s);await i.json()}initEventListeners(){this.close.addEventListener("click",this.boundClose),this.save.addEventListener("click",this.boundOk)}removeEventListeners(){this.close.removeEventListener("click",this.boundClose),this.save.removeEventListener("click",this.boundOk)}reinitialize(e,t,s,i){this.removeEventListeners(),this.id=e,this.params=s,this.lists=i,this.element=t,this.init(),this.initEventListeners()}}class Tt{constructor(e,t,s,i,a){this.id=e,this.port=t,this.imei=s,this.dat=i,this.idBitrix=a,this.activeClassTarir=null,this.element=document.querySelector(".search_input_meta"),this.storageMeta=[{id:1,sensor:"Скорость",parametr:"speed"},{id:2,sensor:"Курс",parametr:"course"},{id:3,sensor:"Спутники",parametr:"sats"},{id:4,sensor:"Широта",parametr:"lat"},{id:5,sensor:"Долгота",parametr:"lon"},{id:6,sensor:"Время посл. сообщения",parametr:"last_valid_time"},{id:7,sensor:"Зажигание",parametr:"engine"},{id:8,sensor:"Бортовое питание",parametr:"pwr"},{id:9,sensor:"Топливо",parametr:"oil"},{id:10,sensor:"t° топлива в баке",parametr:"oiltemp"},{id:11,sensor:"Топливо 2",parametr:"oil2"},{id:12,sensor:"t° топлива в баке 2",parametr:"oiltemp2"},{id:13,sensor:"Топливо 3",parametr:"oil3"},{id:14,sensor:"t° топлива в баке 3",parametr:"oiltemp3"},{id:15,sensor:"Сумматор",parametr:"summatorOil"},{id:16,sensor:"Подъём кузова",parametr:"lift"},{id:17,sensor:"Обороты двигателя",parametr:"engine_rpm"},{id:18,sensor:"t° охлаждающей жидкости",parametr:"engine_coolant_temp"},{id:19,sensor:"Пробег",parametr:"mileage"},{id:20,sensor:"% нагрузки двигателя",parametr:"engine_load"},{id:21,sensor:"Рулевое левое",parametr:"tpms_pressure_2"},{id:22,sensor:"Рулевое правое",parametr:"tpms_pressure_1"},{id:23,sensor:"Тягач Ведущее Лев Внеш",parametr:"tpms_pressure_6"},{id:24,sensor:"Тягач Ведущее Лев Внут",parametr:"tpms_pressure_5"},{id:25,sensor:"Тягач Ведущее Прав Внут",parametr:"tpms_pressure_4"},{id:26,sensor:"Тягач Ведущее Прав Внеш",parametr:"tpms_pressure_3"},{id:27,sensor:"3 Ось Лев Внеш",parametr:"tpms_pressure_10"},{id:28,sensor:"3 Ось Лев Внут",parametr:"tpms_pressure_9"},{id:29,sensor:"3 Ось Прав Внут",parametr:"tpms_pressure_8"},{id:30,sensor:"3 Ось Прав Внеш",parametr:"tpms_pressure_7"},{id:31,sensor:"4 Ось Лев Внеш",parametr:"tpms_pressure_36"},{id:32,sensor:"4 Ось Лев Внут",parametr:"tpms_pressure_35"},{id:33,sensor:"4 Ось Прав Внут",parametr:"tpms_pressure_34"},{id:34,sensor:"4 Ось Прав Внеш",parametr:"tpms_pressure_33"},{id:35,sensor:"Прицеп 1 Ось Л",parametr:"tpms_pressure_40"},{id:36,sensor:"Прицеп 1 Ось П",parametr:"tpms_pressure_37"},{id:37,sensor:"Прицеп 2 Ось Л",parametr:"tpms_pressure_44"},{id:38,sensor:"Прицеп 2 Ось П",parametr:"tpms_pressure_41"},{id:39,sensor:"Прицеп 3 Ось Л",parametr:"tpms_pressure_39"},{id:40,sensor:"Прицеп 3 Ось П",parametr:"tpms_pressure_38"},{id:41,sensor:"t° Рулевое левое",parametr:"tpms_temp_2"},{id:42,sensor:"t° Рулевое правое",parametr:"tpms_temp_1"},{id:43,sensor:"t° Тягач Ведущее Лев Внеш",parametr:"tpms_temp_6"},{id:44,sensor:"t° Тягач Ведущее Лев Внут",parametr:"tpms_temp_5"},{id:45,sensor:"t° Тягач Ведущее Прав Внут",parametr:"tpms_temp_4"},{id:46,sensor:"t° Тягач Ведущее Прав Внеш",parametr:"tpms_temp_3"},{id:47,sensor:"t° 3 Ось Лев Внеш",parametr:"tpms_temp_10"},{id:48,sensor:"t° 3 Ось Лев Внут",parametr:"tpms_temp_9"},{id:49,sensor:"t° 3 Ось Прав Внут",parametr:"tpms_temp_8"},{id:50,sensor:"t° 3 Ось Прав Внеш",parametr:"tpms_temp_7"},{id:51,sensor:"t° 4 Ось Лев Внеш",parametr:"tpms_temp_36"},{id:52,sensor:"t° 4 Ось Лев Внут",parametr:"tpms_temp_35"},{id:53,sensor:"t° 4 Ось Прав Внут",parametr:"tpms_temp_34"},{id:54,sensor:"t° 4 Ось Прав Внеш",parametr:"tpms_temp_33"},{id:55,sensor:"t° Прицеп 1 Ось Л",parametr:"tpms_temp_40"},{id:56,sensor:"t° Прицеп 1 Ось П",parametr:"tpms_temp_37"},{id:57,sensor:"t° Прицеп 2 Ось Л",parametr:"tpms_temp_44"},{id:58,sensor:"t° Прицеп 2 Ось П",parametr:"tpms_temp_41"},{id:59,sensor:"t° Прицеп 3 Ось Л",parametr:"tpms_temp_39"},{id:60,sensor:"t° Прицеп 3 Ось П",parametr:"tpms_temp_38"},{id:61,sensor:"Моточасы",parametr:"engine_hours"},{id:62,sensor:"Колесо",parametr:"tpms_pressure_17"},{id:63,sensor:"Колесо",parametr:"tpms_pressure_20"},{id:64,sensor:"t° Колесо",parametr:"tpms_temp_17"},{id:65,sensor:"t° Колесо",parametr:"tpms_temp_20"},{id:66,sensor:"Топливо 4",parametr:"oil4"},{id:67,sensor:"t° топлива в баке 4",parametr:"oiltemp4"},{id:68,sensor:"Топливо 5",parametr:"oil5"},{id:69,sensor:"t° топлива в баке 5",parametr:"oiltemp5"},{id:70,sensor:"Топливо 6",parametr:"oil6"},{id:71,sensor:"t° топлива в баке 6",parametr:"oiltemp6"}],this.listMeta=document.querySelector(".list_meta"),this.listOldData=document.querySelector(".list_old_data"),this.updateMeta=document.querySelector(".update_meta"),this.clearParams=null,this.itemMeta=null,this.itemStor=null,this.boundUpdate=this.createListMeta.bind(this),this.init(),this.initEventListeners()}reinitialize(e,t,s,i){this.removeEventListeners(),this.id=e,this.port=t,this.imei=s,this.dat=i,this.init(),this.initEventListeners()}initEventListeners(){this.updateMeta.addEventListener("click",this.boundUpdate)}removeEventListeners(){this.updateMeta.removeEventListener("click",this.boundUpdate)}clearMetaParams(e,t){if(t.stopPropagation(),e.classList.contains("clear_params")){this.itemMeta.forEach((t=>{e.previousElementSibling.textContent===t.textContent&&(t.style.borderLeft="none",t.classList.remove("clickMeta"))})),e.previousElementSibling.textContent="";const t=document.querySelectorAll(".wrapper_add_value_fixed");t&&t.forEach((e=>e.style.display="none"));const s=e.parentNode.children[1].textContent;"pwr"===s&&(e.parentNode.children[4].style.color="rgba(6, 28, 71, 1)",this.deleteParams(this.id,s)),"engine"===s&&(e.parentNode.children[4].style.display="none",this.deleteParams(this.id,s)),"summatorOil"===s&&(e.parentNode.children[4].style.color="rgba(6, 28, 71, 1)",e.parentNode.children[2].style.color="rgba(6, 28, 71, 1)",e.parentNode.children[2].textContent="OFF",this.setSummator([]))}}async setSummator(e){const t=this.id,s={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({data:e,idw:t})},i=await fetch("/api/setSummator",s);await i.json()}async deleteParams(e,t){const s={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:e,param:t})},i=await fetch("/api/deleteParams",s);await i.json()}async init(){this.createListParams(),await this.createListMeta()}async createListMeta(){const e=["engine_hours","can_engine_hours","mileage","can_mileage","inter_mileage","pwr_int","rs485fuel_level","rs485fuel_temp","rs485fuel_level1","rs485fuel_temp1","rs485fuel_level2","rs485fuel_temp2"],t=await this.getMetaParams();if(0===t.length)return;const s=Object.entries(t[0]).filter((e=>"nameCar"!==e[0]&&"imei"!==e[0]&&"id"!==e[0]&&"port"!==e[0]&&"idObject"!==e[0])),i=document.querySelectorAll(".item_meta");i&&i.forEach((e=>e.remove())),s.sort(((e,t)=>e[0].localeCompare(t[0]))),s.forEach((t=>{const s=document.createElement("li");s.classList.add("item_meta"),this.listOldData.appendChild(s);const i=document.createElement("div");i.classList.add("item_meta_name"),i.textContent=t[0],s.appendChild(i);const a=document.createElement("div");a.classList.add("item_meta_value"),a.textContent=void 0===t[1]||"-348201.4"===t[1]?"-Н/Д":e.includes(t[0])?` :${parseFloat(Number(t[1]).toFixed(2))}`:` :${t[1]}`,s.appendChild(a)})),new Et(this.element),this.itemMeta=[...document.querySelectorAll(".item_meta")],this.itemMeta.forEach((e=>{e.addEventListener("click",this.metaToggle.bind(this,e))})),this.controllFlashBorder()}controllFlashBorder(){this.dat&&(console.log(this.dat),this.itemStor.forEach((e=>{const t=this.dat.find((t=>t.params===e.children[1].textContent));t&&(e.children[2].textContent=t.meta,e.children[0].value=t.sens,e.children[0].style.color="gray","pwr"!=t.params&&"engine"!=t.params&&"mileage"!=t.params||("pwr_ext"==t.meta||"mileage"==t.meta||"adc3"==t.meta?e.children[4].style.display="block":e.children[4].style.display="none"))})));const e=this.itemStor.filter((e=>e.children[2].textContent)).map((e=>e.children[2].textContent)),t=document.querySelector(".clickStor");this.itemMeta.forEach((s=>{s.style.borderLeft="none",e.includes(s.children[0].textContent)&&s.children[0].classList.add("clickMeta"),t&&t.children[2].textContent===s.children[0].textContent&&(s.style.borderLeft="5px solid green")}))}async setToBaseSensStorMeta(){const e=document.querySelectorAll(".log")[1].textContent,t=(this.id,this.itemStor.filter((e=>e.children[2].textContent)).map((t=>({id:this.id,port:this.port,sens:t.children[0].value?t.children[0].value:t.children[0].placeholder,params:t.children[1].textContent,meta:t.children[2].textContent,value:null,status:null,time:Math.floor((new Date).getTime()/1e3),login:e,data:null,imei:this.imei,idBitrix:this.idBitrix})))),s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:t})},i=await fetch("api/setSensStorMeta",s);return await i.json()}async getMetaParams(){const e=this.id,t=this.port,s=this.imei,i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idw:e,port:t,imei:s})},a=await fetch("api/getMetas",i);return await a.json()}createListParams(){const e=document.querySelectorAll(".item_stor");e&&e.forEach((e=>e.remove())),this.storageMeta.forEach((async e=>{const t=document.createElement("li");t.classList.add("item_stor"),this.listMeta.appendChild(t);const s=document.createElement("input");s.classList.add("sensor_stor"),s.style.color="gray",s.value=e.sensor,s.setAttribute("contenteditable","true"),t.appendChild(s);const i=document.createElement("div");i.classList.add("param_stor"),i.textContent=e.parametr,t.appendChild(i);const a=document.createElement("div");if(a.classList.add("param_meta"),t.appendChild(a),e.id<7)a.textContent=e.parametr;else{const s=document.createElement("i");if(s.classList.add("fas"),s.classList.add("fa-times"),s.classList.add("clear_params"),t.appendChild(s),["pwr","engine","mileage"].includes(e.parametr)){let s=await this.getValueToBase(t);s=s?s[0].value:"";const i=this.createIcon(t,e.parametr);i.style.display="none",""!==s&&(i.style.color="green"),i.addEventListener("click",this.addValueFixed.bind(this,i,s))}if(e.parametr.startsWith("oil")&&e.parametr.length<=4){const s=this.createIcon(t,e.parametr),i=await this.validColorIcon(e.parametr);s.style.color=i?"green":null,s.addEventListener("click",this.createTarir.bind(this,s,e.parametr))}if("summatorOil"===e.parametr){const s=this.createIcon(t,e.parametr);a.textContent="OFF",await this.validColorIconSummator()?(s.style.color="green",this.colorSummator("green","ON",s)):this.colorSummator("rgba(6, 28, 71, 1)","OFF",s),s.addEventListener("click",this.createSummatorOil.bind(this,s,e.parametr))}}})),this.itemStor=[...document.querySelectorAll(".item_stor")],this.clearParams=[...document.querySelectorAll(".clear_params")],this.itemStor.forEach((e=>{e.addEventListener("click",this.storToggle.bind(this,e))})),this.clearParams.forEach((e=>e.addEventListener("click",this.clearMetaParams.bind(this,e))))}colorSummator(e,t,s){const i=s.closest(".item_stor").children[2];this.element.style.color=`${e}`,i.style.color=`${e}`,i.textContent=`${t}`}createIcon(e,t){const s=document.createElement("i");return s.classList.add("fas"),s.classList.add("fa-info-circle"),s.classList.add(`add_${t}`),e.appendChild(s),s}async validColorIcon(e){const t=this.id,s={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:t,param:e})},i=await fetch("api/getTarirTable",s);return 0!==(await i.json()).length}async validColorIconSummator(){const e=this.id,t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:e})},s=await fetch("/api/getSummator",t);return 0!==(await s.json()).length}createSummatorOil(e){this.activeClassSummator?this.activeClassSummator.reinitialize(this.id,e,this.dat,this.listMeta):this.activeClassSummator=new xt(this.id,e,this.dat,this.listMeta)}createTarir(e,t){this.activeClassTarir?this.activeClassTarir.reinitialize(this.id,e,t):this.activeClassTarir=new Lt(this.id,e,t)}async getValueToBase(e){const t=e.children[1].textContent,s=this.id,i={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:s,param:t})},a=await fetch("api/getValuePWR",i);return await a.json()}async addValueFixed(e,t,s){s.stopPropagation();const i=document.querySelectorAll(".wrapper_add_value_fixed");i&&i.forEach((e=>e.style.display="none"));const a=e.parentNode.querySelector(".wrapper_add_value_fixed");if(a)a.style.display="flex";else{const s=e.parentNode,i=document.createElement("div");i.classList.add("wrapper_add_value_fixed"),s.appendChild(i);const a=document.createElement("input");a.classList.add("input_add_value_fixed"),a.value=t,i.appendChild(a);const n=document.createElement("i");n.classList.add("fa"),n.classList.add("fa-check"),n.classList.add("save_ok"),i.appendChild(n);const r=document.createElement("i");r.classList.add("fas"),r.classList.add("fa-times"),r.classList.add("save_cancel"),i.appendChild(r),this.validationInput(a),n.addEventListener("click",this.ok.bind(this,n)),r.addEventListener("click",this.cancel.bind(this,r))}}validationInput(e){e.addEventListener("input",(()=>{let t=e.value;t=t.replace(",","."),t=t.replace(/[^0-9.]/g,"");const s=t.indexOf(".");-1!==s&&t.substr(s+1).length>2&&(t=t.substr(0,s+3)),parseFloat(t)<minValue&&(t=String(minValue)),e.value=t}))}ok(e,t){t.stopPropagation();const s=this.id,i=e.parentNode.parentNode.children[1].textContent,a=e.parentNode.children[0].value;e.parentNode.parentNode.children[4].style.color=""!==a?"green":"rgba(6, 28, 71, 1)",this.saveValueToBase(s,i,a),e.parentNode.style.display="none"}cancel(e,t){t.stopPropagation(),e.parentNode.style.display="none"}async saveValueToBase(e,t,s){const i={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:e,params:t,value:s})},a=await fetch("api/saveValuePWR",i);await a.json()}storToggle(e){const t=document.querySelectorAll(".wrapper_add_value_fixed");t&&t.forEach((e=>e.style.display="none")),"pwr_ext"===e.children[2].textContent&&e.querySelector(".wrapper_add_value_fixed")&&(e.querySelector(".wrapper_add_value_fixed").style.display="flex"),"adc3"===e.children[2].textContent&&e.querySelector(".wrapper_add_value_fixed")&&(e.querySelector(".wrapper_add_value_fixed").style.display="flex"),"mileage"===e.children[2].textContent&&e.querySelector(".wrapper_add_value_fixed")&&(e.querySelector(".wrapper_add_value_fixed").style.display="flex");const s=document.querySelector(".clickStor");s&&s.classList.remove("clickStor"),e.classList.add("clickStor")}metaToggle(e){const t=document.querySelectorAll(".wrapper_add_value_fixed");t&&t.forEach((e=>e.style.display="none"));const s=document.querySelector(".clickStor");s&&(!e.classList.contains("clickMeta")&&e.children[0].classList.add("clickMeta"),s.children[2].textContent=e.children[0].textContent,"engine"===s.children[1].textContent&&"pwr_ext"===s.children[2].textContent||"pwr"===s.children[1].textContent&&"pwr_ext"===s.children[2].textContent||"engine"===s.children[1].textContent&&"adc3"===s.children[2].textContent||"pwr"===s.children[1].textContent&&"adc3"===s.children[2].textContent||"mileage"===s.children[1].textContent&&"mileage"===s.children[2].textContent||s.children[1].textContent.startsWith("oil")&&s.children[1].textContent.length<=4?s.children[4].style.display="block":s.children[4]&&(s.children[4].style.display="none"),this.itemMeta.forEach((e=>{e.children[0].classList.remove("clickMeta")})),this.dat=null,this.controllFlashBorder())}}class qt{constructor(e){this.element=e,this.instance=null,this.modal=document.querySelector(".create_object_modal"),this.noValidation=this.modal.querySelector(".validation_message"),this.closes=this.modal.querySelector(".closes"),this.cancel=this.modal.querySelector(".cancel"),this.updateMeta=this.modal.querySelector(".update_meta"),this.ok=this.modal.querySelector(".ok_modal"),this.buttonModal=document.querySelector(".button_modal"),this.navi=document.querySelector(".navi_object"),this.configParams=document.querySelector(".config_params"),this.listModal=document.querySelector(".list_modal"),this.summator=document.querySelector(".container_summ"),this.login=document.querySelectorAll(".log")[1].textContent,this.field_modal=this.modal.querySelectorAll(".field_modal"),this.element.addEventListener("click",this.viewModal.bind(this)),this.closes.addEventListener("click",this.hiddenModal.bind(this)),this.pop=document.querySelector(".popup-background"),this.cancel.addEventListener("click",this.hiddenModal.bind(this)),this.initEvent(),Array.from(this.navi.children).forEach((e=>{e.addEventListener("click",this.toogleModal.bind(this))})),this.idPref=null,this.id=null,this.object}initEvent(){this.ent=this.enter.bind(this),this.ok.addEventListener("click",this.ent)}destroy(){this.ok.removeEventListener("click",this.ent)}toogleModal(e){e.stopPropagation(),Array.from(this.navi.children).forEach((e=>e.classList.remove("toogleModalNavi"))),e.target.classList.add("toogleModalNavi"),e.target.classList.contains("title_configurator")?(this.listModal.style.display="none",this.configParams.style.display="flex",!this.id&&!this.idPref||(this.updateMeta.style.display="block")):(this.listModal.style.display="block",this.configParams.style.display="none",this.updateMeta.style.display="none")}async enter(){if(console.log("ентер"),"flex"!==this.summator.style.display)if(document.querySelector(".toogleModalNavi").classList.contains("title_configurator")){console.log("сохраняем");const e=await this.instance.setToBaseSensStorMeta();this.handleValidationResult(e,"green","bold"),Pt.startClass(this.object.id)}else{console.log(this.instance);const e=await this.generationId(this.login),t=Math.floor((new Date).getTime()/1e3),s={login:this.login,data:t,idObject:this.idPref?this.idPref:e,idg:"idg",name_g:"Объекты",nameObject:null,typeObject:null,typeDevice:null,port:null,adress:null,imei:null,number:null,marka:null,model:null,vin:null,gosnomer:null,dut:null,angle:null,idBitrix:null};if(this.id=s.idObject,Array.from(this.field_modal).forEach((e=>{s[e.getAttribute("rel")]=e.value})),console.log(this.idPref),!await this.validation(s))return;{console.log(s);const e=this.idPref?await this.updateObject(s):await this.saveObject(s);this.handleValidationResult(e,"green","bold"),!this.idPref&&Pt.startClass(String(s.idObject))}}else this.handleValidationResult("Закройте Сумматор","red","bold")}async validation(e){const t=Array.from(this.field_modal).filter(((e,t)=>0===t||t>1&&t<5)).filter((e=>""===e.value));if(0!==t.length)return this.handleValidationResult("Заполните обязательные поля","red","bold",t),!1;{const t=Array.from(this.field_modal)[6],s=/^\+[7]\d{10}$/;if(""===t.value||s.test(t.value)){const s=[{col:"nameObject",value:e.nameObject},{col:"imei",value:e.imei},{col:"phone",value:e.number}],i="object_table",a=s.map((t=>this.uniqImeiAndPhone(t.col,t.value,i,e.idObject))),n=(await Promise.all(a)).flat().filter((e=>0!==e.length));if(0!==n.length){const e=Array.from(this.field_modal)[5],s=Array.from(this.field_modal)[0];return console.log(n),this.checkDuplicates(n,e,s,t),!1}return!0}return this.handleValidationResult("Не валидный номер телефона","red","bold",[t]),!1}}checkDuplicates=(e,t,s,i)=>{const a=e.map((e=>e.matched_column));a.includes("number")&&a.includes("imei")&&a.includes("nameObject")&&this.handleValidationResult("Такой номер, id устройства и имя объекта уже существуют","red","bold",[t,i,s]),a.includes("number")&&a.includes("imei")&&this.handleValidationResult("Такой номер и id устройства уже существуют","red","bold",[t,i]),a.includes("number")&&a.includes("nameObject")&&this.handleValidationResult("Такой номер и имя объекта уже существуют","red","bold",[i,s]),a.includes("imei")&&a.includes("nameObject")&&this.handleValidationResult("Такой id устройства и имя объекта уже существуют","red","bold",[t,s]),a.includes("number")&&this.handleValidationResult("Такой номер уже существует","red","bold",[i]),a.includes("imei")&&this.handleValidationResult("Такой id устройства уже существует","red","bold",[t]),a.includes("nameObject")&&this.handleValidationResult("Такое имя объекта уже существует","red","bold",[s])};async uniqImeiAndPhone(e,t,s,i){const a=this.login;console.log(e,t,s,a);const n={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({col:e,value:t,table:s,login:a,id:i})},r=await fetch("/api/uniqImeiAndPhone",n);let l=await r.json();return console.log(l),l}handleValidationResult(e,t,s,i){this.noValidation.textContent=e,this.noValidation.style.color=t,this.noValidation.style.fontWeight=s,i?i.forEach((e=>{e.style.border="1px solid red",setTimeout((()=>{this.noValidation.textContent="",e.style.border="none"}),4e3)})):setTimeout((()=>{this.noValidation.textContent=""}),4e3)}async saveObject(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({object:e})};return(await fetch("/api/saveObject",t)).json()}async updateObject(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({object:e})};return(await fetch("/api/updateObject",t)).json()}async generationId(){const e=await fetch("/api/lastIdObject",{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json();return console.log(t),0===t.length?1e3:Number(t[0].idObject)+1}viewModal(){if(console.log(this.element),this.idPref=null,!this.element.classList.contains("gr")){const e=document.querySelectorAll(".item_meta");e&&e.forEach((e=>e.remove()));const t=document.querySelectorAll(".item_stor");t&&t.forEach((e=>e.remove())),this.pop.style.display="block",this.modal.style.display="flex",this.modal.style.zIndex=2,Array.from(this.navi.children).forEach((e=>e.classList.remove("toogleModalNavi"))),Array.from(this.navi.children)[0].classList.add("toogleModalNavi")}}async viewObjects(e){this.object=e.parentElement.parentElement;const t=e.parentElement.parentElement.id,s=e.parentElement.parentElement;if(this.modal.querySelector(".title_modales").textContent="Объект",!this.element.classList.contains("gr")){console.time("11");const e={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({idw:t})},i=fetch("/api/objectsId",e).then((e=>e.json())),a=fetch("/api/getSensStorMeta",e).then((e=>e.json())),[n,r]=await Promise.all([i,a]);console.log(n);const l=[s.children[0].textContent,n[0].typeObject,n[0].typeDevice,n[0].port,n[0].adress,n[0].imei,n[0].phone,n[0].marka,n[0].model,n[0].vin,n[0].gosnomer,n[0].dut,n[0].angle,n[0].id_bitrix];this.idPref=t,console.timeEnd("11"),this.instance?this.instance.reinitialize(this.idPref,"wialon",n[0].imei,r,n[0].id_bitrix):this.instance=new Tt(this.idPref,"wialon",n[0].imei,r,n[0].id_bitrix),l.forEach(((e,t)=>{this.field_modal[t].value=e||"-"})),document.querySelector(".metaObject").textContent=`${l[0]} (${l[1]?l[1]:"-"} : ${l[3]?l[3]:"-"})`,this.pop.style.display="block",this.modal.style.display="flex",this.modal.style.zIndex=2,Array.from(this.navi.children).forEach((e=>e.classList.remove("toogleModalNavi"))),Array.from(this.navi.children)[0].classList.add("toogleModalNavi")}}hiddenModal(){"flex"!==this.summator.style.display?(this.object&&(this.instance.itemMeta&&this.instance.itemMeta.forEach((e=>e.remove())),this.instance.itemStor&&this.instance.itemStor.forEach((e=>e.remove()))),this.object=null,this.modal.querySelector(".title_modales").textContent="Объект",this.pop.style.display="none",this.modal.style.display="none",this.modal.style.zIndex=0,this.field_modal.forEach((e=>{e.value=""})),document.querySelector(".metaObject").textContent="",this.listModal.style.display="block",this.configParams.style.display="none",this.updateMeta.style.display="none",this.id=null):this.handleValidationResult("Закройте Сумматор","red","bold")}}class At{constructor(e,t,s){this.nameCar=t,this.element=e,this.data=s,this.modal=document.querySelector(".create_group_modal"),this.noValidation=this.modal.querySelector(".validation_message"),this.objectsList=document.querySelector(".objects_list"),this.podGroup=document.querySelector(".pod_group"),this.sostavGroup=document.querySelector(".sostav_group"),this.items=null,this.choiceObject=null,this.closes=this.modal.querySelector(".closes_gr"),this.cancel=this.modal.querySelector(".cancel_gr"),this.ok=this.modal.querySelector(".ok_modal_gr"),this.login=document.querySelectorAll(".log")[1].textContent,this.field_modal=this.modal.querySelectorAll(".field_modal"),this.add=document.querySelector(".add"),this.remove=document.querySelector(".remove"),this.element.addEventListener("click",this.viewModal.bind(this)),this.closes.addEventListener("click",this.hiddenModal.bind(this)),this.pop=document.querySelector(".popup-background"),this.cancel.addEventListener("click",this.hiddenModal.bind(this)),this.initEvent()}initEvent(){this.ent=this.enter.bind(this),this.adds=this.movingForvard.bind(this),this.removes=this.movingBack.bind(this),this.ok.addEventListener("click",this.ent),this.add.addEventListener("click",this.adds),this.remove.addEventListener("click",this.removes)}destroy(){this.ok.removeEventListener("click",this.ent),this.add.removeEventListener("click",this.adds),this.remove.removeEventListener("click",this.removes)}async enter(){console.log("эдишон!");const e=this.field_modal[0].getAttribute("rel");if("group"===this.field_modal[0].getAttribute("rel")){await this.edition(e),console.log("логика записи редактирования");const t=document.querySelector(".mores"),s=document.querySelector(".ones");t.classList.remove("toggle_list"),s.classList.remove("toggle_list"),s.classList.add("toggle_list");const i=document.querySelector(".create_object"),a=document.querySelector(".list_item1");i.classList.remove("gr"),new g(i,["Добавить новый объект"]),a.lastElementChild.textContent="Список объектов",Pt.startClass(this.login)}else{const e=await this.generationId(),t=Math.floor((new Date).getTime()/1e3),s={login:this.login,data:t,idg:e,name_g:this.field_modal[0].value,face:this.field_modal[1].value,contact:this.field_modal[2].value,arrayObjects:[]};if(Array.from(this.sostavGroup.children).forEach((e=>{s.arrayObjects.push({idObject:e.getAttribute("rel"),nameObject:e.textContent})})),!await this.validation(e,this.field_modal))return;{console.log(s),await this.setGroup(s),this.pop.style.display="none",this.modal.style.display="none",this.modal.style.zIndex=0,this.field_modal.forEach((e=>e.value="")),Pt.startClass(this.login);const e=document.querySelector(".mores"),t=document.querySelector(".ones");e.classList.remove("toggle_list"),t.classList.remove("toggle_list"),t.classList.add("toggle_list");const i=document.querySelector(".create_object"),a=document.querySelector(".list_item1");new g(i,["Добавить новый объект"]),console.log(a.lastElementChild),a.lastElementChild.textContent="Список объектов",i.classList.remove("gr")}}this.field_modal[0].setAttribute("rel","t")}async edition(){const e=this.field_modal.id,t=Math.floor((new Date).getTime()/1e3),s={login:this.login,data:t,idg:this.field_modal[0].id,name_g:this.field_modal[0].value,face:this.field_modal[1].value,contact:this.field_modal[2].value,arrayObjects:[]};Array.from(this.sostavGroup.children).forEach((e=>{s.arrayObjects.push(JSON.parse(e.getAttribute("data")))})),await this.validation(e,this.field_modal)&&(await this.updateGroup(s),this.pop.style.display="none",this.modal.style.display="none",this.modal.style.zIndex=0,this.field_modal.forEach((e=>e.value="")),Pt.startClass(this.login))}async updateGroup(e){console.log(e);const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({object:e})},s=await fetch("/api/updateGroup",t);return await s.json()}async setGroup(e){console.log(e);const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({object:e})};(await fetch("/api/setGroup",t)).json()}async generationId(){const e=await fetch("/api/lastIdGroup",{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json(),s=0===t.length?1e3:Number(t[0].idg)+1;return console.log(s),s}async getIdGroup(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:e})},s=await fetch("/api/getIdGroup",t);return await s.json()}async validation(e,t){const s=t[2].value;if(console.log(s),""!==s&&!/^\+[7]\d{10}$/.test(s))return this.handleValidationResult("Не валидный номер телефона","red","bold",[t[2]]),!1;if(""===this.field_modal[0].value)return this.handleValidationResult("Укажите название группы","red","bold",[t[0]]),!1;if(0===this.sostavGroup.children.length)return this.handleValidationResult("Добавьте объекты или подгруппы","red","bold",[this.sostavGroup]),!1;if(0!==(await this.validationCloneGroupName(e,t[0].value)).filter((t=>{if(t.idg!==e&&t.id_sub_g!==e)return t})).length){const e=t[0];return this.handleValidationResult("Такое имя группы уже существует","red","bold",[e]),!1}return!0}async validationCloneGroupName(e,t){const s=this.login,i={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:e,name:t,login:s})},a=await fetch("/api/validationCloneGroupName",i);return await a.json()}async uniqImeiAndPhone(e,t,s){const i=this.login,a={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({col:e,value:t,table:s,login:i})},n=await fetch("/api/uniqImeiAndPhone",a);return await n.json()}async viewModal(){this.modal.querySelector(".title_modales").textContent="t"!==this.field_modal[0].getAttribute("rel")?"Редактирование группы":"Новая группа";const e=document.querySelectorAll(".item_middle");e&&e.forEach((e=>e.remove())),this.element.classList.contains("gr")&&(this.addObjectsToList(),this.pop.style.display="block",this.modal.style.display="flex",this.modal.style.zIndex=2,this.items=document.querySelectorAll(".item_middle"),this.items.forEach((e=>e.addEventListener("click",this.activeObject.bind(this,e)))))}hiddenModal(){this.pop.style.display="none",this.modal.style.display="none",this.modal.style.zIndex=0,this.field_modal.forEach((e=>e.value="")),this.field_modal[0].setAttribute("rel","t")}addObjectsToList(){Array.from(new Map(this.data.flat().map((e=>[e[4],e]))).values()).forEach((e=>{this.objectsList.innerHTML+=`<li class="item_middle object_item" data='${JSON.stringify(e[6])}' rel="${e[4]}">${e[0].message}</li>`}))}activeObject(e){this.items.forEach((e=>{e.classList.remove("choice_object")})),e.classList.add("choice_object"),this.choiceObject=e}movingForvard(){this.addListNewGroup(this.choiceObject),this.choiceObject.classList.remove("choice_object"),this.choiceObject=null}movingBack(){this.choiceObject.classList.contains("object_item")?this.deleteListNewGroupToListObjects(this.choiceObject):this.deleteListNewGroupToListGroups(this.choiceObject),this.choiceObject.classList.remove("choice_object"),this.choiceObject=null}addListNewGroup(e){console.log(e),this.sostavGroup.appendChild(e)}deleteListNewGroupToListObjects(e){this.objectsList.appendChild(e)}deleteListNewGroupToListGroups(e){this.podGroup.appendChild(e)}handleValidationResult(e,t,s,i){this.noValidation.textContent=e,this.noValidation.style.color=t,this.noValidation.style.fontWeight=s,console.log(i),i.forEach((e=>{e.style.border="1px solid red",setTimeout((()=>{this.noValidation.textContent="",e.style.border="none"}),3e3)}))}}class Ot{static fomraSetting(){return'<div class="container_index">\n        <div class="header_index">Панель администратора<i class="fas fa fa-times close_modal_window"></i></div>\n        <div class="body_index">\n        <div class="navi_setting">\n        <div class="type_navi" rel="Создать учетную запись" data-att="0">Учетные записи<i class="fas fa-angle-down srows"></i></div>\n           <div class="type_navi" rel="Создать пользователя" data-att="1">Пользователи<i class="fas fa-angle-down srows"></i></div>\n              <div class="type_navi" rel="Создать объект" data-att="2">Объекты<i class="fas fa-angle-down srows"></i></div>\n                 <div class="type_navi" rel="Создать группу" data-att="3">Группы объектов<i class="fas fa-angle-down srows"></i></div>\n                    <div class="type_navi" rel="Создать тарифный пан"data-att="4">Тарифные планы<i class="fas fa-angle-down srows"></i></div>\n                       <div class="type_navi" rel="Создать ретранслятор" data-att="5">Ретрансляторы<i class="fas fa-angle-down srows"></i></div>\n        </div>\n         <div class="table_setting">\n         <div class="table_data_info"></div>\n               <div class="magazin_stor"></div>\n         </div>\n        </div>\n                </div>'}static createFindAndButton(e,t){return`<div class="wrap_settings">\n        <div class="moved"><span class="title_moved mov">Действие</span><div class="button_setting" rel="${t}">${e}</div></div>\n            <div class="moved"><span class="title_moved fin">Поиск</span><div class="search_list inputs_setting">\n                     <select class="select_index_filter">\n <option value="" disabled selected>Фильтр</option>\n                        <option value="1">Имя</option>\n                        <option value="2">Объект</option>\n                        <option value="3">Группа</option>\n                    </select>\n                        <input class="search_input set find_input" placeholder="Поиск">\n                    </div>\n                    <div class="button_setting">Поиск</div>\n                    </div>\n        </div>`}static createLK(e,t,s,i){return`<div class="wrap_lk">\n        <div class="header_index">Новая учетная запись<i class="fas fa fa-times close_modal_window"></i></div>\n  <div class="body_indexs">\n<div class="row_index"><div class="text_index">Имя учетной записи</div><input class="input_index" id="uzname"></div>\n<div class="row_index"><div class="text_index">Тарифный план</div><select class="select_index tp">\n <option value="" disabled selected></option>\n                        <option value="1">ТП1</option>\n                        <option value="2">ТП2</option>\n                        <option value="3">ТП3</option>\n                    </select></div>\n<div class="row_index"><div class="text_low">Создатель</div><select class="select_index creates">\n                       <option value="${s}" data-att="${t}">${e}</option>\n                    ${void 0!==i?[...i].map((e=>`<option value="${e.incriment}" rel='${e.idx}' data-att="${e.role}"'>${e.name}</option>`)).join(""):""}\n                    </select>\n</div ></div>\n<div class="footer_index">\n<div class="valid_message"></div>\n  <div class="button_setting bnt_set">Сохранить</div></div>\n                </div>`}static createUser(e,t,s,i,a){return console.log(e,t,s,i,a),`<div class="wrap_lk wrap_user">\n        <div class="header_index">Новый пользователь<i class="fas fa fa-times close_modal_window"></i></div>\n          <div class="body_indexs">\n<div class="row_index"><div class="text_index">Имя пользователя</div><input class="input_index" id="username"></div>\n<div class="row_index"><div class="text_index">Пароль пользователя</div><input class="input_index" id="password" type="password"></div>\n<div class="row_index"><div class="text_index">Подтвердите пароль</div><input class="input_index" id="confirm_password" type="password"></div>\n<div class="row_index"><div class="text_index">Права доступа</div><select class="select_index roles">\n<option value="" disabled selected></option>\n                                              <option value="Курсор">Курсор</option>\n                        <option value="Интегратор">Интегратор</option>\n                         <option value="Сервис-инженер">Сервис-инженер</option>\n                          <option value="Администратор">Администратор</option>\n                             <option value="Пользователь">Пользователь</option>\n                    </select></div>\n<div class="row_index"><div class="text_low">Создатель</div><select class="select_index creates">\n                        <option value="${s}" data-att="${t}">${e}</option>\n                    ${void 0!==i?[...i].map((e=>`<option value="${e.incriment}" rel='${e.idx}' data-att="${e.role}"'>${e.name}</option>`)).join(""):""}\n                    </select></div>\n<div class="row_index" rel="lk"><div class="text_index">Учетная запись</div><select class="select_index uz">\n<option value="" disabled selected></option>\n                    ${void 0!==a?[...a].map((e=>`<option value="${e.incriment}" rel='${e.idx}' data-att="${e.uniqCreater}"'>${e.name}</option>`)).join(""):""}\n                    </select></div></div>\n                    <div class="footer_index">\n<div class="valid_message"></div>\n  <div class="button_setting bnt_set">Сохранить</div></div>\n                </div>`}static createObj(){return'<div class="wrap_lk wrap_user">\n        <div class="header_index">Новый объект<i class="fas fa fa-times close_modal_window"></i></div>\n          <div class="body_indexs"></div>\n            <div class="footer_index">\n<div class="valid_message"></div>\n  <div class="button_setting bnt_set">Сохранить</div></div>\n                </div>'}static createGroup(){return'<div class="wrap_lk wrap_user">\n        <div class="header_index">Новая группа<i class="fas fa fa-times close_modal_window"></i></div>\n             <div class="body_indexs"></div>\n            <div class="footer_index">\n<div class="valid_message"></div>\n  <div class="button_setting bnt_set">Сохранить</div></div>\n                </div>'}static createPrice(){return'<div class="wrap_lk wrap_user">\n        <div class="header_index">Новый тарифный план<i class="fas fa fa-times close_modal_window"></i></div>\n             <div class="body_indexs"></div>\n            <div class="footer_index">\n<div class="valid_message"></div>\n  <div class="button_setting bnt_set">Сохранить</div></div>\n                </div>'}static createRetro(){return'<div class="wrap_lk wrap_user">\n        <div class="header_index">Новый ретранслятор<i class="fas fa fa-times close_modal_window"></i></div>\n             <div class="body_indexs"></div>\n            <div class="footer_index">\n<div class="valid_message"></div>\n  <div class="button_setting bnt_set">Сохранить</div></div>\n                </div>'}static addTableAccount(){return'<table class="table_stata">\n      <tr class="rows_stata ">\n        <th class="cell_stata cel header_account_table">Имя</th>\n        <th class="cell_stata cel header_account_table">Создатель</th>\n        <th class="cell_stata cel header_account_table">Тарифный план</th>\n        <th class="cell_stata cel header_account_table">Пользователи</th>\n        <th class="cell_stata cel header_account_table">Объекты</th>\n        <th class="cell_stata cel header_account_table">Группы</th>\n        <th class="cell_stata cel header_account_table">Удалить</th>\n      </tr>\n    </table>'}static addTableUser(){return'<table class="table_stata">\n      <tr class="rows_stata">\n        <th class="cell_stata cel header_account_table">Имя</th>\n        <th class="cell_stata cel header_account_table">Создатель</th>\n        <th class="cell_stata cel header_account_table">Учетная запись</th>\n        <th class="cell_stata cel header_account_table">Тарифный план</th>\n        <th class="cell_stata cel header_account_table">Права</th>\n             <th class="cell_stata cel header_account_table">Удалить</th>\n      </tr>\n    </table>'}}class jt{static viewRemark(e,t,s){console.log(e,t,s),e.textContent=s,e.style.color=t,setTimeout((()=>e.textContent=""),5e3)}}class Mt{static updateUZRowVisibility(e,t){e.addEventListener("change",(()=>{let s=!1;const i=e.value;console.log(i),"Курсор"!==i&&"Интегратор"!==i&&"Сервис-инженер"!==i||(s=!0),t.style.display=s?"none":"flex",console.log(t.children[0]),t.children[1].selectedIndex=-1}))}static checkPasswords(e,t,s){t.addEventListener("input",(()=>{const s=e.value,i=t.value;t.style.border=s!==i?"1px solid red":"1px solid green"})),e.addEventListener("input",(()=>{const s=e.value,i=t.value;t.style.border=s!==i?"1px solid red":"1px solid green"}))}static filterRole(e,t,s,i){console.log(i);const a=e.options,n=i.options;function r(e){for(let t=0;t<a.length;t++)e.includes(a[t].value)&&a[t].setAttribute("disabled","disabled")}"Интегратор"===t?r(["Интегратор","Курсор"]):"Сервис-инженер"===t&&r(["Интегратор","Курсор","Сервис-инженер"]),s.addEventListener("change",(function(t){e.selectedIndex=-1,i.selectedIndex=-1;for(let e=0;e<a.length;e++)a[e].removeAttribute("disabled");for(let e=0;e<a.length;e++)n[e].style.display="block";const r=this.options[this.selectedIndex].getAttribute("data-att"),l=this.options[this.selectedIndex].value;Mt.filterAccount(l,i,r),Mt.filterRole(e,r,s,i)}))}static filterAccount(e,t,s){if(console.log(e,t,s),"Курсор"===s)return;const i=t.options;console.log(i);for(let t=0;t<i.length;t++)e!==i[t].getAttribute("data-att")&&(i[t].style.display="none")}}class Nt{static async findId(e){const t={idu:"users",ida:"accounts"}[e],s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({table:t})};try{const t=await fetch("/api/findLastIdUser",s),i=await t.json();let a=1;if(i.length>0){const e=i[0].idx;a=parseInt(e.replace(/\D/g,""),10)+1}return console.log(`${a}${e}`),`${a}${e}`}catch(e){return console.error("Error fetching last idx:",e),null}}static async saveUser(e){const{idx:t,login:s,password:i,role:a,uz:n,creater:r}=e;console.log(e);const l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idx:t,login:s,password:i,role:a,uz:n,creater:r})},o=await fetch("/signup",l),c=await o.json();return console.log(c),c}static async saveAccount(e){const{idx:t,name:s,uniqCreater:i,uniqTP:a}=e;console.log(e);const n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idx:t,name:s,uniqCreater:i,uniqTP:a})},r=await fetch("/api/addAccount",n),l=await r.json();return console.log(l),l}static async getUsers(e,t){const s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:e,creater:t})},i=await fetch("/api/getUsers",s);return await i.json()}static async getAccounts(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({creater:e})},s=await fetch("/api/getAccounts",t);return await s.json()}static async getAccountUsers(e){const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({creater:e})},s=await fetch("/api/getAccountUsers",t);return await s.json()}static async getAccountCreater(e){console.log("рек");const t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({creater:e})},s=await fetch("/api/getAccountCreater",t);return await s.json()}static async deleteAccount(e,t){const s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,index:t})},i=await fetch("/api/deleteAccount",s);return await i.json()}}class It{constructor(e,t){console.log(t),this.index=e,this.table=t.querySelector(".table_data_info"),this.creater=document.querySelector(".role").getAttribute("data-att"),this.prava=document.querySelector(".role").getAttribute("rel"),this.init()}init(){this.controller()}controller(){switch(this.index){case"0":this.createTableAccount();break;case"1":this.createTableUser()}}async createTableAccount(){this.table.innerHTML=Ot.addTableAccount(),this.result=await Nt.getAccountCreater(this.creater);const e={};this.result.forEach((t=>{const s=t.incriment[0];t.incriment[1],e[s]?e[s]++:e[s]=1})),this.addContentAccount()}addContentAccount(){const e=this.table.querySelector(".table_stata"),t={};this.result.forEach((e=>{const s=e.incriment[0],i=e.incriment[1];t[s]&&i!==e.uniqCreater?t[s].usersCount++:t[s]={id:e.uniqCreater,role:e.creator_role,creater:e.creater,name:e.name[0],creator_name:e.creator_name,uniqTP:e.uniqTP,usersCount:i!==e.uniqCreater?1:0,incrimentAccount:s}}));Object.values(t).map((e=>[{id:e.id,role:e.role,creater:e.creater,incrimentAccount:e.incrimentAccount},[e.name,e.creator_name,e.uniqTP,e.usersCount,0,0,"x"]])).forEach((t=>{"Курсор"===this.prava?this.addRowToTable(e,t):"Интегратор"===this.prava?t[0].id!==Number(this.creater)&&t[0].creater!==Number(this.creater)||(console.log(t),console.log(t[0].id,t[0].creater,Number(this.creater)),this.addRowToTable(e,t)):t[0].id===Number(this.creater)&&this.addRowToTable(e,t)}))}addRowToTable(e,t){const s=document.createElement("tr");s.classList.add("rows_stata","rows_move_kursor"),s.innerHTML=t[1].map((e=>`<th class="cell_stata cell cell_table_auth">${e}</th>`)).join(""),e.appendChild(s);const i=e.lastElementChild.lastElementChild;this.idDelete="0"===this.index?t[0].incrimentAccount:t[0].id,i.addEventListener("click",this.updateTable.bind(this,this.idDelete))}async updateTable(e){await Nt.deleteAccount(e,this.index),this.init()}async createTableUser(){this.table.innerHTML=Ot.addTableUser(),this.result=await Nt.getAccountUsers(this.creater),this.addContentUsers()}addContentUsers(){const e=this.table.querySelector(".table_stata");console.log(this.result),this.result.map((e=>[{id:e.incriment[1],role:e.role,creater:e.creater,global_creater_incriment:e.global_creater_incriment},[e.name[1],e.creator_name,e.name[0],e.uniqTP,e.role,"x"]])).forEach((t=>{"Курсор"===this.prava?this.addRowToTable(e,t):"Интегратор"===this.prava?t[0].global_creater_incriment!==Number(this.creater)&&t[0].creater!==Number(this.creater)||this.addRowToTable(e,t):t[0].creater===Number(this.creater)&&this.addRowToTable(e,t)}))}}class $t{constructor(e,t,s,i){this.element=e,this.index=e.getAttribute("rel"),this.creater=document.querySelector(".role").getAttribute("data-att"),this.prava=document.querySelector(".role").getAttribute("rel"),this.container=document.querySelector(".wrapper_set"),this.settingWrap=i,this.pop=t,this.login=s,this.init()}async init(){console.log("здесь"),"Курсор"!==this.prava&&"Интегратор"!==this.prava||await this.getUsers(),await this.controll(),this.modal=this.container.querySelector(".wrap_lk"),this.modalActivity(this.pop,"flex",3),this.close()}close(){const e=this.modal.querySelector(".close_modal_window");console.log(e),e.addEventListener("click",this.modalActivity.bind(this,this.pop,"none",1))}async controll(){switch(this.index){case"0":this.controllLK();break;case"1":await this.getAccounts(),this.controllUser();break;case"2":this.container.innerHTML=Ot.createObj();break;case"3":this.container.innerHTML=Ot.createGroup();break;case"4":this.container.innerHTML=Ot.createPrice();break;case"5":this.container.innerHTML=Ot.createRetro()}}controllLK(){this.container.innerHTML=Ot.createLK(this.login,this.prava,this.creater,this.creators),this.uzname=this.container.querySelector("#uzname"),this.tp=this.container.querySelector(".tp"),this.createsUser=this.container.querySelector(".creates"),this.save("ida")}async controllUser(){this.container.innerHTML=Ot.createUser(this.login,this.prava,this.creater,this.creators,this.accounts),this.username=this.container.querySelector("#username"),this.passwordInput=this.container.querySelector("#password"),this.confirmPasswordInput=this.container.querySelector("#confirm_password"),this.uz=this.container.querySelector(".uz"),this.roles=this.container.querySelector(".roles"),this.createsUser=this.container.querySelector(".creates");const e=this.container.querySelector(".uz").parentElement;Mt.filterAccount(this.creater,this.uz,this.prava),Mt.filterRole(this.roles,this.prava,this.createsUser,this.uz),Mt.checkPasswords(this.passwordInput,this.confirmPasswordInput),Mt.updateUZRowVisibility(this.roles,e),this.save("idu")}save(e){const t=this.container.querySelector(".bnt_set");this.mess=this.container.querySelector(".valid_message"),t.addEventListener("click",this.validation.bind(this,e))}async validation(e){switch(e){case"idu":if(""===this.roles.value)return jt.viewRemark(this.mess,"red","Установите права доступа");if(this.passwordInput.value!==this.confirmPasswordInput.value)return jt.viewRemark(this.mess,"red","Не совпадают пароли");if(""===this.passwordInput.value||""===this.confirmPasswordInput.value)return jt.viewRemark(this.mess,"red","Установите пароль");if(""===this.username.value)return jt.viewRemark(this.mess,"red","Укажите имя пользователя");if("none"!==this.uz.parentElement.style.display&&""===this.uz.value)return jt.viewRemark(this.mess,"red","Укажите учетную запись");this.obj={login:this.username.value,password:this.confirmPasswordInput.value,role:this.roles.value,uz:this.uz.value,creater:this.createsUser.value,idx:await Nt.findId(e)};const t=await Nt.saveUser(this.obj);jt.viewRemark(this.mess,t.flag?"green":"red",t.message);break;case"ida":if(""===this.uzname.value)return jt.viewRemark(this.mess,"red","Укажите имя учетной записи");if(""===this.tp.value)return jt.viewRemark(this.mess,"red","Укажите тарифный план");this.obj={idx:await Nt.findId(e),name:this.uzname.value,uniqCreater:this.createsUser.value,uniqTP:this.tp.value};const s=await Nt.saveAccount(this.obj);console.log(s),jt.viewRemark(this.mess,s.flag?"green":"red",s.message);break;case"2":this.container.innerHTML=Ot.createObj();break;case"3":this.container.innerHTML=Ot.createGroup();break;case"4":this.container.innerHTML=Ot.createPrice();break;case"5":this.container.innerHTML=Ot.createRetro()}new It(this.index,this.settingWrap)}modalActivity(e,t,s){this.modal.style.display=`${t}`,e.style.zIndex=s}async getAccounts(){this.accounts=await Nt.getAccounts(this.creater)}async getUsers(){this.creators=await Nt.getUsers(this.prava,this.creater)}}class Dt{constructor(e){this.login=e,this.container=document.querySelector(".setting_container"),this.button=document.querySelector(".global_settings"),this.pop=document.querySelector(".popup-background"),this.boundButton=this.init.bind(this),this.boundButtonClose=this.modalActivity.bind(this,this.container,this.pop,"none"),this.initEvent()}init(){this.modalActivity(this.container,this.pop,"flex"),this.addContent(),this.clickNavi(),this.initClose()}initEvent(){this.button.addEventListener("click",this.boundButton)}initClose(){this.container.querySelector(".close_modal_window").addEventListener("click",this.boundButtonClose)}clickCreateObjects(){console.log(this.buttons),this.buttons[0].addEventListener("click",(e=>new $t(e.target,this.pop,this.login,this.container)))}modalActivity(e,t,s){e.style.display=`${s}`,t.style.display=`${s}`,t.style.zIndex=1}addContent(){this.container.innerHTML=Ot.fomraSetting(),this.type_navi=this.container.querySelectorAll(".type_navi"),this.naviContainer=this.type_navi[0].parentElement}addContainer(e){const t=e.target.children[0],s=e.target,i=s.getAttribute("rel"),a=s.getAttribute("data-att");this.deleteHTML(),console.log(a),this.controllStows(t,s,i,a),new It(a,this.container)}deleteHTML(){const e=this.naviContainer.querySelector(".wrap_settings");e&&e.remove()}createWrap(e,t,s){e.insertAdjacentHTML("afterend",Ot.createFindAndButton(t,s)),this.buttons=this.naviContainer.querySelectorAll(".button_setting"),this.clickCreateObjects()}controllStows(e,t,s,i){this.type_navi.forEach((t=>{t.children[0]!==e?(t.children[0].classList.remove("fa-angle-up"),t.children[0].classList.add("fa-angle-down")):this.deleteHTML()})),e.classList.contains("fa-angle-up")||this.createWrap(t,s,i),e.classList.toggle("fa-angle-up"),e.classList.toggle("fa-angle-down")}clickNavi(){this.type_navi.forEach((e=>e.addEventListener("click",this.addContainer.bind(this))))}}let Pt;document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".role").getAttribute("rel"),t=document.querySelectorAll(".log")[1].textContent;Pt=new Ft(e,t)}));class Ft{constructor(e,t){this.data=null,this.nameCar=null,this.body=document.querySelector("body"),this.wrapperFull=document.querySelector(".wrapperFull"),this.lowList=this.wrapperFull.querySelector(".low_list"),this.searchInput=this.wrapperFull.querySelector(".search_input"),this.startActivButton=document.querySelector(".stat_start"),this.create=document.querySelector(".create_object"),this.servis=document.querySelector(".servis"),this.role=e,this.login=t,this.dataspisok=!1,this.spisok=null,this.obj=null,this.sett=null,this.validationRole(),this.init()}validationRole(){"Дилер"!==this.role&&"Курсор"!==this.role&&(this.servis.style.display="none")}async init(){console.log("тут"),new Dt(this.login),this.formatContainer(),this.adaptiv(),this.activButton(),await this.startClass(),new Ct(this.data,this.login)}activButton(){this.startActivButton.classList.add("tablo")}async startClass(e){await this.zapros(e),new Ze(this.searchInput),new Ye(this.data),new Xe,this.obj&&this.obj.destroy(),this.obj=new qt(this.create),this.sett&&this.sett.destroy(),this.sett=new At(this.create,this.nameCar,this.data),new Qe(this.obj,this.sett),new et}async zapros(e){const[t]=await Promise.all([this.zaprosWialon(this.login,this.role)]);this.dataspisok=!0;const s=t.response.aLLmassObject;this.nameCar=t.response.arrName,this.data=s,console.log(this.data),0===s.flat().length&&(document.querySelector(".loaders").style.display="none"),this.spisok?this.spisok.updateData(s,e):this.spisok=new Ee(s),function(e){const t=document.getElementById("all"),s=document.querySelector(".check_boxs"),i=s.querySelectorAll(".listTitles");i&&i.forEach((e=>e.remove()));const a=Array.from(new Map(e.map((e=>[e[1],e]))).values());console.log(a),a.forEach((e=>{const t=e[0].replace(/\s+/g,""),i=e[1],a=document.createElement("p");a.classList.add("listTitles"),a.innerHTML=`<input class="checkIn" type="checkbox" \n    value=${t} rel=${t} id=${i}>${t}`,s.appendChild(a)}));const n=document.querySelectorAll(".checkIn");let r=[];!0===t.checked&&n.forEach((e=>{!1===e.checked&&r.push([e.value,e.id])})),n.forEach((e=>{e.addEventListener("change",(function(){if("all"!==this.id&&(t.checked=!1,r=Array.from(n).filter((e=>e.checked)).map((e=>[e.value,e.id]))),"all"==this.id){r.length=0;const e=document.getElementById("all");n.forEach((t=>{t.checked=!1,e.checked=!0,!0!==t.checked&&r.push([t.value,t.id])})),e.checked=!0}}))})),document.querySelector(".dad").addEventListener("click",(()=>{document.querySelector(".clearConfirmCheckModal").style.display="none";const e=document.querySelector(".userRole");!async function(e,t,s){const i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e,role:t,objects:s})},a=await fetch("/api/checkObject",i),n=await a.json(),r=document.querySelector(".messagech");r.textContent=n.message,r.style.color="green",setTimeout((()=>r.textContent=""),2e3)}(document.querySelector(".nameUser").textContent,e.textContent,r)}))}(this.nameCar)}async zaprosWialon(e,t){const s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e,role:t})},i=await fetch("/api/dataSpisok",s),a=await i.json();return console.log(a),a}async zaprosKursor(e){const t={method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({login:e})},s=await fetch("/api/getKursorObjects",t);return await s.json()}async logs(){const e=this.login,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e})},s=await fetch("/api/viewLogs",t);await s.json()}formatContainer(){screen.width<860&&document.querySelectorAll(".newColumn, .newCel").forEach((e=>e.remove())),this.lowList.style.height=this.wrapperFull.clientHeight-65+"px"}adaptiv(){const e=this.body.offsetWidth;if(e>860&&e<=1200&&(this.wrapperFull.querySelector(".wrapper_left").style.display="none"),e<=860){this.wrapperFull.querySelector(".start").style.display="none",this.wrapperFull.style.minHeight=screen.height-85+"px",this.lowList.style.height=this.wrapperFull.clientHeight-20+"px";const e=this.body.querySelector(".auth");e&&this.body.querySelector(".menu").appendChild(e),document.querySelector(".mobile_spisok").classList.add("mobile_active")}}}})();